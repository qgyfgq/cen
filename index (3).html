<!DOCTYPE html>  
<html lang="zh-CN">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>世纪小手机</title>  
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>  
/* ==================== 全局基础样式 ==================== */
*{margin:0;padding:0;box-sizing:border-box}body{font-family:system-ui;background:#fff;display:flex;justify-content:center;align-items:center;min-height:100vh;padding:20px}

/* ==================== 手机容器 ==================== */
.phone-container{width:500px;height:650px;background:white;border:16px solid #000;border-radius:36px;overflow:hidden;position:relative;box-shadow:0 30px 60px rgba(0,0,0,0.8)} .screen{width:100%;height:100%;position:relative;overflow:hidden;border-radius:20px}

/* ==================== 锁屏界面 ==================== */
.lock-screen{position:absolute;top:0;left:0;width:100%;height:100%;background:#fff;z-index:100;display:none;flex-direction:column;align-items:center;justify-content:space-between;padding:60px 20px 40px;transition:transform .6s cubic-bezier(0.4,0,0.2,1);pointer-events:all;overflow:hidden;border-radius:20px}.lock-screen.active{display:flex;transform:translateY(0)}.lock-screen.unlocking{transform:translateY(-100%)}.lock-screen-content{width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:space-between}.lock-icon{width:30px;height:30px;margin-bottom:15px;color:#000;font-size:25px;animation:lockFloat 2s ease-in-out infinite;position:relative;z-index:10}@keyframes lockFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)}}.lock-icon.unlocking{animation:unlock .5s ease-out forwards}@keyframes unlock{0%{transform:translateY(0)scale(1);opacity:1}50%{transform:translateY(-20px)scale(1.2);opacity:.7}100%{transform:translateY(-100px)scale(.5);opacity:0}}.lock-time{font-size:110px;font-weight:1000;letter-spacing:-2px;color:#000;margin-bottom:5px;}.lock-date{font-size:14px;color:#666;margin-bottom:25px;font-weight:400;letter-spacing:1px}.lock-weather{text-align:center;margin-bottom:20px;padding:12px;border-radius:12px;background:rgba(255,255,255,.8);backdrop-filter:blur(10px);border:1px solid rgba(0,0,0,.1);width:85%;max-width:280px}.weather-location{font-size:13px;color:#000;margin-bottom:6px;font-weight:600;display:flex;align-items:center;justify-content:center;gap:6px}.weather-info{font-size:16px;color:#000;font-weight:300}.lock-quote{max-width:260px;text-align:center;margin-bottom:20px;padding:15px}.quote-text{font-size:13px;color:#000;line-height:1.5;font-style:italic;margin-bottom:8px;letter-spacing:.3px;font-weight:300}.quote-author{font-size:10px;color:#666;letter-spacing:.5px;text-transform:uppercase}.unlock-hint{color:#000;font-size:11px;opacity:.7;animation:fadeInOut 2s infinite;text-align:center}.unlock-hint i{display:block;margin-bottom:4px;font-size:14px;animation:slideUp 1.5s infinite}@keyframes slideUp{0%,100%{transform:translateY(0);opacity:.7}50%{transform:translateY(-5px);opacity:1}}@keyframes fadeInOut{0%,100%{opacity:.5}50%{opacity:.9}}.lock-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(to bottom,rgba(255,255,255,.1) 0%,rgba(255,255,255,0) 100%);z-index:5}

/* ==================== 界面通用样式 ==================== */
.interface{position:absolute;top:0;left:0;width:100%;height:100%;padding:20px;opacity:0;pointer-events:none;transition:all .3s ease;background:#fff;display:flex;flex-direction:column;border-radius:20px} .interface.active{opacity:1;pointer-events:all} .interface.exiting{transform:translateX(-100%);opacity:0} .interface.entering{transform:translateX(100%)} .interface.entering.active{transform:translateX(0)}

/* ==================== 头部导航 ==================== */
.header{text-align:center;margin-bottom:15px;padding-bottom:10px;border-bottom:5px solid #000;position:relative;display:flex;align-items:center;justify-content:center;flex-shrink:0} .back-button{position:absolute;left:0;background:#fff;border:1px solid #000;padding:6px 10px;border-radius:20px;cursor:pointer;font-size:12px;z-index:1} .header h1{font-size:21px;font-weight:600;margin:0;display:flex;gap:8px} .toggle-persona{position:absolute;right:0;top:0;background:#fff;border:1px solid #000;padding:6px 10px;border-radius:20px;cursor:pointer;font-size:12px}

/* ==================== 桌面/主屏幕 ==================== */
.desktop-interface{position:absolute;top:0;left:0;width:100%;height:100%;background:#fff;display:none;flex-direction:column;align-items:center;justify-content:center;color:#000;padding-top:10px} .desktop-interface.active{display:flex} .desktop-time{font-size:100px;font-weight:1000;margin-bottom:5px;color:#000} .desktop-signature{font-size:16px;color:#000;margin-bottom:15px;text-align:center;min-height:24px;padding:0 20px;width:100%;cursor:text;transition:all .3s ease;outline:none;border:none;background:transparent;font-family:inherit} .desktop-signature:focus{background:rgba(0,0,0,.05);border-radius:8px} .lock-screen-btn{position:relative;margin:10px auto 0;color:#000;cursor:pointer;font-size:24px;z-index:10;transition:all .3s ease;text-align:center;display:block;background:none;border:none;padding:0} .lock-screen-btn:hover{transform:scale(1.2);color:#333} .lock-screen-btn:active{transform:scale(.9)} .app-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:5px;margin:15px auto 0;padding:0 10px;width:100%;max-width:320px} .app-item{display:flex;flex-direction:column;align-items:center;width:100%;justify-content:center} .app-icon{width:60px;height:50px;border-radius:16px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s ease;font-size:25.5px} .app-icon:hover{transform:scale(1.05)} .app-label{margin-top:10px;font-size:11px;text-align:center;color:#000;max-width:60px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;line-height:1.1;padding:0 2px} .app-navigation{display:none}

/* ==================== 聊天界面 ==================== */
.chat-interface{padding-bottom:0} .scrollable-content{flex:1;overflow-y:auto;margin-bottom:0;-webkit-overflow-scrolling:touch;overflow-scrolling:touch;scrollbar-width:none;-ms-overflow-style:none} .scrollable-content::-webkit-scrollbar{display:none;width:0;background:transparent} .chat-messages{flex:1;overflow-y:auto;padding:10px;border:1px solid #000;background:#fafafa;margin-bottom:10px;scrollbar-width:none;-ms-overflow-style:none} .chat-messages::-webkit-scrollbar{display:none;width:0;background:transparent} .chat-container{display:flex;flex-direction:column;height:100%} .chat-input-container{flex-shrink:0;margin-top:auto;padding:5px 0;background:white} .chat-input{display:flex;gap:10px} .chat-input input{flex:1;padding:10px;border:1px solid #000;border-radius:5px} .chat-input button{padding:10px 20px;border:1px solid #000;background:white;border-radius:5px;cursor:pointer} .chat-input input:focus{border:3px solid #4a6ee0 !important;outline:none !important;box-shadow:none !important}

/* ==================== AI圆圈 ==================== */
.ai-circle{border:3px solid #000;background:#fff;transition:all .3s ease;width:120px;height:120px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:50px;font-weight:700;margin:20px 0} .ai-circle:hover{transform:scale(1.05);box-shadow:0 5px 15px rgba(0,0,0,.1)} .message{border:1px solid #000;background:#fff;margin:8px 0;max-width:85%} .user-message{margin-left:auto;background:#f8f8f8} .ai-message{margin-right:auto;background:#f0f0f0}

/* ==================== 外卖小票样式 ==================== */
.chat-receipt-wrapper{max-width:280px;margin:10px auto;background:transparent;border:none;border-radius:0;overflow:visible;position:relative;box-shadow:0 4px 12px rgba(0,0,0,0.1);font-family:'Courier New',monospace} .chat-receipt{padding:20px;position:relative;background:white;border-left:1px dashed #000;border-right:1px dashed #000} .chat-receipt::before{content:"";position:absolute;top:-6px;left:-1px;right:-1px;height:6px;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M-1 7 Q 5 -2 11 7' fill='%23fff' stroke='%23000' stroke-width='1' stroke-dasharray='2,2'/%3E%3C/svg%3E");background-size:10px 6px;background-repeat:round;z-index:1} .chat-receipt::after{content:"";position:absolute;bottom:-6px;left:-1px;right:-1px;height:6px;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M-1 -1 Q 5 8 11 -1' fill='%23fff' stroke='%23000' stroke-width='1' stroke-dasharray='2,2'/%3E%3C/svg%3E");background-size:10px 6px;background-repeat:round;z-index:1} .receipt-header{text-align:center;margin-bottom:15px;padding-bottom:10px;border-bottom:2px dashed #000} .receipt-title{font-size:18px;font-weight:800;margin:0;letter-spacing:1px} .receipt-subtitle{font-size:12px;color:#666;margin:5px 0} .receipt-store-info{font-size:11px;color:#666;margin-bottom:15px;text-align:center} .receipt-datetime{font-size:11px;color:#666;text-align:center;margin-bottom:15px} .receipt-items{margin:15px 0;border-top:1px dashed #000;border-bottom:1px dashed #000;padding:10px 0} .receipt-item{display:flex;justify-content:space-between;margin-bottom:8px;font-size:12px} .receipt-item-name{flex:1} .receipt-item-quantity{margin:0 10px;min-width:20px;text-align:center} .receipt-item-price{min-width:40px;text-align:right;font-weight:600} .receipt-divider{border-bottom:1px dashed #000;margin:10px 0} .receipt-totals{margin:15px 0} .receipt-total-line{display:flex;justify-content:space-between;margin-bottom:5px;font-size:12px} .receipt-total-line.total{border-top:2px dashed #000;padding-top:8px;margin-top:8px} .receipt-footer{text-align:center;margin-top:20px;padding-top:10px;border-top:2px dashed #000} .receipt-thankyou{font-size:12px;font-weight:600;margin-bottom:5px} .receipt-barcode{height:30px;width:80%;margin:10px auto;background-image:linear-gradient(90deg,#000 0%,#000 4%,transparent 4%,transparent 5%,#000 5%,#000 7%,transparent 7%,transparent 9%,#000 9%,#000 14%,transparent 14%,transparent 15%,#000 15%,#000 18%,transparent 18%,transparent 21%,#000 21%,#000 23%,transparent 23%,transparent 25%,#000 25%,#000 31%,transparent 31%,transparent 33%,#000 33%,#000 37%,transparent 37%,transparent 39%,#000 39%,#000 42%,transparent 42%,transparent 44%,#000 44%,#000 49%,transparent 49%,transparent 51%,#000 51%,#000 55%,transparent 55%,transparent 57%,#000 57%,#000 61%,transparent 61%,transparent 63%,#000 63%,#000 67%,transparent 67%,transparent 71%,#000 71%,#000 75%,transparent 75%,transparent 77%,#000 77%,#000 81%,transparent 81%,transparent 83%,#000 83%,#000 89%,transparent 89%,transparent 91%,#000 91%,#000 95%,transparent 95%,transparent 100%)} .receipt-barcode-number{font-size:10px;letter-spacing:4px;color:#000;text-align:center;margin-top:-5px} .receipt-order-number{font-size:10px;color:#666;margin:5px 0} .receipt-status{display:inline-block;padding:3px 10px;border-radius:10px;font-size:10px;font-weight:600;margin-top:5px} .receipt-status.delivered{background:#e8f5e8;color:#2e7d32} .receipt-status.overtime{background:#ffebee;color:#c62828} .receipt-status.delivering{background:#e3f2fd;color:#1565c0} .receipt-checkbox{position:absolute;top:10px;right:10px;width:18px;height:18px;border:2px solid #000;border-radius:3px;cursor:pointer;background:white;z-index:10} .receipt-checkbox.checked{background:#000} .receipt-checkbox.checked::after{content:"✓";color:white;font-size:12px;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)} .chat-receipt-wrapper:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(0,0,0,0.15)} .chat-receipt-wrapper.selected{border-color:#4a6ee0;box-shadow:0 0 0 2px rgba(74,110,224,0.3)} .receipt-action-buttons{display:flex;gap:8px;margin-top:10px;padding-top:10px;border-top:1px dashed #ddd} .receipt-action-btn{flex:1;padding:6px 10px;border:1px solid #000;background:white;border-radius:4px;cursor:pointer;font-size:11px;text-align:center;transition:all .2s} .receipt-action-btn:hover{background:#000;color:white} .receipt-action-btn.primary{background:#000;color:white} .receipt-action-btn.primary:hover{background:#333} .receipt-remark{font-size:10px;color:#666;margin:8px 0 5px 0;padding-top:8px;border-top:1px dashed #ddd;word-wrap:break-word;line-height:1.4;text-align:left} .receipt-remark strong{color:#000;font-weight:600}

/* ==================== 外卖订单条框样式 ==================== */
.order-type-selector{margin-bottom:10px;font-size:14px;display:flex;align-items:center;gap:8px} .order-type-selector select{padding:5px 10px;border:1px solid #000;border-radius:4px;background:#fff;font-size:13px} .simple-order-item{padding:12px 14px;border:1px solid #ddd;border-radius:6px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;background:#fff;transition:all .2s ease} .simple-order-item:hover{background:#f9f9f9;border-color:#000} .simple-order-info{flex:1;font-size:12px} .simple-order-name{font-weight:700;font-size:13px;color:#333;margin-bottom:4px} .simple-order-details{font-size:12px;color:#666;margin-bottom:4px} .simple-order-time{font-size:11px;color:#999} .simple-order-right{display:flex;flex-direction:column;align-items:flex-end;gap:6px} .simple-order-price{font-size:13px;font-weight:700;color:#000} .simple-order-status{font-size:11px;padding:3px 8px;border-radius:12px;background:#f0f0f0;color:#666} .status-delivering{background:#e8f5e8;color:#2e7d32} .status-delivered{background:#e3f2fd;color:#0a0;font-size:10px} .status-overtime{background:#ffebee;color:#f00;font-size:10px} .empty-order{text-align:center;padding:25px;color:#999;font-size:13px}

/* ==================== 聊天管理 ==================== */
.chat-management-section{margin-top:10px;padding:15px;border:1px solid #000;background:#fafafa;border-radius:8px} .chat-management-section h3{margin-bottom:10px;font-size:16px;display:flex;align-items:center;gap:8px} .chat-management-buttons{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px} .chat-management-buttons button{flex:1;padding:8px 12px;border:1px solid #000;background:#fff;border-radius:5px;cursor:pointer;font-size:12px;min-width:120px;transition:all .2s ease} .chat-management-buttons button:hover{background:#f0f0f0;transform:translateY(-1px)} .chat-management-buttons button.danger{background:#f8f8f8;border-color:#888;color:#333} .chat-management-buttons button.danger:hover{background:#e0e0e0} .selection-mode-info{padding:8px;background:#f0f0f0;border-radius:5px;margin-bottom:10px;display:none;font-size:12px} .selection-mode-info.active{display:block} .selection-count{font-weight:700;color:#666} .selection-actions{display:flex;gap:8px;margin-top:8px;display:none} .selection-actions.active{display:flex} .selection-actions button{flex:1;padding:6px 10px;border:1px solid #000;background:#fff;border-radius:5px;cursor:pointer;font-size:11px} .selection-actions button.danger{background:#f8f8f8;border-color:#888;color:#333} .message-checkbox{display:none;margin-left:10px;cursor:pointer} .selection-mode .message-checkbox{display:inline-block} .message{max-width:100%;padding:14px;margin:10px 0;border-radius:20px;word-wrap:break-word;position:relative;transition:all .3s ease;opacity:1;transform:scale(1)} .message:hover{background-color:transparent} .message.selected{background:#f0f0f0!important;border-color:#aaa!important} .message.selected:hover{background-color:#e8e8e8!important} .selection-mode .message-actions{display:none!important} .user-message{background:#fff;border:1px solid #000;margin-left:auto} .ai-message{background:#fff;border:1px solid #000;margin-right:auto} .message-sender{font-size:16px;color:#000;margin-bottom:3px;font-weight:800} .user-message .message-sender{text-align:right;display:flex;justify-content:flex-end;margin-right:10px;margin-left:auto;color:#000} .ai-message .message-sender{text-align:left;justify-content:flex-start;margin-left:8px;margin-right:auto;color:#000} .message-content{font-size:13px;text-align:center} .message-actions{position:absolute;top:10px;display:none;gap:5px}.user-message .message-actions{left:17px;right:auto}.ai-message .message-actions{left:auto;right:17px} .message:hover .message-actions{display:flex} .message-action{background:rgba(255,255,255,.9);border:1px solid #000;border-radius:3px;width:20px;height:20px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:10px} .message.editing{background:#fff;border-color:#000!important} .message.deleting{opacity:0;transform:scale(.5);max-height:0;margin:0;padding:0;overflow:hidden;transition:all .3s ease} .message.editing textarea::-webkit-scrollbar{display:none}.message.editing textarea{scrollbar-width:none} .chat-mode-switch,.chat-type-switch{margin-top:10px;padding:8px;background:#f0f0f0;border:1px solid #000;border-radius:5px;display:flex;align-items:center;justify-content:space-between;font-size:12px} .chat-mode-label,.chat-type-label{font-weight:700} .chat-mode-buttons,.chat-type-buttons{display:flex;gap:5px} .chat-mode-btn,.chat-type-btn{padding:4px 8px;border:1px solid #000;background:#fff;border-radius:3px;cursor:pointer;font-size:11px;transition:all .2s ease} .chat-mode-btn.active,.chat-type-btn.active{background:#000;color:#fff} .chat-mode-btn:hover,.chat-type-btn:hover{background:#f0f0f0} .chat-mode-btn.active:hover,.chat-type-btn.active:hover{background:#333} .chat-mode-indicator{display:inline-block;width:6px;height:6px;border-radius:50%;margin-left:5px;vertical-align:middle} .chat-mode-online{background:#0f0} .chat-mode-offline{background:red} .chat-mode-description{font-size:10px;color:#666;margin-top:4px;text-align:center} .multi-persona-selector{margin-top:10px;padding:8px;background:#f0f0f0;border:1px solid #000;border-radius:5px;display:none;font-size:12px} .multi-persona-selector.active{display:block} .multi-persona-label{font-weight:700;margin-bottom:5px;display:block} .persona-select{width:100%;padding:5px;border:1px solid #000;border-radius:3px;background:#fff;font-size:11px} .multi-persona-management{margin-top:5px;display:flex;gap:5px} .multi-persona-management button{flex:1;padding:4px 8px;border:1px solid #000;background:#fff;border-radius:3px;cursor:pointer;font-size:10px} .multi-persona-management button:hover{background:#f0f0f0} .chat-character-profile{margin-top:20px;padding:16px;border:1px solid #e0e0f0;border-radius:8px;background-color:#fafafa} .chat-character-header{display:flex;align-items:center;gap:12px;margin-bottom:16px} .chat-character-avatar{width:60px;height:60px;border-radius:50%;background-color:#000;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:24px} .chat-character-info{flex:1} .chat-character-name{font-weight:600;font-size:18px;margin-bottom:4px} .chat-character-bio{font-size:14px;color:#666} .chat-character-stats{display:flex;gap:16px;margin-bottom:16px} .chat-character-stat{text-align:center} .chat-character-stat-number{font-weight:600;font-size:16px} .chat-character-stat-label{font-size:12px;color:#666} .chat-character-edit-btn{background-color:#000;color:#fff;border:none;border-radius:4px;padding:8px 16px;font-size:14px;cursor:pointer;width:100%}

/* ==================== 备份与编辑 ==================== */
.backup-section{margin-top:15px;padding:15px;border:1px solid #000;border-radius:8px;background:#fafafa} .backup-section h3{margin-bottom:10px;font-size:16px} .backup-buttons{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px} .backup-buttons button{flex:1;padding:8px 12px;border:1px solid #000;background:#fff;border-radius:5px;cursor:pointer;font-size:12px;min-width:120px} .backup-buttons button:hover{background:#f0f0f0} .backup-file-input{display:none} .backup-status{margin-top:10px;padding:8px;border-radius:5px;text-align:center;display:none;font-size:12px} .backup-success,.backup-error{background:#f0f0f0;border:1px solid #000;color:#000} .backup-info{font-size:11px;color:#666;margin-top:8px;text-align:center} .edit-input{width:100%;padding:8px;border:1px solid #000;border-radius:9px;font-size:13px;resize:vertical;min-height:80px} .edit-actions{display:flex;gap:10px;margin-top:10px;justify-content:flex-end} .edit-actions button{padding:5px 10px;border:1px solid #000;background:#fff;border-radius:3px;cursor:pointer;font-size:12px} .persona-editor{max-height:0;overflow:hidden;transition:max-height .3s ease;margin-bottom:10px} .persona-editor.expanded{max-height:100px} .persona-form{padding:15px;border:2px solid #000;border-radius:5px;background:#fafafa} .form-group{margin-bottom:5px} .form-group label{display:block;margin-bottom:4px;font-size:14px} .form-input{width:100%;padding:8px;border:1px solid #000;border-radius:9px;background:#fff} .persona-actions{display:flex;gap:10px;flex-wrap:wrap} .persona-actions button{flex:1;padding:5px;border:1px solid #000;background:#fff;border-radius:20px;cursor:pointer;min-width:50px} input,textarea,select,input:-webkit-autofill{border:2px solid #ddd;border-radius:8px;padding:12px 15px;width:100%;background:#fff} input:focus,textarea:focus,.input:focus,select:focus{border:3px solid #4a6ee0!important;outline:none;box-shadow:none} input:-webkit-autofill{-webkit-box-shadow:0 0 0 1000px #fff inset;border:3px solid #4a6ee0!important}

/* ==================== API设置 ==================== */
#api-interface .header h1{margin-left:20px} .api-section{margin-bottom:15px;padding:15px;border:1px solid #000} .api-section h3{margin-bottom:10px} .api-input{width:100%;padding:8px;border:1px solid #000;margin-bottom:10px;border-radius:5px} .api-buttons{display:flex;gap:10px;flex-wrap:wrap} .api-buttons button{padding:8px 15px;border:1px solid #000;background:#fff;border-radius:5px;cursor:pointer;flex:1} .api-status{margin-top:10px;padding:8px;border-radius:5px;text-align:center;display:none} .status-success,.status-error{background:#f0f0f0;border:1px solid #000} .model-list{max-height:200px;overflow-y:auto;border:1px solid #000;margin-top:10px;padding:10px;background:#fafafa;scrollbar-width:none} .model-list::-webkit-scrollbar{display:none} .model-item{padding:5px;border-bottom:1px solid #eee;cursor:pointer} .model-item:hover{background:#f0f0f0} .model-item:last-child{border-bottom:none} .refresh-status{display:flex;align-items:center;gap:10px;margin-top:10px} .refresh-button{background:#fff;border:1px solid #000;padding:5px 10px;border-radius:3px;cursor:pointer} .last-updated{font-size:12px;color:#666} .model-info{display:flex;justify-content:space-between;align-items:center;margin-top:10px;padding:5px;background:#fff;border-radius:3px} .current-model{font-size:14px;font-weight:600} .model-badge{background:#000;color:#fff;padding:3px 6px;border-radius:10px;font-size:12px}

/* ==================== TTS语音设置样式 ==================== */
#tts-api-section .tts-config-group{display:flex;flex-direction:column;gap:8px}
#tts-api-section .form-group{display:flex;flex-direction:column;gap:3px}
#tts-api-section .form-group label{font-size:12px;font-weight:500;color:#000}
#tts-api-section .api-input{width:100%;padding:6px 8px;border:1px solid #000;margin-bottom:0;border-radius:4px;font-size:12px}
.tts-buttons{display:flex;gap:6px;flex-wrap:wrap;margin-top:5px}
.tts-buttons button{padding:6px 10px;border:1px solid #000;background:#fff;border-radius:4px;cursor:pointer;flex:1;font-size:11px;min-width:80px}
.tts-buttons button:hover{background:#f0f0f0}
#test-tts-voice-btn{background:#fff;color:#000;border:1px solid #000}
#test-tts-voice-btn:hover{background:#f0f0f0}
.tts-status{margin-top:8px;padding:6px;border-radius:4px;text-align:center;display:none;font-size:11px}
.tts-status.success{background:#f0f0f0;border:1px solid #000;color:#000;display:block}
.tts-status.error{background:#f0f0f0;border:1px solid #000;color:#000;display:block}
.tts-status.info{background:#f0f0f0;border:1px solid #000;color:#000;display:block}
.tts-model-info{display:flex;flex-direction:column;gap:4px;margin-top:8px;padding:8px;background:#fafafa;border:1px solid #000;border-radius:4px;font-size:11px}
.current-model,.current-voice{display:flex;justify-content:space-between}
.current-model span,.current-voice span{font-weight:600}
.tts-buttons button:active,.api-buttons button:active{transform:translateY(1px)}

/* ==================== 设置界面样式 ==================== */
#settings-interface .header h1{margin-left:25px}
.settings-container{padding:20px}
.settings-category{margin-bottom:30px}
.settings-category-title{font-size:14px;font-weight:600;color:#666;margin-bottom:10px;text-transform:uppercase;letter-spacing:1px}
.settings-list{background:#fff;border:1.5px solid #000;border-radius:12px;overflow:hidden}
.settings-item{display:flex;align-items:center;padding:16px 20px;border-bottom:1px solid #eee;cursor:pointer;transition:background-color .2s ease}
.settings-item:last-child{border-bottom:none}
.settings-item:hover{background-color:#f9f9f9}
.settings-icon{width:36px;height:36px;display:flex;align-items:center;justify-content:center;font-size:25px;border-radius:8px;margin-right:15px;flex-shrink:0;font-weight:900}
.settings-info{flex:1}
.settings-title{font-size:16px;font-weight:600;color:#000;margin-bottom:4px}
.settings-desc{font-size:13px;color:#666}
.settings-arrow{font-size:24px;color:#999;margin-left:10px}
.settings-value{font-size:14px;color:#666;margin-left:10px}
.settings-switch{margin-left:10px}
.switch{position:relative;display:inline-block;width:50px;height:24px}
.switch input{opacity:0;width:0;height:0}
.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:34px}
.slider:before{position:absolute;content:"";height:16px;width:16px;left:4px;bottom:4px;background-color:#fff;transition:.4s;border-radius:50%}
input:checked+.slider{background-color:#000}
input:checked+.slider:before{transform:translateX(26px)}
.settings-footer{text-align:center;margin-top:40px;padding-top:20px;border-top:1px solid #eee;color:#999;font-size:13px}
.app-version{font-weight:600;margin-bottom:8px}
.copyright{font-size:12px}

/* ==================== 安全隐私界面 ==================== */
#security-interface .header h1{margin-left:25px}
.security-container{display:flex;flex-direction:column;align-items:center;justify-content:flex-start;min-height:400px;padding:20px}
.security-card{width:100%;max-width:300px;padding:20px;border:1px solid #000;border-radius:12px;margin-bottom:20px;background:#fafafa}
.security-card h3{margin-bottom:15px;font-size:16px}
.security-card p{font-size:13px;color:#666;margin-bottom:10px}
.security-btn{padding:10px 15px;border:1px solid #000;background:#fff;border-radius:8px;cursor:pointer;margin:5px;transition:all .2s ease}
.security-btn:hover{background:#000;color:#fff}
.security-lock{width:120px;height:120px;border:3px solid #000;background:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:50px;font-weight:700;margin:40px auto;color:#000;transition:all .3s ease}
.security-lock:hover{transform:scale(1.05);box-shadow:0 5px 15px rgba(0,0,0,.1)}

/* ==================== 样式编辑器 ==================== */
#style-interface .header h1{margin-left:30px}
.style-container{display:flex;flex-direction:column;align-items:center;justify-content:flex-start;min-height:400px}
.css-editor{width:100%;height:200px;padding:10px;border:1px solid #000;border-radius:8px;font-family:monospace;resize:vertical}
.css-editor{width:100%;height:200px;padding:10px;border:1px solid #000;border-radius:8px;font-family:monospace;resize:vertical;scrollbar-width:none;-ms-overflow-style:none}.css-editor::-webkit-scrollbar{display:none;width:0;background:transparent}.css-editor:hover{scrollbar-width:thin}.css-editor:hover::-webkit-scrollbar{display:block;width:6px}.css-editor:hover::-webkit-scrollbar-track{background:transparent}.css-editor:hover::-webkit-scrollbar-thumb{background:#0003;border-radius:3px}
.apply-css{width:100%;padding:10px;border:1px solid #000;background:#fff;border-radius:5px;cursor:pointer;margin-top:10px}
.style-buttons{display:flex;gap:10px;flex-wrap:wrap;margin-top:15px;width:100%}
.style-buttons button{flex:1;padding:10px;border:1px solid #000;background:#fff;border-radius:5px;cursor:pointer;min-width:120px}

/* ==================== 通用组件 ==================== */
.scroll-hint{text-align:center;font-size:10px;color:#666;margin-top:10px;display:none}
.confirm-dialog{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;justify-content:center;align-items:center;z-index:1000}
.confirm-content{background:#fff;padding:20px;border:2px solid #000;border-radius:10px;text-align:center;max-width:300px;margin:0 20px}
.confirm-buttons{display:flex;gap:10px;margin-top:15px}
.confirm-buttons button{flex:1;padding:8px;border:1px solid #000;background:#fff;border-radius:5px;cursor:pointer}
.status-indicator{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:5px;transition:all .3s ease}
.status-online{background:#0f0}
.status-offline{background:red}
.status-generating{background:#0f0;animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.loading{opacity:.7;pointer-events:none}
.typing-indicator{display:inline-block;margin-left:5px}
.typing-dot{display:inline-block;width:4px;height:4px;background:#000;border-radius:50%;margin:0 1px;animation:typing 1.4s infinite}
.typing-dot:nth-child(2){animation-delay:.2s}
.typing-dot:nth-child(3){animation-delay:.4s}
@keyframes typing{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-5px)}}

/* ==================== 角色模态框 ==================== */
.persona-modal{position:fixed!important;top:0!important;left:0!important;width:100vw!important;height:100vh!important;background:rgba(0,0,0,.7)!important;display:none;justify-content:center;align-items:center;z-index:9999!important;margin:0!important;padding:0!important}
.modal-content{background:#fff!important;width:90%;max-width:350px;max-height:80vh;border:2px solid #000!important;border-radius:10px;overflow:hidden;display:flex;flex-direction:column;z-index:10000}
.modal-header{padding:15px;background:#ffffff;display:flex;justify-content:space-between;align-items:center;position:relative}.modal-header h3{margin:0;font-size:16px;position:absolute;left:50%;transform:translateX(-50%);z-index:1}.close-modal{margin-left:auto;z-index:2;}
.modal-header h3{margin:-5;font-size:23px;margin-top:10px}
.close-modal{background:none;border:none;font-size:20px;cursor:pointer;width:30px;height:30px;display:flex;align-items:center;justify-content:center}
.modal-body{flex:1;overflow-y:auto;padding:15px;scrollbar-width:none;margin-top:-20px}
.modal-body::-webkit-scrollbar{display:none}
.persona-tabs{display:flex;border-bottom:1px solid #000;margin-bottom:15px}
.persona-tab{flex:1;padding:10px;text-align:center;border:none;background:#fff;cursor:pointer;border-bottom:2px solid transparent}
.persona-tab.active{border-bottom:2px solid #000;font-weight:600}
.persona-form-section{display:none}
.persona-form-section.active{display:block}
.form-section{margin-bottom:20px;padding:15px;border:1px solid #000;border-radius:5px}
.form-section h4{margin-bottom:10px;font-size:14px}
.persona-preview{margin-top:15px;padding:10px;border:1px solid #000;border-radius:5px;background:#fafafa;font-size:12px}
.persona-preview h5{margin-bottom:5px;font-size:12px;color:#000}
#multi-preview-content{color:#000}
#multi-preview-content div{color:#000;border-color:#000}

/* ==================== 音乐播放器 ==================== */
#music-interface .header h1{margin-left:30px}
.music-player{display:flex;flex-direction:column;height:100%;background:#fff}
.music-fixed-area{flex-shrink:0;display:flex;flex-direction:column;align-items:center;padding:10px 15px 5px}
.music-scrollable-area{flex:1;overflow-y:auto;padding:5px 15px 15px;scrollbar-width:none}
.music-scrollable-area::-webkit-scrollbar{display:none}
.disc-container{width:220px;height:220px;margin:15px 0 20px;display:flex;justify-content:center;align-items:center;position:relative}
.disc-container::before{content:"";display:block;padding-top:100%}
.disc-container>*{position:absolute;top:0;left:0;width:100%;height:100%}
.disc{width:100%;height:100%;background:radial-gradient(circle,#333 0%,#000 100%);border-radius:50%;display:flex;justify-content:center;align-items:center;position:relative;animation:rotate 20s linear infinite;animation-play-state:paused}
.disc-center{width:40px;height:40px;background-color:#fff;border-radius:50%;z-index:2}
.disc.playing{animation-play-state:running}
@keyframes rotate{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
.music-title{font-size:16px;font-weight:700;margin-bottom:8px;text-align:center;width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.music-artist{font-size:12px;color:#666;margin-bottom:15px;text-align:center;width:100%}
.song-info{margin-bottom:15px;width:100%;text-align:center}
.song-title{font-size:18px;font-weight:600;margin-bottom:8px;color:#000}
.song-artist{font-size:14px;color:#555}
.progress-container{width:100%;margin-bottom:15px}
.progress-info{display:flex;justify-content:space-between;margin-bottom:10px;font-size:12px;color:#555}
.progress-bar{width:100%;height:4px;background-color:#ddd;border-radius:2px;cursor:pointer;position:relative;overflow:hidden}
.progress{height:100%;background-color:#000;border-radius:2px;width:0;transition:width .1s}
.control-buttons{display:flex;justify-content:center;align-items:center;gap:30px;margin-bottom:15px}
.btn{background:none;border:none;cursor:pointer;font-size:20px;color:#000;width:20px;height:40px;display:flex;justify-content:center;align-items:center;border-radius:50%;transition:all .3s}
.btn:hover{background-color:#f0f0f0}
.btn-play{width:50px;height:50px;background-color:#000;color:#fff;font-size:18px;display:flex;justify-content:center;align-items:center;padding-bottom:2px}
.btn-play:hover{background-color:#333;transform:scale(1.05)}
.btn-loop{font-size:18px;width:40px;height:40px;background:none;border:none;cursor:pointer;padding:0 20px}
.import-section{margin-top:5px;width:100%;max-width:100%}
.import-btn{width:100%;padding:10px;background:#fff;border:2px solid #000;border-radius:8px;text-align:center;cursor:pointer;margin-bottom:10px;transition:all .2s ease;font-size:14px}
.import-btn:hover{background:#f0f0f0}
.file-input{display:none}
.playlist{width:100%;max-height:200px;overflow-y:auto;border:1px solid #ddd;border-radius:8px;padding:8px;margin-top:10px;border:2px solid #000;font-size:12px;scrollbar-width:none}
.playlist::-webkit-scrollbar{display:none}
.playlist-item{padding:6px;border-bottom:1px solid #eee;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
.playlist-item:last-child{border-bottom:none}
.playlist-item:hover{background:#f9f9f9}
.playlist-item.active{background:#f0f0f0;font-weight:700}
.song-duration{font-size:10px;color:#666;margin-left:8px}

/* ==================== 世界书 ==================== */
#worldbook-interface .header{display:flex;justify-content:space-between;align-items:center;position:relative;text-align:center;margin-bottom:15px;padding-bottom:10px;border-bottom:5px solid #000;flex-shrink:0;width:100%}#worldbook-interface .header h1{flex:1;margin:0;display:flex;align-items:flex-start;justify-content:center;gap:8px;font-size:22px;margin-left:16px}#worldbook-interface .add-worldbook-btn{background:none;border:none;font-size:40px;cursor:pointer;padding:0;width:50px;height:30px;display:flex;align-items:center;justify-content:center;position:absolute;right:0;color:#000;font-weight:300;transition:all .2s ease}#worldbook-interface .add-worldbook-btn:hover{transform:scale(1.1);color:#333}#worldbook-interface h2{display:flex;align-items:center;gap:8px;font-size:20px}.worldbook-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}.worldbook-list{display:flex;flex-direction:column;gap:10px;margin-top:15px}.worldbook-item{border:1px solid #000;border-radius:8px;padding:12px;background:#fff;position:relative}.worldbook-title{font-weight:700;margin-bottom:5px;font-size:14px}.worldbook-content{font-size:12px;color:#333;margin-bottom:10px;max-height:60px;overflow:hidden;position:relative}.worldbook-content.expanded{max-height:none;overflow:visible}.worldbook-actions{display:flex;gap:8px;justify-content:flex-end}.worldbook-action{background:#fff;border:1px solid #000;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:11px}.worldbook-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;justify-content:center;align-items:center;z-index:1002}.worldbook-modal-content{background:#fff;padding:20px;border:2px solid #000;border-radius:10px;width:90%;max-width:350px}.worldbook-form-group{margin-bottom:15px}.worldbook-form-group label{display:block;margin-bottom:5px;font-size:14px}.worldbook-form-input{width:100%;padding:8px;border:1px solid #000;border-radius:5px;font-size:14px}.worldbook-form-textarea{width:100%;padding:8px;border:1px solid #000;border-radius:5px;font-size:14px;resize:vertical;min-height:100px}.worldbook-form-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:15px}.worldbook-form-btn{padding:8px 15px;border:1px solid #000;background:#fff;border-radius:5px;cursor:pointer}.worldbook-status,.worldbook-backup-status{margin-top:10px;padding:8px;border-radius:5px;text-align:center;display:none;font-size:12px}.worldbook-status-success,.worldbook-backup-success,.worldbook-status-error,.worldbook-backup-error{background:#f0f0f0;border:1px solid #000;color:#000}.worldbook-toggle{position:absolute;right:10px;top:10px;background:#fff;border:1px solid #000;padding:2px 6px;border-radius:3px;cursor:pointer;font-size:10px}.worldbook-active-indicator{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:5px}.worldbook-active{background:#0f0}.worldbook-inactive{background:red}.worldbook-backup-section{margin-top:20px;padding:15px;border:1px solid #000;border-radius:8px;background:#fafafa}.worldbook-backup-section h3{margin-bottom:10px;font-size:16px;display:flex;align-items:center;gap:8px}.worldbook-backup-buttons{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}.worldbook-backup-buttons button{flex:1;padding:8px 12px;border:1px solid #000;background:#fff;border-radius:5px;cursor:pointer;font-size:12px;min-width:120px;transition:all .2s ease}.worldbook-backup-buttons button:hover{background:#f0f0f0;transform:translateY(-1px)}.worldbook-backup-info{font-size:11px;color:#666;margin-top:8px;text-align:center}.worldbook-backup-file-input{display:none}

/* ==================== 钱包 ==================== */
#wallet-interface .header h1{margin-left:30px}
.wallet-container{max-width:100%;margin:0 auto;padding:0 10px;overflow-x:hidden}
.balance-card{background:#000;color:#fff;border-radius:15px;padding:25px;text-align:center;box-shadow:0 5px 15px rgba(0,0,0,.1);margin-bottom:25px;border:2px solid #000;overflow:hidden;width:100%;box-sizing:border-box}
.balance-label{font-size:.9em;opacity:.8;margin-bottom:8px}
.balance-amount{font-size:2.2em;font-weight:700;letter-spacing:1px;margin:10px 0;word-wrap:break-word;overflow-wrap:break-word;max-width:100%;padding:0 10px}
.balance-sub-info{font-size:.9em;opacity:.8;display:flex;justify-content:space-around;margin-top:15px;flex-wrap:wrap}
.action-buttons{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:25px}
.action-btn{background:#000;color:#fff;border:2px solid #000;border-radius:12px;padding:15px;text-align:center;cursor:pointer;transition:all .3s ease;font-weight:500}
.action-btn:hover{background:#333;transform:translateY(-2px)}
.action-btn .icon{font-size:1.2em;margin-bottom:5px;display:block}
.transaction-section{margin-top:20px;border-radius:10px;background:#f9f9f9;overflow:hidden}
.transaction-section h3{margin-bottom:15px;font-size:1.1em;color:#000;text-align:center;padding:15px;border-bottom:1px solid #ddd}
.transaction-list{max-height:300px;overflow-y:auto;padding:10px}
.transaction-item{display:flex;justify-content:space-between;align-items:center;padding:12px 10px;border-bottom:1px solid #eee}
.transaction-item:last-child{border-bottom:none}
.transaction-info{flex:1}
.transaction-title{font-weight:700;font-size:.9em;margin-bottom:3px}
.transaction-date{font-size:.8em;color:#666}
.transaction-amount{font-weight:700;font-size:1em}
.transaction-expense{color:#f44}
.transaction-income{color:#0a0}
.empty-state{padding:30px 0;color:#666;text-align:center}
.wallet-modal,.utility-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:1000;justify-content:center;align-items:center}
.wallet-modal-content,.utility-modal-content{background:#fff;padding:25px;border-radius:15px;width:90%;max-width:350px;box-shadow:0 5px 20px rgba(0,0,0,.2)}
.wallet-modal-header,.utility-modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.wallet-modal-title,.utility-modal-title{font-size:1.3em;font-weight:700;color:#000}
.wallet-close-btn,.utility-close-btn{background:none;border:none;font-size:1.5em;cursor:pointer;color:#000}
.wallet-input-group{margin-bottom:20px}
.wallet-input-label{display:block;margin-bottom:8px;color:#000;font-weight:500}
.amount-input{width:100%;padding:12px 15px;border:2px solid #000;border-radius:8px;font-size:1.1em;text-align:center;transition:all .3s ease}
.amount-input:focus{outline:none;border-color:#07f}
.wallet-confirm-btn,.utility-confirm-btn{width:100%;background:#000;color:#fff;border:2px solid #000;border-radius:8px;padding:12px;font-size:1.1em;cursor:pointer;transition:background .3s ease}
.wallet-confirm-btn:hover,.utility-confirm-btn:hover{background:#333}
.house-type-selector{margin-bottom:20px;padding:15px;background:#f9f9f9;border-radius:10px;border:1px solid #ddd}
.house-type-selector label{display:block;margin-bottom:8px;color:#000;font-weight:500}
.house-type-select{width:100%;padding:12px 15px;border:2px solid #000;border-radius:8px;font-size:1em;background-color:#fff}
.utility-info{margin-bottom:20px;padding:15px;background:#f9f9f9;border-radius:10px;border:1px solid #ddd}
.utility-item{display:flex;justify-content:space-between;margin-bottom:10px;font-size:1em}
.utility-total{display:flex;justify-content:space-between;margin-top:15px;padding-top:15px;border-top:1px solid #ddd;font-weight:700;font-size:1.1em}
@media (max-width:480px){.balance-amount{font-size:1.8em}.action-buttons{grid-template-columns:1fr;gap:10px}.balance-sub-info{flex-direction:column;gap:5px}}

/* ==================== 微博 ==================== */
#weibo-interface .header h1{margin-left:25px}
.weibo-container{max-width:100%;margin:0 auto;border-left:1px solid #f0f0f0;border-right:1px solid #f0f0f0;min-height:100vh;background:#fff;overflow-y:auto;padding:0}
.weibo-header{position:sticky;top:0;background:rgba(255,255,255,.95);backdrop-filter:blur(10px);border-bottom:1px solid #e0e0e0;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;z-index:100}
.weibo-logo{font-weight:700;font-size:20px}
.weibo-nav a{color:#000;text-decoration:none;margin-left:20px;font-size:14px;cursor:pointer;padding:4px 8px;border-radius:4px;transition:all .2s}
.weibo-nav a.active{background-color:#000;color:#fff}
.weibo-nav a.active:hover{background-color:#000;color:#fff} 
.weibo-nav a:hover{background-color:#f0f0f0}
.weibo-page-content{display:none}
.weibo-page-content.active{display:block}
.weibo-category-section{padding:16px;border-bottom:1px solid #f0f0f0;background-color:#fafafa}
.weibo-category-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.weibo-category-title{font-weight:600;font-size:16px}
.weibo-manage-categories-btn{background:none;border:1px solid #000;border-radius:4px;padding:4px 12px;font-size:12px;cursor:pointer;transition:all .2s}
.weibo-manage-categories-btn:hover{background-color:#000;color:#fff}
.weibo-category-tags{display:flex;flex-wrap:wrap;gap:8px}
.weibo-category-tag{background-color:#fff;border:1px solid #000;border-radius:16px;padding:4px 12px;font-size:12px;cursor:pointer;transition:all .3s ease;color:#000}
.weibo-category-tag.active{background-color:#000;color:#fff}
.weibo-category-tag:hover{background-color:#f0f0f0;transform:translateY(-1px)}
.weibo-modal,.weibo-comment-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:1000;justify-content:center;align-items:center}
.weibo-modal-content,.weibo-comment-content{background-color:#fff;padding:24px;border-radius:8px;width:90%;max-width:500px;max-height:80vh;overflow-y:auto}
.weibo-comment-content{padding:20px}
.weibo-modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.weibo-close-modal{background:none;border:none;font-size:20px;cursor:pointer}
.weibo-category-input-group{display:flex;margin-bottom:16px}
.weibo-category-input{flex:1;border:1px solid #e0e0e0;border-radius:4px 0 0 4px;padding:8px;outline:none}
.weibo-add-category-btn{background-color:#000;color:#fff;border:none;border-radius:0 4px 4px 0;padding:0 16px;cursor:pointer}
.weibo-category-list{max-height:200px;overflow-y:auto}
.weibo-category-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #f0f0f0}
.weibo-delete-category{background:none;border:none;color:#666;cursor:pointer}
.weibo-profile-form{display:flex;flex-direction:column;gap:16px}
.weibo-form-group{display:flex;flex-direction:column;gap:8px}
.weibo-form-group label{font-size:14px;font-weight:600}
.weibo-form-group input,.weibo-form-group textarea{border:1px solid #e0e0e0;border-radius:4px;padding:8px;font-family:inherit;font-size:14px;outline:none}
.weibo-form-group textarea{resize:vertical;min-height:80px}
.weibo-save-profile-btn{background-color:#000;color:#fff;border:none;border-radius:4px;padding:10px;font-size:14px;cursor:pointer;margin-top:8px}
.weibo-compose-section{padding:16px;border-bottom:1px solid #f0f0f0}
.weibo-compose-box{display:flex;gap:12px}
.weibo-avatar{width:40px;height:40px;border-radius:50%;background-color:#000;cursor:pointer;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:16px}
.weibo-compose-input{flex:1}
.weibo-compose-input textarea{width:100%;border:1px solid #e0e0f0;border-radius:8px;padding:12px;font-family:inherit;font-size:14px;resize:none;outline:none;height:60px}
.weibo-compose-actions{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
.weibo-category-select{border:1px solid #e0e0f0;border-radius:4px;padding:6px 12px;font-size:12px;background:none}
.weibo-list{padding:0}
.weibo-item{padding:16px;border-bottom:1px solid #f0f0f0;display:flex;gap:12px}
.weibo-content{flex:1}
.weibo-item-header{display:flex;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:8px}
.weibo-username{font-weight:600;margin-right:8px}
.weibo-item-category{background-color:#f0f0f0;border-radius:12px;padding:2px 8px;font-size:10px;color:#666}
.weibo-timestamp{color:#666;font-size:12px}
.weibo-item-text{margin-bottom:12px;font-size:13px;line-height:1.5}
.weibo-item-actions{display:flex;gap:20px}
.weibo-item-actions button{background:none;border:none;color:#666;cursor:pointer;font-size:12px;display:flex;align-items:center;gap:4px;transition:all .2s;padding:4px 8px;border-radius:4px}
.weibo-item-actions button:hover{background-color:#f0f0f0}
.weibo-item-actions button.liked{color:#f4d;border-color:#f4d}
.weibo-item-actions button.liked:hover{background-color:#ff1f10}
.weibo-item-actions button.delete-btn{color:#000}
.weibo-item-actions button.delete-btn:hover{background-color:#f0f0f0}
.weibo-discover-section{padding:16px}
.weibo-discover-title{font-weight:600;font-size:18px;margin-bottom:16px}
.weibo-trending-topics{margin-bottom:24px}
.weibo-trending-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.weibo-trending-title{font-weight:600;font-size:16px}
.weibo-refresh-btn{background:none;border:1px solid #000;border-radius:4px;padding:4px 8px;font-size:12px;cursor:pointer}
.weibo-topic-list{display:flex;flex-direction:column;gap:8px}
.weibo-topic-item{padding:12px;border:1px solid #f0f0f0;border-radius:8px;cursor:pointer}
.weibo-topic-name{font-weight:600;font-size:15px;margin-bottom:4px;display:flex;align-items:center;gap:6px}
.weibo-topic-stats{font-size:12px;color:#666;display:flex;justify-content:space-between;align-items:center}
.weibo-rank-number{font-weight:700;width:20px;display:inline-block;text-align:center;margin-right:5px;font-style:italic}
.rank-top-1{color:red}
.rank-top-2{color:#f60}
.rank-top-3{color:#fa0}
.rank-normal{color:#999}
.weibo-tag{display:inline-block;padding:1px 3px;border-radius:3px;font-size:10px;color:#fff;margin-left:5px;font-weight:400}
.tag-hot{background:#f44}
.tag-new{background:#f90}
.tag-boiled{background:#c00}
.weibo-recommended-users{margin-bottom:24px}
.weibo-user-list{display:flex;flex-direction:column;gap:12px}
.weibo-user-item{display:flex;align-items:center;gap:12px;padding:8px;border-radius:8px;cursor:pointer}
.weibo-user-avatar{width:40px;height:40px;border-radius:50%;background-color:#000;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:16px}
.weibo-user-info{flex:1}
.weibo-user-name{font-weight:600;font-size:14px}
.weibo-user-bio{font-size:12px;color:#666;margin-top:2px}
.weibo-follow-btn{background:none;border:1px solid #000;border-radius:16px;padding:4px 12px;font-size:12px;cursor:pointer}
.weibo-random-quote{padding:16px;background-color:#fafafa;border-radius:8px;text-align:center;font-style:italic;margin-top:16px}
.weibo-comment-input{width:100%;border:1px solid #e0e0f0;border-radius:4px;padding:12px;font-family:inherit;font-size:14px;resize:none;outline:none;min-height:80px;margin-bottom:12px}
.weibo-comment-actions{display:flex;justify-content:flex-end;gap:12px}
.weibo-cancel-comment{background:none;border:1px solid #000;border-radius:4px;padding:6px 12px;cursor:pointer}
.weibo-comments-list{margin-top:16px;max-height:200px;overflow-y:auto}
.weibo-comment-item{padding:8px 0;border-bottom:1px solid #f0f0f0}
.weibo-comment-user{font-weight:600;margin-right:8px}
.weibo-comment-text{margin-top:4px}
@media (max-width:600px){.weibo-container{border:none}}
.weibo-comments-container{margin-top:12px;padding:12px;background:#fafafa;border-radius:8px;border:1px solid #e0e0e0;width:280px;max-width:280px;margin-left:-40px;display:block}
.weibo-comments-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.weibo-comments-title{font-size:13px;font-weight:600;color:#333}
.refresh-comments-btn{background:none;border:1px solid #000;border-radius:4px;padding:4px 8px;font-size:11px;cursor:pointer;transition:all .2s}
.refresh-comments-btn:hover{background:#000;color:#fff}
.refresh-comments-btn.loading{opacity:.7;cursor:not-allowed}
.weibo-comments-list-inline{max-height:300px;overflow-y:auto}
.weibo-comment-item-inline{padding:8px;border-bottom:1px solid #eee}
.weibo-comment-item-inline:last-child{border-bottom:none}
.weibo-comment-header-inline{display:flex;align-items:center;margin-bottom:4px}
.weibo-comment-user-inline{font-weight:600;font-size:12px;margin-right:8px}
.weibo-comment-time-inline{font-size:10px;color:#666}
.weibo-comment-text-inline{font-size:11px;line-height:1.4}
.weibo-comment-stance{display:inline-block;margin-left:6px;padding:1px 4px;border-radius:3px;font-size:9px;font-weight:700}
.stance-supportive{background:#e6fffa;color:#00c9a7;border:1px solid #00a68c}
.stance-critical{background:#ffeaea;color:#ff3860;border:1px solid #d11a3f}
.stance-fan{background:#e6f7ff;color:#00bfff;border:1px solid #0099cc}
.stance-anti{background:#f3e5f5;color:#d500f9;border:1px solid #aa00ff}
.profile-card{margin-top:20px;padding:16px;border:1px solid #e0e0e0;border-radius:8px;background:#fafafa;transition:all .3s ease}
.profile-summary{display:flex;justify-content:space-between;align-items:center;cursor:pointer}
.profile-avatar{width:50px;height:50px;border-radius:50%;background:#000;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:20px}
.profile-basic{flex:1;margin-left:12px}
.profile-name{font-weight:600;font-size:16px;margin-bottom:2px}
.profile-bio{font-size:12px;color:#666;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical}
.profile-toggle{background:none;border:none;font-size:16px;cursor:pointer;width:24px;height:24px;display:flex;align-items:center;justify-content:center;color:#666}
.profile-details{max-height:0;overflow:hidden;transition:max-height .3s ease}
.profile-card.expanded .profile-details{max-height:500px;margin-top:16px}
.profile-stats{display:flex;gap:16px;margin-bottom:12px}
.profile-stat{text-align:center;flex:1}
.profile-stat-number{font-weight:600;font-size:16px}
.profile-stat-label{font-size:10px;color:#666;margin-top:2px}
.weibo-modal{z-index:1100}
.weibo-modal-content{z-index:1101;position:relative}
#weibo-interface.interface{padding:20px!important;display:flex!important;flex-direction:column!important}
#weibo-interface .header{padding:0 0 10px 0!important;margin:0!important;flex-shrink:0!important}
#weibo-interface .scrollable-content{flex:1!important;overflow-y:auto!important;margin:0 -20px!important;padding:0 21px!important;width:calc(100% + 40px)!important;box-sizing:border-box!important}
#weibo-interface .weibo-container{width:100%!important;max-width:100%!important;margin:0!important;padding:0!important}
#weibo-interface .weibo-compose-section{padding:16px 0!important;width:100%!important;box-sizing:border-box!important}
#weibo-interface .weibo-compose-box{width:100%!important;max-width:100%!important}
#weibo-interface .weibo-compose-input textarea{width:100%!important;max-width:100%!important;box-sizing:border-box!important;margin:0!important}
#weibo-interface .weibo-list{padding:0!important;width:100%!important}
#weibo-interface .weibo-item{padding:16px 0!important;width:100%!important;box-sizing:border-box!important}
#weibo-interface .weibo-content{width:100%!important;max-width:100%!important;flex:1!important;min-width:0!important}
#weibo-interface .weibo-item-text{width:100%!important;max-width:100%!important;margin:8px 0!important;padding:0!important;word-wrap:break-word!important;word-break:break-word!important;display:block!important}
#weibo-interface .weibo-comment-input{width:100%!important;max-width:100%!important;box-sizing:border-box!important;margin:0!important}
#weibo-interface .weibo-comment-text-inline{width:100%!important;max-width:100%!important;word-wrap:break-word!important}
.profile-edit-btn,#editMyProfileBtn,#weiboSaveBackupBtn,#weiboImportBackupBtn{width:100%!important;padding:8px!important;background:#000!important;color:#fff!important;border:none!important;border-radius:4px!important;font-size:12px!important;cursor:pointer!important;display:block!important;margin-bottom:5px!important}
.weibo-publish-btn{background:#000!important;color:#fff!important;border-radius:6px!important;padding:6px 10px!important;cursor:pointer!important;margin-left: 10px !important;border:none!important}

/* ==================== 外卖/桃源 ==================== */
#food-delivery-interface{color:#000;overflow-x:hidden;max-width:100vw;scrollbar-width:none;-ms-overflow-style:none}
#food-delivery-interface::-webkit-scrollbar{display:none;width:0;background:transparent}
:root{--primary-color:#000;--secondary-color:#000;--light-color:#fff;--border-color:#000;--accent-color:#000;--success-color:#4caf50;--warning-color:#f90;--danger-color:#f44}
#food-delivery-interface .scrollable-content,#food-delivery-interface .categories,#food-delivery-interface .food-grid,#food-delivery-interface .scrollable-content::-webkit-scrollbar,#food-delivery-interface .categories::-webkit-scrollbar,#food-delivery-interface .food-grid::-webkit-scrollbar{overflow-y:auto;scrollbar-width:none;display:none}
#food-delivery-interface .header{text-align:center;margin-bottom:15px;padding-bottom:10px;border-bottom:5px solid #000;position:relative;display:flex;align-items:center;justify-content:center;flex-shrink:0;background-color:#fff;height:auto;padding:0 10px 10px;z-index:1000;margin:0 0 15px}
#food-delivery-interface .header h1{font-size:20px;font-weight:600;margin:0;display:flex;align-items:flex-start;gap:8px;position:relative;left:0;top:0;transform:none;z-index:10}
#food-delivery-interface .cart-btn{position:absolute;right:10px;background:none;border:none;font-size:22px;color:var(--primary-color);cursor:pointer}
#food-delivery-interface .cart-count{position:absolute;top:-5px;right:-5px;background-color:var(--primary-color);color:#fff;font-size:10px;width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center}
#food-delivery-interface .food-page-container{display:none;margin-top:-15px;padding:0 8px 20px 8px;background-color:var(--light-color);min-height:calc(100% - 140px);height:100%;overflow-y:auto;scrollbar-width:none}
#food-delivery-interface .food-page-container::-webkit-scrollbar{display:none}
#food-delivery-interface .food-page-container.active{display:block}
#food-delivery-interface .home-page{background-color:var(--light-color)}
#food-delivery-interface .search-container{padding:10px 8px 5px}
#food-delivery-interface .search-box{display:flex;align-items:center;background-color:var(--light-color);border-radius:24px;padding:10px 12px;border:1px solid var(--border-color)}
#food-delivery-interface .search-icon{color:var(--secondary-color);margin-right:10px}
#food-delivery-interface .search-input{border:none;background:none;flex:1;font-size:14px;outline:none;color:var(--primary-color)}
#food-delivery-interface .categories{display:flex;overflow-x:auto;padding:12px 8px 8px;margin-top:0;background-color:#fff;gap:18px;border-bottom:1px solid var(--border-color);-ms-overflow-style:none}
#food-delivery-interface .category-item{display:flex;flex-direction:column;align-items:center;min-width:58px;cursor:pointer}
#food-delivery-interface .category-icon{width:38px;height:38px;border-radius:50%;background-color:var(--light-color);display:flex;align-items:center;justify-content:center;font-size:18px;color:var(--primary-color);margin-bottom:6px;border:1px solid var(--border-color)}
#food-delivery-interface .category-name{font-size:12px;color:var(--secondary-color);text-align:center;line-height:1.2}
#food-delivery-interface .category-item.active .category-icon{background-color:var(--primary-color);color:#fff;border-color:var(--primary-color)}
#food-delivery-interface .category-item.active .category-name{color:var(--primary-color);font-weight:600}
#food-delivery-interface .recommendations{padding:16px 8px}
#food-delivery-interface .section-title{font-size:18px;font-weight:700;margin-bottom:16px;color:var(--primary-color);position:relative;padding-left:12px}
#food-delivery-interface .section-title::before{content:'';position:absolute;left:0;top:0;bottom:0;width:4px;background-color:var(--primary-color);border-radius:2px}
#food-delivery-interface .food-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;overflow-y:auto;max-height:100%}
#food-delivery-interface .food-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;overflow-y:auto;max-height:100%;scrollbar-width:none;-ms-overflow-style:none}
#food-delivery-interface .food-grid::-webkit-scrollbar{display:none;width:0;background:transparent}
#food-delivery-interface .food-card{background-color:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.05);transition:transform .3s,box-shadow .3s;cursor:pointer;border:1px solid var(--border-color);padding:12px;display:flex;flex-direction:column;position:relative}
#food-delivery-interface .food-card:hover{transform:translateY(-3px);box-shadow:0 4px 12px rgba(0,0,0,.08)}
#food-delivery-interface .favorite-btn{position:absolute;top:10px;right:10px;background:none;border:none;font-size:18px;color:#000;cursor:pointer;z-index:10;transition:color .3s}
#food-delivery-interface .favorite-btn.active{color:#f47}
#food-delivery-interface .food-icon{width:100%;height:75px;background-color:var(--light-color);border-radius:8px;display:flex;align-items:center;justify-content:center;margin-bottom:10px;color:var(--secondary-color);font-size:22px;border:1px dashed var(--border-color)}
#food-delivery-interface .food-info{flex:1}
#food-delivery-interface .food-name{font-size:16px;font-weight:700;margin-bottom:6px;color:var(--primary-color);display:flex;justify-content:space-between;align-items:center}
#food-delivery-interface .food-category{font-size:10px;background-color:var(--light-color);color:var(--secondary-color);padding:2px 6px;border-radius:8px;border:1px solid var(--border-color)}
#food-delivery-interface .food-desc{font-size:13px;color:var(--secondary-color);margin-bottom:10px;line-height:1.4}
#food-delivery-interface .food-features{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:10px}
#food-delivery-interface .food-feature{font-size:10px;color:var(--secondary-color);background-color:var(--light-color);padding:2px 6px;border-radius:8px;border:1px solid var(--border-color)}
#food-delivery-interface .food-footer{display:flex;justify-content:space-between;align-items:center;margin-top:auto}
#food-delivery-interface .food-price{font-size:17px;font-weight:800;color:var(--primary-color)}
#food-delivery-interface .add-to-cart-btn{width:30px;height:30px;border-radius:50%;background-color:var(--primary-color);color:#fff;border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px;transition:background-color .3s}
#food-delivery-interface .add-to-cart-btn:hover{background-color:#222}
#food-delivery-interface .orders-page{padding:16px 8px}
#food-delivery-interface .orders-filter{display:flex;gap:8px;margin-bottom:20px;overflow-x:auto;padding-bottom:8px;white-space:nowrap;scrollbar-width:none;-ms-overflow-style:none}
#food-delivery-interface .orders-filter::-webkit-scrollbar{display:none;width:0;height:0;background:transparent}
#food-delivery-interface .filter-btn{padding:8px 16px;background-color:var(--light-color);border:1px solid var(--border-color);border-radius:20px;color:var(--secondary-color);font-size:13px;cursor:pointer;white-space:nowrap;flex-shrink:0;height:36px;display:flex;align-items:center;justify-content:center;min-width:80px}
#food-delivery-interface .filter-btn.active{background-color:var(--primary-color);color:#fff;border-color:var(--primary-color)}
#food-delivery-interface .empty-orders{text-align:center;padding:60px 20px;color:#999}
#food-delivery-interface .empty-orders i{font-size:48px;margin-bottom:16px;color:#ddd}
#food-delivery-interface .empty-orders p{font-size:16px;margin-top:10px}
#food-delivery-interface .orders-list{height:auto;overflow-y:visible;padding-right:0;padding-bottom:20px}
#food-delivery-interface .order-card{background-color:#fff;border-radius:12px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,.05);border:1px solid var(--border-color);overflow:hidden;transition:transform .3s,box-shadow .3s}
#food-delivery-interface .order-card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.08)}
#food-delivery-interface .order-header{padding:14px;display:flex;justify-content:space-between;align-items:center}
#food-delivery-interface .order-status{padding:6px 12px;border-radius:20px;font-size:12px;font-weight:600;white-space:nowrap;display:inline-flex;align-items:center;justify-content:center;min-width:70px;height:24px}
#food-delivery-interface .status-delivering{background-color:rgba(76,175,80,.1);color:var(--success-color)}
#food-delivery-interface .status-delivered{background-color:rgba(33,150,243,.1);color:#2196f3}
#food-delivery-interface .status-canceled{background-color:rgba(244,67,54,.1);color:var(--danger-color)}
#food-delivery-interface .status-overtime{background-color:rgba(255,152,0,.1);color:var(--warning-color)}
#food-delivery-interface .order-time{font-size:12px;color:var(--secondary-color);white-space:nowrap}
#food-delivery-interface .order-content{padding:0 14px 14px}
#food-delivery-interface .order-restaurant{font-weight:700;margin-bottom:8px;color:var(--primary-color);display:flex;align-items:center;padding-top:14px}
#food-delivery-interface .order-restaurant i{margin-right:8px;color:var(--secondary-color)}
#food-delivery-interface .order-items{margin-bottom:12px}
#food-delivery-interface .order-item{display:flex;justify-content:space-between;margin-bottom:6px;align-items:center}
#food-delivery-interface .order-item-name{flex:1;color:var(--secondary-color);font-size:14px;overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .order-item-quantity{color:var(--secondary-color);font-size:14px;margin:0 10px;white-space:nowrap}
#food-delivery-interface .order-item-price{color:var(--primary-color);font-weight:600;font-size:14px;min-width:60px;text-align:right;white-space:nowrap}
#food-delivery-interface .order-divider{display:none}
#food-delivery-interface .order-total{display:flex;justify-content:space-between;font-weight:700;color:var(--primary-color);font-size:16px;padding-top:12px;margin-top:12px;border-top:1px dashed var(--border-color)}
#food-delivery-interface .order-footer{padding:14px;display:flex;justify-content:flex-end;align-items:center;gap:10px}
#food-delivery-interface .order-actions{display:flex;gap:8px}
#food-delivery-interface .order-btn{padding:8px 16px;border-radius:20px;font-size:12px;cursor:pointer;border:1px solid var(--border-color);background-color:#fff;color:var(--primary-color);transition:all .3s;white-space:nowrap;height:32px;display:flex;align-items:center;justify-content:center;min-width:70px}
#food-delivery-interface .order-btn.primary{background-color:var(--primary-color);color:#fff;border-color:var(--primary-color)}
#food-delivery-interface .order-btn.primary:hover{background-color:#222}
#food-delivery-interface .order-btn.danger{background-color:#fff;color:var(--danger-color);border-color:var(--danger-color)}
#food-delivery-interface .order-btn.danger:hover{background-color:rgba(244,67,54,.1)}
#food-delivery-interface .order-btn:hover{background-color:var(--light-color)}
#food-delivery-interface .order-detail-modal{position:absolute;top:0;left:0;right:0;bottom:0;background-color:#fff;z-index:2000;transform:translateY(100%);transition:transform .4s ease;display:flex;flex-direction:column;overflow-y:auto;scrollbar-width:none}
#food-delivery-interface .order-detail-modal::-webkit-scrollbar{display:none}
#food-delivery-interface .order-detail-modal.active{transform:translateY(0)}
#food-delivery-interface .detail-header{position:sticky;top:0;background-color:#fff;z-index:10;padding:20px 16px 16px;border-bottom:1px solid var(--border-color);display:flex;align-items:center;justify-content:space-between}
#food-delivery-interface .detail-title{font-size:18px;font-weight:700;color:var(--primary-color);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .detail-close{background:none;border:none;font-size:20px;color:var(--secondary-color);cursor:pointer;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center}
#food-delivery-interface .detail-close:hover{background-color:var(--light-color)}
#food-delivery-interface .detail-content{flex:1;padding:16px;scrollbar-width:none}
#food-delivery-interface .detail-content::-webkit-scrollbar{display:none}
#food-delivery-interface .detail-section{padding:20px 0;border-bottom:1px solid var(--border-color)}
#food-delivery-interface .detail-section:last-child{border-bottom:none}
#food-delivery-interface .detail-section-title{font-size:16px;font-weight:700;margin-bottom:16px;color:var(--primary-color);display:flex;align-items:center}
#food-delivery-interface .detail-section-title i{margin-right:8px;color:var(--secondary-color)}
#food-delivery-interface .delivery-time-info{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
#food-delivery-interface .delivery-time-label{font-size:14px;color:var(--secondary-color)}
#food-delivery-interface .delivery-time-value{font-size:16px;font-weight:700;color:var(--primary-color);white-space:nowrap}
#food-delivery-interface .delivery-time-value.overtime{color:var(--danger-color)}
#food-delivery-interface .time-countdown{font-size:14px;color:var(--secondary-color);text-align:right}
#food-delivery-interface .countdown-timer{font-size:20px;font-weight:800;color:var(--primary-color);margin-top:4px}
#food-delivery-interface .countdown-timer.overtime{color:var(--danger-color)}
#food-delivery-interface .delivery-progress{margin-bottom:20px}
#food-delivery-interface .progress-steps{display:flex;justify-content:space-between;margin-bottom:8px}
#food-delivery-interface .progress-step{display:flex;flex-direction:column;align-items:center;flex:1;position:relative}
#food-delivery-interface .step-icon{width:28px;height:28px;border-radius:50%;background-color:var(--light-color);border:2px solid var(--border-color);display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--secondary-color);margin-bottom:4px;z-index:1}
#food-delivery-interface .step-icon.active{background-color:var(--primary-color);border-color:var(--primary-color);color:#fff}
#food-delivery-interface .step-icon.delayed{background-color:var(--light-color);border-color:var(--border-color);color:var(--secondary-color)}
#food-delivery-interface .step-label{font-size:11px;color:var(--secondary-color);text-align:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:100%}
#food-delivery-interface .step-label.active{color:var(--primary-color);font-weight:600}
#food-delivery-interface .step-label.delayed{color:var(--secondary-color)}
#food-delivery-interface .progress-bar{position:absolute;top:14px;left:0;right:0;height:2px;background-color:var(--border-color);z-index:0}
#food-delivery-interface .progress-fill{position:absolute;top:14px;left:0;height:2px;background-color:var(--primary-color);z-index:0;transition:width .5s ease}
#food-delivery-interface .progress-fill.delayed{background-color:var(--secondary-color)}
#food-delivery-interface .delivery-status-info{display:none}
#food-delivery-interface .rider-info{margin-top:12px;padding:12px;background-color:var(--light-color);border-radius:8px}
#food-delivery-interface .rider-name{font-weight:600;margin-bottom:6px;color:var(--primary-color)}
#food-delivery-interface .rider-rating{display:flex;align-items:center;font-size:14px}
#food-delivery-interface .star-rating{margin-right:8px}
#food-delivery-interface .detail-address{margin-top:16px}
#food-delivery-interface .address-label{font-size:12px;color:var(--secondary-color);margin-bottom:4px}
#food-delivery-interface .address-value{font-size:14px;color:var(--primary-color);word-break:break-word}
#food-delivery-interface .detail-items-list{margin-bottom:16px}
#food-delivery-interface .detail-item{display:flex;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid var(--border-color)}
#food-delivery-interface .detail-item:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
#food-delivery-interface .detail-item-img{width:60px;height:60px;border-radius:8px;background-color:var(--light-color);display:flex;align-items:center;justify-content:center;margin-right:12px;color:var(--secondary-color);font-size:20px;border:1px solid var(--border-color);flex-shrink:0}
#food-delivery-interface .detail-item-info{flex:1;min-width:0}
#food-delivery-interface .detail-item-name{font-weight:600;margin-bottom:4px;color:var(--primary-color);overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .detail-item-desc{font-size:12px;color:var(--secondary-color);margin-bottom:6px;word-break:break-word}
#food-delivery-interface .detail-item-price{font-weight:600;color:var(--primary-color);white-space:nowrap}
#food-delivery-interface .detail-remark{margin-top:16px}
#food-delivery-interface .remark-label{font-size:12px;color:var(--secondary-color);margin-bottom:4px}
#food-delivery-interface .remark-value{font-size:14px;color:var(--primary-color);word-break:break-word}
#food-delivery-interface .detail-utensils{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
#food-delivery-interface .utensil-option{display:flex;align-items:center;padding:8px 12px;border:1px solid var(--border-color);border-radius:20px;background-color:#fff;cursor:pointer;transition:all .3s;white-space:nowrap}
#food-delivery-interface .utensil-option.active{background-color:var(--primary-color);color:#fff;border-color:var(--primary-color)}
#food-delivery-interface .utensil-option i{margin-right:6px}
#food-delivery-interface .cart-detail-modal{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) scale(.9);width:92%;max-width:480px;background-color:#fff;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.15);z-index:2000;opacity:0;visibility:hidden;transition:all .4s ease;overflow:hidden;border:1px solid var(--border-color)}
#food-delivery-interface .cart-detail-modal.active{opacity:1;visibility:visible;transform:translate(-50%,-50%) scale(1)}
#food-delivery-interface .cart-detail-header{padding:20px 20px 16px;border-bottom:1px solid var(--border-color);display:flex;align-items:center;justify-content:space-between}
#food-delivery-interface .cart-detail-title{font-size:18px;font-weight:700;color:var(--primary-color);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .cart-detail-close{background:none;border:none;font-size:20px;color:var(--secondary-color);cursor:pointer;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center}
#food-delivery-interface .cart-detail-close:hover{background-color:var(--light-color)}
#food-delivery-interface .cart-detail-content{padding:20px;max-height:60vh;overflow-y:auto;scrollbar-width:none}
#food-delivery-interface .cart-detail-content::-webkit-scrollbar{display:none}
#food-delivery-interface .quantity-control{display:flex;align-items:center;justify-content:center;margin:16px 0}
#food-delivery-interface .quantity-btn{width:36px;height:36px;border-radius:50%;background-color:var(--light-color);border:1px solid var(--border-color);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;color:var(--primary-color);flex-shrink:0}
#food-delivery-interface .quantity-value{margin:0 16px;font-size:18px;font-weight:600;min-width:30px;text-align:center;color:var(--primary-color);white-space:nowrap}
#food-delivery-interface .cart-detail-remark{margin-top:20px}
#food-delivery-interface .remark-input{width:100%;padding:12px;border:1px solid var(--border-color);border-radius:8px;font-size:14px;outline:none;resize:vertical;min-height:80px;margin-top:8px;color:var(--primary-color);background-color:#fff;box-sizing:border-box}
#food-delivery-interface .cart-detail-utensils{margin-top:20px}
#food-delivery-interface .cart-detail-actions{padding:20px;border-top:1px solid var(--border-color);display:flex;gap:12px}
#food-delivery-interface .cart-detail-btn{flex:1;padding:14px 20px;border-radius:50px;border:1px solid var(--border-color);font-size:16px;font-weight:600;cursor:pointer;transition:all .3s;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .cart-detail-btn.primary{background-color:var(--primary-color);color:#fff;border-color:var(--primary-color)}
#food-delivery-interface .cart-detail-btn.primary:hover{background-color:#222}
#food-delivery-interface .cart-detail-btn.secondary{background-color:#fff;color:var(--primary-color)}
#food-delivery-interface .cart-detail-btn.secondary:hover{background-color:var(--light-color)}
#food-delivery-interface .cart-panel{position:absolute;top:0;right:0;bottom:0;width:88%;max-width:360px;background-color:#fff;z-index:1500;transform:translateX(100%);transition:transform .4s ease;display:flex;flex-direction:column;box-shadow:-5px 0 20px rgba(0,0,0,.1);border-left:1px solid var(--border-color)}
#food-delivery-interface .cart-panel.active{transform:translateX(0)}
#food-delivery-interface .cart-header{display:flex;justify-content:space-between;align-items:center;padding:20px;border-bottom:1px solid var(--border-color)}
#food-delivery-interface .cart-title{font-size:18px;font-weight:700;color:var(--primary-color);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .cart-close{background:none;border:none;font-size:20px;color:var(--secondary-color);cursor:pointer}
#food-delivery-interface .cart-address-info{padding:16px 20px;background-color:var(--light-color);border-bottom:1px solid var(--border-color);cursor:pointer;transition:background-color .3s}
#food-delivery-interface .cart-address-info:hover{background-color:rgba(0,0,0,.05)}
#food-delivery-interface .cart-address-info.empty{color:#999}
#food-delivery-interface .address-info-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
#food-delivery-interface .address-info-title{font-size:14px;font-weight:600;color:var(--primary-color);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .address-info-change{font-size:12px;color:var(--secondary-color);background:none;border:none;cursor:pointer;white-space:nowrap}
#food-delivery-interface .address-info-content{font-size:13px;color:var(--secondary-color);word-break:break-word}
#food-delivery-interface .cart-items{flex:1;overflow-y:auto;padding:20px;scrollbar-width:none}
#food-delivery-interface .cart-items::-webkit-scrollbar{display:none}
#food-delivery-interface .cart-item{display:flex;align-items:center;padding:15px 0;border-bottom:1px solid var(--border-color)}
#food-delivery-interface .cart-item-icon{width:60px;height:60px;border-radius:8px;background-color:var(--light-color);display:flex;align-items:center;justify-content:center;margin-right:15px;color:var(--secondary-color);font-size:20px;border:1px solid var(--border-color);flex-shrink:0}
#food-delivery-interface .cart-item-info{flex:1;min-width:0}
#food-delivery-interface .cart-item-name{font-weight:600;margin-bottom:5px;color:var(--primary-color);overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .cart-item-price{color:var(--primary-color);font-weight:700;font-size:16px;white-space:nowrap}
#food-delivery-interface .cart-item-controls{display:flex;align-items:center;justify-content:space-between;margin-top:10px}
#food-delivery-interface .cart-item-quantity{display:flex;align-items:center;gap:10px;flex-shrink:0}
#food-delivery-interface .cart-item-quantity-value{font-weight:600;min-width:24px;text-align:center;color:var(--primary-color);white-space:nowrap}
#food-delivery-interface .quantity-btn-small{width:24px;height:24px;border-radius:50%;background-color:var(--light-color);border:1px solid var(--border-color);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px;color:var(--primary-color);flex-shrink:0}
#food-delivery-interface .cart-item-detail-btn{background:none;border:1px solid var(--border-color);color:var(--secondary-color);font-size:12px;padding:4px 10px;border-radius:12px;cursor:pointer;transition:all .3s;white-space:nowrap;flex-shrink:0}
#food-delivery-interface .cart-item-detail-btn:hover{background-color:var(--light-color);color:var(--primary-color)}
#food-delivery-interface .cart-footer{padding:20px;border-top:1px solid var(--border-color);background-color:#fff}
#food-delivery-interface .cart-total{display:flex;justify-content:space-between;margin-bottom:20px;font-size:18px;font-weight:700;color:var(--primary-color)}
#food-delivery-interface .cart-checkout{width:100%;padding:16px;background-color:var(--primary-color);color:#fff;border:none;border-radius:50px;font-size:16px;font-weight:600;cursor:pointer;transition:background-color .3s;border:1px solid var(--primary-color)}
#food-delivery-interface .cart-checkout:hover{background-color:#222}
#food-delivery-interface .recommendation-modal{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) scale(.9)!important;width:92%;max-width:400px;background-color:#fff;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.15);z-index:2000;opacity:0;visibility:hidden;transition:all .4s ease;overflow:hidden;border:none!important}
#food-delivery-interface .recommendation-modal.active{opacity:1;visibility:visible;transform:translate(-50%,-50%) scale(1)!important}
#food-delivery-interface .recommendation-modal .modal-content,#food-delivery-interface .product-detail-box{border:none!important;transform:none!important;background:transparent!important}
#food-delivery-interface .recommendation-modal .modal-content{padding-left:40px;padding-right:15px;text-align:center}
#food-delivery-interface .modal-title{font-size:26px!important;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .modal-subtitle{font-size:16px!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .modal-desc{font-size:16px!important;line-height:1.6;word-break:break-word}
#food-delivery-interface .modal-price{font-size:32px!important;font-weight:900;white-space:nowrap}
#food-delivery-interface .modal-feature{font-size:14px!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .modal-btn{font-size:12px!important;border-radius:15px!important;padding:10px 20px!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .modal-header{padding:24px 24px 16px;border-bottom:none;text-align:center;background-color:var(--light-color)}
#food-delivery-interface .modal-icon{width:60px;height:60px;border-radius:50%;background-color:#fff;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;font-size:28px;color:var(--primary-color);border:none}
#food-delivery-interface .modal-close{position:absolute;top:16px;right:16px;width:32px;height:32px;border-radius:50%;background-color:#fff;border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;color:var(--primary-color)}
#food-delivery-interface .modal-content{padding:20px}
#food-delivery-interface .modal-actions{display:flex;gap:12px}
#food-delivery-interface .modal-btn{flex:1;padding:14px 20px;border-radius:50px;border:1px solid var(--border-color);font-size:16px;font-weight:600;cursor:pointer;transition:all .3s;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .modal-btn.primary{background-color:var(--primary-color);color:#fff;border-color:var(--primary-color)}
#food-delivery-interface .modal-btn.primary:hover{background-color:#222}
#food-delivery-interface .modal-btn.secondary{background-color:#fff;color:var(--primary-color)}
#food-delivery-interface .modal-btn.secondary:hover{background-color:var(--light-color)}
#food-delivery-interface .bottom-nav{position:absolute;bottom:0;left:0;right:0;height:70px;background-color:#fff;display:flex;justify-content:space-around;align-items:center;box-shadow:0 -2px 10px rgba(0,0,0,.05);z-index:1000;border-top:1px solid var(--border-color)}
#food-delivery-interface .nav-item{display:flex;flex-direction:column;align-items:center;justify-content:center;text-decoration:none;color:var(--secondary-color);font-size:12px;flex:1;height:100%;transition:color .3s;cursor:pointer}
#food-delivery-interface .nav-item i{font-size:20px;margin-bottom:4px}
#food-delivery-interface .nav-item.active{color:var(--primary-color)}
#food-delivery-interface .address-panel{position:absolute;top:0;left:0;right:0;bottom:0;background-color:#fff;z-index:1500;transform:translateY(100%);transition:transform .4s ease;display:flex;flex-direction:column;border-top:1px solid var(--border-color)}
#food-delivery-interface .address-panel.active{transform:translateY(0)}
#food-delivery-interface .address-header{padding:20px 16px 16px;border-bottom:1px solid var(--border-color);display:flex;align-items:center;justify-content:space-between;background-color:#fff}
#food-delivery-interface .address-title{font-size:18px;font-weight:700;color:var(--primary-color);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .address-close{background:none;border:none;font-size:20px;color:var(--secondary-color);cursor:pointer;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center}
#food-delivery-interface .address-close:hover{background-color:var(--light-color)}
#food-delivery-interface .address-content{flex:1;overflow-y:auto;padding:16px;background-color:var(--light-color);scrollbar-width:none}
#food-delivery-interface .address-content::-webkit-scrollbar{display:none}
#food-delivery-interface .address-input-group{background-color:#fff;border-radius:12px;padding:16px;margin-bottom:16px;border:1px solid var(--border-color)}
#food-delivery-interface .address-input-title{font-size:16px;font-weight:600;margin-bottom:12px;color:var(--primary-color)}
#food-delivery-interface .address-input{width:100%;padding:14px;border:1px solid var(--border-color);border-radius:8px;font-size:15px;outline:none;margin-bottom:16px;color:var(--primary-color);background-color:#fff;transition:border-color .3s;box-sizing:border-box}
#food-delivery-interface .address-input:focus{border-color:var(--primary-color)}
#food-delivery-interface .address-tags{display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap}
#food-delivery-interface .address-tag{padding:8px 16px;background-color:var(--light-color);border:1px solid var(--border-color);border-radius:20px;font-size:14px;color:var(--secondary-color);cursor:pointer;transition:all .3s;white-space:nowrap}
#food-delivery-interface .address-tag.active{background-color:var(--primary-color);color:#fff;border-color:var(--primary-color)}
#food-delivery-interface .save-address-btn{width:100%;padding:14px;background-color:var(--primary-color);color:#fff;border:none;border-radius:50px;font-size:16px;font-weight:600;cursor:pointer;transition:background-color .3s}
#food-delivery-interface .save-address-btn:hover{background-color:#222}
#food-delivery-interface .saved-addresses-section{background-color:#fff;border-radius:12px;padding:16px;border:1px solid var(--border-color)}
#food-delivery-interface .saved-addresses-title{font-size:16px;font-weight:600;margin-bottom:16px;color:var(--primary-color)}
#food-delivery-interface .address-list{display:flex;flex-direction:column;gap:12px}
#food-delivery-interface .address-item{padding:16px;background-color:#fff;border-radius:8px;border:1px solid var(--border-color);cursor:pointer;transition:all .3s;position:relative}
#food-delivery-interface .address-item:hover{border-color:var(--primary-color);transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.05)}
#food-delivery-interface .address-item.active{border-color:var(--primary-color);background-color:rgba(51,51,51,.03)}
#food-delivery-interface .address-item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
#food-delivery-interface .address-item-name{font-weight:600;font-size:14px;color:var(--primary-color);display:flex;align-items:center;gap:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .address-tag-small{font-size:10px;background-color:var(--light-color);color:var(--secondary-color);padding:2px 8px;border-radius:10px;border:1px solid var(--border-color);white-space:nowrap}
#food-delivery-interface .address-item-actions{display:flex;gap:8px;flex-shrink:0}
#food-delivery-interface .address-item-action-btn{background:none;border:none;color:var(--secondary-color);font-size:14px;cursor:pointer;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center}
#food-delivery-interface .address-item-action-btn:hover{background-color:var(--light-color);color:var(--primary-color)}
#food-delivery-interface .address-item-content{font-size:14px;color:var(--secondary-color);line-height:1.5;word-break:break-word}
#food-delivery-interface .no-addresses{text-align:center;padding:40px 20px;color:#999}
#food-delivery-interface .no-addresses i{font-size:48px;margin-bottom:16px;color:#ddd}
#food-delivery-interface .no-addresses p{font-size:14px}
#food-delivery-interface .profile-page{padding:20px 8px}
#food-delivery-interface .profile-header{background-color:#fff;border-radius:12px;padding:20px;margin-bottom:20px;border:1px solid var(--border-color)}
#food-delivery-interface .profile-info{display:flex;flex-direction:column;gap:16px}
#food-delivery-interface .profile-field{display:flex;flex-direction:column;gap:6px}
#food-delivery-interface .profile-field label{font-size:14px;color:var(--secondary-color)}
#food-delivery-interface .name-display{display:flex;align-items:center;justify-content:space-between;padding:6px 0;cursor:pointer;transition:background-color .3s;border-radius:4px;padding-left:8px}
#food-delivery-interface .name-display:hover{background-color:var(--light-color)}
#food-delivery-interface .name-display.editing{background-color:var(--light-color);border-bottom:1px solid var(--primary-color)}
#food-delivery-interface .name-text{font-size:16px;color:var(--primary-color);font-weight:500;overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .name-edit-btn{background:none;border:none;color:var(--secondary-color);font-size:14px;cursor:pointer;padding:4px 8px;border-radius:4px;transition:all .3s;display:none;white-space:nowrap}
#food-delivery-interface .name-display:hover .name-edit-btn{display:block}
#food-delivery-interface .name-display.editing .name-edit-btn{display:block;color:var(--primary-color);background-color:#fff;border:1px solid var(--border-color)}
#food-delivery-interface .name-edit-input{display:none;padding:12px;border:1px solid var(--border-color);border-radius:8px;font-size:16px;outline:none;color:var(--primary-color);background-color:#fff;margin-bottom:12px;width:100%;box-sizing:border-box}
#food-delivery-interface .name-edit-input.active{display:block}
#food-delivery-interface .profile-edit-btn{padding:10px 20px;background-color:var(--primary-color);color:#fff;border:none;border-radius:8px;font-size:14px;cursor:pointer;transition:background-color .3s;align-self:flex-start;display:none}
#food-delivery-interface .profile-edit-btn.active{display:block}
#food-delivery-interface .profile-menu{background-color:#fff;border-radius:12px;overflow:hidden;border:1px solid var(--border-color)}
#food-delivery-interface .menu-item{display:flex;align-items:center;padding:16px;border-bottom:1px solid var(--border-color);text-decoration:none;color:var(--primary-color);transition:background-color .3s;cursor:pointer}
#food-delivery-interface .menu-item:last-child{border-bottom:none}
#food-delivery-interface .menu-item:hover{background-color:var(--light-color)}
#food-delivery-interface .menu-item i{font-size:20px;margin-right:12px;color:var(--secondary-color);width:24px;text-align:center}
#food-delivery-interface .menu-item span{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .menu-item .arrow{font-size:14px;color:var(--secondary-color)}
#food-delivery-interface .favorites-page{padding:20px 8px}
#food-delivery-interface .favorites-list{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;scrollbar-width:none}
#food-delivery-interface .favorites-list::-webkit-scrollbar{display:none}
#food-delivery-interface .favorites-empty{text-align:center;padding:60px 20px;color:#999;grid-column:1/-1}
#food-delivery-interface .favorites-empty i{font-size:48px;margin-bottom:16px;color:#ddd}
#food-delivery-interface .favorites-empty p{font-size:16px;margin-top:10px}
#food-delivery-interface .evaluations-page{padding:20px 8px}
#food-delivery-interface .evaluations-list{max-height:100%;overflow-y:auto;padding-right:5px;scrollbar-width:none}
#food-delivery-interface .evaluations-list::-webkit-scrollbar{display:none}
#food-delivery-interface .evaluation-card{background-color:#fff;border-radius:12px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,.05);border:1px solid var(--border-color);overflow:hidden;transition:transform .3s,box-shadow .3s}
#food-delivery-interface .evaluation-card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.08)}
#food-delivery-interface .evaluation-header{padding:16px;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center}
#food-delivery-interface .evaluation-restaurant{font-weight:700;color:var(--primary-color);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .evaluation-time{font-size:12px;color:var(--secondary-color);white-space:nowrap}
#food-delivery-interface .evaluation-content{padding:16px}
#food-delivery-interface .rating-section{margin-bottom:16px}
#food-delivery-interface .rating-title{font-size:14px;color:var(--secondary-color);margin-bottom:8px}
#food-delivery-interface .star-rating-input{display:flex;gap:5px}
#food-delivery-interface .star-input{font-size:24px;color:#ddd;cursor:pointer;transition:color .2s;flex-shrink:0}
#food-delivery-interface .star-input.active{color:#fc0}
#food-delivery-interface .comment-section{margin-bottom:16px}
#food-delivery-interface .comment-input{width:100%;padding:12px;border:1px solid var(--border-color);border-radius:8px;font-size:14px;outline:none;resize:vertical;min-height:80px;margin-top:8px;color:var(--primary-color);background-color:#fff;box-sizing:border-box}
#food-delivery-interface .evaluation-actions{display:flex;justify-content:flex-end;gap:10px}
#food-delivery-interface .evaluation-btn{padding:6px 10px;border-radius:16px;font-size:12px;cursor:pointer;border:1px solid var(--border-color);background-color:#fff;color:var(--primary-color);transition:all .3s;white-space:nowrap}
#food-delivery-interface .evaluation-btn.primary{background-color:var(--primary-color);color:#fff;border-color:var(--primary-color)}
#food-delivery-interface .evaluation-btn.primary:hover{background-color:#222}
#food-delivery-interface .evaluation-btn:hover{background-color:var(--light-color)}
#food-delivery-interface .submitted-evaluation{padding:16px;border-top:1px solid var(--border-color);background-color:var(--light-color);position:relative}
#food-delivery-interface .submitted-evaluation-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
#food-delivery-interface .submitted-evaluation-title{font-size:16px;font-weight:700;color:var(--primary-color);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .submitted-evaluation-time{font-size:12px;color:var(--secondary-color);white-space:nowrap}
#food-delivery-interface .submitted-rating{display:flex;align-items:center;margin-bottom:8px}
#food-delivery-interface .submitted-comment{font-size:14px;color:var(--primary-color);line-height:1.5;margin-bottom:12px;padding:10px;background-color:#fff;border-radius:8px;border:1px solid var(--border-color);word-break:break-word}
#food-delivery-interface .overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:1400;opacity:0;visibility:hidden;transition:opacity .4s,visibility .4s}
#food-delivery-interface .overlay.active{opacity:1;visibility:visible}
@media (max-width:768px){#food-delivery-interface .food-grid,#food-delivery-interface .favorites-list{grid-template-columns:1fr}#food-delivery-interface .recommendation-modal,#food-delivery-interface .cart-detail-modal{width:96%}}
@media (min-width:992px){#food-delivery-interface .food-grid,#food-delivery-interface .favorites-list{grid-template-columns:repeat(3,1fr)}}
#food-delivery-interface .text-primary{color:var(--primary-color)}
#food-delivery-interface .text-secondary{color:var(--secondary-color)}
#food-delivery-interface .bg-light{background-color:var(--light-color)}
#food-delivery-interface .border-light{border-color:var(--border-color)}
#food-delivery-interface .countdown-container{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;padding:12px;background-color:var(--light-color);border-radius:8px;border:1px solid var(--border-color)}
#food-delivery-interface .countdown-label{font-size:14px;color:var(--secondary-color)}
#food-delivery-interface .countdown-time{font-size:20px;font-weight:800;color:var(--primary-color)}
#food-delivery-interface .countdown-time.overtime{color:var(--danger-color)}
#food-delivery-interface .countdown-status{font-size:12px;padding:4px 8px;border-radius:10px;background-color:var(--light-color);color:var(--secondary-color);white-space:nowrap}
#food-delivery-interface .countdown-status.on-time{background-color:rgba(76,175,80,.1);color:var(--success-color)}
#food-delivery-interface .countdown-status.delayed{background-color:rgba(255,152,0,.1);color:var(--warning-color)}
#food-delivery-interface .countdown-status.overtime{background-color:rgba(244,67,54,.1);color:var(--danger-color)}
#food-delivery-interface .add-food-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:2500;display:none;justify-content:center;align-items:center}
#food-delivery-interface .add-food-modal-content{background-color:#fff;border-radius:12px;width:94%;max-width:500px;max-height:80vh;overflow-y:auto;border:2px solid var(--border-color)}
#food-delivery-interface .add-food-modal-header{padding:20px;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center}
#food-delivery-interface .add-food-modal-header h2{font-size:18px;margin:0;color:var(--primary-color)}
#food-delivery-interface .add-food-modal-close{background:none;border:none;font-size:20px;color:var(--secondary-color);cursor:pointer}
#food-delivery-interface .add-food-modal-body{padding:20px}
#food-delivery-interface .add-food-modal-body .form-group{margin-bottom:15px}
#food-delivery-interface .add-food-modal-body label{display:block;margin-bottom:5px;font-size:14px;color:var(--secondary-color);font-weight:600}
#food-delivery-interface .add-food-modal-body input,#food-delivery-interface .add-food-modal-body textarea,#food-delivery-interface .add-food-modal-body select{width:100%;padding:10px;border:1px solid var(--border-color);border-radius:6px;font-size:14px;color:var(--primary-color);background-color:#fff;box-sizing:border-box}
#food-delivery-interface .add-food-modal-body textarea{resize:vertical;min-height:80px}
#food-delivery-interface .add-food-modal-body input:focus,#food-delivery-interface .add-food-modal-body textarea:focus,#food-delivery-interface .add-food-modal-body select:focus{border-color:var(--primary-color);outline:none}
#food-delivery-interface .add-food-modal-actions{padding:20px;border-top:1px solid var(--border-color);display:flex;gap:10px}
#food-delivery-interface .add-food-modal-btn{flex:1;padding:12px;border-radius:6px;border:1px solid var(--border-color);font-size:14px;cursor:pointer;transition:all .3s;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#food-delivery-interface .add-food-modal-btn.primary{background-color:var(--primary-color);color:#fff;border-color:var(--primary-color)}
#food-delivery-interface .add-food-modal-btn.primary:hover{background-color:#222}
#food-delivery-interface .add-food-modal-btn.secondary{background-color:#fff;color:var(--primary-color)}
#food-delivery-interface .add-food-modal-btn.secondary:hover{background-color:var(--light-color)}
#food-delivery-interface .delete-food-btn{background:transparent;border:none;color:#000;cursor:pointer;font-size:18px;padding:0;margin:0}
#food-delivery-interface .delete-food-btn:hover{color:#000}
.food-order-section{margin-top:15px;padding:15px;border:1px solid #000;border-radius:8px;background:#fafafa}
.food-order-section h3{font-size:16px;font-weight:600;margin-bottom:10px}
.order-list{max-height:150px;overflow-y:auto;margin-bottom:10px;border:1px solid #ddd;padding:10px;background:#fff;scrollbar-width:none}
.order-list::-webkit-scrollbar{display:none}
.order-item{padding:8px;border-bottom:1px solid #eee;display:flex;align-items:center}
.order-item:last-child{border-bottom:none}
.order-item input{margin-right:10px}
.order-info{flex:1;font-size:12px;overflow:hidden}
.order-details{font-size:11px;color:#666;margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.order-actions{display:flex;gap:10px}
.order-actions button{flex:1;padding:8px 12px;border:1px solid #000;background:#fff;border-radius:5px;cursor:pointer;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.order-actions button:hover{background:#f0f0f0}
#fab-container{position:absolute;right:25px;bottom:40px;z-index:1100;width:56px;height:56px}#fab-main-btn{width:100%;height:100%;background:#000;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:32px;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.2);position:relative;z-index:2}#fab-main-btn span{transition:transform .3s ease;display:inline-block}.fab-menu{position:absolute;width:100%;height:100%;top:0;left:0;pointer-events:none;transition:all .3s ease}.fab-menu-item{position:absolute;top:0;left:0;width:48px;height:48px;background:#000;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.15);transition:all .3s cubic-bezier(0.68, -0.55, 0.27, 1.55);transform:scale(0);opacity:0;pointer-events:none}#fab-container.active .fab-menu{pointer-events:auto}#fab-container.active .fab-menu-item{transform:scale(1);opacity:1;pointer-events:auto}#fab-container.active .fab-menu-item:nth-child(1){transform:translateX(-75px)}#fab-container.active .fab-menu-item:nth-child(2){transform:translateX(-53px) translateY(-53px)}#fab-container.active .fab-menu-item:nth-child(3){transform:translateY(-75px)}.fab-menu-item[data-page="home"]{transition-delay:.2s}.fab-menu-item[data-page="orders"]{transition-delay:.1s}.fab-menu-item[data-page="profile"]{transition-delay:0s}

/* ==================== 谧笺书城 ==================== */
.bookstore-container{width:100%;height:100%;background:
body,html,div,section,.scrollable-content,.interface,.chat-messages,.playlist,.food-grid,.orders-filter,.favorites-list,.evaluations-list,.profile-menu,.nav-tabs{scrollbar-width:none;-ms-overflow-style:none}
body::-webkit-scrollbar,html::-webkit-scrollbar,div::-webkit-scrollbar,section::-webkit-scrollbar,.scrollable-content::-webkit-scrollbar,.interface::-webkit-scrollbar,.chat-messages::-webkit-scrollbar,.playlist::-webkit-scrollbar,.food-grid::-webkit-scrollbar,.orders-filter::-webkit-scrollbar,.favorites-list::-webkit-scrollbar,.evaluations-list::-webkit-scrollbar,.profile-menu::-webkit-scrollbar,.nav-tabs::-webkit-scrollbar{display:none;width:0;height:0;background:transparent}#fff;position:relative;overflow-x:hidden}.bookstore-content{width:100%;height:100%;display:flex;flex-direction:column}.sidebar-nav{position:absolute;top:50%;left:-60px;transform:translateY(-50%);z-index:100;transition:left .3s ease;display:flex;flex-direction:column;gap:12px}.sidebar-bubble{width:48px;height:48px;border-radius:50%;background:#fff;border:2px solid #000;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all .3s ease;box-shadow:0 4px 8px rgba(0,0,0,0.1);position:relative}.sidebar-bubble:hover{transform:scale(1.05);box-shadow:0 6px 12px rgba(0,0,0,0.15)}.sidebar-bubble.active{background:#000;border-color:#000}.sidebar-bubble.active .bubble-icon{color:#fff}.sidebar-bubble.active .bubble-label{color:#fff}.bubble-icon{font-size:20px;color:#000;transition:color .3s ease}.bubble-label{font-size:9px;font-weight:500;color:#000;margin-top:2px;transition:color .3s ease}.sidebar-nav.active{left:20px}.nav-item{display:none}.bookstore-page{display:none;flex-direction:column;flex:1;overflow-y:auto;padding:8px 10px 1px}.bookstore-page.active{display:flex}.bookstore-container .page-content{flex:1;overflow-y:auto}.bookstore-container .nav-tabs{display:flex;gap:5px;margin-bottom:8px;overflow-x:auto;padding-bottom:3px;scrollbar-width:none;-ms-overflow-style:none}
.bookstore-container .nav-tabs::-webkit-scrollbar{display:none;width:0;height:0;background:transparent}.bookstore-container .nav-tab{padding:4px 8px;border:1px solid #000;border-radius:12px;font-size:10px;white-space:nowrap;cursor:pointer}.bookstore-container .nav-tab.active{background:#000;color:#fff}.bookstore-container .search-box{position:relative;margin-bottom:8px}.bookstore-container .search-input{width:100%;padding:7px 12px 7px 30px;border:1px solid #000;border-radius:12px;font-size:12px;background:#fff}.bookstore-container .search-icon{position:absolute;left:8px;top:50%;transform:translateY(-50%);font-size:13px;color:#666}.bookstore-container .section-title{font-size:14px;font-weight:600;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center}.bookstore-container .section-more{font-size:10px;color:#555;text-decoration:none;cursor:pointer}.bookstore-container .featured-book,.bookstore-container .book-item{border:1px solid #000;border-radius:10px;padding:10px;margin-bottom:8px;background:#fff}.bookstore-container .featured-title,.bookstore-container .book-title{font-size:15px;font-weight:600;margin-bottom:4px;display:flex;justify-content:space-between;align-items:center}.bookstore-container .featured-badge,.bookstore-container .book-badge{font-size:10px;background:#000;color:#fff;padding:2px 6px;border-radius:8px;white-space:nowrap}.bookstore-container .featured-meta,.bookstore-container .book-meta{display:flex;gap:8px;font-size:11px;color:#555;margin-bottom:5px}.bookstore-container .featured-meta i,.bookstore-container .book-meta i{margin-right:2px}.bookstore-container .featured-desc,.bookstore-container .book-desc{font-size:12px;line-height:1.4;margin-bottom:6px;color:#333}.bookstore-container .featured-desc{display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}.bookstore-container .book-desc{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}.bookstore-container .featured-stats,.bookstore-container .book-stats{display:flex;justify-content:space-between;font-size:10px;color:#777}.bookstore-container .book-list{display:grid;grid-template-columns:1fr;gap:8px;margin-bottom:10px}.bookstore-container .shelf-empty{text-align:center;padding:30px 20px;color:#666;flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center}.bookstore-container .shelf-empty i{font-size:48px;color:#ccc;margin-bottom:15px}.bookstore-container .profile-info{text-align:center;padding:15px 0}.bookstore-container .menu-list{list-style:none;margin-top:15px}.bookstore-container .menu-item{padding:12px;border-bottom:1px solid #000;display:flex;justify-content:space-between;align-items:center;cursor:pointer;font-size:15px;color:#000}.bookstore-container .menu-item:hover{background:#f9f9f9}.bookstore-container .menu-item:last-child{border-bottom:none}.bookstore-container .menu-item div i{margin-right:10px}.bookstore-container .remove-book{font-size:10px;color:#f44;border:none;background:none;cursor:pointer;padding:2px 5px;margin-left:8px}.bookstore-container .user-info-section{padding:20px;text-align:center}.bookstore-container .user-avatar{margin-bottom:15px}.bookstore-container .avatar-circle{width:100px;height:100px;background:#000;border-radius:50%;margin:0 auto 15px;display:flex;align-items:center;justify-content:center}.bookstore-container .avatar-circle i{font-size:50px;color:#fff}.bookstore-container .user-name-editable{cursor:pointer;display:inline-block}.bookstore-container #user-display-name{margin:0;color:#333;font-size:18px;font-weight:600;padding:8px 16px;border-radius:6px;border:1px solid transparent;transition:all .3s ease}.bookstore-container .user-name-editable:hover #user-display-name{border-color:#000;background:#f9f9f9}@media (max-width:400px){.sidebar-nav{left:-48px}.sidebar-bubble{width:42px;height:42px}.bubble-icon{font-size:18px}.bubble-label{font-size:8px}.bookstore-container .book-list{grid-template-columns:1fr}.bookstore-page{padding:6px 8px 3px}.bookstore-container .avatar-circle{width:60px;height:60px}.bookstore-container .avatar-circle i{font-size:28px}}.swipe-hint{position:absolute;top:50%;right:12px;transform:translateY(-50%);font-size:12px;color:#ccc;writing-mode:vertical-rl;text-orientation:mixed;opacity:0.3;animation:pulse 2s infinite}@keyframes pulse{0%,100%{opacity:0.3}50%{opacity:0.5}}.bookstore-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.1);z-index:99;display:none}#new-dream-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);display:none;justify-content:center;align-items:center;z-index:9999}.new-dream-content{background:#fff;width:90%;max-width:400px;border:2px solid #000;border-radius:10px;overflow:hidden}.new-dream-header{padding:15px;border-bottom:1px solid #000;background:#fafafa;display:flex;justify-content:space-between;align-items:center}.new-dream-header h3{margin:0;font-size:16px}.close-new-dream{background:none;border:none;font-size:20px;cursor:pointer}.new-dream-body{padding:15px}.new-dream-form-group{margin-bottom:15px}.new-dream-form-group label{display:block;margin-bottom:5px;font-size:14px;font-weight:600}.new-dream-input,.new-dream-textarea,.new-dream-select{width:100%;padding:8px;border:1px solid #000;border-radius:5px;font-size:13px}.new-dream-textarea{resize:vertical;min-height:60px}.new-dream-actions{display:flex;gap:10px;margin-top:20px}.new-dream-btn{flex:1;padding:10px;border:1px solid #000;border-radius:5px;cursor:pointer;font-size:13px}.new-dream-btn.save{background:#000;color:#fff}.new-dream-btn.cancel{background:#fff;color:#000}.new-dream-tabs{display:flex;border-bottom:1px solid #000;margin-bottom:15px}.new-dream-tab{flex:1;padding:10px;text-align:center;border:none;background:#fff;cursor:pointer;border-bottom:2px solid transparent}.new-dream-tab.active{border-bottom:2px solid #000;font-weight:600}.new-dream-tab-content{display:none}.new-dream-tab-content.active{display:block}#edit-featured-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);display:none;justify-content:center;align-items:center;z-index:9999}.book-selector-container{max-height:400px;overflow-y:auto}.book-selector-item{border:1px solid #ddd;border-radius:8px;padding:10px;margin-bottom:8px;cursor:pointer;transition:all .2s ease}.book-selector-item:hover{border-color:#000;background:#f9f9f9}.book-selector-item.selected{border-color:#000;background:#f0f0f0;box-shadow:inset 0 0 0 1px #000}.book-selector-title{font-size:14px;font-weight:600;margin-bottom:4px;display:flex;justify-content:space-between;align-items:center}.book-selector-badge{font-size:10px;background:#000;color:#fff;padding:2px 6px;border-radius:8px;white-space:nowrap}.book-selector-meta{display:flex;gap:8px;font-size:11px;color:#555;margin-bottom:4px}.book-selector-desc{font-size:12px;color:#666;line-height:1.3;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}.close-edit-featured{background:none;border:none;font-size:20px;cursor:pointer}.role-selector-container{max-height:200px;overflow-y:auto;border:1px solid #ddd;border-radius:5px;padding:10px}.role-item{margin-bottom:8px;display:flex;align-items:center;width:100%}.role-item input[type="checkbox"]{margin:0 8px 0 0;padding:0;width:16px;height:16px;flex-shrink:0}.role-item label{font-size:13px;cursor:pointer;flex:1;text-align:left}.no-roles{color:#777;font-size:12px;text-align:center;padding:10px}#bookstore-status{display:inline-block!important;background:#0f0!important}#bookstore-interface .header h1{margin-left:20px;font-size:21px}#book-detail-content .manage-chapters-btn,#book-detail-content .start-reading-btn{background:#000;color:#fff;border:none;border-radius:8px;padding:12px 40px;font-size:16px;cursor:pointer;width:160px}#chapter-manager-page .add-chapter-btn{background:#000;color:#fff;border:none;border-radius:8px;padding:8px 16px;font-size:14px;cursor:pointer}#chapter-edit-modal .save-chapter-btn,#chapter-edit-modal .cancel-chapter-btn{background:#000;color:#fff;border:none;border-radius:6px;padding:10px;font-size:14px;cursor:pointer;flex:1;text-align:center}.view-detail-btn,.edit-style-btn,.remove-custom-book{background:#4CAF50;color:white;border:none;border-radius:3px;padding:2px 8px;font-size:11px;cursor:pointer;margin-left:8px}.remove-custom-book{background:#ff6b6b}.edit-custom-btn{background:none;border:none;color:#0066cc;font-size:12px;cursor:pointer}.edit-chapter-btn,.delete-chapter-btn{border:1px solid #000;border-radius:4px;padding:4px 8px;font-size:11px;cursor:pointer;background:#fff;color:#000;transition:all .2s;min-width:40px}.edit-chapter-btn:hover,.delete-chapter-btn:hover{background:#000;color:#fff}.chapter-actions button i{display:none}.chapter-actions button:after{content:attr(data-text);display:inline-block}.edit-chapter-btn:after{content:"编辑"}.delete-chapter-btn:after{content:"删除"}.chapter-item{border:1px solid #000!important}#chapter-title-input,#chapter-content-input,#chapter-word-count{border:1px solid #000!important}.chapters-info{border:1px solid #000!important}.book-detail-info{border:1px solid #000!important}#book-detail-page .header h1{text-align:left!important;margin-left:100px!important;margin-right:auto!important;transform:none!important}#chapter-manager-page .header h1{text-align:left!important;margin-left:98px!important;margin-right:auto!important;transform:none!important}#reading-page .header h1{text-align:left!important;margin-left:106px!important;margin-right:auto!important;transform:none!important}
#reading-content div { font-size: 15px !important; }
#movieFileBtn::-webkit-file-upload-button{background:#000;color:#fff;border:none;border-radius:20px;padding:8px 25px;font-size:12px;cursor:pointer;margin-right:10px;transition:all .3s;}#movieFileBtn{color:#666;font-size:12px;background:#f5f5f5;border-radius:20px;padding:5px;width:100%;}
#mVideo{border-radius:15px!important;outline:3px solid #fff!important;outline-offset:-1px;overflow:hidden!important;box-shadow:0 0 0 1px rgba(255,255,255,0.5)!important;}

/* ==================== 奕阁界面样式 ==================== */
#construction-interface .header{text-align:center;margin-bottom:15px;padding-bottom:10px;border-bottom:5px solid #000;position:relative;display:flex;align-items:center;justify-content:center;flex-shrink:0}
#construction-interface .header h1{font-size:21px;font-weight:600;margin:0;margin-left:12px;position:relative}
#construction-interface .header h1 #construction-status{position:absolute;top:1px;right:-20px;width:8px;height:8px;border-radius:50%;background-color:red}
#construction-interface .back-button{position:absolute;left:0;background:#fff;border:1px solid #000;padding:6px 10px;border-radius:20px;cursor:pointer;font-size:12px;z-index:1}
.construction-page{display:flex;flex-direction:column;flex:1;overflow-y:auto}
.game-list{display:flex;flex-direction:column;gap:12px;margin-top:20px}
.game-item{display:flex;align-items:center;padding:15px;border:1px solid #000;border-radius:12px;background:#fff;cursor:pointer;transition:all .3s;gap:15px}
.game-item:hover{background:#f9f9f9;transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.08)}
.game-icon{width:40px;height:40px;border-radius:10px;background:#000;color:#fff;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:700}
.game-info{flex:1}
.game-name{font-size:16px;font-weight:600;color:#000;margin-bottom:4px}
.game-desc{font-size:12px;color:#666}
.game-arrow{font-size:20px;color:#999;margin-left:10px}
.gomoku-back-btn{padding:6px 16px;border:1px solid #000;background:#fff;border-radius:20px;cursor:pointer;font-size:12px;transition:all .3s;white-space:nowrap}
.gomoku-back-btn:hover{background:#000;color:#fff}
.gomoku-container{display:flex;flex-direction:column;align-items:center;padding:15px;background:#fff;border-radius:8px;border:1px solid #000;margin:15px auto;width:280px;box-shadow:0 5px 15px rgba(0,0,0,0.08);box-sizing:border-box;position:relative;left:50%;transform:translateX(-50%)}
.gomoku-title{margin:0 0 10px;font-weight:700;letter-spacing:2px;font-size:18px;color:#000}
.gomoku-status{margin-bottom:10px;font-size:12px;color:#666;height:18px;font-weight:600}
.gomoku-board-wrapper{border:1px solid #000;line-height:0;padding:0;background:#fff;margin:0 auto;width:100%;max-width:450px;box-sizing:border-box}
.gomoku-canvas{width:100%;height:auto;aspect-ratio:1/1;cursor:crosshair;display:block}
.gomoku-btn{margin-top:15px;padding:8px 20px;border:1px solid #000;background:#fff;border-radius:5px;cursor:pointer;transition:all .3s;font-size:12px;font-weight:500;min-width:120px}
.gomoku-btn:hover{background:#000;color:#fff}
@media (max-width:480px){.gomoku-container{padding:10px;margin:10px auto}.gomoku-title{font-size:16px}.gomoku-board-wrapper{border-width:1px}}
.truth-game-container{width:100%;margin:0;padding:0;background:#fff;border:none;border-radius:0;box-sizing:border-box}.truth-game-wrapper{display:flex;flex-direction:column;gap:8px;width:100%;padding:1px}.truth-control-panel{width:100%;background:#fff;border-radius:0;padding:6px 1px}.truth-dice-container{background:#111;border-radius:6px;padding:8px;margin-bottom:8px;max-width:100%}.truth-dice{width:50px;height:50px;background:#fff;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:1.8rem;font-weight:bold;margin:0 auto 4px;cursor:pointer}.truth-roll-btn{background:#222;color:#fff;border:none;border-radius:3px;padding:6px 8px;font-size:0.9rem;width:100%;cursor:pointer}.truth-player-status{display:flex;gap:6px;margin-bottom:8px;padding:0 1px}.truth-player-info{display:flex;align-items:center;gap:4px;padding:6px;border-radius:3px;border:1px solid #000;background:#f5f5f5;flex:1}.truth-player-info.active{border-color:#222;background:rgba(0,0,0,0.05)}.truth-player-color{width:8px;height:8px;border-radius:50%;background:#111}.truth-player-name{font-size:0.85rem;margin:0;font-weight:600}.truth-player-position{font-size:0.75rem;margin:1px 0 0 0;color:#666}.truth-game-status{background:#111;color:#fff;padding:6px;border-radius:3px;text-align:center;font-size:0.8rem;margin-bottom:8px}.truth-question-panel{background:#fff;border-radius:0;padding:10px 3px;margin-bottom:0}.truth-question-title{font-size:0.9rem;color:#111;margin:0 0 4px 0;font-weight:600}.truth-question-text{font-size:0.8rem;line-height:1.3;min-height:40px;padding:6px;background:#f9f9f9;border-radius:2px;border:1px solid #000;margin:0 0 6px 0}.truth-answer-input{width:100%;padding:6px;border:1px solid #000;border-radius:2px;font-size:0.8rem;margin:0 0 4px 0;resize:vertical;min-height:35px;box-sizing:border-box}.truth-current-answer{background:#f8f8f8;border-left:1px solid #000;padding:6px;border-radius:2px}.truth-answer-text{font-size:0.75rem}.truth-answer-info{font-size:0.7rem;color:#666;margin-top:2px}.truth-question-controls{display:flex;gap:4px}.truth-submit-btn,.truth-answer-btn,.truth-skip-btn{flex:1;padding:5px;border:none;border-radius:2px;cursor:pointer;font-size:0.8rem}.truth-submit-btn{background:#222;color:#fff}.truth-answer-btn{background:#444;color:#fff}.truth-skip-btn{background:#777;color:#fff}.truth-questions-manager{background:#fff;border-radius:0;padding:10px 3px;margin-bottom:0}.truth-manager-title{font-size:0.9rem;color:#111;margin:0 0 4px 0;font-weight:600}.truth-questions-list{max-height:70px;overflow-y:auto;margin:0 0 6px 0;padding:4px;background:#f9f9f9;border-radius:2px;border:1px solid #000;scrollbar-width:none;-ms-overflow-style:none}.truth-questions-list::-webkit-scrollbar{display:none}.truth-question-item{padding:4px 5px;border-bottom:1px solid #000;display:flex;justify-content:space-between;font-size:0.75rem;align-items:center}.truth-delete-question{background:#fff;color:#000;border:1px solid #000;border-radius:12px;padding:2px 8px;font-size:0.7rem;cursor:pointer;min-width:40px;text-align:center}.truth-add-question{display:flex;gap:4px}.truth-question-input{flex:1;padding:6px;border:1px solid #000;border-radius:2px;font-size:0.8rem}.truth-add-btn{background:#222;color:#fff;border:none;border-radius:2px;padding:6px 8px;cursor:pointer;font-size:0.8rem}.truth-answer-history{background:#fff;border-radius:0;padding:10px 3px}.truth-history-title{font-size:0.9rem;color:#111;margin:0 0 4px 0;font-weight:600}.truth-answers-list{max-height:70px;overflow-y:auto;padding:4px;background:#f9f9f9;border-radius:2px;border:1px solid #000;scrollbar-width:none;-ms-overflow-style:none}.truth-answers-list::-webkit-scrollbar{display:none}.truth-answer-item{padding:4px 5px;border-bottom:1px solid #000;font-size:0.75rem}

/* ==================== 国际汇界面样式 ==================== */
#international-interface .header{position:relative;height:50px;display:flex;align-items:center}
#international-interface .back-button{position:absolute;left:0;background:#fff;border:1px solid #000;padding:6px 10px;border-radius:20px;cursor:pointer;font-size:12px;z-index:1}
#international-interface .header h1{position:absolute;left:120px;top:50%;transform:translateY(-50%);margin:0;font-size:23px;font-weight:600}
#international-interface .shop-container{padding-top:0px}
#international-interface .search-bar{padding:5px 10px;border-bottom:1px solid #000;margin-top:-5px}
#international-interface .search-box{display:flex;align-items:center;background:#fff;border:1px solid #000;border-radius:20px;padding:4px 10px}
#international-interface .search-icon{color:#000;margin-right:8px;font-size:12px}
#international-interface .search-input{flex:1;border:none;background:none;font-size:12px;outline:none}
#international-interface .brands-scroll{display:flex;overflow-x:auto;gap:12px;padding:12px 20px;border-bottom:1px solid #000;scrollbar-width:none}
#international-interface .brand-item{padding:8px 16px;border:1px solid #000;border-radius:20px;font-size:12px;cursor:pointer;white-space:nowrap;flex-shrink:0}
#international-interface .brand-item.active{background:#000;color:#fff}
#international-interface .categories-scroll{display:flex;overflow-x:auto;gap:10px;padding:10px 20px;border-bottom:1px solid #000;scrollbar-width:none}
#international-interface .category-item{padding:6px 14px;border:1px solid #000;border-radius:16px;font-size:11px;cursor:pointer;white-space:nowrap;flex-shrink:0}
#international-interface .category-item.active{background:#000;color:#fff}
#international-interface .products-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1px;background:#ffffff}
#international-interface .product-card{background:#fff;padding:20px;border-top:1px solid #f0f0f0;border-right:1px solid #000000;border-bottom:1px solid #000000;border-left:1px solid #000000;cursor:pointer;position:relative}
#international-interface .product-icon{font-size:32px;text-align:center;margin-bottom:12px}
#international-interface .product-info{text-align:center}
#international-interface .product-name{font-size:13px;font-weight:600;margin-bottom:8px;line-height:1.3}
#international-interface .product-price{font-size:14px;font-weight:700}
#international-interface .delete-product-btn{position:absolute;top:5px;right:5px;width:22px;height:22px;background:#000000;color:#fff;border:none;border-radius:50%;cursor:pointer;font-size:16px;line-height:20px;text-align:center;opacity:0;transition:all 0.2s ease;z-index:10;display:flex;align-items:center;justify-content:center;padding:0;box-shadow:0 2px 4px rgba(0,0,0,0.2)}
#international-interface .delete-product-btn:hover{background:#333;transform:scale(1.1);opacity:1!important}
#international-interface .product-card:hover .delete-product-btn{opacity:0.9}
#international-interface .delete-product-btn::before{content:"×";display:block;font-weight:bold}
#international-interface .add-category-btn,#international-interface .add-brand-btn{padding:6px 14px;border:1px solid #000;border-radius:16px;font-size:11px;cursor:pointer;white-space:nowrap;flex-shrink:0;background:#ffffff;color:#000;display:flex;align-items:center;justify-content:center;min-width:30px}
#international-interface .add-brand-btn{padding:8px 16px;border-radius:20px;font-size:12px}
#international-interface .add-category-btn:hover,#international-interface .add-brand-btn:hover{background:#000;color:#fff}
#international-interface .add-category-btn::before,#international-interface .add-brand-btn::before{content:"+";font-weight:bold}
#international-interface .delete-product-btn{opacity:0;position:absolute;top:5px;right:5px;width:22px;height:22px;background:#000;color:#fff;border:none;border-radius:50%;cursor:pointer;font-size:16px;line-height:20px;text-align:center;z-index:10;display:flex;align-items:center;justify-content:center;padding:0}#international-interface .delete-product-btn::before{content:"×";display:block;font-weight:bold}
.arc-menu{position:absolute;bottom:-150px;left:50%;transform:translateX(-50%);width:280px;height:120px;background:transparent;transition:all 0.5s cubic-bezier(0.18,0.89,0.32,1.28);display:flex;justify-content:center;z-index:9999;pointer-events:none}.arc-menu.show{bottom:50px;pointer-events:auto}.nav-item{position:absolute;font-size:35px;cursor:pointer;width:60px;height:60px;display:flex;align-items:center;justify-content:center;background:white;border-radius:50%;box-shadow:0 4px 15px rgba(0,0,0,0.2);transition:all 0.3s;filter:none}.nav-item:nth-child(1){bottom:60px;left:110px} .nav-item:nth-child(2){bottom:10px;left:20px} .nav-item:nth-child(3){bottom:10px;right:20px}.full-page{position:absolute;top:0;left:0;width:100%;height:100%;background:#f4f4f4;z-index:1000;padding-top:60px;text-align:center}.arc-menu.show { bottom: 20px !important; }

/* ==================== 激活码验证样式 ==================== */
#activation-modal,#admin-panel{font-family:system-ui;}#activation-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:9999;display:flex;justify-content:center;align-items:center;color:#fff;flex-direction:column;text-align:center;padding:20px;}#activation-code{width:100%;padding:15px;border:2px solid #fff;background:transparent;color:#fff;font-size:16px;border-radius:25px;text-align:center;letter-spacing:2px;}#activation-code::placeholder{color:rgba(255,255,255,0.5);}#activation-code:focus{outline:none;border-color:#4a6ee0;}#activate-btn,button[onclick*=toggleAdminPanel],button[onclick*=showImportDialog]{padding:12px 30px;background:transparent;color:#fff;border:2px solid #fff;border-radius:25px;font-size:16px;cursor:pointer;font-weight:bold;transition:all .3s;}#activate-btn:hover,button[onclick*=toggleAdminPanel]:hover,button[onclick*=showImportDialog]:hover{background:rgba(255,255,255,0.1);transform:translateY(-2px);box-shadow:0 4px 12px rgba(255,255,255,0.1);}#activate-btn:active,button[onclick*=toggleAdminPanel]:active,button[onclick*=showImportDialog]:active{transform:translateY(0);}#admin-panel{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:500px;background:#fff;border:2px solid #000;border-radius:12px;z-index:10000;display:none;max-height:80vh;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,0.2);}#admin-panel button{padding:8px 16px;background:#000;color:#fff;border:none;border-radius:25px;font-size:12px;cursor:pointer;transition:all .2s;}#admin-panel button:hover{background:#333;transform:translateY(-1px);}#admin-panel button:active{transform:translateY(0);}#admin-panel button[style*="background:#fff"]{background:#fff;color:#000;border:1px solid #000;}#admin-panel button[style*="background:#fff"]:hover{background:#f0f0f0;}#admin-panel input{padding:8px 12px;border:1px solid #000;border-radius:25px;font-size:12px;width:100%;box-sizing:border-box;}#admin-panel input:focus{border-color:#4a6ee0;outline:none;box-shadow:0 0 0 2px rgba(74,110,224,0.1);}#code-list{max-height:300px;overflow-y:auto;border:1px solid #eee;border-radius:6px;}#code-list::-webkit-scrollbar{width:6px;}#code-list::-webkit-scrollbar-track{background:#f1f1f1;border-radius:3px;}#code-list::-webkit-scrollbar-thumb{background:#ccc;border-radius:3px;}#code-list::-webkit-scrollbar-thumb:hover{background:#999;}.code-item{padding:12px;margin-bottom:8px;border:1px solid #000;border-radius:8px;background:#fff;display:flex;justify-content:space-between;align-items:center;transition:all .3s ease;}.code-item:hover{transform:translateY(-2px);box-shadow:0 2px 8px rgba(0,0,0,0.1);}.code-used{opacity:0.7;border-color:#ddd;background:#f9f9f9;}.code-actions button{padding:4px 12px;border:none;border-radius:25px;cursor:pointer;font-size:11px;transition:all .2s ease;}.code-actions button:hover{transform:scale(1.05);}input,textarea,select{border:1px solid #000;border-radius:25px;padding:8px 12px;font-size:12px;width:100%;box-sizing:border-box;}input:focus,textarea:focus,select:focus{border-color:#4a6ee0;outline:none;box-shadow:0 0 0 2px rgba(74,110,224,0.1);}button{cursor:pointer;transition:all .2s ease;}button:hover{opacity:0.9;transform:translateY(-1px);}button:active{transform:translateY(0);}#import-dialog{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:10001;display:none;justify-content:center;align-items:center;}#import-dialog>div{background:#fff;color:#000;padding:30px;border:2px solid #000;border-radius:12px;width:90%;max-width:400px;box-shadow:0 10px 40px rgba(0,0,0,0.3);}#import-dialog h3{margin-top:0;margin-bottom:15px;font-size:18px;color:#000;text-align:center;}#import-dialog p{color:#666;font-size:14px;margin-bottom:20px;text-align:center;}#import-file{width:100%;padding:12px;margin-bottom:20px;background:#fff;color:#000;border:1px solid #000;border-radius:25px;font-size:14px;cursor:pointer;transition:all .2s;box-sizing:border-box;}#import-file:focus{border-color:#4a6ee0;outline:none;box-shadow:0 0 0 2px rgba(74,110,224,0.1);}#import-dialog .dialog-buttons{display:flex;gap:12px;justify-content:flex-end;}#import-dialog .dialog-buttons button{padding:10px 24px;border:none;border-radius:25px;cursor:pointer;font-size:14px;transition:all .2s;}#import-dialog .dialog-buttons button:first-child{background:#fff;color:#000;border:1px solid #000;}#import-dialog .dialog-buttons button:first-child:hover{background:#f0f0f0;}#import-dialog .dialog-buttons button:last-child{background:#000;color:#fff;}#import-dialog .dialog-buttons button:last-child:hover{background:#333;}
    </style>  
</head>  
<body>  
<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<!--   ✦ 删除模态框 ✦       -->
<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<div class="confirm-dialog" id="confirm-dialog"><div class="confirm-content"><h3>确认删除</h3><p>您确定要删除这条消息吗？此操作不可撤销。</p><div class="confirm-buttons"><button id="confirm-delete-btn">确认删除</button><button id="cancel-delete-btn">取消</button></div></div></div><div class="confirm-dialog" id="import-confirm-dialog"><div class="confirm-content"><h3>导入聊天记录</h3><p>导入聊天记录将覆盖当前的所有消息，此操作不可撤销。确定要继续吗？</p><div class="confirm-buttons"><button id="confirm-import-btn">确认导入</button><button id="cancel-import-btn">取消</button></div></div></div><div class="confirm-dialog" id="restore-confirm-dialog"><div class="confirm-content"><h3>恢复聊天记录</h3><p id="restore-confirm-text">恢复聊天记录将覆盖当前的所有消息，此操作不可撤销。确定要恢复吗？</p><div class="confirm-buttons"><button id="confirm-restore-btn">确认恢复</button><button id="cancel-restore-btn">取消</button></div></div></div><div class="confirm-dialog" id="clear-chat-dialog"><div class="confirm-content"><h3>清空聊天记录</h3><p id="clear-chat-text">您确定要清空所有聊天记录吗？此操作不可撤销。</p><div class="confirm-buttons"><button id="confirm-clear-chat-btn">确认清空</button><button id="cancel-clear-chat-btn">取消</button></div></div></div><div class="confirm-dialog" id="delete-selected-dialog"><div class="confirm-content"><h3>删除选中消息</h3><p id="delete-selected-text">您确定要删除选中的消息吗？此操作不可撤销。</p><div class="confirm-buttons"><button id="confirm-delete-selected-btn">确认删除</button><button id="cancel-delete-selected-btn">取消</button></div></div></div><div class="confirm-dialog" id="delete-worldbook-dialog"><div class="confirm-content"><h3>删除世界书记录</h3><p>您确定要删除这个记录吗？此操作不可撤销。</p><div class="confirm-buttons"><button id="confirm-delete-worldbook-btn">确认删除</button><button id="cancel-delete-worldbook-btn">取消</button></div></div></div><div class="confirm-dialog" id="weibo-delete-dialog"><div class="confirm-content"><h3>删除微博</h3><p>您确定要删除这条微博吗？此操作不可撤销。</p><div class="confirm-buttons"><button id="confirm-weibo-delete-btn">确认删除</button><button id="cancel-weibo-delete-btn">取消</button></div></div></div>

<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<!--   ✦ 钱包模态框 ✦       -->
<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<div class="wallet-modal" id="rechargeModal"><div class="wallet-modal-content"><div class="wallet-modal-header"><h2 class="wallet-modal-title">手机充值</h2><button class="wallet-close-btn" id="closeModal">&times;</button></div><div class="wallet-input-group"><label class="wallet-input-label">充值金额 (元)</label><input type="number" class="amount-input" id="rechargeAmount" placeholder="请输入充值金额" min="1" step="0.01"></div><button class="wallet-confirm-btn" id="confirmRecharge">确认充值</button></div></div><div class="utility-modal" id="utilityModal"><div class="utility-modal-content"><div class="utility-modal-header"><h2 class="utility-modal-title">本月水电费</h2><button class="utility-close-btn" id="closeUtilityModal">&times;</button></div><div class="house-type-selector"><label for="houseTypeSelect">选择房型</label><select class="house-type-select" id="houseTypeSelect"><option value="豪宅、庄园、城堡">豪宅、庄园、城堡</option><option value="别墅、独栋">别墅、独栋</option><option value="高档公寓、大平层">高档公寓、大平层</option><option value="普通公寓、居民楼、小区">普通公寓、居民楼、小区</option><option value="经济适用房、小户型">经济适用房、小户型</option><option value="宿舍、合租房">宿舍、合租房</option><option value="老破小、旧房" selected>老破小、旧房</option><option value="农村自建房、乡村">农村自建房、乡村</option></select></div><div class="utility-info"><div class="utility-item"><span>当前房型:</span><span id="utility-house-type">老破小</span></div><div class="utility-item"><span>水费:</span><span id="utility-water">0.00 元</span></div><div class="utility-item"><span>电费:</span><span id="utility-electricity">0.00 元</span></div><div class="utility-total"><span>总计:</span><span id="utility-total">0.00 元</span></div></div><button class="utility-confirm-btn" id="confirmUtility">确认缴纳</button></div></div>

<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<!--   ✦ 世界书模态框 ✦       -->
<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<div class="worldbook-modal" id="worldbook-modal"><div class="worldbook-modal-content"><h3 id="worldbook-modal-title">添加世界书记录</h3><div class="worldbook-form-group"><label for="worldbook-title">记录标题</label><input type="text" class="worldbook-form-input" id="worldbook-title" placeholder="输入记录标题..."></div><div class="worldbook-form-group"><label for="worldbook-content">记录内容</label><textarea class="worldbook-form-textarea" id="worldbook-content" placeholder="输入记录内容..."></textarea></div><div class="worldbook-form-actions"><button class="worldbook-form-btn" id="save-worldbook-btn">保存</button><button class="worldbook-form-btn" id="cancel-worldbook-btn">取消</button></div><div class="worldbook-status" id="worldbook-status"></div></div></div>

<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<!--   ✦ 微博模态框 ✦       -->
<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<div class="weibo-modal" id="chatCharacterModal"><div class="weibo-modal-content"><div class="weibo-modal-header"><h3>编辑聊天角色主页</h3><button class="weibo-close-modal" id="closeChatCharacterModal">×</button></div><div class="weibo-profile-form"><div class="weibo-form-group"><label for="chatCharacterName">角色姓名</label><input type="text" id="chatCharacterName" placeholder="请输入角色姓名"></div><div class="weibo-form-group"><label for="chatCharacterBio">角色简介</label><textarea id="chatCharacterBio" placeholder="介绍一下角色..."></textarea></div><div class="weibo-form-group"><label for="chatCharacterFollowers">粉丝数量</label><input type="number" id="chatCharacterFollowers" placeholder="请输入粉丝数量"></div><button class="weibo-save-profile-btn" id="saveChatCharacterBtn">保存角色设置</button></div></div></div><div class="weibo-modal" id="weiboCategoryModal"><div class="weibo-modal-content"><div class="weibo-modal-header"><h3>管理分类</h3><button class="weibo-close-modal" id="weiboCloseCategoryModal">×</button></div><div class="weibo-category-input-group"><input type="text" class="weibo-category-input" id="weiboNewCategoryInput" placeholder="输入新分类名称"><button class="weibo-add-category-btn" id="weiboAddCategoryBtn">添加</button></div><div class="weibo-category-list" id="weiboCategoryList"></div></div></div><div class="weibo-modal" id="weiboProfileModal"><div class="weibo-modal-content"><div class="weibo-modal-header"><h3>编辑个人资料</h3><button class="weibo-close-modal" id="weiboCloseProfileModal">×</button></div><div class="weibo-profile-form"><div class="weibo-form-group"><label for="weiboProfileName">姓名</label><input type="text" id="weiboProfileName" placeholder="请输入您的姓名"></div><div class="weibo-form-group"><label for="weiboProfileBio">个人简介</label><textarea id="weiboProfileBio" placeholder="介绍一下自己..."></textarea></div><div class="weibo-form-group"><label for="weiboProfilePersona">人设/标签</label><input type="text" id="weiboProfilePersona" placeholder="例如：摄影爱好者、程序员、美食家等"></div><div class="weibo-form-group"><label for="weiboProfileLocation">所在地</label><input type="text" id="weiboProfileLocation" placeholder="请输入您所在的城市"></div><div class="weibo-form-group"><label for="weiboProfileFollowers">粉丝数量</label><input type="number" id="weiboProfileFollowers" placeholder="请输入粉丝数量"></div><div class="weibo-form-group"><label for="weiboProfileFollowing">关注数量</label><input type="number" id="weiboProfileFollowing" placeholder="请输入关注数量"></div><button class="weibo-save-profile-btn" id="weiboSaveProfileBtn">保存资料</button></div></div></div><div class="weibo-comment-modal" id="weiboCommentModal"><div class="weibo-comment-content"><div class="weibo-modal-header"><h3>评论</h3><button class="weibo-close-modal" id="weiboCloseCommentModal">×</button></div><textarea class="weibo-comment-input" id="weiboCommentInput" placeholder="写下您的评论..."></textarea><div class="weibo-comment-actions"><button class="weibo-cancel-comment" id="weiboCancelComment">取消</button><button class="weibo-submit-comment" id="weiboSubmitComment">发布评论</button></div><div class="weibo-comments-list" id="weiboCommentsList"></div></div></div>

<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<!--   ✦ 手机桌面 ✦       -->
<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<div class=phone-container><div class=screen><div class=desktop-interface active id=desktop-interface><div class=desktop-time id=desktop-time>--:--</div><div class=desktop-signature id=desktop-signature contenteditable=true>点击编辑个性签名...</div><div class=lock-screen-btn onclick=lockScreen.lock()><i class="fas fa-lock"></i></div><div class=app-grid><div class=app-item onclick="openApp('chat')"><div class=app-icon>∅</div><div class=app-label>聊天</div></div><div class=app-item onclick="openApp('api')"><div class=app-icon>∽</div><div class=app-label>API</div></div><div class=app-item onclick="openApp('settings')"><div class=app-icon>❖</div><div class=app-label>设置</div></div><div class=app-item onclick="openApp('worldbook')"><div class=app-icon>✧</div><div class=app-label>世界书</div></div><div class=app-item onclick="openApp('wallet')"><div class=app-icon>$</div><div class=app-label>钱包</div></div><div class=app-item onclick="openApp('music')"><div class=app-icon>᯽</div><div class=app-label>拟刻</div></div><div class=app-item onclick="openApp('weibo')"><div class=app-icon>@</div><div class=app-label>微界</div></div><div class=app-item onclick="openApp('food-delivery')"><div class=app-icon>ꕤ</div><div class=app-label>桃源</div></div><div class=app-item onclick="openApp('bookstore')"><div class=app-icon>♨</div><div class=app-label>谧笺</div></div><div class=app-item onclick="openApp('construction')"><div class=app-icon>⟁</div><div class=app-label>奕阁</div></div><div class=app-item onclick="openApp('international')"><div class=app-icon>⧉</div><div class=app-label>国际汇</div></div></div></div>

<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<!--   ✦ 聊天界面 ✦       -->
<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<div class="interface chat-interface" id="chat-interface"><div class="header"><button class="back-button" onclick="goBackToDesktop()">●</button><h1>✤世纪 <span class="status-indicator" id="chat-status"></span></h1><button class="toggle-persona" onclick="openPersonaModal()">编辑人设</button></div><div class="scrollable-content"><div class="chat-container"><div class="chat-messages" id="chat-messages"></div></div><div class="chat-management-section"><h3>聊天管理</h3><div class="chat-type-switch"><div class="chat-type-label">聊天类型: </div><div class="chat-type-buttons"><button class="chat-type-btn active" id="single-chat-btn" onclick="switchChatType('single')">单聊</button><button class="chat-type-btn" id="multi-chat-btn" onclick="switchChatType('multi')">多聊</button></div></div><div class="multi-persona-selector" id="multi-persona-selector"><label class="multi-persona-label">当前角色:</label><select class="persona-select" id="multi-persona-select" onchange="switchMultiPersona()"></select><div class="multi-persona-management"><button onclick="refreshMultiPersonaSelect()">刷新角色</button><button onclick="openPersonaModal(); switchPersonaTab('multi')">管理角色</button></div></div><div class="chat-mode-switch"><div class="chat-mode-label">聊天模式: <span id="chat-mode-display">线上模式</span><span class="chat-mode-indicator chat-mode-online" id="chat-mode-indicator"></span></div><div class="chat-mode-buttons"><button class="chat-mode-btn active" id="online-mode-btn" onclick="switchChatMode('online')">线上</button><button class="chat-mode-btn" id="offline-mode-btn" onclick="switchChatMode('offline')">线下</button></div></div><div class="chat-mode-description" id="chat-mode-description">线上模式: 短信模式短文本，日常说话风格 | 线下模式: 剧情模式长文本，唯美小说风格</div><div class="chat-management-buttons"><button onclick="clearAllChatHistory()">一键清空记录</button><button onclick="toggleSelectionMode()" id="selection-mode-btn">选择消息清空</button></div><div class="selection-mode-info" id="selection-mode-info"><span>已选择 <span class="selection-count" id="selection-count">0</span> 条消息</span><div class="selection-actions" id="selection-actions"><button onclick="deleteSelectedMessages()" class="danger">删除选中消息</button><button onclick="toggleSelectionMode()">取消选择</button></div></div></div><div class="food-order-section"><h3>外卖订单</h3><div class="order-list" id="order-list"><div class="empty-order">正在加载已送达订单...</div></div><div class="order-actions"><button onclick="loadDeliveredOrders()">刷新订单</button><button onclick="goToFoodDelivery()">去桃源点外卖</button></div></div><div class="backup-section"><h3>聊天备份</h3><div class="backup-buttons"><button onclick="exportChatHistory()">导出聊天记录</button><button onclick="importChatHistory()">导入聊天记录</button><button onclick="backupToLocal()">备份到本地</button><button onclick="restoreFromLocal()">从本地恢复</button></div><div class="backup-status" id="backup-status"></div><div class="backup-info">使用导出/导入功能可以在不同浏览器之间迁移聊天记录</div><input type="file" class="backup-file-input" id="backup-file-input" accept=".json"></div><div class="scroll-hint" id="chat-scroll-hint">↑ 继续向上滑动查看更多内容</div></div><div class="chat-input-container"><div class="chat-input"><input type="text" id="message-input" placeholder="输入您的消息..." onkeypress="handleMessageKeypress(event)"><button onclick="handleSendButtonClick()" id="send-button">发送</button></div></div><div class="app-navigation" style="display: none;"></div></div><!-- 人设模态框 --><div class="persona-modal" id="persona-modal"><div class="modal-content"><div class="modal-header"><h3>人设身份证</h3><button class="close-modal" onclick="closePersonaModal()">×</button></div><div class="modal-body"><div class="persona-tabs"><button class="persona-tab active" onclick="switchPersonaTab('ai')">角色人设</button><button class="persona-tab" onclick="switchPersonaTab('user')">我的人设</button><button class="persona-tab" onclick="switchPersonaTab('multi')" id="multi-persona-tab">多聊角色</button></div><div class="persona-form-section active" id="ai-persona-section"><div class="form-section"><h4>角色人设</h4><div class="form-group"><label for="ai-persona-name">姓名</label><input type="text" class="form-input" id="ai-persona-name" placeholder="输入姓名..."></div><div class="form-group"><label for="ai-persona-desc">人设描述</label><textarea class="form-input" id="ai-persona-desc" rows="3" placeholder="输入人设描述..."></textarea></div><div class="persona-actions"><button onclick="saveAIPersona()">保存角色</button><button onclick="loadAIPersona()">加载角色</button></div></div><div class="persona-preview" id="ai-persona-preview"><h5>人设预览：</h5><div id="ai-preview-content">暂无人设</div></div></div><div class="persona-form-section" id="user-persona-section"><div class="form-section"><h4>我的人设</h4><div class="form-group"><label for="user-persona-name">姓名</label><input type="text" class="form-input" id="user-persona-name" placeholder="输入姓名..."></div><div class="form-group"><label for="user-persona-desc">人设描述</label><textarea class="form-input" id="user-persona-desc" rows="3" placeholder="输入人设描述..."></textarea></div><div class="persona-actions"><button onclick="saveUserPersona()">保存我的</button><button onclick="loadUserPersona()">加载我的</button></div></div><div class="persona-preview" id="user-persona-preview"><h5>人设预览：</h5><div id="user-preview-content">暂无我的人设</div></div></div><div class="persona-form-section" id="multi-persona-section"><div class="form-section"><h4>多聊角色</h4><div class="form-group"><label for="multi-persona-name">姓名</label><input type="text" class="form-input" id="multi-persona-name" placeholder="输入姓名..."></div><div class="form-group"><label for="multi-persona-desc">人设描述</label><textarea class="form-input" id="multi-persona-desc" rows="3" placeholder="输入人设描述..."></textarea></div><div class="persona-actions"><button onclick="addMultiPersona()">添加角色</button><button onclick="saveMultiPersonas()">保存所有角色</button></div></div><div class="persona-preview" id="multi-persona-preview"><h5>多聊角色预览：</h5><div id="multi-preview-content">暂无多聊角色</div></div></div></div></div></div>

<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<!--   ✦ api界面 ✦       -->
<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<div class="interface" id="api-interface"><div class="header"><button class="back-button" onclick="goBackToDesktop()">●</button><h1>API配置 <span class="status-indicator" id="api-status-indicator"></span></h1></div><div class="scrollable-content"><div class="api-section"><h3>API提供商</h3><select class="api-input" id="api-provider" onchange="updateApiEndpoints()"><option value="openai">OpenAI</option><option value="anthropic">Anthropic (Claude)</option><option value="google">Google (Gemini)</option><option value="custom">自定义</option></select></div><div class="api-section"><h3>API端点配置</h3><input type="text" class="api-input" id="api-url" placeholder="输入API端点URL..." value="https://api.openai.com/v1"><input type="password" class="api-input" id="api-key" placeholder="输入API密钥..."><div class="api-buttons"><button onclick="testApiConnection()">测试连接</button><button onclick="refreshModels()">刷新模型列表</button><button onclick="saveApiConfig()">保存配置</button><button onclick="clearApiConfig()">清除配置</button></div><div class="api-status" id="api-status"></div></div><div class="api-section"><h3>模型选择</h3><div class="model-info"><span class="current-model" id="current-model-display">当前模型: 未选择</span><span class="model-badge" id="model-provider-badge">OpenAI</span></div><select class="api-input" id="model-select" onchange="updateSelectedModel()"><option value="">请选择模型</option></select><div class="refresh-status"><button class="refresh-button" onclick="refreshModels()">刷新模型</button><span class="last-updated" id="last-updated">上次更新: 从未</span></div><div class="model-list" id="model-list" style="display: none;"><div class="api-status" id="models-status"></div></div></div><div class="api-section"><h3>高级设置</h3><div class="form-group"><label for="temperature">温度 (0-2)</label><input type="range" class="api-input" id="temperature" min="0" max="2" step="0.1" value="0.7" oninput="updateTemperatureValue()"><span id="temperature-value">0.7</span></div><div class="form-group"><label for="max-tokens">最大令牌数</label><input type="number" class="api-input" id="max-tokens" value="1000" min="1" max="4000"></div><div class="form-group"><label for="reply-count">角色回复条数 (1-5)</label><input type="number" class="api-input" id="reply-count" value="1" min="1" max="5"></div></div><div class="api-section" id="tts-api-section"><h3>TTS 语音设置</h3><div class="tts-config-group"><div class="form-group"><label for="tts-api-provider">TTS 提供商</label><select class="api-input" id="tts-api-provider" onchange="updateTtsApiEndpoints()"><option value="minimax">Minimax TTS</option><option value="volink">Volink API</option><option value="custom">自定义</option></select></div><div class="form-group"><label for="tts-api-url">API 地址</label><input type="text" class="api-input" id="tts-api-url" placeholder="输入 TTS API 端点 URL..." value="https://api.minimaxi.com/v1"></div><div class="form-group"><label for="tts-api-key">API 密钥</label><input type="password" class="api-input" id="tts-api-key" placeholder="输入 TTS API 密钥..."></div><div class="form-group"><label for="tts-group-id">Group ID (Minimax专用)</label><input type="text" class="api-input" id="tts-group-id" placeholder="输入 Group ID..."></div><div class="form-group"><label for="tts-model-select">选择模型</label><select class="api-input" id="tts-model-select" onchange="updateSelectedTtsModel()"><option value="">请先刷新模型列表</option></select></div><div class="form-group"><label for="tts-voice-select">选择语音</label><select class="api-input" id="tts-voice-select"><option value="">请先选择模型</option></select></div><div class="tts-buttons"><button onclick="testTtsConnection()">测试连接</button><button onclick="refreshTtsModels()">刷新模型列表</button><button onclick="saveTtsConfig()">保存配置</button><button onclick="clearTtsConfig()">清除配置</button><button onclick="testTtsVoice()" id="test-tts-voice-btn" style="background:#000000;color:white">试听语音</button></div><div class="tts-status" id="tts-status"></div><div class="refresh-status"><button class="refresh-button" onclick="refreshTtsVoices()">刷新语音列表</button><span class="last-updated" id="tts-last-updated">上次更新: 从未</span></div><div class="tts-model-info"><div class="current-model" id="current-tts-model-display">当前模型: 未选择</div><div class="current-voice" id="current-tts-voice-display">当前语音: 未选择</div></div></div></div><div class="scroll-hint" id="api-scroll-hint">↑ 继续向上滑动查看更多内容</div></div></div>
        
<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<!--   ✦ 设置界面 ✦       -->
<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<div class=interface id=settings-interface><div class=header><button class=back-button onclick="goBackToDesktop()">●</button><h1>系统设置 <span class=status-indicator id=settings-status style="background-color:#0f0;"></span></h1></div><div class=scrollable-content><div class=settings-container><div class=settings-category><h3 class=settings-category-title>连接</h3><div class=settings-list><div class=settings-item onclick=toggleSetting('wifi')><div class=settings-icon>W</div><div class=settings-info><div class=settings-title>WLAN</div><div class=settings-desc>已连接/未连接</div></div><div class=settings-switch><label class=switch><input type=checkbox id=wifi-toggle><span class=slider></span></label></div></div><div class=settings-item onclick=toggleSetting('mobile')><div class=settings-icon>N</div><div class=settings-info><div class=settings-title>移动网络</div><div class=settings-desc>5G/6G</div></div><div class=settings-switch><label class=switch><input type=checkbox id=mobile-toggle><span class=slider></span></label></div></div><div class=settings-item onclick=toggleSetting('bluetooth')><div class=settings-icon>B</div><div class=settings-info><div class=settings-title>蓝牙</div><div class=settings-desc>已连接/未连接</div></div><div class=settings-switch><label class=switch><input type=checkbox id=bluetooth-toggle><span class=slider></span></label></div></div></div></div><div class=settings-category><h3 class=settings-category-title>设备</h3><div class=settings-list><div class=settings-item onclick=openSubSetting('sound')><div class=settings-icon>S</div><div class=settings-info><div class=settings-title>声音</div><div class=settings-desc>音量与震动</div></div><div class=settings-arrow>›</div></div><div class=settings-item onclick="openApp('style')"><div class=settings-icon>D</div><div class=settings-info><div class=settings-title>显示</div><div class=settings-desc>CSS美化</div></div><div class=settings-arrow>›</div></div><div class=settings-item onclick=openSubSetting('battery')><div class=settings-icon>P</div><div class=settings-info><div class=settings-title>电池</div><div class=settings-desc>电量剩余 100%</div></div><div class=settings-arrow>›</div></div></div></div><div class=settings-category><h3 class=settings-category-title>系统</h3><div class=settings-list><div class=settings-item onclick="openApp('security')"><div class=settings-icon>L</div><div class=settings-info><div class=settings-title>安全隐私</div><div class=settings-desc>密码与权限</div></div><div class=settings-arrow>›</div></div><div class=settings-item onclick=openSubSetting('storage')><div class=settings-icon>M</div><div class=settings-info><div class=settings-title>存储</div><div class=settings-desc>内存1TB</div></div><div class=settings-arrow>›</div></div><div class=settings-item onclick=openSubSetting('about')><div class=settings-icon>I</div><div class=settings-info><div class=settings-title>关于手机</div><div class=settings-desc>版本与设备</div></div><div class=settings-arrow>›</div></div></div></div><div class=settings-footer><div class=app-version>版本 1.0.0</div><div class=copyright>✤世纪小手机✤</div></div></div><div class=scroll-hint id=settings-scroll-hint>↑ 继续向上滑动查看更多内容</div></div></div>

<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<!--   ✦ 美化界面 ✦       -->
<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<div class="interface" id="style-interface"><div class="header"><button class="back-button" onclick="goBackToDesktop()">●</button><h1>CSS美化 <span class="status-indicator" id="style-status"></span></h1></div><div class="scrollable-content"><div class="style-container"><div class="ai-circle">AI</div><textarea class="css-editor" id="css-editor" placeholder="输入全局CSS代码...">/* 在这里输入您的自定义CSS */
.message { border: 1px solid #000; background: white; margin: 8px 0; max-width: 85%; }
.user-message { margin-left: auto; background: #f8f8f8; }
.ai-message { margin-right: auto; background: #f0f0f0; }
.ai-circle { border: 3px solid #000; background: white; transition: all 0.3s ease; }
.ai-circle:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }</textarea><div class="style-buttons"><button class="apply-css" onclick="applyGlobalCSS()">应用CSS</button><button class="apply-css" onclick="resetCSS()">重置CSS</button><button class="apply-css" onclick="exportCSS()">导出CSS</button><button class="apply-css" onclick="importCSS()">导入CSS</button></div></div><div class="scroll-hint" id="style-scroll-hint">↑ 继续向上滑动查看更多内容</div></div></div>

<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<!--   ✦ 密码设置界面 ✦       -->
<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<div class="interface" id="security-interface"><div class="header"><button class="back-button" onclick="goBackToDesktop()">●</button><h1>安全隐私 <span class="status-indicator" id="security-status"></span></h1></div><div class="scrollable-content"><div class="style-container" style="padding:20px;min-height:400px"><h2 style="margin-bottom:20px">安全隐私设置</h2><p style="color:#666;margin-bottom:30px">管理锁屏密码和其他安全设置</p><div id="password-display-area" style="width:100%;margin-bottom:30px"><div id="lock-icon-area" class="security-lock"><i class="fas fa-lock"></i></div><div id="saved-password-display" style="display:none;width:100%;padding:15px;border:2px solid #000;border-radius:8px;background:#fafafa;position:relative"><span id="password-stars" style="font-family:monospace;letter-spacing:3px;font-size:18px;position:absolute;left:15px;top:50%;transform:translateY(-50%)">●●●●●●</span><button onclick="deletePassword()" style="position:absolute;right:45px;top:50%;transform:translateY(-50%);padding:8px 15px;border:none;background:transparent;border-radius:4px;font-size:16px;cursor:pointer;color:#f00;font-weight:500">删除</button><button onclick="changePassword()" style="position:absolute;right:0px;top:50%;transform:translateY(-50%);padding:8px 15px;border:none;background:transparent;border-radius:4px;font-size:16px;cursor:pointer;color:#000;font-weight:500">修改</button></div></div><div id="password-setup-area" style="display:none;width:100%;margin-bottom:30px"><div style="margin-bottom:15px"><input type="password" id="setup-new-password" placeholder="输入新密码" style="width:100%;padding:12px;border:1px solid #000;border-radius:4px;margin-bottom:10px;font-size:14px"><input type="password" id="setup-confirm-password" placeholder="确认新密码" style="width:100%;padding:12px;border:1px solid #000;border-radius:4px;font-size:14px"></div><div style="display:flex;gap:10px"><button onclick="saveNewPassword()" style="flex:1;padding:10px;border:1px solid #000;background:#000;color:#fff;border-radius:4px;cursor:pointer;font-size:14px">保存密码</button><button onclick="cancelPasswordSetup()" style="flex:1;padding:10px;border:1px solid #000;background:#fff;border-radius:4px;cursor:pointer;font-size:14px">取消</button></div></div><div class="style-buttons" style="width:100%;margin-top:40px"><button class="apply-css" onclick="showPasswordSetup()">设置密码</button><button class="apply-css" onclick="alert('功能开发中')">权限管理</button><button class="apply-css" onclick="alert('功能开发中')">隐私设置</button><button class="apply-css" onclick="goBackToDesktop()">返回桌面</button></div><div id="password-status-message" style="margin-top:20px;padding:10px;border-radius:5px;text-align:center;display:none;font-size:13px"></div></div><div class="scroll-hint" id="security-scroll-hint">↑ 继续向上滑动查看更多内容</div></div></div>

<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<!--   ✦ 世界书界面 ✦       -->
<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<div class="interface" id="worldbook-interface"><div class="header"><button class="back-button" onclick="goBackToDesktop()">●</button><h1>世界书 <span class="status-indicator" id="worldbook-status-indicator"></span></h1><button class="add-worldbook-btn" onclick="openWorldbookModal()">+</button></div><div class="scrollable-content"><div style="padding: 15px;"><h2>世界书管理 <span class="status-indicator" id="worldbook-status-indicator-title"></span></h2><p style="font-size:12px;">世界书是告诉AI除了角色之外还需要遵守的行为准则和世界观设定。</p><div class="chat-summary-section" style="margin-top:15px;padding:12px;border:1px solid #000;border-radius:6px;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,0.05);"><div class="summary-header" style="margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid #000;"><h3 style="margin:0;font-size:14px;font-weight:600;display:flex;align-items:center;gap:6px;"><i class="fas fa-book"></i>聊天剧情总结</h3><div style="font-size:10px;color:#666;margin-top:3px;">选择聊天记录生成小说风格总结</div></div><div class="summary-controls"><div class="chat-select-section" style="margin-bottom:12px;"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;"><span style="font-size:12px;font-weight:600;">选择聊天记录</span><button onclick="loadAllChatsForSummary()" style="padding:3px 8px;border:1px solid #000;background:#fff;border-radius:3px;font-size:10px;cursor:pointer;">刷新列表</button></div><div class="chat-list-container" style="border:1px solid #000;border-radius:4px;padding:8px;max-height:120px;overflow-y:auto;background:#fafafa;"><div id="chat-selection-list"><div style="text-align:center;padding:15px;color:#999;font-size:11px;">正在加载聊天记录...</div></div></div><div style="margin-top:6px;font-size:10px;color:#666;display:flex;justify-content:space-between;"><span>已选择: <span id="selected-count">0</span> 条</span><button onclick="toggleSelectAllChats()" style="background:none;border:none;color:#000;font-size:10px;cursor:pointer;text-decoration:underline;">全选/取消</button></div></div><div class="summary-settings" style="margin-bottom:12px;"><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;"><div><label style="display:block;margin-bottom:4px;font-size:11px;font-weight:600;">总结长度</label><select id="summary-length" style="width:100%;padding:6px;border:1px solid #000;border-radius:3px;background:#fff;font-size:11px;"><option value="short">简略版（约500字）</option><option value="medium" selected>标准版（约1000字）</option><option value="long">详细版（约2000字）</option></select></div><div><label style="display:block;margin-bottom:4px;font-size:11px;font-weight:600;">小说风格</label><select id="summary-style" style="width:100%;padding:6px;border:1px solid #000;border-radius:3px;background:#fff;font-size:11px;"><option value="modern" selected>现代小说风格</option><option value="ancient">古代小说风格</option><option value="romantic">唯美小说风格</option></select></div></div></div><div class="summary-actions" style="display:flex;gap:6px;"><button onclick="generateChatSummary()" style="flex:2;padding:8px;border:1px solid #000;background:#000;color:#fff;border-radius:3px;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:4px;"><i class="fas fa-magic"></i>生成剧情总结</button><button onclick="clearSummarySelection()" style="flex:1;padding:8px;border:1px solid #000;background:#fff;border-radius:3px;font-size:12px;cursor:pointer;">清空选择</button></div></div><div id="summary-progress" style="display:none;margin-top:12px;padding:10px;border:1px solid #000;border-radius:5px;background:#fafafa;"><div style="display:flex;justify-content:space-between;margin-bottom:6px;"><span id="summary-progress-text" style="font-size:11px;font-weight:600;">正在准备生成...</span><span id="summary-progress-percent" style="font-size:10px;color:#666;">0%</span></div><div style="height:3px;background:#e0e0e0;border-radius:2px;overflow:hidden;"><div id="summary-progress-fill" style="height:100%;width:0%;background:#000;transition:width 0.5s ease;"></div></div><div id="summary-progress-detail" style="font-size:9px;color:#666;margin-top:5px;text-align:center;">正在处理选中的聊天记录...</div></div><div id="summary-result" style="display:none;margin-top:12px;border:1px solid #000;border-radius:6px;overflow:hidden;"><div class="result-header" style="padding:10px 12px;background:#f0f0f0;border-bottom:1px solid #000;display:flex;justify-content:space-between;align-items:center;"><div style="font-size:13px;font-weight:600;">生成的小说总结</div><div style="display:flex;gap:5px;"><button onclick="copySummary()" style="width:26px;height:26px;border:1px solid #000;background:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:11px;" title="复制">C</button><button onclick="regenerateSummary()" style="width:26px;height:26px;border:1px solid #000;background:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:11px;" title="重新生成">R</button></div></div><div class="result-content" style="padding:12px;max-height:180px;overflow-y:auto;background:#fff;"><div id="summary-content" style="font-size:12px;line-height:1.4;color:#333;white-space:pre-wrap;"></div></div><div class="result-footer" style="padding:6px 12px;background:#fafafa;border-top:1px solid #000;display:flex;justify-content:space-between;font-size:9px;color:#666;"><div><span>字数: <span id="summary-word-count" style="font-weight:600;">0</span></span><span style="margin-left:6px;">风格: <span id="summary-style-display" style="font-weight:600;">现代小说</span></span></div><div><span id="summary-timestamp">刚刚生成</span></div></div></div><div id="summary-empty" style="margin-top:15px;text-align:center;padding:15px 12px;border:2px dashed #ddd;border-radius:6px;background:#f9f9f9;"><div style="margin-bottom:8px;font-size:14px;color:#999;">✤</div><div style="font-size:12px;font-weight:600;margin-bottom:4px;color:#666;">选择聊天记录生成小说总结</div><div style="font-size:10px;color:#888;line-height:1.2;margin-bottom:10px;">勾选您想总结的聊天记录，选择长度和风格，AI将为您创作精美的小说段落</div><button onclick="loadAllChatsForSummary()" style="padding:5px 12px;border:1px solid #000;background:#000;color:#fff;border-radius:3px;font-size:10px;cursor:pointer;">加载聊天记录</button></div></div><div class="worldbook-list" id="worldbook-list"></div><div class="worldbook-backup-section"><h3>世界书备份管理</h3><p style="font-size: 12px; color: #666; margin-bottom: 10px;">备份您的世界书记录到本地文件，或从文件导入恢复</p><div class="worldbook-backup-buttons"><button onclick="exportWorldbookRecords()">导出世界书记录</button><button onclick="importWorldbookRecords()">导入世界书记录</button><button onclick="backupWorldbookToLocal()">备份到本地存储</button><button onclick="restoreWorldbookFromLocal()">从本地恢复</button></div><div class="worldbook-backup-status" id="worldbook-backup-status"></div><div class="worldbook-backup-info">使用导出/导入功能可以在不同设备之间迁移世界书记录</div><input type="file" class="worldbook-backup-file-input" id="worldbook-backup-file-input" accept=".json"></div><div class="worldbook-status" id="worldbook-status"></div></div><div class="scroll-hint" id="worldbook-scroll-hint">↑ 继续向上滑动查看更多内容</div></div></div>

<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<!--   ✦ 钱包界面 ✦       -->
<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<div class="interface" id="wallet-interface"><div class="header"><button class="back-button" onclick="goBackToDesktop()">●</button><h1>钱包 <span class="status-indicator" id="wallet-status"></span></h1></div><div class="scrollable-content"><div class="wallet-container"><section class="balance-card"><div class="balance-label">总余额 (元)</div><div class="balance-amount" id="totalBalance">0.00</div><div class="balance-sub-info"><span>今日支出: ¥<span id="todayExpense">0.00</span></span><span>本月收入: ¥<span id="monthIncome">0.00</span></span></div></section><section class="action-buttons"><button class="action-btn" id="rechargeBtn"><span class="icon">✚</span> 手机充值</button><button class="action-btn" id="utilityBtn"><span class="icon">⚡</span> 水电费</button></section><section class="transaction-section"><h3>收入支出</h3><div class="transaction-list" id="transaction-list"></div></section></div></div></div>

<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<!--   ✦ 拟刻界面 ✦       -->
<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<div class="interface" id="music-interface"><div class="header"><button class="back-button" onclick="goBackToDesktop()">●</button><h1>黑胶唱片 <span class="status-indicator" id="music-status"></span></h1></div><div class="scrollable-content"><div class="music-player"><div class="music-fixed-area"><div class="disc-container"><div class="disc" id="disc"><div class="disc-center"></div></div></div><div class="song-info"><div class="song-title" id="song-title">选择音频开始播放</div><div class="song-artist" id="song-artist">-</div></div><div class="progress-container"><div class="progress-info"><span class="current-time" id="current-time">0:00</span><span class="duration" id="duration">0:00</span></div><div class="progress-bar" id="progress-bar"><div class="progress" id="progress"></div></div></div><div class="control-buttons"><button class="btn btn-loop active" id="list-loop-btn" title="顺序播放">✦</button><button class="btn btn-prev" id="prev-btn">⏮</button><button class="btn btn-play" id="play-pause-btn">▶</button><button class="btn btn-next" id="next-btn">⏭</button><button class="btn btn-loop" id="single-loop-btn" title="单曲循环">✦</button></div></div><div class="music-scrollable-area"><div class="import-section"><div class="import-btn" id="import-btn">选择音频文件</div><input type="file" class="file-input" id="file-input" accept="audio/*" multiple><div class="playlist" id="playlist"><div class="playlist-item empty">播放列表为空</div></div></div></div></div></div></div>

<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<!--   ✦ 微界界面 ✦       -->
<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<div class="interface" id="weibo-interface"><div class="header"><button class="back-button" onclick="goBackToDesktop()">●</button><h1>MicroWorld<span class="status-indicator" id="weibo-status"></span></h1></div><div class="scrollable-content"><div class="weibo-container"><header class="weibo-header"><div class="weibo-logo">Horizon</div><nav class="weibo-nav"><a href="#" id="weiboHomeLink" class="active">首页</a><a href="#" id="weiboDiscoverLink">发现</a><a href="#" id="weiboProfileLink">我的</a></nav></header><section id="weiboHomePage" class="weibo-page-content active"><section class="weibo-category-section"><div class="weibo-category-header"><div class="weibo-category-title">内容分类</div><button class="weibo-manage-categories-btn" id="weiboManageCategories">管理分类</button><button class="weibo-refresh-btn" id="weiboRefreshDynamicBtn">生成动态</button></div><div class="weibo-category-tags" id="weiboCategoryTags"></div></section><section class="weibo-compose-section"><div class="weibo-compose-box"><div class="weibo-avatar" id="weiboUserAvatar"></div><div class="weibo-compose-input"><textarea placeholder="分享新鲜事..." id="weiboText"></textarea><div class="weibo-compose-actions"><select class="weibo-category-select" id="weiboCategorySelect"><option value="">选择分类</option></select><button class="weibo-publish-btn" id="weiboPublishBtn">发布</button></div></div></div></section><section class="weibo-list" id="weiboList"></section></section><section id="weiboDiscoverPage" class="weibo-page-content"><div class="weibo-discover-section"><div class="weibo-discover-title">发现精彩内容</div><div class="weibo-trending-topics"><div class="weibo-trending-header"><div class="weibo-trending-title">微博热搜</div><button class="weibo-refresh-btn" id="weiboRefreshHotSearch">刷新榜单</button></div><div class="weibo-topic-list" id="weiboHotSearchList"></div></div><div class="weibo-trending-topics"><div class="weibo-trending-header"><div class="weibo-trending-title">热门话题</div><button class="weibo-refresh-btn" id="weiboRefreshTopics">换一批</button></div><div class="weibo-topic-list" id="weiboTopicList"></div></div><div class="weibo-random-quote" id="weiboRandomQuote"></div></div></section><section id="weiboProfilePage" class="weibo-page-content"><div class="weibo-discover-section"><div class="weibo-discover-title">个人主页</div><div class="profile-card" id="myProfileCard"><div class="profile-summary" onclick="toggleProfileCard()"><div class="profile-avatar" id="myProfileAvatar"></div><div class="profile-basic"><div class="profile-name" id="myProfileName">微博用户</div><div class="profile-bio" id="myProfileBio">这个人很懒，什么都没有写...</div></div><button class="profile-toggle">▼</button></div><div class="profile-details"><div class="profile-stats"><div class="profile-stat"><div class="profile-stat-number" id="myProfileFollowers">0</div><div class="profile-stat-label">粉丝</div></div><div class="profile-stat"><div class="profile-stat-number" id="myProfileFollowing">0</div><div class="profile-stat-label">关注</div></div><div class="profile-stat"><div class="profile-stat-number" id="myProfileWeibos">0</div><div class="profile-stat-label">微博</div></div></div><button class="profile-edit-btn" id="editMyProfileBtn">编辑我的主页</button><div class="profile-system-actions" style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px;"><button class="profile-edit-btn" id="weiboSaveBackupBtn" style="background-color: #333; color: white; border-radius: 25px; width: 100%;">储存备份数据</button><button class="profile-edit-btn" id="weiboImportBackupBtn" style="background-color: #333; color: white; border-radius: 25px; width: 100%;">取出备份数据</button><input type="file" id="weiboImportInput" style="display: none;" accept=".json"></div></div></div></div></section></div></div></div>

<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<!--   ✦ 桃源界面 ✦       -->
<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<div class="interface" id="food-delivery-interface"><div class="header"><button class="back-button" onclick="goBackToDesktop()">●</button><h1>桃源外卖 <span class="status-indicator" id="food-status"></span></h1><button class="cart-btn" id="cart-btn"><i class="fas fa-shopping-cart"></i><div class="cart-count" id="cart-count">0</div></button></div><div class="food-page-container home-page active" id="home-page"><div class="search-container"><div class="search-box"><i class="fas fa-search search-icon"></i><input type="text" class="search-input" placeholder="搜索美食、商家"></div></div><div class="categories"><div class="category-item active"><div class="category-icon"><i class="fas fa-utensils"></i></div><div class="category-name">全部</div></div><div class="category-item"><div class="category-icon"><i class="fas fa-hamburger"></i></div><div class="category-name">汉堡</div></div><div class="category-item"><div class="category-icon"><i class="fas fa-pizza-slice"></i></div><div class="category-name">披萨</div></div><div class="category-item"><div class="category-icon"><i class="fas fa-bowl-food"></i></div><div class="category-name">中餐</div></div><div class="category-item"><div class="category-icon"><i class="fas fa-mug-hot"></i></div><div class="category-name">饮品</div></div><div class="category-item"><div class="category-icon"><i class="fas fa-ice-cream"></i></div><div class="category-name">甜点</div></div><div class="category-item"><div class="category-icon"><i class="fas fa-drumstick-bite"></i></div><div class="category-name">炸鸡</div></div><div class="category-item"><div class="category-icon"><i class="fas fa-bread-slice"></i></div><div class="category-name">面包</div></div><div class="category-item" id="add-food-category"><div class="category-icon"><i class="fas fa-plus"></i></div><div class="category-name">添加</div></div></div><div class="recommendations"><h2 class="section-title">今日美食推荐</h2><div class="food-grid" id="food-grid"></div><h2 class="section-title" style="margin-top:30px">附近热门美食</h2><div class="food-grid" id="hot-food-grid"></div></div></div><div class="food-page-container orders-page" id="orders-page"><div class="orders-filter"><button class="filter-btn active" data-filter="all">全部订单</button><button class="filter-btn" data-filter="delivering">配送中</button><button class="filter-btn" data-filter="delivered">已送达</button><button class="filter-btn" data-filter="canceled">已取消</button><button class="filter-btn" data-filter="overtime">已超时</button></div><div class="orders-list" id="orders-list"><div class="empty-orders" id="empty-orders"><i class="fas fa-clipboard-list"></i><p>暂无订单</p><p>快去首页选购美食吧！</p></div></div></div><div class="food-page-container profile-page" id="profile-page"><div class="profile-header"><div class="profile-info"><div class="profile-field"><label for="profile-name">姓名</label><div class="name-display" id="name-display"><div class="name-text" id="name-text">某某</div><button class="name-edit-btn" id="name-edit-btn"><i class="fas fa-edit"></i> 编辑</button></div><input type="text" class="name-edit-input" id="name-edit-input" value="…"><button class="profile-edit-btn" id="profile-save-btn">保存</button></div></div></div><div class="profile-menu"><div class="menu-item" id="address-menu-item"><i class="fas fa-map-marker-alt"></i><span>我的地址</span><i class="fas fa-chevron-right arrow"></i></div><div class="menu-item" id="favorites-menu-item"><i class="fas fa-heart"></i><span>我的收藏</span><i class="fas fa-chevron-right arrow"></i></div><div class="menu-item" id="evaluations-menu-item"><i class="fas fa-comment-alt"></i><span>我的评价</span><i class="fas fa-chevron-right arrow"></i></div></div></div><div class="food-page-container favorites-page" id="favorites-page"><h2 class="section-title">我的收藏</h2><div class="favorites-list" id="favorites-list"><div class="favorites-empty" id="empty-favorites"><i class="fas fa-heart"></i><p>暂无收藏</p><p>快去首页收藏你喜欢的美食吧！</p></div></div></div><div class="food-page-container evaluations-page" id="evaluations-page"><h2 class="section-title">我的评价</h2><div class="evaluations-list" id="evaluations-list"><div class="empty-orders" id="empty-evaluations"><i class="fas fa-comment-alt"></i><p>暂无评价</p><p>完成订单后可以在这里进行评价</p></div></div></div><div class="order-detail-modal" id="order-detail-modal"><div class="detail-header"><h2 class="detail-title">订单详情</h2><button class="detail-close" id="order-detail-close"><i class="fas fa-times"></i></button></div><div class="detail-content" id="order-detail-content"></div></div><div class="cart-detail-modal" id="cart-detail-modal"><div class="cart-detail-header"><h2 class="cart-detail-title">商品详情</h2><button class="cart-detail-close" id="cart-detail-close"><i class="fas fa-times"></i></button></div><div class="cart-detail-content" id="cart-detail-content"></div><div class="cart-detail-actions"><button class="cart-detail-btn secondary" id="cart-detail-cancel">取消</button><button class="cart-detail-btn primary" id="cart-detail-save">保存</button></div></div><div class="recommendation-modal" id="recommendation-modal"><div class="modal-header"><div class="modal-icon" id="recommendation-modal-icon"><i class="fas fa-crown"></i></div><button class="modal-close" id="modal-close"><i class="fas fa-times"></i></button></div><div class="modal-content"><h2 class="modal-title" id="recommendation-modal-title">招牌黑椒牛肉汉堡</h2><div class="modal-subtitle" id="recommendation-modal-subtitle">今日特惠 · 限量供应</div><p class="modal-desc" id="recommendation-modal-desc">精选澳洲牛肉饼，搭配浓郁黑椒酱汁，外层面包烤至金黄酥脆，内层蔬菜新鲜爽脆，口感层次丰富，肉质鲜嫩多汁。</p><div class="modal-features" id="recommendation-modal-features"><div class="modal-feature">厚实牛肉饼</div><div class="modal-feature">黑椒酱汁</div><div class="modal-feature">金黄面包</div><div class="modal-feature">新鲜蔬菜</div></div><div class="modal-price" id="recommendation-modal-price">¥38.8</div><div class="modal-actions"><button class="modal-btn secondary" id="modal-later">稍后看看</button><button class="modal-btn primary" id="modal-add">加入购物车</button></div></div></div><div class="add-food-modal" id="add-food-modal"><div class="add-food-modal-content"><div class="add-food-modal-header"><h2>添加新食物</h2><button class="add-food-modal-close" id="add-food-modal-close"><i class="fas fa-times"></i></button></div><div class="add-food-modal-body"><div class="form-group"><label for="new-food-name">食物名称</label><input type="text" id="new-food-name" placeholder="请输入食物名称"></div><div class="form-group"><label for="new-food-description">食物描述</label><textarea id="new-food-description" placeholder="请输入食物描述，介绍这道美食的特点..."></textarea></div><div class="form-group"><label for="new-food-price">价格 (元)</label><input type="number" id="new-food-price" placeholder="0.00" step="0.01" min="0"></div><div class="form-group"><label for="new-food-category">分类</label><select id="new-food-category"></option><option value="食物">自定义</option><option value="自定义">自定义分类</option></select><input type="text" id="new-food-custom-category" placeholder="输入自定义分类" style="display:none;margin-top:5px;"></div><div class="form-group"><label for="new-food-icon">图标</label><select id="new-food-icon"><option value="fas fa-utensils">通用</option></select></div><div class="form-group"><label for="new-food-features">标签</label><input type="text" id="new-food-features" placeholder="例如：新鲜, 辣味, 推荐"></div></div><div class="add-food-modal-actions"><button class="add-food-modal-btn secondary" id="add-food-cancel">取消</button><button class="add-food-modal-btn primary" id="add-food-save">保存食物</button></div></div></div><div class="cart-panel" id="cart-panel"><div class="cart-header"><h2 class="cart-title">购物车</h2><button class="cart-close" id="cart-close"><i class="fas fa-times"></i></button></div><div class="cart-address-info" id="cart-address-info"><div class="address-info-header"><div class="address-info-title">收货信息</div><button class="address-info-change" id="cart-change-address">更改</button></div><div class="address-info-content" id="cart-address-content">请添加收货地址</div></div><div class="cart-items" id="cart-items"><div style="text-align:center;padding:40px;color:#999">购物车是空的</div></div><div class="cart-footer"><div class="cart-total"><span>总计</span><span id="cart-total-price">¥0.0</span></div><button class="cart-checkout" id="checkout-btn">去结算</button></div></div><div class="address-panel" id="address-panel"><div class="address-header"><h2 class="address-title">我的地址</h2><button class="address-close" id="address-close"><i class="fas fa-times"></i></button></div><div class="address-content"><div class="address-input-group"><div class="address-input-title">添加/编辑地址</div><input type="text" class="address-input" id="address-input" placeholder="请输入详细地址（如：XX省XX市XX区XX街道XX号）"><div class="address-tags"><div class="address-tag active" data-tag="家">家</div><div class="address-tag" data-tag="公司">公司</div><div class="address-tag" data-tag="学校">学校</div><div class="address-tag" data-tag="其他">其他</div></div><button class="save-address-btn" id="save-address-btn">保存地址</button></div><div class="saved-addresses-section"><h3 class="saved-addresses-title">已保存的地址</h3><div class="address-list" id="address-list"></div></div></div></div><div class="overlay" id="overlay"></div><div id=fab-container><div class=fab-menu><div class=fab-menu-item data-page=home title=首页><i class="fas fa-home"></i></div><div class=fab-menu-item data-page=orders title=订单><i class="fas fa-file-alt"></i></div><div class=fab-menu-item data-page=profile title=我的><i class="fas fa-user"></i></div></div><div id=fab-main-btn><span>✤</span></div></div></div>

<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<!--   ✦ 谧笺界面 ✦       -->
<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<div class="interface" id="bookstore-interface"><div class="header"><button class="back-button" onclick="goBackToDesktop()">●</button><h1>谧笺 <span class="status-indicator" id="bookstore-status"></span></h1></div><div class="scrollable-content"><div class="bookstore-container"><div class="sidebar-nav"><div class="sidebar-bubble active" data-page="home" title="阅读"><div class="bubble-icon"><i class="fas fa-home"></i></div><div class="bubble-label">阅读</div></div><div class="sidebar-bubble" data-page="movie" title="影视"><div class="bubble-icon"><i class="fas fa-film"></i></div><div class="bubble-label">影视</div></div><div class="sidebar-bubble" data-page="shelf" title="书架"><div class="bubble-icon"><i class="fas fa-book"></i></div><div class="bubble-label">书架</div></div><div class="sidebar-bubble" data-page="profile" title="我的"><div class="bubble-icon"><i class="fas fa-user"></i></div><div class="bubble-label">我的</div></div></div><div class="bookstore-content"><div id="bookstore-home" class="bookstore-page active"><div class="page-content"><div class="nav-tabs"><div class="nav-tab active" data-category="recommend">推荐</div><div class="nav-tab" data-category="literature">文学</div><div class="nav-tab" data-category="novel">小说</div><div class="nav-tab" data-category="classic">经典</div><div class="nav-tab" data-category="horror">恐怖</div><div class="nav-tab" data-category="history">历史</div><div class="nav-tab" data-category="custom">自定义</div></div><div class="search-box"><i class="fas fa-search search-icon"></i><input type="text" class="search-input" placeholder="搜索书名、作者或关键词..."></div><div class="featured-section"><div class="section-title"><span>编辑推荐</span><a href="#" class="section-more edit-featured-btn">设置</a></div><div id="featured-book-container" class="featured-book" data-id="1"><div class="featured-title"><span>傲慢与偏见</span><span class="featured-badge">经典</span></div><div class="featured-meta"><span><i class="fas fa-user"></i> 简·奥斯汀</span><span><i class="fas fa-tag"></i> 文学/爱情</span><span><i class="fas fa-star"></i> 9.8</span></div><div class="featured-desc">19世纪英国社会的爱情与婚姻故事，描绘了班纳特家五姐妹的爱情经历，探讨了财富、阶级与婚姻的关系。</div><div class="featured-stats"><span>42万字</span><span>世界文学经典</span></div></div></div><div class="featured-section"><div class="section-title"><span>热门书籍</span><a href="#" class="section-more">更多 <i class="fas fa-chevron-right"></i></a></div><div class="book-list"><div class="book-item" data-id="1"><div class="book-title"><span>傲慢与偏见</span><span class="book-badge">经典</span></div><div class="book-meta"><span><i class="fas fa-user"></i> 简·奥斯汀</span><span><i class="fas fa-tag"></i> 文学/爱情</span><span><i class="fas fa-star"></i> 9.8</span></div><div class="book-desc">19世纪英国社会的爱情与婚姻故事，描绘了班纳特家五姐妹的爱情经历...</div><div class="book-stats"><span>42万字</span><span>世界文学经典</span></div></div><div class="book-item" data-id="2"><div class="book-title"><span>悲惨世界</span><span class="book-badge">经典</span></div><div class="book-meta"><span><i class="fas fa-user"></i> 雨果</span><span><i class="fas fa-tag"></i> 文学/社会</span><span><i class="fas fa-star"></i> 9.7</span></div><div class="book-desc">法国19世纪社会生活的史诗性巨著，讲述苦役犯冉·阿让的救赎之路...</div><div class="book-stats"><span>120万字</span><span>雨果代表作</span></div></div><div class="book-item" data-id="3"><div class="book-title"><span>绿山墙的安妮</span><span class="book-badge">经典</span></div><div class="book-meta"><span><i class="fas fa-user"></i> 蒙哥马利</span><span><i class="fas fa-tag"></i> 文学/成长</span><span><i class="fas fa-star"></i> 9.5</span></div><div class="book-desc">红发孤儿安妮在绿山墙农庄的成长故事，充满想象与温情...</div><div class="book-stats"><span>25万字</span><span>加拿大经典</span></div></div><div class="book-item" data-id="4"><div class="book-title"><span>飞鸟集</span><span class="book-badge">经典</span></div><div class="book-meta"><span><i class="fas fa-user"></i> 泰戈尔</span><span><i class="fas fa-tag"></i> 诗歌/文学</span><span><i class="fas fa-star"></i> 9.6</span></div><div class="book-desc">印度诗人泰戈尔的抒情短诗集，包含325首清丽的小诗...</div><div class="book-stats"><span>5万字</span><span>诺贝尔文学奖</span></div></div><div class="book-item" data-id="5"><div class="book-title"><span>时间简史</span><span class="book-badge">经典</span></div><div class="book-meta"><span><i class="fas fa-user"></i> 霍金</span><span><i class="fas fa-tag"></i> 科普/科学</span><span><i class="fas fa-star"></i> 9.4</span></div><div class="book-desc">探索宇宙的起源与命运，介绍黑洞、时间箭头等物理概念...</div><div class="book-stats"><span>18万字</span><span>科普经典</span></div></div><div class="book-item" data-id="6"><div class="book-title"><span>秘密花园</span><span class="book-badge">经典</span></div><div class="book-meta"><span><i class="fas fa-user"></i> 伯内特</span><span><i class="fas fa-tag"></i> 儿童/成长</span><span><i class="fas fa-star"></i> 9.3</span></div><div class="book-desc">任性孤僻的玛丽在神秘花园中发现自然与友谊的力量...</div><div class="book-stats"><span>15万字</span><span>儿童文学经典</span></div></div><div class="book-item" data-id="7"><div class="book-title"><span>哈尔的移动城堡</span><span class="book-badge">小说</span></div><div class="book-meta"><span><i class="fas fa-user"></i> 戴安娜·琼斯</span><span><i class="fas fa-tag"></i> 奇幻/小说</span><span><i class="fas fa-star"></i> 9.2</span></div><div class="book-desc">苏菲被女巫变成老太婆后进入哈尔的移动城堡的奇幻冒险...</div><div class="book-stats"><span>22万字</span><span>奇幻小说</span></div></div><div class="book-item" data-id="8"><div class="book-title"><span>暗恋泰迪熊</span><span class="book-badge">小说</span></div><div class="book-meta"><span><i class="fas fa-user"></i> 唐浣纱</span><span><i class="fas fa-tag"></i> 言情/小说</span><span><i class="fas fa-star"></i> 9.1</span></div><div class="book-desc">安紫芹暗恋追爱成功，她心心念念的聂瀚东哥哥也爱着她…</div><div class="book-stats"><span>28万字</span><span>台湾小说</span></div></div><div class="book-item" data-id="9"><div class="book-title"><span>肖申克的救赎</span><span class="book-badge">小说</span></div><div class="book-meta"><span><i class="fas fa-user"></i> 斯蒂芬·金</span><span><i class="fas fa-tag"></i> 悬疑/小说</span><span><i class="fas fa-star"></i> 9.9</span></div><div class="book-desc">银行家安迪被冤枉入狱，二十年后成功越狱的励志故事...</div><div class="book-stats"><span>35万字</span><span>励志经典</span></div></div><div class="book-item" data-id="10"><div class="book-title"><span>人间失格</span><span class="book-badge">文学</span></div><div class="book-meta"><span><i class="fas fa-user"></i> 太宰治</span><span><i class="fas fa-tag"></i> 文学/心理</span><span><i class="fas fa-star"></i> 9.3</span></div><div class="book-desc">太宰治的自传体小说，探讨人的存在与自我认同...</div><div class="book-stats"><span>122万字</span><span>日本文学</span></div></div><div class="book-item" data-id="11"><div class="book-title"><span>始乱终弃阿波罗后</span><span class="book-badge">小说</span></div><div class="book-meta"><span><i class="fas fa-user"></i> 佚名</span><span><i class="fas fa-tag"></i> 言情/小说</span><span><i class="fas fa-star"></i> 8.9</span></div><div class="book-desc">现代女性穿越到希腊神话世界，与太阳神阿波罗的爱恨情仇...</div><div class="book-stats"><span>45万字</span><span>连载中</span></div></div><div class="book-item" data-id="12"><div class="book-title"><span>小王子</span><span class="book-badge">经典</span></div><div class="book-meta"><span><i class="fas fa-user"></i> 圣埃克苏佩里</span><span><i class="fas fa-tag"></i> 寓言/文学</span><span><i class="fas fa-star"></i> 9.8</span></div><div class="book-desc">小王子在各个星球旅行的寓言故事，探讨爱与责任...</div><div class="book-stats"><span>5万字</span><span>世界名著</span></div></div><div class="book-item" data-id="13"><div class="book-title"><span>时代广场的蟋蟀</span><span class="book-badge">文学</span></div><div class="book-meta"><span><i class="fas fa-user"></i> 塞尔登</span><span><i class="fas fa-tag"></i> 儿童文学</span><span><i class="fas fa-star"></i> 9.2</span></div><div class="book-desc">一只蟋蟀从康涅狄格州来到纽约时代广场的奇妙故事...</div><div class="book-stats"><span>8万字</span><span>儿童文学经典</span></div></div><div class="book-item" data-id="14"><div class="book-title"><span>盗墓笔记</span><span class="book-badge">恐怖</span></div><div class="book-meta"><span><i class="fas fa-user"></i> 南派三叔</span><span><i class="fas fa-tag"></i> 恐怖/冒险</span><span><i class="fas fa-star"></i> 9.6</span></div><div class="book-desc">一群盗墓者的诡异经历，探寻古墓中的神秘与恐怖...</div><div class="book-stats"><span>150万字</span><span>恐怖经典</span></div></div><div class="book-item" data-id="15"><div class="book-title"><span>第七天</span><span class="book-badge">文学</span></div><div class="book-meta"><span><i class="fas fa-user"></i> 余华</span><span><i class="fas fa-tag"></i> 文学/现实</span><span><i class="fas fa-star"></i> 9.4</span></div><div class="book-desc">一个死者死后七天的见闻，展现中国社会众生相...</div><div class="book-stats"><span>18万字</span><span>当代文学</span></div></div><div class="book-item" data-id="16"><div class="book-title"><span>罗生门</span><span class="book-badge">经典</span></div><div class="book-meta"><span><i class="fas fa-user"></i> 芥川龙之介</span><span><i class="fas fa-tag"></i> 文学/短篇</span><span><i class="fas fa-star"></i> 9.6</span></div><div class="book-desc">日本文学经典短篇小说集，探讨人性与真相...</div><div class="book-stats"><span>10万字</span><span>日本经典</span></div></div><div class="book-item" data-id="17"><div class="book-title"><span>中华上下5000年</span><span class="book-badge">历史</span></div><div class="book-meta"><span><i class="fas fa-user"></i> 林汉达等</span><span><i class="fas fa-tag"></i> 历史/文化</span><span><i class="fas fa-star"></i> 9.7</span></div><div class="book-desc">系统介绍中国五千年历史文明的通俗读本...</div><div class="book-stats"><span>80万字</span><span>历史通识</span></div></div><div class="book-item" data-id="18"><div class="book-title"><span>射雕英雄传</span><span class="book-badge">经典</span></div><div class="book-meta"><span><i class="fas fa-user"></i> 金庸</span><span><i class="fas fa-tag"></i> 武侠/小说</span><span><i class="fas fa-star"></i> 9.9</span></div><div class="book-desc">郭靖黄蓉的江湖传奇，南宋抗金背景的武侠巨著...</div><div class="book-stats"><span>120万字</span><span>武侠经典</span></div></div><div class="book-item" data-id="19"><div class="book-title"><span>阴间神探</span><span class="book-badge">恐怖</span></div><div class="book-meta"><span><i class="fas fa-user"></i> 道门老九</span><span><i class="fas fa-tag"></i> 恐怖/悬疑</span><span><i class="fas fa-star"></i> 9.5</span></div><div class="book-desc">一名能够与鬼魂沟通的侦探，破解各种灵异案件...</div><div class="book-stats"><span>80万字</span><span>恐怖悬疑</span></div></div><div class="book-item" data-id="20"><div class="book-title"><span>十日终焉</span><span class="book-badge">恐怖</span></div><div class="book-meta"><span><i class="fas fa-user"></i> 杀虫队队员</span><span><i class="fas fa-tag"></i> 恐怖/生存</span><span><i class="fas fa-star"></i> 9.7</span></div><div class="book-desc">一群人被困在神秘空间，必须在十天内完成各种恐怖游戏...</div><div class="book-stats"><span>95万字</span><span>恐怖生存</span></div></div></div></div></div></div><div id="bookstore-movie" class="bookstore-page" style="display:none;background:#1a1a1a;color:white;"><div class="page-content" style="padding:20px;"><div style="text-align:center;margin-bottom:20px;"><h3>私人影院</h3><p style="font-size:12px;color:#888;">加载本地视频进行观看</p></div><div class="upload-section" style="border:2px dashed #555;padding:20px;text-align:center;border-radius:10px;margin-bottom:20px;"><label for="fileSelector" style="display:block;margin-bottom:10px;">点击此处选择视频文件</label><input type="file" id="fileSelector" accept="video/*" style="width:100%;max-width:250px;"></div><div class="player-container" style="background:#000;border-radius:8px;overflow:hidden;width:100%;min-height:200px;"><video id="myVideo" style="width:100%;display:block;">您的浏览器不支持 HTML5</video></div><div class="controls" style="margin-top:20px;display:flex;justify-content:center;gap:15px;"><button id="playBtn" style="padding:10px 20px;border-radius:20px;background:#e91e63;color:white;border:none;">播放/暂停</button><button id="fullBtn" style="padding:10px 20px;border-radius:20px;background:#00bcd4;color:white;border:none;">全屏显示</button></div></div></div><div id="bookstore-shelf" class="bookstore-page"><div class="page-content"><div class="shelf-empty" id="emptyShelf"><i class="fas fa-book-open"></i><div style="font-size:16px;margin-bottom:10px;">书架空空如也</div><div style="font-size:12px;color:#777;margin-bottom:20px;">快去发现好书加入书架吧</div><button class="header-btn" id="goDiscoverBtn">去发现好书</button></div><div id="shelfContent" style="display:none;"><div class="section-title"><span>我的书架</span><span class="section-more" id="editShelfBtn">编辑</span></div><div class="book-list" id="shelfBooks"></div></div></div></div><div id="bookstore-profile" class="bookstore-page"><div class="page-content"><div class="user-info-section"><div class="user-avatar"><div class="avatar-circle"><i class="fas fa-user"></i></div><div class="user-name-editable"><h2 id="user-display-name">游客用户</h2></div></div></div><ul class="menu-list"><li class="menu-item" id="myCollection"><div><i class="fas fa-bookmark"></i>我的收藏</div><i class="fas fa-chevron-right"></i></li><li class="menu-item" id="readingHistory"><div><i class="fas fa-history"></i>阅读历史</div><i class="fas fa-chevron-right"></i></li><li class="menu-item" id="myComments"><div><i class="fas fa-comment"></i>我的评论</div><i class="fas fa-chevron-right"></i></li><li class="menu-item" id="about"><div><i class="fas fa-info-circle"></i>关于谧笺</div><i class="fas fa-chevron-right"></i></li></ul></div></div></div></div></div></div><div id="username-edit-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center;"><div class="edit-name-content" style="width:300px;background:white;border-radius:8px;padding:20px;border:1px solid #000;"><div class="edit-name-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;"><h3 style="margin:0;color:#333;">编辑用户名</h3><button class="close-edit-name" style="background:none;border:none;font-size:20px;cursor:pointer;color:#333;">×</button></div><div style="margin-bottom:15px;"><label style="display:block;margin-bottom:5px;font-size:14px;color:#333;">用户名：</label><input type="text" id="username-input" class="edit-name-input" style="width:100%;padding:10px;border:1px solid #000;border-radius:4px;background:#fff;color:#333;" placeholder="请输入用户名" maxlength="20"></div><div class="edit-name-actions" style="display:flex;justify-content:flex-end;gap:10px;"><button class="edit-name-btn save" id="save-username-btn" style="padding:8px 16px;background:#000;color:#fff;border:none;border-radius:4px;cursor:pointer;">保存</button><button class="edit-name-btn cancel" id="cancel-username-btn" style="padding:8px 16px;background:#f0f0f0;color:#333;border:1px solid #000;border-radius:4px;cursor:pointer;">取消</button></div></div></div><div id="new-dream-modal"><div class="new-dream-content"><div class="new-dream-header"><h3>新梦境</h3><button class="close-new-dream">×</button></div><div class="new-dream-tabs"><button class="new-dream-tab active" data-tab="title">标题</button><button class="new-dream-tab" data-tab="intro">简介</button><button class="new-dream-tab" data-tab="relate">关联</button></div><div class="new-dream-body"><div class="new-dream-tab-content active" id="tab-title"><div class="new-dream-form-group"><label for="dream-title">梦境标题</label><input type="text" class="new-dream-input" id="dream-title" placeholder="请输入梦境标题..."></div></div><div class="new-dream-tab-content" id="tab-intro"><div class="new-dream-form-group"><label for="dream-intro">梦境简介</label><textarea class="new-dream-textarea" id="dream-intro" placeholder="请输入梦境简介..."></textarea></div></div><div class="new-dream-tab-content" id="tab-relate"><div class="new-dream-form-group"><label for="dream-roles">关联角色</label><div class="role-selector-container" id="dream-roles-container"></div></div><div class="new-dream-form-group"><label for="dream-worldbook">关联世界书</label><select class="new-dream-select" id="dream-worldbook"><option value="">选择世界书</option></select></div></div><div class="new-dream-actions"><button class="new-dream-btn save" id="save-dream-btn">保存梦境</button><button class="new-dream-btn cancel" id="cancel-dream-btn">取消</button></div></div></div></div><div id="edit-featured-modal" class="new-dream-modal"><div class="new-dream-content"><div class="new-dream-header"><h3>设置编辑推荐</h3><button class="close-edit-featured">×</button></div><div class="new-dream-body"><div class="book-selector-container"><div class="search-box" style="margin-bottom:15px;"><input type="text" class="search-input" id="featured-search" placeholder="搜索书籍..."></div><div class="book-selector-list" id="featured-book-list"><div class="book-selector-item" data-id="1"><div class="book-selector-title"><span>傲慢与偏见</span><span class="book-selector-badge">经典</span></div><div class="book-selector-meta"><span><i class="fas fa-user"></i> 简·奥斯汀</span><span><i class="fas fa-star"></i> 9.8</span></div><div class="book-selector-desc">19世纪英国社会的爱情与婚姻故事...</div></div></div></div><div class="new-dream-actions"><button class="new-dream-btn save" id="save-featured-btn">保存推荐</button><button class="new-dream-btn cancel" id="cancel-featured-btn">取消</button></div></div></div></div>

<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<!--   ✦ 奕阁界面 ✦       -->
<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<div class=interface id=construction-interface><div class=header><button class=back-button onclick=goBackToDesktop()>●</button><h1>奕阁<span class=status-indicator id=construction-status></span></h1></div><div class=scrollable-content><div class=construction-page id=construction-master-page><div style=padding:20px><h2 style=margin-bottom:15px>游戏大厅</h2><div class=game-quote>此后，将有群星闪耀因为我如今来过；此后将有百花绽放因为我从未离去</div><p style=color:#666;margin-bottom:20px>选择游戏开始畅玩</p><div class=game-list><div class=game-item onclick="openGamePage('gomoku')"><div class=game-icon>♦</div><div class=game-info><div class=game-name>五子棋</div><div class=game-desc>黑白对弈，五子连珠</div></div><div class=game-arrow>›</div></div><div class=game-item onclick="openGamePage('truth')"><div class=game-icon>♥</div><div class=game-info><div class=game-name>真心话</div><div class=game-desc>摇骰子问答，暧昧拉扯</div></div><div class=game-arrow>›</div></div></div></div></div><div class=construction-page id=construction-gomoku-page style=display:none><div style=padding:20px><div style=display:flex;align-items:center;justify-content:space-between;margin-bottom:15px><h2 style=margin:0>五子棋</h2><button class=gomoku-back-btn onclick="goBackToGameMaster()">返回</button></div><p style=color:#666;margin-bottom:20px>下方是独属你的博弈，黑棋为你，白棋为AI，黑子先手，AI会自动反击。</p><div id=gomoku-game-container></div></div></div><div class=construction-page id=construction-truth-page style=display:none><div style=padding:20px><div style=display:flex;align-items:center;justify-content:space-between;margin-bottom:15px><h2 style=margin:0>真心话</h2><button class=gomoku-back-btn onclick="goBackToGameMaster()">返回</button></div><p style=color:#666;margin-bottom:20px>下方是独属你的甜蜜，60句自定义深夜问答，让彼此心动感情快速升温。</p><div id=truth-game-container></div></div></div></div></div>

<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<!--   ✦ 国际汇界面 ✦       -->
<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<div class="interface" id="international-interface"><div class="header"><button class="back-button" onclick="goBackToDesktop()">●</button><h1>国际汇 <span id="international-status"></span><i class="fas fa-shopping-cart" style="position: absolute; left:140px; top:4px; cursor: pointer; color: #000;" onclick="openCart()"></i></h1></div><div class="scrollable-content"><div class="shop-container"><div class="search-bar"><div class="search-box"><i class="fas fa-search search-icon" id="international-search-icon"></i><input type="text" class="search-input" placeholder="搜索商品..." id="international-search-input"></div></div><div class="brands-scroll"><div class="brand-item active" onclick="internationalHandleBrandClick(this)">全部</div><div class="brand-item" onclick="internationalHandleBrandClick(this)">NIKE</div><div class="brand-item" onclick="internationalHandleBrandClick(this)">APPLE</div><div class="brand-item" onclick="internationalHandleBrandClick(this)">YSL</div><div class="brand-item" onclick="internationalHandleBrandClick(this)">SONY</div><div class="brand-item" onclick="internationalHandleBrandClick(this)">PRADA</div><div class="brand-item" onclick="internationalHandleBrandClick(this)">UNIQLO</div><div class="brand-item" onclick="internationalHandleBrandClick(this)">SAMSUNG</div><div class="brand-item add-brand-btn" onclick="internationalOpenAddBrandModal()"></div></div><div class="categories-scroll"><div class="category-item active" data-category="all" onclick="internationalHandleCategoryClick(this)">全部</div><div class="category-item" data-category="clothing" onclick="internationalHandleBrandClick(this)">服饰</div><div class="category-item" data-category="shoes" onclick="internationalHandleCategoryClick(this)">鞋靴</div><div class="category-item" data-category="digital" onclick="internationalHandleCategoryClick(this)">数码</div><div class="category-item" data-category="appliances" onclick="internationalHandleCategoryClick(this)">家电</div><div class="category-item" data-category="beauty" onclick="internationalHandleCategoryClick(this)">美妆</div><div class="category-item" data-category="home" onclick="internationalHandleCategoryClick(this)">家居</div><div class="category-item" data-category="food" onclick="internationalHandleCategoryClick(this)">食品</div><div class="category-item add-category-btn" onclick="internationalOpenAddCategoryModal()"></div></div><div class="products-grid"><div class="product-card" onclick="internationalOpenProductDetail('A-01 Linear Speaker','¥8,200')" data-category="digital"><div class="product-icon">Ａ</div><div class="product-info"><div class="product-name">A-01 Linear Speaker</div><div class="product-price">¥8,200</div></div><button class="delete-product-btn" onclick="event.stopPropagation();const card=this.parentNode;const name=card.querySelector('.product-name').textContent;card.remove();removeCustomProduct(name)"></button></div><div class="product-card" onclick="internationalOpenProductDetail('M1 Optics Lens','¥4,500')" data-category="digital"><div class="product-icon">Ｂ</div><div class="product-info"><div class="product-name">M1 Optics Lens</div><div class="product-price">¥4,500</div></div><button class="delete-product-btn" onclick="event.stopPropagation();const card=this.parentNode;const name=card.querySelector('.product-name').textContent;card.remove();removeCustomProduct(name)"></button></div><div class="product-card" onclick="internationalOpenProductDetail('Kinetic Watch','¥12,000')" data-category="digital"><div class="product-icon">Ｃ</div><div class="product-info"><div class="product-name">Kinetic Watch</div><div class="product-price">¥12,000</div></div><button class="delete-product-btn" onclick="event.stopPropagation();const card=this.parentNode;const name=card.querySelector('.product-name').textContent;card.remove();removeCustomProduct(name)"></button></div><div class="product-card" onclick="internationalOpenProductDetail('Minimalist Chair','¥3,800')" data-category="home"><div class="product-icon">Ｄ</div><div class="product-info"><div class="product-name">Minimalist Chair</div><div class="product-price">¥3,800</div></div><button class="delete-product-btn" onclick="event.stopPropagation();const card=this.parentNode;const name=card.querySelector('.product-name').textContent;card.remove();removeCustomProduct(name)"></button></div><div class="product-card" onclick="internationalOpenProductDetail('Wireless Headphones','¥1,200')" data-category="digital"><div class="product-icon">Ｅ</div><div class="product-info"><div class="product-name">Wireless Headphones</div><div class="product-price">¥1,200</div></div><button class="delete-product-btn" onclick="event.stopPropagation();const card=this.parentNode;const name=card.querySelector('.product-name').textContent;card.remove();removeCustomProduct(name)"></button></div><div class="product-card" onclick="internationalOpenProductDetail('White Sneakers','¥890')" data-category="shoes"><div class="product-icon">Ｆ</div><div class="product-info"><div class="product-name">White Sneakers</div><div class="product-price">¥890</div></div><button class="delete-product-btn" onclick="event.stopPropagation();const card=this.parentNode;const name=card.querySelector('.product-name').textContent;card.remove();removeCustomProduct(name)"></button></div><div class="product-card" onclick="internationalOpenProductDetail('Leather Backpack','¥1,500')" data-category="clothing"><div class="product-icon">Ｇ</div><div class="product-info"><div class="product-name">Leather Backpack</div><div class="product-price">¥1,500</div></div><button class="delete-product-btn" onclick="event.stopPropagation();const card=this.parentNode;const name=card.querySelector('.product-name').textContent;card.remove();removeCustomProduct(name)"></button></div><div class="product-card" onclick="internationalOpenProductDetail('Desk Lamp','¥450')" data-category="home"><div class="product-icon">Ｈ</div><div class="product-info"><div class="product-name">Desk Lamp</div><div class="product-price">¥450</div></div><button class="delete-product-btn" onclick="event.stopPropagation();const card=this.parentNode;const name=card.querySelector('.product-name').textContent;card.remove();removeCustomProduct(name)"></button></div><div class="product-card" onclick="internationalOpenProductDetail('Coffee Maker','¥2,100')" data-category="appliances"><div class="product-icon">Ｉ</div><div class="product-info"><div class="product-name">Coffee Maker</div><div class="product-price">¥2,100</div></div><button class="delete-product-btn" onclick="event.stopPropagation();const card=this.parentNode;const name=card.querySelector('.product-name').textContent;card.remove();removeCustomProduct(name)"></button></div><div class="product-card" onclick="internationalOpenProductDetail('Minimalist Watch','¥3,200')" data-category="digital"><div class="product-icon">Ｊ</div><div class="product-info"><div class="product-name">Minimalist Watch</div><div class="product-price">¥3,200</div></div><button class="delete-product-btn" onclick="event.stopPropagation();const card=this.parentNode;const name=card.querySelector('.product-name').textContent;card.remove();removeCustomProduct(name)"></button></div><div class="product-card" onclick="internationalOpenProductDetail('Bluetooth Speaker','¥680')" data-category="digital"><div class="product-icon">Ｋ</div><div class="product-info"><div class="product-name">Bluetooth Speaker</div><div class="product-price">¥680</div></div><button class="delete-product-btn" onclick="event.stopPropagation();const card=this.parentNode;const name=card.querySelector('.product-name').textContent;card.remove();removeCustomProduct(name)"></button></div><div class="product-card" onclick="internationalOpenProductDetail('Wireless Mouse','¥320')" data-category="digital"><div class="product-icon">Ｌ</div><div class="product-info"><div class="product-name">Wireless Mouse</div><div class="product-price">¥320</div></div><button class="delete-product-btn" onclick="event.stopPropagation();const card=this.parentNode;const name=card.querySelector('.product-name').textContent;card.remove();removeCustomProduct(name)"></button></div><div class="product-card" onclick="internationalOpenProductDetail('Minimalist Pen','¥120')" data-category="home"><div class="product-icon">Ｍ</div><div class="product-info"><div class="product-name">Minimalist Pen</div><div class="product-price">¥120</div></div><button class="delete-product-btn" onclick="event.stopPropagation();const card=this.parentNode;const name=card.querySelector('.product-name').textContent;card.remove();removeCustomProduct(name)"></button></div><div class="product-card" onclick="internationalOpenProductDetail('Laptop Stand','¥580')" data-category="digital"><div class="product-icon">Ｎ</div><div class="product-info"><div class="product-name">Laptop Stand</div><div class="product-price">¥580</div></div><button class="delete-product-btn" onclick="event.stopPropagation();const card=this.parentNode;const name=card.querySelector('.product-name').textContent;card.remove();removeCustomProduct(name)"></button></div><div class="product-card" onclick="internationalOpenProductDetail('Smartphone Case','¥280')" data-category="digital"><div class="product-icon">Ｏ</div><div class="product-info"><div class="product-name">Smartphone Case</div><div class="product-price">¥280</div></div><button class="delete-product-btn" onclick="event.stopPropagation();const card=this.parentNode;const name=card.querySelector('.product-name').textContent;card.remove();removeCustomProduct(name)"></button></div><div class="product-card" onclick="internationalOpenProductDetail('Sunglasses','¥890')" data-category="clothing"><div class="product-icon">Ｐ</div><div class="product-info"><div class="product-name">Sunglasses</div><div class="product-price">¥890</div></div><button class="delete-product-btn" onclick="event.stopPropagation();const card=this.parentNode;const name=card.querySelector('.product-name').textContent;card.remove();removeCustomProduct(name)"></button></div><div class="product-card" onclick="internationalOpenProductDetail('Leather Wallet','¥420')" data-category="clothing"><div class="product-icon">Ｑ</div><div class="product-info"><div class="product-name">Leather Wallet</div><div class="product-price">¥420</div></div><button class="delete-product-btn" onclick="event.stopPropagation();const card=this.parentNode;const name=card.querySelector('.product-name').textContent;card.remove();removeCustomProduct(name)"></button></div><div class="product-card" onclick="internationalOpenProductDetail('Yoga Mat','¥380')" data-category="sports"><div class="product-icon">Ｒ</div><div class="product-info"><div class="product-name">Yoga Mat</div><div class="product-price">¥380</div></div><button class="delete-product-btn" onclick="event.stopPropagation();const card=this.parentNode;const name=card.querySelector('.product-name').textContent;card.remove();removeCustomProduct(name)"></button></div><div class="product-card" onclick="internationalOpenProductDetail('Water Bottle','¥180')" data-category="home"><div class="product-icon">Ｓ</div><div class="product-info"><div class="product-name">Water Bottle</div><div class="product-price">¥180</div></div><button class="delete-product-btn" onclick="event.stopPropagation();const card=this.parentNode;const name=card.querySelector('.product-name').textContent;card.remove();removeCustomProduct(name)"></button></div><div class="product-card" onclick="internationalOpenProductDetail('Notebook Set','¥240')" data-category="home"><div class="product-icon">Ｔ</div><div class="product-info"><div class="product-name">Notebook Set</div><div class="product-price">¥240</div></div><button class="delete-product-btn" onclick="event.stopPropagation();const card=this.parentNode;const name=card.querySelector('.product-name').textContent;card.remove();removeCustomProduct(name)"></button></div><div class="product-card" onclick="internationalOpenProductDetail('Nike Air Max 270','¥1,299')" data-category="shoes" data-brand="NIKE"><div class="product-icon">Ｕ</div><div class="product-info"><div class="product-name">Nike Air Max 270</div><div class="product-price">¥1,299</div></div><button class="delete-product-btn" onclick="event.stopPropagation();const card=this.parentNode;const name=card.querySelector('.product-name').textContent;card.remove();removeCustomProduct(name)"></button></div><div class="product-card" onclick="internationalOpenProductDetail('Nike Dri-FIT T恤','¥299')" data-category="clothing" data-brand="NIKE"><div class="product-icon">Ｖ</div><div class="product-info"><div class="product-name">Nike Dri-FIT T恤</div><div class="product-price">¥299</div></div><button class="delete-product-btn" onclick="event.stopPropagation();const card=this.parentNode;const name=card.querySelector('.product-name').textContent;card.remove();removeCustomProduct(name)"></button></div><div class="product-card" onclick="internationalOpenProductDetail('Nike 运动短裤','¥399')" data-category="clothing" data-brand="NIKE"><div class="product-icon">Ｗ</div><div class="product-info"><div class="product-name">Nike 运动短裤</div><div class="product-price">¥399</div></div><button class="delete-product-btn" onclick="event.stopPropagation();const card=this.parentNode;const name=card.querySelector('.product-name').textContent;card.remove();removeCustomProduct(name)"></button></div><div class="product-card" onclick="internationalOpenProductDetail('iPhone 15 Pro','¥8,999')" data-category="digital" data-brand="APPLE"><div class="product-icon">Ｘ</div><div class="product-info"><div class="product-name">iPhone 15 Pro</div><div class="product-price">¥8,999</div></div><button class="delete-product-btn" onclick="event.stopPropagation();const card=this.parentNode;const name=card.querySelector('.product-name').textContent;card.remove();removeCustomProduct(name)"></button></div><div class="product-card" onclick="internationalOpenProductDetail('MacBook Air M2','¥9,499')" data-category="digital" data-brand="APPLE"><div class="product-icon">Ｙ</div><div class="product-info"><div class="product-name">MacBook Air M2</div><div class="product-price">¥9,499</div></div><button class="delete-product-btn" onclick="event.stopPropagation();const card=this.parentNode;const name=card.querySelector('.product-name').textContent;card.remove();removeCustomProduct(name)"></button></div><div class="product-card" onclick="internationalOpenProductDetail('AirPods Pro','¥1,899')" data-category="digital" data-brand="APPLE"><div class="product-icon">Ｚ</div><div class="product-info"><div class="product-name">AirPods Pro</div><div class="product-price">¥1,899</div></div><button class="delete-product-btn" onclick="event.stopPropagation();const card=this.parentNode;const name=card.querySelector('.product-name').textContent;card.remove();removeCustomProduct(name)"></button></div><div class="product-card" onclick="internationalOpenProductDetail('YSL 口红','¥380')" data-category="beauty" data-brand="YSL"><div class="product-icon">１</div><div class="product-info"><div class="product-name">YSL 口红</div><div class="product-price">¥380</div></div><button class="delete-product-btn" onclick="event.stopPropagation();const card=this.parentNode;const name=card.querySelector('.product-name').textContent;card.remove();removeCustomProduct(name)"></button></div><div class="product-card" onclick="internationalOpenProductDetail('YSL 香水','¥890')" data-category="beauty" data-brand="YSL"><div class="product-icon">２</div><div class="product-info"><div class="product-name">YSL 香水</div><div class="product-price">¥890</div></div><button class="delete-product-btn" onclick="event.stopPropagation();const card=this.parentNode;const name=card.querySelector('.product-name').textContent;card.remove();removeCustomProduct(name)"></button></div><div class="product-card" onclick="internationalOpenProductDetail('Sony WH-1000XM5','¥2,999')" data-category="digital" data-brand="SONY"><div class="product-icon">３</div><div class="product-info"><div class="product-name">Sony WH-1000XM5</div><div class="product-price">¥2,999</div></div><button class="delete-product-btn" onclick="event.stopPropagation();const card=this.parentNode;const name=card.querySelector('.product-name').textContent;card.remove();removeCustomProduct(name)"></button></div><div class="product-card" onclick="internationalOpenProductDetail('Sony PlayStation 5','¥3,899')" data-category="digital" data-brand="SONY"><div class="product-icon">４</div><div class="product-info"><div class="product-name">Sony PlayStation 5</div><div class="product-price">¥3,899</div></div><button class="delete-product-btn" onclick="event.stopPropagation();const card=this.parentNode;const name=card.querySelector('.product-name').textContent;card.remove();removeCustomProduct(name)"></button></div><div class="product-card" onclick="internationalOpenProductDetail('Prada 太阳镜','¥3,200')" data-category="clothing" data-brand="PRADA"><div class="product-icon">５</div><div class="product-info"><div class="product-name">Prada 太阳镜</div><div class="product-price">¥3,200</div></div><button class="delete-product-btn" onclick="event.stopPropagation();const card=this.parentNode;const name=card.querySelector('.product-name').textContent;card.remove();removeCustomProduct(name)"></button></div><div class="product-card" onclick="internationalOpenProductDetail('Prada 手提包','¥12,000')" data-category="clothing" data-brand="PRADA"><div class="product-icon">６</div><div class="product-info"><div class="product-name">Prada 手提包</div><div class="product-price">¥12,000</div></div><button class="delete-product-btn" onclick="event.stopPropagation();const card=this.parentNode;const name=card.querySelector('.product-name').textContent;card.remove();removeCustomProduct(name)"></button></div><div class="product-card" onclick="internationalOpenProductDetail('UNIQLO 羽绒服','¥699')" data-category="clothing" data-brand="UNIQLO"><div class="product-icon">７</div><div class="product-info"><div class="product-name">UNIQLO 羽绒服</div><div class="product-price">¥699</div></div><button class="delete-product-btn" onclick="event.stopPropagation();const card=this.parentNode;const name=card.querySelector('.product-name').textContent;card.remove();removeCustomProduct(name)"></button></div><div class="product-card" onclick="internationalOpenProductDetail('UNIQLO HEATTECH','¥199')" data-category="clothing" data-brand="UNIQLO"><div class="product-icon">８</div><div class="product-info"><div class="product-name">UNIQLO HEATTECH</div><div class="product-price">¥199</div></div><button class="delete-product-btn" onclick="event.stopPropagation();const card=this.parentNode;const name=card.querySelector('.product-name').textContent;card.remove();removeCustomProduct(name)"></button></div><div class="product-card" onclick="internationalOpenProductDetail('Samsung Galaxy S24','¥6,999')" data-category="digital" data-brand="SAMSUNG"><div class="product-icon">９</div><div class="product-info"><div class="product-name">Samsung Galaxy S24</div><div class="product-price">¥6,999</div></div><button class="delete-product-btn" onclick="event.stopPropagation();const card=this.parentNode;const name=card.querySelector('.product-name').textContent;card.remove();removeCustomProduct(name)"></button></div><div class="product-card" onclick="internationalOpenProductDetail('Samsung 电视','¥8,500')" data-category="appliances" data-brand="SAMSUNG"><div class="product-icon">10</div><div class="product-info"><div class="product-name">Samsung 电视</div><div class="product-price">¥8,500</div></div><button class="delete-product-btn" onclick="event.stopPropagation();const card=this.parentNode;const name=card.querySelector('.product-name').textContent;card.remove();removeCustomProduct(name)"></button></div><div class="product-card add-product-btn" onclick="internationalOpenAddProductModal()"><div class="product-icon">＋</div><div class="product-info"><div class="product-name">添加商品</div></div></div></div></div></div><div id="international-add-product-modal" class="international-modal" style="display:none;position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:999;align-items:center;justify-content:center"><div class="international-modal-content" style="background:#fff;padding:30px;border-radius:10px;width:90%;max-width:400px;border:2px solid #000"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px"><h2 style="margin:0;font-size:18px">添加商品</h2><button onclick="internationalCloseAddProductModal()" style="background:none;border:none;font-size:24px;cursor:pointer">×</button></div><div style="margin-bottom:15px"><label style="display:block;margin-bottom:5px;font-size:14px">名称</label><input type="text" id="international-product-name" placeholder="请输入商品名称（如：三星S23ultra）" style="width:100%;padding:10px;border:1px solid #000;border-radius:5px"></div><div style="margin-bottom:15px"><label style="display:block;margin-bottom:5px;font-size:14px">价格</label><input type="text" id="international-product-price" placeholder="请输入价格（如：9600）" style="width:100%;padding:10px;border:1px solid #000;border-radius:5px"></div><div style="margin-bottom:20px"><label style="display:block;margin-bottom:5px;font-size:14px">分类</label><select id="international-product-category" onchange="toggleCustomCategoryInput()" style="width:100%;padding:10px;border:1px solid #000;border-radius:5px"><option value="clothing">服饰</option><option value="shoes">鞋靴</option><option value="digital">数码</option><option value="appliances">家电</option><option value="beauty">美妆</option><option value="home">家居</option><option value="food">食品</option><option value="sports">运动</option><option value="custom">自定义</option></select><input type="text" id="international-custom-category-input" placeholder="请输入新的分类名称（如：笔记本）" style="display:none;width:100%;padding:10px;border:1px solid #000;border-radius:5px;margin-top:10px"></div><button onclick="internationalAddCustomProduct()" style="width:100%;padding:12px;background:#000;color:#fff;border:none;border-radius:5px;font-size:16px;cursor:pointer">添加</button></div></div><div id="international-add-category-modal" class="international-modal" style="display:none;position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:999;align-items:center;justify-content:center"><div class="international-modal-content" style="background:#fff;padding:30px;border-radius:10px;width:90%;max-width:400px;border:2px solid #000"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px"><h2 style="margin:0;font-size:18px">添加分类</h2><button onclick="internationalCloseAddCategoryModal()" style="background:none;border:none;font-size:24px;cursor:pointer">×</button></div><div style="margin-bottom:20px"><label style="display:block;margin-bottom:5px;font-size:14px">名称</label><input type="text" id="international-category-name" placeholder="请输入分类名（如：毛绒玩偶）" style="width:100%;padding:10px;border:1px solid #000;border-radius:5px"></div><button onclick="internationalAddCustomCategory()" style="width:100%;padding:12px;background:#000;color:#fff;border:none;border-radius:5px;font-size:16px;cursor:pointer">添加</button></div></div><div id="international-add-brand-modal" class="international-modal" style="display:none;position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:999;align-items:center;justify-content:center"><div class="international-modal-content" style="background:#fff;padding:30px;border-radius:10px;width:90%;max-width:400px;border:2px solid #000"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px"><h2 style="margin:0;font-size:18px">添加品牌</h2><button onclick="internationalCloseAddBrandModal()" style="background:none;border:none;font-size:24px;cursor:pointer">×</button></div><div style="margin-bottom:20px"><label style="display:block;margin-bottom:5px;font-size:14px">名称</label><input type="text" id="international-brand-name" placeholder="请输入品牌名（如：香奈儿）" style="width:100%;padding:10px;border:1px solid #000;border-radius:5px"></div><button onclick="internationalAddCustomBrand()" style="width:100%;padding:12px;background:#000;color:#fff;border:none;border-radius:5px;font-size:16px;cursor:pointer">添加</button></div></div><div id="nav-trigger" style="position:absolute;bottom:0;left:0;width:100%;height:50px;z-index:9998;background:transparent;"></div><div id="arc-nav" class="arc-menu" style="position:absolute;bottom:-150px;left:50%;transform:translateX(-50%);width:200px;height:150px;z-index:9999;transition:bottom 0.3s ease"><div class="nav-item" style="position:absolute;width:50px;height:50px;border-radius:50%;background:#000;color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:20px;top:20px;left:75px;box-shadow:0 2px 8px rgba(0,0,0,0.3)" onclick="switchPage('home')">⦿</div><div class="nav-item" style="position:absolute;width:50px;height:50px;border-radius:50%;background:#000;color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:20px;top:70px;left:25px;box-shadow:0 2px 8px rgba(0,0,0,0.3)" onclick="switchPage('orders')">◈</div><div class="nav-item" style="position:absolute;width:50px;height:50px;border-radius:50%;background:#000;color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:20px;top:70px;left:125px;box-shadow:0 2px 8px rgba(0,0,0,0.3)" onclick="switchPage('profile')">▣</div></div><div id="page-orders" class="full-page" style="display:none;"><h2>订单界面</h2><p>暂无订单记录</p></div><div id="page-profile" class="full-page" style="display:none;"><h2>个人中心</h2><p>这里是你的个人信息</p></div></div><div id="cart-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1000; align-items:center; justify-content:center;"><div style="background:#fff; padding:20px; border-radius:10px; width:80%; max-width:300px; text-align:center; border:2px solid #000;"><h3 style="margin-top:0;">我的购物车</h3><div id="cart-items-list" style="margin:20px 0; color:#666;">购物车还是空的哦~</div><button onclick="closeCart()" style="width:100%; padding:10px; background:#000; color:#fff; border:none; border-radius:5px; cursor:pointer;">关闭</button></div></div>

<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<!--   ✦ 锁屏界面 ✦       -->
<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<div class="lock-screen active" id="lock-screen"><div class="lock-screen-content"><div class="lock-icon" id="lock-icon"><i class="fas fa-lock"></i></div><div class="lock-time" id="lock-time">--:--</div><div class="lock-date" id="lock-date">--- --- --</div><div class="lock-weather" id="lock-weather"><div class="weather-location" id="weather-location">定位中...</div><div class="weather-info" id="weather-info">天气加载中...</div></div><div class="lock-quote" id="lock-quote"><div class="quote-text">Design is intelligence made visible.</div><div class="quote-author">— Alina Wheeler</div></div><div class="unlock-hint"><i class="fas fa-chevron-up"></i><span>上滑解锁</span></div></div><div class="lock-password-panel" id="lock-password-panel" style="display:none;position:absolute;top:0;left:0;width:100%;height:100%;background:#fff;border-radius:20px"><div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;padding:60px 20px 40px"><div class="password-time" style="font-size:80px;font-weight:700;margin-bottom:10px">--:--</div><div class="password-date" style="font-size:14px;color:#666;margin-bottom:40px">--- --- --</div><div style="width:250px;margin-bottom:30px"><input type="password" id="password-input" placeholder="输入密码" style="width:100%;padding:12px;border:2px solid #000;border-radius:8px;font-size:16px;text-align:center;outline:none"><div class="password-hint" style="text-align:center;font-size:12px;color:#666;height:20px;margin-top:10px"></div></div><div style="display:flex;gap:10px;width:250px"><button onclick="submitPassword()" style="flex:1;padding:12px;border:1px solid #000;background:#000;color:#fff;border-radius:8px;cursor:pointer;font-size:14px">解锁</button><button onclick="cancelPassword()" style="flex:1;padding:12px;border:1px solid #000;background:#fff;border-radius:8px;cursor:pointer;font-size:14px">取消</button></div></div></div></div>

<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<!--   ✦ 开机动画界面 ✦       -->
<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<div id="startup-overlay" style="position:absolute;top:-50px;left:-50px;width:calc(100% + 100px);height:calc(100% + 100px);background:#000;color:#fff;display:flex;justify-content:center;align-items:center;z-index:999;cursor:pointer;transition:opacity .8s ease"><style>.phone-container:has(#startup-overlay){background:#000!important}.screen:has(#startup-overlay){border-radius:0!important}@keyframes orbit1{0%{transform:rotate(0deg) translateX(150px) rotate(0deg) scale(1);opacity:1}100%{transform:rotate(360deg) translateX(150px) rotate(-360deg) scale(1.8);opacity:0}}@keyframes orbit2{0%{transform:rotate(180deg) translateX(140px) rotate(-180deg) scale(1);opacity:1}100%{transform:rotate(540deg) translateX(140px) rotate(-540deg) scale(1.8);opacity:0}}</style><div id="startup-container" style="position:absolute;top:50px;left:50px;width:calc(100% - 100px);height:calc(100% - 100px);display:flex;flex-direction:column;justify-content:center;align-items:center;transition:all .8s ease"><div style="text-align:center;margin-top:2vh;position:relative;display:inline-block"><h1 style="font-size:3.0rem;letter-spacing:8px;padding-left:12px;margin:0;line-height:1.4;font-weight:500">✤世纪✤<br><span style="font-size:200;letter-spacing:2px;opacity:.9;display:inline-block">Mini Phone</span></h1><span class="flower" style="position:absolute;left:50%;top:50%;opacity:0;font-size:3.2rem;margin-left:-.9rem;margin-top:-.9rem;transition:opacity .3s">✤</span><span class="flower" style="position:absolute;left:50%;top:50%;opacity:0;font-size:3.2rem;margin-left:-.9rem;margin-top:-.9rem;transition:opacity .3s">✤</span><p id="app-hint" style="margin-top:20px;font-size:100;opacity:.5;letter-spacing:10px;padding-left:20px">唤醒独属于你的世纪</p></div></div><script>document.getElementById("startup-overlay").addEventListener("click",function(){const t=this,e=document.getElementById("startup-container"),n=document.querySelectorAll(".flower"),o=document.getElementById("app-hint");o.style.opacity="0",n.forEach((t,e)=>{t.style.opacity="1",t.style.animation=(0===e?"orbit1":"orbit2")+" 1.5s cubic-bezier(0.4, 0, 0.2, 1) forwards"}),e.style.transform="scale(0.95)",setTimeout(()=>{e.style.opacity="0",t.style.opacity="0",setTimeout(()=>t.remove(),800)},1200)});</script></div>

<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<!--   ✦ 激活码界面 ✦       -->
<!-- ⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡⟡ -->
<div id=activation-modal style="position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:9999;display:flex;justify-content:center;align-items:center;color:#fff;flex-direction:column;text-align:center;padding:20px;"><h1 style=font-size:28px;margin-bottom:20px;>✤ 世纪小手机 ✤</h1><p style=margin-bottom:30px;max-width:400px;line-height:1.5;color:#ccc;>本站为私密站点，实行一机一码制。<br>请输入激活码以继续使用。</p><div style=width:300px;margin-bottom:20px;><input type=text id=activation-code placeholder=请输入激活码 style="width:100%;padding:15px;border:none;background:transparent;color:#fff;font-size:16px;border-radius:8px;text-align:center;letter-spacing:2px;"></div><div style=display:flex;gap:15px;margin-bottom:20px;><button id=activate-btn style="padding:12px 30px;background:transparent;color:#fff;border:2px solid #fff;border-radius:8px;font-size:16px;cursor:pointer;font-weight:bold;">激活设备</button><button onclick=toggleAdminPanel() style="padding:12px 30px;background:transparent;color:#fff;border:2px solid #fff;border-radius:8px;font-size:16px;cursor:pointer;">管理员</button></div><div style=margin-bottom:30px;><button onclick=showImportDialog() style="width:200px;padding:10px 20px;background:transparent;color:#fff;border:2px solid #ffffff;border-radius:8px;font-size:15px;cursor:pointer;">导入激活码</button></div><div id=activation-message style=margin-bottom:20px;min-height:40px;color:#ff6b6b;></div><div style="font-size:14px;color:#888;margin-top:20px;"><p>请联系管理员获取激活码</p><p>一机一码，禁止多设备共享</p></div></div><div id=admin-panel style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:330px;background:#fff;border:2px solid #000;border-radius:12px;z-index:10000;display:none;max-height:85vh;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,0.5);"><div style="background:#fff;color:#000;padding:25px 15px 10px;text-align:center;position:relative;"><span style="display:inline-block;font-size:25px;font-weight:bold;">系统管理后台</span><span onclick=toggleAdminPanel() style="cursor:pointer;position:absolute;right:15px;top:50%;transform:translateY(-50%);font-size:20px;font-weight:1000">✕</span></div><div id=admin-login style="padding:20px 15px;"><div style="text-align:center;margin-bottom:18px;"><h4 style="margin:0 0 10px;">管理员登录</h4><p style="color:#666;font-size:12px;margin:0;">请输入管理员密码</p></div><div style=margin-bottom:18px;><input type=password id=admin-password placeholder=输入密码 style="width:100%;padding:10px 12px;border:1px solid #000;border-radius:5px;font-size:13px;"></div><button onclick=loginAdmin() style="width:100%;padding:10px;background:#000;color:#fff;border:none;border-radius:5px;font-size:13px;cursor:pointer;font-weight:bold;">登录</button><div id=login-message style="margin-top:8px;color:#f44;font-size:12px;text-align:center;min-height:18px;"></div></div><div id=admin-content style=display:none;padding:15px;><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:12px;border-bottom:2px solid #000;"><h4 style="margin:0;font-size:14px;">数据管理</h4><div style=display:flex;gap:5px;><button onclick=showAddCodeForm() style="padding:5px 8px;background:#000;color:#fff;border:none;border-radius:4px;font-size:11px;cursor:pointer;">添加</button><button onclick=exportCodes() style="padding:5px 8px;background:#000;color:#fff;border:none;border-radius:4px;font-size:11px;cursor:pointer;">导出</button><button onclick=logoutAdmin() style="padding:5px 8px;background:#fff;border:1px solid #000;border-radius:4px;font-size:11px;cursor:pointer;">退出</button></div></div><div style=margin-bottom:15px;><div id=code-list style="height:180px;overflow-y:auto;border:1px solid #000;border-radius:5px;padding:8px;font-size:12px;"></div></div><div style="background:#f4f4f4;border-radius:8px;padding:12px;border:1px solid #ccc;"><h5 style="margin:0 0 8px;font-size:12px;text-align:center;">设备状态统计</h5><div style=display:flex;justify-content:space-around;><div style=text-align:center;><div style="font-size:16px;font-weight:bold;color:#000;" id=total-codes>0</div><div style="font-size:10px;color:#666;">总码数</div></div><div style=text-align:center;><div style="font-size:16px;font-weight:bold;color:#000;" id=used-codes>0</div><div style="font-size:10px;color:#666;">已激活</div></div></div></div><div id=add-code-form style="display:none;background:#fff;border:1px solid #000;border-radius:5px;padding:10px;margin-top:10px;"><div style=margin-bottom:10px;><label style="display:block;margin-bottom:5px;font-size:11px;">新激活码</label><div style=display:flex;gap:5px;><input type=text id=new-code-input style="flex:1;padding:6px;border:1px solid #000;border-radius:4px;font-size:11px;"><button onclick=generateCode() style="padding:6px;background:#000;color:#fff;border:none;border-radius:4px;font-size:11px;cursor:pointer;">生成</button></div></div><div style=display:flex;gap:5px;><button onclick=addCode() style="flex:1;padding:8px;background:#000;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:11px;">保存</button><button onclick=hideAddForm() style="flex:1;padding:8px;background:#fff;border:1px solid #000;border-radius:4px;cursor:pointer;font-size:11px;">取消</button></div></div></div></div>

<script>    
/***********************************
 * ✤ 基础配置与数据定义
 ***********************************/
//● 锁屏名言 
const lockScreenQuotesData=[{text:"Design is intelligence made visible.",author:"Alina Wheeler"},{text:"Simplicity is the ultimate sophistication.",author:"Leonardo da Vinci"},{text:"Less, but better.",author:"Dieter Rams"},{text:"The details are not the details. They make the design.",author:"Charles Eames"},{text:"Good design is as little design as possible.",author:"Dieter Rams"},{text:"Design is not just what it looks like and feels like. Design is how it works.",author:"Steve Jobs"},{text:"Typography is the craft of endowing human language with a durable visual form.",author:"Robert Bringhurst"},{text:"White space is like air: it is necessary for design to breathe.",author:"Wojciech Zieliński"},{text:"Design creates culture. Culture shapes values. Values determine the future.",author:"Robert L. Peters"},{text:"A designer knows he has achieved perfection not when there is nothing left to add, but when there is nothing left to take away.",author:"Antoine de Saint-Exupéry"}]; 
 
//● 水电费价格配置
const utilityPrices={"豪宅、庄园、城堡":{water:800,electricity:1200},"别墅、独栋":{water:500,electricity:800},"高档公寓、大平层":{water:300,electricity:500},"普通公寓、居民楼、小区":{water:150,electricity:300},"经济适用房、小户型":{water:100,electricity:200},"宿舍、合租房":{water:80,electricity:150},"老破小、旧房":{water:50,electricity:100},"农村自建房、乡村":{water:30,electricity:80}};

//● API 配置与模型列表
const API_ENDPOINTS = {openai: 'https://api.openai.com/v1',anthropic: 'https://api.anthropic.com/v1',google: 'https://generativelanguage.googleapis.com/v1'};const MODEL_LISTS = {openai: ['gpt-4', 'gpt-4-turbo', 'gpt-3.5-turbo', 'gpt-3.5-turbo-16k'],anthropic: ['claude-3-opus', 'claude-3-sonnet', 'claude-3-haiku'],google: ['gemini-pro', 'gemini-pro-vision']};

//● 外卖系统基础数据
const chineseSurnames = ["王", "李", "张", "刘", "陈", "杨", "赵", "黄", "周", "吴", "徐", "孙", "胡", "朱", "高", "林", "何", "郭", "马", "罗", "梁", "宋", "郑", "谢", "韩", "唐", "冯", "于", "董", "萧", "程", "曹", "袁", "邓", "许", "傅", "沈", "曾", "彭", "吕"];const foodData = [{ id: 1, name: "招牌黑椒牛肉汉堡", description: "厚实的澳洲牛肉饼搭配浓郁黑椒酱汁，金黄酥脆的面包裹着新鲜蔬菜，层次丰富，肉质鲜嫩多汁。", features: ["厚实牛肉饼", "黑椒酱汁", "金黄面包", "新鲜蔬菜"], price: 38.8, icon: "fas fa-hamburger", category: "汉堡", isFavorite: false },{ id: 2, name: "经典玛格丽特披萨", description: "薄脆饼底上铺满香浓马苏里拉奶酪和新鲜番茄酱，撒上罗勒叶，烤制后奶酪拉丝，香气四溢。", features: ["薄脆饼底", "马苏里拉奶酪", "番茄酱", "罗勒叶"], price: 68.5, icon: "fas fa-pizza-slice", category: "披萨", isFavorite: false },{ id: 3, name: "川味麻辣香锅", description: "多种新鲜食材搭配秘制麻辣香料炒制，色泽红亮，香气扑鼻，麻辣鲜香，回味无穷。", features: ["秘制香料", "多种食材", "麻辣鲜香", "色泽红亮"], price: 45.9, icon: "fas fa-bowl-food", category: "中餐", isFavorite: false },{ id: 4, name: "手冲精品咖啡", description: "精选阿拉比卡咖啡豆，手工现磨现冲，口感醇厚顺滑，带有坚果和巧克力的香气。", features: ["阿拉比卡豆", "手工现冲", "醇厚顺滑", "坚果香气"], price: 28.8, icon: "fas fa-mug-hot", category: "饮品", isFavorite: false },{ id: 5, name: "抹茶千层蛋糕", description: "层层叠叠的抹茶薄饼与淡奶油交替叠加，外形整齐美观，口感细腻，抹茶香气浓郁。", features: ["抹茶薄饼", "淡奶油", "层次分明", "香气浓郁"], price: 32.9, icon: "fas fa-ice-cream", category: "甜点", isFavorite: false },{ id: 6, name: "香酥炸鸡桶", description: "外皮金黄酥脆，内里鸡肉鲜嫩多汁，搭配特制香料，香气扑鼻，口感层次丰富。", features: ["金黄酥脆", "鲜嫩多汁", "特制香料", "香气扑鼻"], price: 55.5, icon: "fas fa-drumstick-bite", category: "炸鸡", isFavorite: false },{ id: 7, name: "法式可颂面包", description: "外形呈现完美层次，外皮金黄酥脆，内里柔软有弹性，黄油香气浓郁。", features: ["完美层次", "金黄酥脆", "柔软弹性", "黄油香气"], price: 18.8, icon: "fas fa-bread-slice", category: "面包", isFavorite: false },{ id: 8, name: "台式珍珠奶茶", description: "茶香浓郁，奶味醇厚，珍珠Q弹有嚼劲，甜度适中，口感丰富顺滑。", features: ["茶香浓郁", "奶味醇厚", "珍珠Q弹", "口感顺滑"], price: 22.5, icon: "fas fa-wine-bottle", category: "饮品", isFavorite: false }];

/***********************************
* ✤ 核心管理
 ***********************************/
//● 世界书管理器：处理设定集记录的增删改查
class WorldbookManager{constructor(){this.records=JSON.parse(localStorage.getItem('worldbook')||'[]');this.currentEditingId=null;}addRecord(title,content){if(!title||title.trim()===''||!content||content.trim()==='')return null;const record={id:Date.now()+'-'+Math.random().toString(36).substr(2,9),title:title,content:content,active:true,timestamp:new Date().toISOString()};this.records.push(record);this.saveRecords();return record;}updateRecord(id,title,content){const record=this.records.find(r=>r.id===id);if(record){record.title=title||record.title;record.content=content||record.content;record.timestamp=new Date().toISOString();this.saveRecords();return true;}return false;}deleteRecord(id){const index=this.records.findIndex(r=>r.id===id);if(index!==-1){this.records.splice(index,1);this.saveRecords();return true;}return false;}toggleRecord(id){const record=this.records.find(r=>r.id===id);if(record){record.active=!record.active;this.saveRecords();return record.active;}return false;}getActiveRecords(){return this.records.filter(r=>r.active);}getAllRecords(){return[...this.records];}getRecordById(id){return this.records.find(r=>r.id===id);}saveRecords(){try{localStorage.setItem('worldbook',JSON.stringify(this.records));}catch(e){console.log('存储失败');}}}

//● 多人设管理器：处理多聊模式的角色
class MultiPersonaManager{constructor(){this.personas=JSON.parse(localStorage.getItem('multiPersonas')||'[]');this.currentPersonaId=JSON.parse(localStorage.getItem('currentMultiPersonaId')||'null');}addPersona(name,description){if(!name||name.trim()==='')return null;const persona={id:Date.now()+'-'+Math.random().toString(36).substr(2,9),name:name,description:description||'',timestamp:new Date().toISOString()};this.personas.push(persona);this.savePersonas();return persona;}updatePersona(id,name,description){const persona=this.personas.find(p=>p.id===id);if(persona){persona.name=name||persona.name;persona.description=description||persona.description;persona.timestamp=new Date().toISOString();this.savePersonas();return true;}return false;}deletePersona(id){const index=this.personas.findIndex(p=>p.id===id);if(index!==-1){this.personas.splice(index,1);this.savePersonas();if(this.currentPersonaId===id){this.currentPersonaId=this.personas.length>0?this.personas[0].id:null;this.saveCurrentPersonaId();}return true;}return false;}getPersonaById(id){return this.personas.find(p=>p.id===id);}getCurrentPersona(){if(!this.currentPersonaId&&this.personas.length>0){this.currentPersonaId=this.personas[0].id;this.saveCurrentPersonaId();}return this.personas.find(p=>p.id===this.currentPersonaId);}setCurrentPersona(id){this.currentPersonaId=id;this.saveCurrentPersonaId();}getAllPersonas(){return[...this.personas];}getPersonaCount(){return this.personas.length;}savePersonas(){try{localStorage.setItem('multiPersonas',JSON.stringify(this.personas));}catch(e){console.log('存储失败');}}saveCurrentPersonaId(){try{localStorage.setItem('currentMultiPersonaId',JSON.stringify(this.currentPersonaId));}catch(e){console.log('存储失败');}}}

//● 聊天管理器：处理消息队列、存储和事件监听
class ChatManager{constructor(){this.messages=JSON.parse(localStorage.getItem("chatMessages")||'[]');this.currentEditingId=null;this.listeners=[];this.messages=this.createObservableArray(this.messages);}createObservableArray(e){const t=this;return new Proxy(e,{set(e,s,a){const n=Reflect.set(e,s,a);t.notifyListeners("messagesChanged",e);t.saveMessages();return n;},get(e,s){const a=Reflect.get(e,s);return"function"==typeof a?function(...n){const i=a.apply(e,n);return["push","pop","shift","unshift","splice"].includes(s)&&(t.notifyListeners("messagesChanged",e),t.saveMessages()),i}:a;}})}addListener(e,t){this.listeners.push({event:e,callback:t});}notifyListeners(e,t){this.listeners.forEach(s=>{s.event===e&&s.callback(t);});}saveMessages(){try{localStorage.setItem("chatMessages",JSON.stringify(this.messages));}catch(e){console.log('存储失败');}}addMessage(e,t,s="",a=null,n="text"){if(!s){if("user"===e){const i=JSON.parse(localStorage.getItem("userPersona")||"{}");s=i.name||"您";}else if("single"===appState.chatType){const r=JSON.parse(localStorage.getItem("aiPersona")||"{}");s=r.name||"助手";}else{const o=appState.multiPersonaManager.getCurrentPersona();s=o?o.name:"助手";}}if(!t||t.trim()==='')return null;const i={id:Date.now()+'-'+Math.random().toString(36).substr(2,9),sender:e,senderName:s,content:t,personaId:a,type:n,timestamp:(new Date).toISOString()};return this.messages.push(i),i;}updateMessage(e,t){const s=this.messages.find(t=>t.id===e);if(!s||!t||t.trim()==='')return false;s.content=t;s.timestamp=(new Date).toISOString();this.saveMessages();this.notifyListeners("messageUpdated",s);return true;}deleteMessage(e){const t=this.messages.findIndex(t=>t.id===e);if(-1!==t){const s=this.messages[t];this.messages.splice(t,1);this.saveMessages();this.notifyListeners("messageDeleted",s);return true;}return false;}deleteMessages(e){const t=e.length;if(t===0)return 0;e.sort((e,t)=>t-e).forEach(e=>{const t=this.messages.findIndex(t=>t.id===e);-1!==t&&this.messages.splice(t,1);});this.saveMessages();this.notifyListeners("messagesChanged",this.messages);return t;}clearAllMessages(){const e=this.messages.length;this.messages.length=0;this.saveMessages();this.notifyListeners("messagesChanged",this.messages);return e;}getMessages(){return[...this.messages];}getMessageCount(){return this.messages.length;}}

//● 聊天API 服务：处理与 AI 接口的通信
class ApiService{constructor(){this.config=JSON.parse(localStorage.getItem("apiConfig")||'{"provider":"openai","apiKey":"","apiUrl":"https://api.openai.com/v1","model":"gpt-3.5-turbo","replyCount":1}');}async getModels(){try{const e=await fetch(`${this.config.apiUrl}/models`,{method:"GET",headers:{Authorization:`Bearer ${this.config.apiKey}`,"Content-Type":"application/json"}});if(!e.ok){const t=await e.json();throw new Error(t.error?t.error.message:`API请求失败:${e.status}`);}const t=await e.json();return t.data.map(e=>e.id);}catch(e){console.error("获取模型列表失败:",e);throw e;}}cleanBracketsContent(e){return e.replace(/\([^)]*\)/g,"").replace(/（[^）]*）/g,"").replace(/【[^】]*】/g,"").replace(/\[[^\]]*\]/g,"").replace(/\{[^}]*\}/g,"").replace(/〈[^〉]*〉/g,"").replace(/《[^》]*》/g,"").replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"").replace(/^\s*[：:]\s*/,"").trim();}cleanUsernamePrefix(e){return e.replace(/^\[\s*[^\]]*\s*\]\s*[:：]\s*/,"").replace(/^[^:：]*[:：]\s*/,"");}async chatWithRole(e,t,s=.7,a=1,n="online",i="single",r=""){if(!this.config.apiKey)throw new Error("API密钥未配置");if(!t||t.trim()==='')throw new Error("消息内容不能为空");const o=JSON.parse(localStorage.getItem("aiPersona")||"{}"),c=JSON.parse(localStorage.getItem("userPersona")||"{}"),l=appState.worldbookManager.getActiveRecords();let d="";if("multi"===i){d=`你现在的身份是：${r}。\n\n你的详细人设如下：\n${e}\n\n【场景说明】\n这是一个多人聊天群组（Group Chat）。\n请时刻保持你的角色设定，不要跳出戏，不要说自己是AI或语言模型。\n你需要根据群里的对话内容，以${r}的口吻进行回复。`;"online"===n?d+=`\n\n【严格指令：线上模式（短信模式）】\n1. 回复必须简短精炼，像日常短信对话\n2. 使用日常说话语气，自然亲切\n3. 禁止使用括号描写动作、表情或心理活动\n4. 禁止使用任何文学性修饰词\n5. 只能有纯文本对话内容，不能有任何描述性文字\n6. 尽量使用短句，表达直接\n7. 回复长度控制在100字以内\n8. 格式示例：\n   错误：(微笑)你好啊，今天天气不错\n   正确：你好，今天天气不错\n\n重要：你的回复必须严格遵守以上规则，只能输出对话内容，不能有任何括号、描述或说明性文字。\n\n注意：即使历史消息中包含括号内容，你也必须忽略它们，按照线上模式的要求回复。`:"offline"===n&&(d+="\n\n重要：请使用线下模式（剧情模式）回复：\n1. 回复要详细、有画面感，像小说剧情\n2. 使用唯美、文学性的语言，可以大量使用修饰词\n3. 注重情感表达和氛围营造\n4. 可以展开想象，创造生动的场景和细节\n5. 回复可以较长，200-500字为宜\n6. 保持角色的一致性，让对话有剧情推进感");if(c.name||c.description){d+="\n\n和你对话的用户设定：";c.name&&(d+=`\n- 姓名：${c.name}`);c.description&&(d+=`\n- 描述：${c.description}`);}}else{d=e;if(o.name||o.description){d+="\n\n角色信息：";o.name&&(d+=`\n- 姓名：${o.name}`);o.description&&(d+=`\n- 描述：${o.description}`);}if(c.name||c.description){d+="\n\n用户信息：";c.name&&(d+=`\n- 姓名：${c.name}`);c.description&&(d+=`\n- 描述：${c.description}`);d+=`\n\n[系统指令]：请严格根据"用户信息"中的描述确认用户的性别。如果描述中提到是女性，请使用"她"或女性称呼；如果是男性，使用"他"。`;}}"online"===n&&!d.includes("【严格指令：线上模式（短信模式）】")?d+="\n\n【严格指令：线上模式（短信模式）】\n1. 回复必须简短精炼，像日常短信对话\n2. 使用日常说话语气，自然亲切\n3. 禁止使用括号描写动作、表情或心理活动\n4. 禁止使用任何文学性修饰词\n5. 只能有纯文本对话内容，不能有任何描述性文字\n6. 尽量使用短句，表达直接\n7. 回复长度控制在100字以内\n8. 格式示例：\n   错误：(微笑)你好啊，今天天气不错\n   正确：你好，今天天气不错\n\n重要：你的回复必须严格遵守以上规则，只能输出对话内容，不能有任何括号、描述或说明性文字。\n\n注意：即使历史消息中包含括号内容，你也必须忽略它们，按照线上模式的要求回复。":"offline"===n&&!d.includes("线下模式（剧情模式）")&&(d+="\n\n重要：请使用线下模式（剧情模式）回复：\n1. 回复要详细、有画面感，像小说剧情\n2. 使用唯美、文学性的语言，可以大量使用修饰词\n3. 注重情感表达和氛围营造\n4. 可以展开想象，创造生动的场景和细节\n5. 回复可以较长，200-500字为宜\n6. 保持角色的一致性，让对话有剧情推进感");l.length>0&&(d+="\n\n世界书记录：",l.forEach((e,t)=>{d+=`\n${t+1}. ${e.content}`;}));a>1&&(d+=`\n\n重要：请连续回复${a}条消息，这些回复应该是自然的、连贯的对话。\n示例：\n用户说："你好"\n你应该回复：\n你好！今天过得怎么样？\n|||\n我是AI助手，有什么可以帮你的吗？\n|||\n看起来你今天心情不错呢！\n注意：\n1. 每条回复都应该是对话的自然延续\n2. 不要添加任何序号前缀（如"第二条消息："、"回复2："等）\n3. 不要添加任何说明性文字\n4. 每条回复之间用"|||"分隔\n5. 保持语气和角色的一致性，让对话有剧情推进感`);const h=appState.chatManager.getMessages().filter(e=>"正在思考..."!==e.content&&e.content!==t).slice(-15),u=[{role:"system",content:d}];if("multi"===i){h.forEach(e=>{let t=e.senderName;t||(t="user"===e.sender?c.name||"用户":r);let s=e.content;"online"===n&&(s=this.cleanBracketsContent(s));const a=`[${t}]: ${s}`;u.push("user"===e.sender?{role:"user",content:a}:{role:"assistant",content:a});});const p=c.name||"我";u.push({role:"user",content:`[${p}]: ${t}`});}else{h.forEach(e=>{const s=e.sender;let a=e.content;"online"===n&&(a=this.cleanBracketsContent(a));u.push("user"===s?{role:"user",content:a}:{role:"assistant",content:a});});u.push({role:"user",content:t});}try{const e=await fetch(`${this.config.apiUrl}/chat/completions`,{method:"POST",headers:{Authorization:`Bearer ${this.config.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:this.config.model,messages:u,temperature:s,max_tokens:parseInt(document.getElementById("max-tokens")?document.getElementById("max-tokens").value:1000)||1000})});if(!e.ok){const t=await e.json();throw new Error(`API请求失败:${t.error?t.error.message:e.status}`);}const n=await e.json();let i=n.choices[0].message.content;i=this.cleanUsernamePrefix(i);"online"===n&&(i=this.cleanBracketsContent(i));let l=[];if(a>1){l=i.split(/\|\|\|/).map(e=>e.trim()).filter(e=>e.length>0);l=l.map(e=>e.replace(/^(第[一二三四五六七八九十\d]+条(消息|回复)[:：]\s*)/,"").replace(/^((回复|消息)[一二三四五六七八九十\d]+[:：]\s*)/,"").replace(/^((回复|消息)[\d]+[:：]\s*)/,"").replace(/^[\d]+[\.、:：]\s*/,"").trim()).filter(e=>e.length>0);if(l.length<=1&&i.includes("\n")){const e=i.split("\n").map(e=>e.trim()).filter(e=>e.length>0&&!e.startsWith("回复")&&!e.startsWith("第")&&!e.match(/^\d+[\.:：]/)&&!e.includes("|||"));e.length>1&&(l=e);}l=l.length<=1?[i]:l.slice(0,a);}else l=[i];return l;}catch(e){console.error("API调用失败:",e);throw e;}}async generateRawContent(e,t,s=.8){if(!this.config.apiKey)throw new Error("API密钥未配置");if(!t||t.trim()==='')throw new Error("生成内容不能为空");const a=[{role:"system",content:e},{role:"user",content:t}];try{const e=await fetch(`${this.config.apiUrl}/chat/completions`,{method:"POST",headers:{Authorization:`Bearer ${this.config.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:this.config.model,messages:a,temperature:s,max_tokens:500})});if(!e.ok)throw new Error(`API请求失败:${e.status}`);const t=await e.json();return t.choices[0].message.content;}catch(e){console.error("API generateRawContent 调用失败:",e);throw e;}}async testConnection(){try{const e=await this.getModels();return{success:true,models:e};}catch(e){return{success:false,error:e.message};}}updateConfig(e){this.config={...this.config,...e};try{localStorage.setItem("apiConfig",JSON.stringify(this.config));}catch(e){console.log('存储失败');}}getCurrentConfig(){return{...this.config};}}

//● 语音API 服务：处理与 AI 接口的说话
class MinimaxTtsService{constructor(){this.config=JSON.parse(localStorage.getItem('minimaxTtsConfig')||'{"apiKey":"","groupId":"","apiUrl":"https://api.minimaxi.com/v1","enabled":false}');this.models=JSON.parse(localStorage.getItem('minimaxModels')||'[]');this.voices=JSON.parse(localStorage.getItem('minimaxVoices')||'[]');this.lastUpdated=localStorage.getItem('minimaxLastUpdated')||'从未';}async getModels(){try{const e=await fetch(`${this.config.apiUrl}/models`,{method:'GET',headers:{'Authorization':`Bearer ${this.config.apiKey}`,'Content-Type':'application/json'}});if(!e.ok){const t=await e.json();throw new Error(t.error?.message||`请求失败:${e.status}`);}const t=await e.json();this.models=t.models?.filter(e=>e.id.includes('speech'))||[];this.saveModels();this.updateLastUpdated();return this.models;}catch(e){console.error('获取Minimax模型失败:',e);throw e;}}async getVoices(e=''){try{let t=`${this.config.apiUrl}/t2a_voice_list`;e&&(t+=`?model=${encodeURIComponent(e)}`);const a=await fetch(t,{method:'GET',headers:{'Authorization':`Bearer ${this.config.apiKey}`,'Content-Type':'application/json'}});if(!a.ok){const e=await a.json();throw new Error(e.error?.message||`请求失败:${a.status}`);}const n=await a.json();this.voices=n.voice_list?.map(e=>({id:e.voice_id,name:e.voice_name||`声音${e.voice_id}`,gender:e.gender===1?'female':'male',model:e.model||'speech-01',languages:['zh-CN','en-US'],timbre_type:e.timbre_type||0}))||[];this.saveVoices();this.updateLastUpdated();return this.voices;}catch(e){console.error('获取Minimax语音失败:',e);throw e;}}async textToSpeech(e,t='',a='speech-01',n=1){try{const i=t||this.voices[0]?.id;if(!i)throw new Error('请先选择语音');if(!e||e.trim()==='')throw new Error('文本内容不能为空');const r={text:e,model:a,voice_id:i,speed:n,vol:1,pitch:0,timbre_type:0,response_format:'mp3'};this.config.groupId&&(r.group_id=this.config.groupId);const o=await fetch(`${this.config.apiUrl}/text_to_speech`,{method:'POST',headers:{'Authorization':`Bearer ${this.config.apiKey}`,'Content-Type':'application/json'},body:JSON.stringify(r)});if(!o.ok){const e=await o.json();throw new Error(e.error?.message||`TTS转换失败:${o.status}`);}const s=await o.blob();return s;}catch(e){console.error('Minimax TTS转换失败:',e);throw e;}}async testConnection(){try{const e=await this.getModels();return{success:!0,models:e.length,message:`连接成功！发现${e.length}个可用模型`};}catch(e){return{success:!1,error:e.message};}}updateConfig(e){this.config={...this.config,...e};this.saveConfig();}getCurrentConfig(){return{...this.config};}saveConfig(){try{localStorage.setItem('minimaxTtsConfig',JSON.stringify(this.config));}catch(e){console.log('Minimax配置存储失败');}}saveModels(){try{localStorage.setItem('minimaxModels',JSON.stringify(this.models));}catch(e){console.log('Minimax模型存储失败');}}saveVoices(){try{localStorage.setItem('minimaxVoices',JSON.stringify(this.voices));}catch(e){console.log('Minimax语音存储失败');}}updateLastUpdated(){const e=new Date;this.lastUpdated=`${e.getHours().toString().padStart(2,'0')}:${e.getMinutes().toString().padStart(2,'0')}`,localStorage.setItem('minimaxLastUpdated',this.lastUpdated);}}

/***********************************
* ✤ 功能管理
 ***********************************/
//● 锁屏管理 
const lockScreen={quotes:lockScreenQuotesData,init:function(){this.bindEvents(),this.updateTime(),this.updateQuote(),this.getLocation(),setInterval(()=>this.updateTime(),6e4),setInterval(()=>this.updateQuote(),3e4)},bindEvents:function(){const e=document.getElementById("lock-screen");let t=0,a=0,o=!1;e.addEventListener("touchstart",e=>{t=e.touches[0].clientY,o=!0,e.style.transition="none"}),e.addEventListener("touchmove",e=>{if(!o)return;a=e.touches[0].clientY;const n=t-a;n>0&&(e.style.transform=`translateY(-${Math.min(n/150,1)*100}%)`,document.getElementById("lock-icon").style.transform=`translateY(-${Math.min(n/150,1)*20}px) scale(${1+Math.min(n/150,1)*.2})`)}),e.addEventListener("touchend",()=>{if(!o)return;o=!1,e.style.transition="transform .6s cubic-bezier(0.4,0,0.2,1)";const n=t-a;n>100?this.unlock():(e.style.transform="translateY(0)",document.getElementById("lock-icon").style.transform="translateY(0) scale(1)")}),e.addEventListener("mousedown",e=>{t=e.clientY,o=!0,e.style.transition="none",e.preventDefault()}),document.addEventListener("mousemove",e=>{if(!o)return;a=e.clientY;const n=t-a;n>0&&(document.getElementById("lock-screen").style.transform=`translateY(-${Math.min(n/150,1)*100}%)`,document.getElementById("lock-icon").style.transform=`translateY(-${Math.min(n/150,1)*20}px) scale(${1+Math.min(n/150,1)*.2})`)}),document.addEventListener("mouseup",()=>{if(!o)return;o=!1;const e=document.getElementById("lock-screen");e.style.transition="transform .6s cubic-bezier(0.4,0,0.2,1)";const n=t-a;n>100?this.unlock():(e.style.transform="translateY(0)",document.getElementById("lock-icon").style.transform="translateY(0) scale(1)")})},updateTime:function(){const e=new Date,a=e.getHours().toString().padStart(2,"0")+":"+e.getMinutes().toString().padStart(2,"0"),o=e.toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"});document.getElementById("lock-time").textContent=a,document.getElementById("lock-date").textContent=o},updateQuote:function(){const e=this.quotes[Math.floor(Math.random()*this.quotes.length)];document.getElementById("lock-quote").innerHTML=`<div class="quote-text">${e.text}</div><div class="quote-author">— ${e.author}</div>`},unlock:function(){const e=document.getElementById("lock-screen"),t=document.getElementById("lock-icon");t.classList.add("unlocking"),e.classList.add("unlocking"),setTimeout(()=>{e.classList.remove("active","unlocking"),t.classList.remove("unlocking"),e.style.transform="translateY(0)",t.style.transform="translateY(0) scale(1)",document.getElementById("desktop-interface").classList.add("active")},600)},lock:function(){const e=document.getElementById("lock-screen");e.classList.add("active"),this.updateTime(),this.updateQuote(),document.getElementById("desktop-interface").classList.remove("active")},getLocation:function(){navigator.geolocation?navigator.geolocation.getCurrentPosition(e=>{this.getWeatherByCoords(e.coords.latitude,e.coords.longitude)},()=>{this.updateWeather("Beijing","北京", "位置服务已关闭", "--")},{timeout:1e4}):this.updateWeather("Beijing","北京","无法获取位置","--")},getWeatherByCoords:async function(e,t){try{const a=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${e}&longitude=${t}&current_weather=true`);if(!a.ok)throw new Error("天气API请求失败");const n=await a.json(),o=n.current_weather.temperature.toFixed(0),r=n.current_weather.weathercode,l={0:"晴",1:"晴",2:"局部多云",3:"多云",45:"雾",48:"雾凇",51:"小雨",53:"中雨",55:"大雨",56:"冻雨",57:"冻雨",61:"阵雨",63:"中雨",65:"大雨",66:"冻雨",67:"冻雨",71:"小雪",73:"中雪",75:"大雪",77:"冰雹",80:"阵雨",81:"中雨",82:"大雨",85:"阵雪",86:"大雪",95:"雷暴",96:"雷暴",99:"雷暴"};let i=l[r]||"未知";try{const s=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e}&lon=${t}`),c=await s.json(),d=c.address.city||c.address.town||c.address.village||"当前位置";this.updateWeather(d,null,i,o)}catch(s){this.updateWeather("当前位置",null,i,o)}}catch(a){console.error("获取天气失败:",a),this.updateWeather("本地",null,"天气更新失败","--")}},updateWeather:function(e,t,a,n){document.getElementById("weather-location").innerHTML=`<i class="fas fa-map-marker-alt"></i> ${e}`,document.getElementById("weather-info").textContent=a&&n?`${a} ${n}°C`:"天气加载中"}};

//● 锁屏密码管理  
const lockPassword={showPasswordPanel:function(){const e=new Date;document.querySelector('.password-time').textContent=e.getHours().toString().padStart(2,'0')+':'+e.getMinutes().toString().padStart(2,'0'),document.querySelector('.password-date').textContent=e.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'}),document.getElementById('lock-password-panel').style.display='block',document.getElementById('password-input').value='',document.getElementById('password-input').focus(),document.querySelector('.password-hint').textContent='输入密码',document.querySelector('.password-hint').style.color=''},hidePasswordPanel:function(){document.getElementById('lock-password-panel').style.display='none',document.getElementById('password-input').value=''},verifyPassword:function(){const e=document.getElementById('password-input').value,t=localStorage.getItem('lockScreenPassword');if(!t)return this.unlockDevice();e===t?(document.querySelector('.password-hint').textContent='密码正确',document.querySelector('.password-hint').style.color='#0a0',setTimeout(()=>{this.unlockDevice()},500)):(document.querySelector('.password-hint').textContent='密码错误，请重试',document.querySelector('.password-hint').style.color='#f44',document.getElementById('password-input').value='',setTimeout(()=>{document.querySelector('.password-hint').textContent='输入密码',document.querySelector('.password-hint').style.color=''},1e3))},unlockDevice:function(){originalUnlock.call(lockScreen),this.hidePasswordPanel()},cancelPassword:function(){this.hidePasswordPanel();const e=document.getElementById('lock-screen');e.style.transform='translateY(0)';const t=document.getElementById('lock-icon');t.style.transform='translateY(0) scale(1)'}}; 

//● 聊天外卖订单管理
function loadDeliveredOrders(){const e=document.getElementById("order-list");if(!e)return;e.innerHTML="";const t=localStorage.getItem("foodDeliveryOrders");if(!t){e.innerHTML='<div class="empty-order">暂无外卖订单</div>';return}const o=JSON.parse(t).filter(e=>"delivered"===e.status||"overtime"===e.status);if(0===o.length){e.innerHTML='<div class="empty-order">暂无已送达的外卖订单</div>';return}o.sort((e,t)=>new Date(t.time)-new Date(e.time)).forEach(t=>{const c=document.createElement("div");c.className="order-item",c.dataset.id=t.id;const a=t.items.reduce((e,t)=>e+t.price*t.quantity,0),l=new Date(t.time),d=`${l.getMonth()+1}/${l.getDate()} ${l.getHours()}:${l.getMinutes().toString().padStart(2,"0")}`;let r="simple-order-status",n="";switch(r+="status-delivering","配送中",t.status){case"delivering":r+=" status-delivering",n="配送中";break;case"delivered":r+=" status-delivered",n="已送达";break;case"overtime":r+=" status-overtime",n="已超时";break;default:n=t.status}c.innerHTML=`<div style="display:flex;align-items:center;width:100%;"><div style="margin-right:10px;"><input type="checkbox" class="order-checkbox" data-id="${t.id}"></div><div style="flex:1;"><div class="simple-order-info"><div class="simple-order-name">${t.restaurant||"外卖订单"}</div><div class="simple-order-details">${t.items.slice(0,2).map(e=>`${e.name}×${e.quantity}`).join("、")}${t.items.length>2?"...":""}</div><div class="simple-order-time">${d}</div></div></div><div class="simple-order-right"><div class="simple-order-price">¥${a.toFixed(1)}</div><div class="${r}">${n}</div></div></div>`,c.addEventListener("click",e=>{e.target.classList.contains("order-checkbox")||showChatOrderDetail(t)}),e.appendChild(c)});const c=e.parentNode.querySelector(".send-to-chat-btn");c&&c.remove();const a=document.createElement("button");a.textContent="发送选中订单到聊天",a.className="send-to-chat-btn",a.style.cssText="margin-top:10px;width:100%;padding:8px;background:#000;color:#fff;border:none;border-radius:5px;cursor:pointer;font-size:12px;",a.onclick=sendSelectedOrdersToChat,e.parentNode.appendChild(a)}function showChatOrderDetail(e){const t=e.items.reduce((t,o)=>t+o.price*o.quantity,0),o=document.getElementById("confirm-dialog"),c=o.querySelector(".confirm-content");c.innerHTML=`<h3>订单详情</h3><div style="padding:15px;background:#f8f8f8;border-radius:8px;margin:10px 0;"><h4 style="margin-bottom:10px;color:#000;">${e.restaurant||"外卖订单"}</h4><div style="font-size:12px;color:#666;margin-bottom:5px;">${e.time}</div><div style="margin:10px 0;border-top:1px solid #ddd;padding-top:10px;">${e.items.map(e=>`<div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span>${e.name}×${e.quantity}</span><span>¥${(e.price*e.quantity).toFixed(1)}</span></div>`).join("")}</div><div style="display:flex;justify-content:space-between;font-weight:bold;border-top:1px solid #ddd;padding-top:10px;margin-top:10px;"><span>总计</span><span>¥${t.toFixed(1)}</span></div><div style="margin-top:10px;font-size:12px;color:#666;"><div><strong>配送地址：</strong>${e.deliveryAddress||"未设置"}</div>${e.remark?`<div><strong>备注：</strong>${e.remark}</div>`:""}${e.utensils?`<div><strong>餐具：</strong>${e.utensils}</div>`:""}</div></div><div class="confirm-buttons" style="margin-top:15px;"><button onclick="closeOrderDetail()">关闭</button></div>`,o.style.display="flex"}function closeOrderDetail(){document.getElementById("confirm-dialog").style.display="none"}function goToFoodDelivery(){openApp("food-delivery"),setTimeout(()=>{const e=document.getElementById("food-delivery-interface");e&&e.querySelector('.nav-item[data-page="orders"]').click()},100)}function sendSelectedOrdersToChat(){const e=document.querySelectorAll(".order-checkbox:checked");if(0===e.length)return void alert("请先选择要发送的订单");const t=localStorage.getItem("foodDeliveryOrders");if(!t)return;const o=JSON.parse(t);e.forEach(e=>{const c=parseInt(e.dataset.id),a=o.find(e=>e.id===c);a&&(appState.chatManager.addMessage("user",createReceiptHTML(a),"系统通知",null,"receipt"),setTimeout(()=>{const e=getAIResponseForOrder(a);appState.chatManager.addMessage("ai",e,"AI助手")},500))}),renderChatMessages(),e.forEach(e=>e.checked=!1),alert(`已发送 ${e.length} 个订单小票到聊天界面`)}function createReceiptHTML(e){const t=e.items.reduce((e,t)=>e+t.price*t.quantity,0),o=new Date(e.time),c=`${o.getFullYear()}-${(o.getMonth()+1).toString().padStart(2,"0")}-${o.getDate().toString().padStart(2,"0")}`,a=`${o.getHours().toString().padStart(2,"0")}:${o.getMinutes().toString().padStart(2,"0")}`,l="receipt-status ",d="delivered"===e.status?l+"delivered":"overtime"===e.status?l+"overtime":"delivering"===e.status?l+"delivering":l+"delivered",r="delivered"===e.status?"已送达":"overtime"===e.status?"已超时":"delivering"===e.status?"配送中":e.status;let n="顾客";try{const e=localStorage.getItem("foodDeliveryProfile");if(e){const t=JSON.parse(e);t.name&&"某某"!==t.name&&(n=t.name)}"顾客"===n&&window.userProfile&&window.userProfile.name&&(n=window.userProfile.name),"顾客"===n&&window.foodDelivery&&window.foodDelivery.userProfile&&window.foodDelivery.userProfile.name&&(n=window.foodDelivery.userProfile.name)}catch(e){console.error("获取用户姓名失败:",e)}const i="R"+e.id.toString().slice(-6),s=e.remark?`<div class="receipt-remark"><strong>备注：</strong>${e.remark}</div>`:"",u=e.deliveryAddress?`<div style="font-size:10px;color:#666;margin-top:5px;">配送地址: ${e.deliveryAddress}</div>`:"";return`<div class="chat-receipt-wrapper"><div class="chat-receipt"><div class="receipt-header"><div class="receipt-title">桃源外卖</div><div class="receipt-subtitle">美食小票</div></div><div class="receipt-store-info">${e.restaurant||"桃源餐厅"}<br>感谢您的光临</div><div class="receipt-datetime">${c} ${a}<br>订单号: ${i}</div><div class="receipt-items">${e.items.map(e=>`<div class="receipt-item"><div class="receipt-item-name">${e.name}</div><div class="receipt-item-quantity">×${e.quantity}</div><div class="receipt-item-price">¥${(e.price*e.quantity).toFixed(1)}</div></div>`).join("")}</div><div class="receipt-divider"></div><div class="receipt-totals"><div class="receipt-total-line"><span>小计</span><span>¥${t.toFixed(1)}</span></div><div class="receipt-total-line"><span>配送费</span><span>¥0.0</span></div><div class="receipt-total-line total"><span>总计</span><span>¥${t.toFixed(1)}</span></div></div><div class="receipt-footer"><div class="receipt-thankyou">谢谢惠顾，欢迎再次光临！</div><div class="receipt-barcode"></div><div class="receipt-barcode-number">${n}</div><div class="receipt-order-number">订单状态: <span class="${d}">${r}</span></div>${s}${u}</div></div></div>`}function getAIResponseForOrder(e){const t={"delivered":["外卖已送达！希望您用餐愉快！","订单已签收，记得给骑手好评哦！","美食已到，请慢慢享用！","送达确认！期待您的下次光临！"],"overtime":["啊哦，订单超时了！骑手正在努力配送中...","抱歉让您久等了，订单有些延误...","配送延迟了，请再耐心等待一下！","超时提醒：骑手正在加速赶来！"],"delivering":["您的外卖正在路上，骑手马上就到！","美食正在配送中，请稍等片刻！","骑手已取餐，正在赶往您的地址！","订单已出餐，即将送达！"]};return(t[e.status]||t.delivered)[Math.floor(Math.random()*(t[e.status]||t.delivered).length)]}

//● 密码设置管理
function showPasswordSetup(){document.getElementById('lock-icon-area').style.display='none',document.getElementById('password-setup-area').style.display='block',document.getElementById('saved-password-display').style.display='none',document.getElementById('setup-new-password').focus()}function cancelPasswordSetup(){const e=localStorage.getItem('lockScreenPassword');e?(document.getElementById('lock-icon-area').style.display='none',document.getElementById('saved-password-display').style.display='block',document.getElementById('password-setup-area').style.display='none'):(document.getElementById('lock-icon-area').style.display='flex',document.getElementById('saved-password-display').style.display='none',document.getElementById('password-setup-area').style.display='none'),document.getElementById('setup-new-password').value='',document.getElementById('setup-confirm-password').value='',hideStatusMessage()}function saveNewPassword(){const e=document.getElementById('setup-new-password').value,t=document.getElementById('setup-confirm-password').value;if(!e)return showStatusMessage('密码不能为空','error'),void document.getElementById('setup-new-password').focus();if(e!==t)return showStatusMessage('两次输入的密码不一致','error'),void document.getElementById('setup-confirm-password').focus();localStorage.setItem('lockScreenPassword',e),document.getElementById('lock-icon-area').style.display='none',document.getElementById('saved-password-display').style.display='block',document.getElementById('password-setup-area').style.display='none',document.getElementById('password-stars').textContent='●●●●●●',showStatusMessage('密码设置成功！','success'),document.getElementById('setup-new-password').value='',document.getElementById('setup-confirm-password').value='',updateLockScreenHint()}function changePassword(){showPasswordSetup()}function deletePassword(){if(confirm('确定要删除锁屏密码吗？删除后锁屏可直接上滑解锁。')){localStorage.removeItem('lockScreenPassword'),document.getElementById('lock-icon-area').style.display='flex',document.getElementById('saved-password-display').style.display='none',document.getElementById('password-setup-area').style.display='none',showStatusMessage('密码已删除，锁屏可直接上滑解锁','success'),updateLockScreenHint()}}function showStatusMessage(e,t){const a=document.getElementById('password-status-message');a.textContent=e,a.style.display='block',a.style.backgroundColor='success'===t?'#f0f0f0':'#ffebee',a.style.border='success'===t?'1px solid #000':'1px solid #f44',a.style.color='success'===t?'#000':'#c00',setTimeout(()=>{a.style.display='none'},3e3)}function hideStatusMessage(){document.getElementById('password-status-message').style.display='none'}function updateLockScreenHint(){const e=document.querySelector('.unlock-hint span');e&&localStorage.getItem('lockScreenPassword')?e.textContent='上滑并输入密码解锁':e.textContent='上滑解锁'}function initPasswordDisplay(){const e=localStorage.getItem('lockScreenPassword');e?(document.getElementById('lock-icon-area').style.display='none',document.getElementById('saved-password-display').style.display='block',document.getElementById('password-stars').textContent='●●●●●●'):(document.getElementById('lock-icon-area').style.display='flex',document.getElementById('saved-password-display').style.display='none')}

//● 钱包与账单管理器
const walletManager = {loadWalletData: function() { const e = localStorage.getItem('walletData'); return e ? JSON.parse(e) : { totalBalance: 0, todayExpense: 0, monthIncome: 0, lastUtilityPayMonth: null, transactions: [] }; },saveWalletData: function() { localStorage.setItem('walletData', JSON.stringify(this.walletData)); },walletData: null,loadHouseType: function() { return localStorage.getItem('userHouseType') || "老破小、旧房"; },saveHouseType: function(e) { localStorage.setItem('userHouseType', e); },initWallet: function() { this.walletData = this.loadWalletData(); document.getElementById('totalBalance').textContent = this.walletData.totalBalance.toFixed(2); document.getElementById('todayExpense').textContent = this.walletData.todayExpense.toFixed(2); document.getElementById('monthIncome').textContent = this.walletData.monthIncome.toFixed(2); this.renderTransactions(); },renderTransactions: function() {const e = document.getElementById('transaction-list');if (0 === this.walletData.transactions.length) { e.innerHTML = '<div class="empty-state"><p>暂无交易记录</p><p style="font-size: 0.8em; margin-top: 10px; color: #999;">所有消费和收入将在这里显示</p></div>'; return; }const t = [...this.walletData.transactions].sort((e, t) => new Date(t.date) - new Date(e.date));e.innerHTML = '';t.forEach(t => { const a = document.createElement('div'); a.className = 'transaction-item'; const n = 'expense' === t.type ? 'transaction-expense' : 'transaction-income'; const i = 'expense' === t.type ? '-' : '+'; a.innerHTML = `<div class="transaction-info"><div class="transaction-title">${t.description}</div><div class="transaction-date">${this.formatDate(t.date)}</div></div><div class="transaction-amount ${n}">${i}¥${t.amount.toFixed(2)}</div>`; e.appendChild(a); });},formatDate: function(e) { const t = new Date(e); return `${t.getFullYear()}-${(t.getMonth() + 1).toString().padStart(2, '0')}-${t.getDate().toString().padStart(2, '0')}`; },addTransaction: function(e, t, a) { const n = { id: Date.now() + Math.random().toString(36).substr(2, 9), type: e, amount: t, description: a, date: (new Date).toISOString() }; this.walletData.transactions.push(n); this.saveWalletData(); this.renderTransactions(); },setupEventListeners: function() {document.getElementById('rechargeBtn').addEventListener('click', function() { document.getElementById('rechargeModal').style.display = 'flex'; document.getElementById('rechargeAmount').focus(); });document.getElementById('closeModal').addEventListener('click', function() { document.getElementById('rechargeModal').style.display = 'none'; document.getElementById('rechargeAmount').value = ''; });document.getElementById('confirmRecharge').addEventListener('click', function() { const e = document.getElementById('rechargeAmount'), t = parseFloat(e.value); isNaN(t) || t <= 0 ? (alert('请输入有效的充值金额！'), e.focus()) : walletManager.recharge(t); });document.getElementById('rechargeModal').addEventListener('click', function(e) { e.target === this && (this.style.display = 'none', document.getElementById('rechargeAmount').value = '') });document.getElementById('rechargeAmount').addEventListener('keypress', function(e) { 'Enter' === e.key && document.getElementById('confirmRecharge').click() });document.getElementById('utilityBtn').addEventListener('click', function() { walletManager.openUtilityModal() });document.getElementById('closeUtilityModal').addEventListener('click', function() { document.getElementById('utilityModal').style.display = 'none' });document.getElementById('confirmUtility').addEventListener('click', function() { walletManager.payUtility() });document.getElementById('utilityModal').addEventListener('click', function(e) { e.target === this && (this.style.display = 'none') });document.getElementById('houseTypeSelect').addEventListener('change', function() { walletManager.updateUtilityPrices() });},recharge: function(e) { this.walletData.totalBalance += e; document.getElementById('totalBalance').textContent = this.walletData.totalBalance.toFixed(2); this.saveWalletData(); document.getElementById('rechargeModal').style.display = 'none'; document.getElementById('rechargeAmount').value = ''; alert(`成功充值 ${e.toFixed(2)} 元！`) },openUtilityModal: function() { const e = this.loadHouseType(); document.getElementById('houseTypeSelect').value = e; this.updateUtilityPrices(); document.getElementById('utilityModal').style.display = 'flex'; },updateUtilityPrices: function() { const e = document.getElementById('houseTypeSelect').value, t = utilityPrices[e] || utilityPrices["老破小、旧房"]; document.getElementById('utility-house-type').textContent = e; document.getElementById('utility-water').textContent = `${t.water.toFixed(2)} 元`; document.getElementById('utility-electricity').textContent = `${t.electricity.toFixed(2)} 元`; document.getElementById('utility-total').textContent = `${(t.water + t.electricity).toFixed(2)} 元`; },hasPaidUtilityThisMonth: function() { if (!this.walletData.lastUtilityPayMonth) return !1; const e = (new Date).getMonth(), t = (new Date).getFullYear(), a = new Date(this.walletData.lastUtilityPayMonth).getMonth(), n = new Date(this.walletData.lastUtilityPayMonth).getFullYear(); return e === a && t === n; },payUtility: function() {if (this.hasPaidUtilityThisMonth()) return void(alert('本月水电费已经缴纳过了，下个月再来吧！'), document.getElementById('utilityModal').style.display = 'none');const e = document.getElementById('houseTypeSelect').value, t = utilityPrices[e] || utilityPrices["老破小、旧房"], a = t.water + t.electricity;if (this.walletData.totalBalance < a) return void alert('余额不足，无法缴纳水电费！');this.walletData.totalBalance -= a; document.getElementById('totalBalance').textContent = this.walletData.totalBalance.toFixed(2); this.walletData.todayExpense += a; document.getElementById('todayExpense').textContent = this.walletData.todayExpense.toFixed(2); this.walletData.lastUtilityPayMonth = (new Date).toISOString();this.addTransaction('expense', a, `${e}水电费`); this.saveHouseType(e); this.saveWalletData(); document.getElementById('utilityModal').style.display = 'none'; alert(`成功缴纳水电费 ${a.toFixed(2)} 元！`);},payFoodDelivery: function(e, t) {if (this.walletData.totalBalance < e) return { success: !1, message: '余额不足，无法完成支付！' };this.walletData.totalBalance -= e; this.walletData.todayExpense += e; document.getElementById('totalBalance').textContent = this.walletData.totalBalance.toFixed(2); document.getElementById('todayExpense').textContent = this.walletData.todayExpense.toFixed(2);this.addTransaction('expense', e, t); this.saveWalletData();return { success: !0, message: `支付成功！扣除 ¥${e.toFixed(2)}` };}};
 
//● 音乐播放器管理器
const musicPlayer = {audio: new Audio(), playlist: [], currentIndex: -1, isPlaying: false, loopMode: 'list',init: function() {this.bindEvents();this.audio.addEventListener('loadedmetadata', () => { this.updateTotalTime(); });this.audio.addEventListener('timeupdate', () => { this.updateProgress(); });this.audio.addEventListener('ended', () => { if (this.loopMode === 'single') { this.audio.currentTime = 0; this.audio.play(); } else { this.next(); } });this.updateMusicStatusIndicator(); this.setLoopMode('list');},bindEvents: function() {document.getElementById('play-pause-btn').addEventListener('click', () => { this.togglePlay(); });document.getElementById('prev-btn').addEventListener('click', () => { this.prev(); });document.getElementById('next-btn').addEventListener('click', () => { this.next(); });document.getElementById('progress-bar').addEventListener('click', (e) => { this.seek(e); });document.getElementById('import-btn').addEventListener('click', () => { document.getElementById('file-input').click(); });document.getElementById('single-loop-btn').addEventListener('click', () => { this.setLoopMode('single'); });document.getElementById('list-loop-btn').addEventListener('click', () => { this.setLoopMode('list'); });document.getElementById('file-input').addEventListener('change', (e) => { this.handleFileSelect(e); });},handleFileSelect: function(e) {const files = e.target.files; if (files.length === 0) return;for (let i = 0; i < files.length; i++) { const file = files[i]; if (file.type.startsWith('audio/')) { const url = URL.createObjectURL(file); this.addToPlaylist(file.name, url, file); } }if (this.currentIndex === -1 && this.playlist.length > 0) { this.play(0); } e.target.value = '';},addToPlaylist: function(name, url, file) {const playlist = document.getElementById('playlist'); if (playlist.querySelector('.empty')) { playlist.innerHTML = ''; }const item = document.createElement('div'); item.className = 'playlist-item'; item.dataset.url = url;const tempAudio = new Audio(url);tempAudio.addEventListener('loadedmetadata', () => { const duration = this.formatTime(tempAudio.duration); item.innerHTML = `<div class="song-title">${name}</div><div class="song-duration">${duration}</div>`; item.dataset.duration = tempAudio.duration; });item.addEventListener('click', () => { const index = Array.from(playlist.children).indexOf(item); this.play(index); });playlist.appendChild(item); this.playlist.push({ name: name, url: url, file: file });},play: function(index) {if (index < 0 || index >= this.playlist.length) return;this.currentIndex = index; const song = this.playlist[index]; this.audio.src = song.url;document.getElementById('song-title').textContent = song.name; document.getElementById('song-artist').textContent = '本地音乐';const playlistItems = document.querySelectorAll('.playlist-item'); playlistItems.forEach(item => item.classList.remove('active')); playlistItems[index].classList.add('active');this.audio.play(); this.isPlaying = true; this.updatePlayState();},togglePlay: function() { if (this.currentIndex === -1) { if (this.playlist.length > 0) { this.play(0); } return; } if (this.isPlaying) { this.audio.pause(); } else { this.audio.play(); } this.isPlaying = !this.isPlaying; this.updatePlayState(); },updatePlayState: function() { const disc = document.getElementById('disc'); const playPauseIcon = document.getElementById('play-pause-btn'); if (this.isPlaying) { disc.classList.add('playing'); playPauseIcon.textContent = '❚❚'; } else { disc.classList.remove('playing'); playPauseIcon.textContent = '▶'; } this.updateMusicStatusIndicator(); },updateMusicStatusIndicator: function() { const musicStatus = document.getElementById('music-status'); if (this.isPlaying) { musicStatus.className = 'status-indicator status-online'; musicStatus.title = '正在播放'; } else { musicStatus.className = 'status-indicator status-offline'; musicStatus.title = '未播放'; } },prev: function() { if (this.playlist.length === 0) return; let newIndex = this.currentIndex - 1; if (newIndex < 0) { newIndex = this.playlist.length - 1; } this.play(newIndex); },next: function() { if (this.playlist.length === 0) return; let newIndex = this.currentIndex + 1; if (newIndex >= this.playlist.length) { newIndex = 0; } this.play(newIndex); },seek: function(e) { if (this.currentIndex === -1) return; const progressBar = document.getElementById('progress-bar'); const rect = progressBar.getBoundingClientRect(); const percent = (e.clientX - rect.left) / rect.width; this.audio.currentTime = percent * this.audio.duration; },updateProgress: function() { const progress = document.getElementById('progress'); const currentTime = document.getElementById('current-time'); if (this.audio.duration) { const percent = (this.audio.currentTime / this.audio.duration) * 100; progress.style.width = `${percent}%`; currentTime.textContent = this.formatTime(this.audio.currentTime); } },updateTotalTime: function() { const duration = document.getElementById('duration'); duration.textContent = this.formatTime(this.audio.duration); },formatTime: function(seconds) { if (isNaN(seconds)) return '0:00'; const mins = Math.floor(seconds / 60); const secs = Math.floor(seconds % 60); return `${mins}:${secs < 10 ? '0' : ''}${secs}`; },setLoopMode: function(mode) { const singleBtn = document.getElementById('single-loop-btn'); const listBtn = document.getElementById('list-loop-btn'); singleBtn.classList.remove('active'); listBtn.classList.remove('active'); this.loopMode = mode; if (mode === 'single') { singleBtn.classList.add('active'); } else { listBtn.classList.add('active'); } }};

//● 微博仿真系统管理器
const weiboManager = {categories: JSON.parse(localStorage.getItem("weiboCategories")) || [], weibos: JSON.parse(localStorage.getItem("weibos")) || [], userProfile: JSON.parse(localStorage.getItem("weiboUserProfile")) || { name: "微博用户", bio: "这个人很懒，什么都没有写...", persona: "普通用户", location: "", followers: 0, following: 0 },neutralNPCs: Array(26).fill().map((e, t) => ({ name: "网友" + String.fromCharCode(65 + t), description: "中性化角色，根据题材发动态" })), fanNPCs: Array(26).fill().map((e, t) => ({ name: "网友" + String.fromCharCode(65 + t), description: "吃瓜角色，围绕用户和角色发动态" })),trendingTopics: [{ name: "#AI技术分享#", posts: "12.3万", trend: "上升" }, { name: "#日常生活#", posts: "8.7万", trend: "热门" }, { name: "#数码新品#", posts: "15.6万", trend: "新" }, { name: "#旅行日记#", posts: "23.1万", trend: "上升" }, { name: "#美食探索#", posts: "18.9万", trend: "热门" }, { name: "#财经新闻#", posts: "31.2万", trend: "爆款" }, { name: "#体育赛事#", posts: "5.4万", trend: "新" }, { name: "#娱乐八卦#", posts: "7.8万", trend: "上升" }, { name: "#恐怖故事#", posts: "9.2万", trend: "新" }],hotSearchList: [], quotes: ["如果世界真的不喜欢你 那世界就是我的敌人", "童年的梦境锈迹斑斑 所罗门式的痛苦曾钻透月亮", "生命生来就如璀璨的夏日之花 不凋不败", "和蒲公英密谋一场叛逃 目的地为乌托邦银河渡口", "吾与吾爱皆亡于高塔 君与君心皆留于盛夏", "我永恒的灵魂注视着你的心 纵然黑夜孤寂 白昼如焚", "我观春山意难容 青也惊鸿 颓也从容", "爱诞生于每一次垂眸相视的瞬间里"],dynamicConfig: { userWeiboFrequency: 0, maxUserWeibosPerRefresh: 0 },identityKeywords: { entertainment: ["明星", "演员", "歌手", "偶像", "艺人", "巨星", "歌星", "影星", "娱乐圈", "演艺圈", "娱乐"], detective: ["法医", "警察", "侦探", "刑侦", "案件", "尸体", "刑警", "警探", "犯罪", "侦查"], tech: ["程序员", "工程师", "科学家", "研究员", "技术", "开发", "编程", "码农", "IT"], medical: ["医生", "护士", "医疗", "医学", "医院", "诊所", "医师", "治疗"], education: ["老师", "教师", "教授", "教育", "学校", "学生", "教学"] },categoryIdentityMap: { 娱乐: "entertainment", 科技: "tech", 数码: "tech", 恐怖: "detective", 刑侦: "detective", 案件: "detective", 医疗: "medical", 教育: "education" },dynamicContent: {topicStyles: { 恐怖: "语气必须令人感到绝望、恐惧、阴森、不安、毛骨悚然。侧重于心理恐怖或未知的恐惧。绝对不要搞笑。", 灵异: "语气必须令人感到绝望、恐惧、阴森、不安、毛骨悚然。侧重于心理恐怖或未知的恐惧。绝对不要搞笑。", 生活: "语气必须温馨、治愈、积极向上、充满生活气息、轻松愉快。", 日常: "语气必须温馨、治愈、积极向上、充满生活气息、轻松愉快。", 科技: "语气必须专业、理性、对未来科技充满向往、强调先进性、硬核。", 数码: "语气必须专业、理性、对未来科技充满向往、强调先进性、硬核。", 娱乐: "语气八卦、兴奋、或者犀利点评，充满娱乐精神，可以使用饭圈用语。", 明星: "语气八卦、兴奋、或者犀利点评，充满娱乐精神，可以使用饭圈用语。", 体育: "语气热血、充满激情、强调拼搏精神和竞技状态。", 运动: "语气热血、充满激情、强调拼搏精神和竞技状态。", 财经: "语气严谨、客观、分析透彻、关注利益和风险。", 金融: "语气严谨、客观、分析透彻、关注利益和风险。", default: "语气符合该话题的常规社交媒体风格。" },emojis: ["😊", "😂", "❤️", "👍", "🔥", "⭐", "🙏", "🎉", "💡", "👏", "🎮", "📚", "✈️", "🍕", "☕", "😭", "🥰"], horrorEmojis: ["😨", "👻", "💀", "🕯️", "🌑", "🕷️", "🦇", "⚰️", "🩸", "👁️", "🧟", "🧛"],generateNPCWeibo: async function(e = null) {const t = JSON.parse(localStorage.getItem("aiPersona") || "{}"), a = JSON.parse(localStorage.getItem("userPersona") || "{}"), n = t.name || "某人", i = a.name || "某人", o = this.extractIdentity(t.description || ""), r = this.extractIdentity(a.description || ""), s = weiboManager.categoryIdentityMap[e] || null, c = !s || !o || this.isIdentityMatch(o, s), l = !s || !r || this.isIdentityMatch(r, s), d = Math.random(); let u, p, m = !1, h = !1, g = "", f = "";if (d < .2 && c && t.name && t.description) m = !0, u = t.name, p = t.description, g = `以${u}的身份发布关于"${e || this.getRandomTopic()}"的微博。`, f = `角色设定：${p}`;else if (d < .6 || !c && !l) { const e = weiboManager.neutralNPCs[Math.floor(Math.random() * weiboManager.neutralNPCs.length)]; u = e.name, p = e.description, g = `以${u}的身份发布关于"${e || this.getRandomTopic()}"的微博。`, f = `角色设定：${p}` }else {h = !0; const n = weiboManager.fanNPCs[Math.floor(Math.random() * weiboManager.fanNPCs.length)]; u = n.name, p = n.description; const o = Math.random(), r = e || this.getRandomTopic();o < .4 && l && a.name ? (g = `以${u}的身份，作为路人或粉丝，发布一条关于用户"${i}"的微博，讨论"${r}"。`, f = `角色设定：${p}\n【重要参考】用户(${i})的人设资料：${a.description || "普通用户"}`) : o < .8 && c && t.name ? (g = `以${u}的身份，作为路人或粉丝，发布一条关于角色"${n}"的微博，讨论"${r}"。`, f = `角色设定：${p}\n【重要参考】角色(${n})的人设资料：${t.description || "虚拟角色"}`) : c && l && t.name && a.name ? (g = `以${u}的身份，作为吃瓜群众，发布一条同时提到"${n}"和"${i}"的微博，讨论"${r}"或他们的关系。`, f = `角色设定：${p}\n【重要参考】用户(${i})资料：${a.description}\n【重要参考】角色(${n})资料：${t.description}`) : (h = !1, g = `以${u}的身份发布关于"${r}"的微博。`, f = `角色设定：${p}`)}const y = this.getTopicStyle(e || "日常"), v = `任务：${g}\n${f}\n情感基调/风格要求：${y}\n其他要求：\n1. 字数控制在140字以内。\n2. 直接输出内容，不要包含解释。\n3. ⚠️必须严格根据【重要参考】中的资料区分用户和角色的性别，不要弄错"他"和"她"。`;try { const e = await appState.apiService.generateRawContent(`你是一个模拟微博用户的AI。`, v, .8); return { content: this.cleanContent(e), username: u, userBio: p, isChatCharacter: m, isFanRole: h } } catch (t) { console.error("生成NPC微博内容失败:", t); return null }},getRandomTopic: function() { const e = ["日常生活", "科技动态", "美食分享", "旅行见闻", "心情随笔", "影视推荐", "音乐分享", "读书感悟", "健康养生", "运动健身", "时尚穿搭", "美妆技巧", "宠物日常", "亲子教育", "职场心得", "学习成长", "摄影作品", "游戏体验", "动漫讨论", "时事热点"]; return e[Math.floor(Math.random() * e.length)] },getTopicStyle: function(e) { if (!e) return this.topicStyles.default; const t = e.toLowerCase(); for (const [e, a] of Object.entries(this.topicStyles)) if (t.includes(e.toLowerCase())) return a; return this.topicStyles.default },extractIdentity: function(e) { const t = e.toLowerCase(); for (const [e, a] of Object.entries(weiboManager.identityKeywords)) for (const n of a) if (t.includes(n.toLowerCase())) return e; return null },isIdentityMatch: function(e, t) { if (e === t) return !0; const a = { detective: ["horror"], entertainment: ["life"], tech: ["finance"] }; return !(!a[e] || !a[e].includes(t)) },generateFallbackContent: function(e) { return null },cleanContent: function(e) { return e.replace(/^["']|["']$/g, "").replace(/^(这是一条|我生成|我写|我创作|我发布|这是一张|这是一段|这是一个)/g, "").replace(/^(关于|今天|刚刚|最近)/g, "").trim() },getRandomEmojis: function() { const e = Math.floor(2 * Math.random()) + 1; let t = ""; for (let a = 0; a < e; a++) t += this.emojis[Math.floor(Math.random() * this.emojis.length)]; return t },generateTimestamp: function(e = 0) { if (e > 0) return `${e}天前`; const t = Math.floor(24 * Math.random()), a = Math.floor(60 * Math.random()); return t > 0 ? `${t}小时前` : a > 0 ? `${a}分钟前` : "刚刚" }},getRandomNPCPersona: function() { const e = Math.random() < .5, t = e ? this.fanNPCs : this.neutralNPCs; return t[Math.floor(Math.random() * t.length)] },generateDiverseComments: async function(e, t) {const a = `请为以下微博内容生成6条多样化的评论，包含不同的立场和语气：\n\n微博内容："${e}"\n\n要求：\n1. 生成6条评论，每条评论20-40字\n2. 包含以下四种立场（比例大致平均）：\n   - 支持（支持、欣赏的语气）\n   - 批评（批评、质疑的语气）\n   - 粉丝（狂热支持、维护的语气）\n   - 黑粉（恶意攻击、嘲讽的语气）\n3. 评论之间要有互动感，可以体现"粉黑开撕"的氛围\n4. 评论者使用"网友A"到"网友Z"之间的随机名字\n5. 每条评论单独一行，格式必须为："[立场] 用户名: 评论内容"\n6. 立场只能从以下四个中选择：[支持]、[批评]、[粉丝]、[黑粉]\n7. 评论要真实自然，符合微博评论风格\n\n请直接输出评论，不要添加任何解释：`;try {const n = await appState.apiService.generateRawContent("你是一个微博评论生成器，擅长生成真实、多样化的社交媒体评论。", a, .8), i = n.split("\n").map(e => { const t = e.match(/^\[(支持|批评|粉丝|黑粉)\]\s*([^:]+):\s*(.+)$/); return t ? { stanceRaw: t[1], user: t[2].trim(), comment: t[3].trim() } : null }).filter(e => null !== e).slice(0, 6), o = i.map((e, a) => { let n = "neutral"; "支持" === e.stanceRaw ? n = "supportive" : "批评" === e.stanceRaw ? n = "critical" : "粉丝" === e.stanceRaw ? n = "fan" : "黑粉" === e.stanceRaw && (n = "anti"); const i = ["刚刚", "1分钟前", "5分钟前", "10分钟前", "半小时前", "1小时前"][Math.floor(6 * Math.random())]; return { id: Date.now() + a, weiboId: t, user: e.user, content: e.comment, stance: n, stanceText: e.stanceRaw, time: i, likes: Math.floor(20 * Math.random()) } });return 0 === o.length ? this.generateFallbackComments(e, t) : o} catch (a) { return console.error("生成多样化评论失败:", a), this.generateFallbackComments(e, t) }},generateFallbackComments: function(e, t) { return [] },refreshCommentsForWeibo: async function(e) {const t = this.weibos.find(t => t.id === e); if (!t || t.generatingComments) return; t.generatingComments = !0; const a = document.querySelector(`.refresh-comments-btn[data-weibo-id="${e}"]`); a && (a.classList.add("loading"), a.textContent = "生成中...", a.disabled = !0);try { const n = await this.generateDiverseComments(t.content, e); t.commentsList = n, t.comments = n.length, t.lastCommentRefresh = (new Date).toISOString(), localStorage.setItem("weibos", JSON.stringify(this.weibos)), this.renderWeiboList(), a && (a.textContent = "刷新评论 ✓", setTimeout(() => { a.textContent = "刷新评论" }, 1e3)) } catch (e) { console.error("刷新评论失败:", e), a && (a.textContent = "刷新失败", setTimeout(() => { a.textContent = "刷新评论" }, 2e3)) } finally { t.generatingComments = !1, a && (a.classList.remove("loading"), a.disabled = !1) }},currentCategory: "", currentWeiboId: null, currentDeletingWeiboId: null,init: function() { this.renderCategoryTags(), this.renderCategoryList(), this.renderCategorySelect(), this.loadUserProfile(), this.switchPage("home"), this.bindEvents(), this.renderWeiboList(), this.renderDiscoverPage(), this.updateUserAvatar(), this.bindDeleteDialogEvents() },bindDeleteDialogEvents: function() { document.getElementById("confirm-weibo-delete-btn").addEventListener("click", () => { this.confirmDeleteWeibo() }), document.getElementById("cancel-weibo-delete-btn").addEventListener("click", () => { this.cancelDeleteWeibo() }) },deleteWeibo: function(e) { const t = this.weibos.findIndex(t => t.id === e); return -1 !== t && (this.weibos.splice(t, 1), localStorage.setItem("weibos", JSON.stringify(this.weibos)), this.renderWeiboList(), this.loadUserProfile(), !0) },showDeleteWeiboConfirm: function(e) { this.currentDeletingWeiboId = e, document.getElementById("weibo-delete-dialog").style.display = "flex" },confirmDeleteWeibo: function() { this.currentDeletingWeiboId && (this.deleteWeibo(this.currentDeletingWeiboId), document.getElementById("weibo-delete-dialog").style.display = "none", this.currentDeletingWeiboId = null) },cancelDeleteWeibo: function() { document.getElementById("weibo-delete-dialog").style.display = "none", this.currentDeletingWeiboId = null },updateUserAvatar: function() { const e = document.getElementById("weiboUserAvatar"); e && (e.textContent = this.userProfile.name.charAt(0)) },loadDynamicWeibos: async function() {const e = document.getElementById("weiboList"); e.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">正在加载动态内容...</div>'; const t = [];for (let e = 0; e < 3; e++) try { const a = await this.dynamicContent.generateNPCWeibo(this.currentCategory); if(!a || !a.content) continue; const n = { id: Date.now() + e, username: a.username, content: a.content, timestamp: this.dynamicContent.generateTimestamp(Math.floor(3 * Math.random())), category: this.currentCategory || this.getRandomCategory(), likes: Math.floor(50 * Math.random()), comments: 0, reposts: Math.floor(15 * Math.random()), commentsList: [], userBio: a.userBio, isLiked: !1, isChatCharacter: a.isChatCharacter || !1, isFanRole: a.isFanRole || !1, generatingComments: !1, lastCommentRefresh: null }; t.push(n) } catch (e) { console.error("生成微博失败:", e) }this.weibos = [...t, ...this.weibos], localStorage.setItem("weibos", JSON.stringify(this.weibos)), this.renderWeiboList()},getRandomCategory: function() { return this.categories.length > 0 ? this.categories[Math.floor(Math.random() * this.categories.length)] : "生活" },renderCategoryTags: function() { const e = document.getElementById("weiboCategoryTags"); e.innerHTML = ""; const t = document.createElement("div"); t.className = `weibo-category-tag ${"" === this.currentCategory ? "active" : ""}`, t.textContent = "全部", t.setAttribute("data-category", ""), t.addEventListener("click", () => this.filterByCategory("")), e.appendChild(t), this.categories.forEach(t => { const a = document.createElement("div"); a.className = `weibo-category-tag ${this.currentCategory === t ? "active" : ""}`, a.textContent = t, a.setAttribute("data-category", t), a.addEventListener("click", () => this.filterByCategory(t)), e.appendChild(a) }) },renderCategoryList: function() { const e = document.getElementById("weiboCategoryList"); e.innerHTML = "", this.categories.forEach(t => { const a = document.createElement("div"); a.className = "weibo-category-item", a.innerHTML = `<span>${t}</span><button class="weibo-delete-category" data-category="${t}">删除</button>`, e.appendChild(a) }), document.querySelectorAll(".weibo-delete-category").forEach(e => { e.addEventListener("click", e => { const t = e.target.getAttribute("data-category"); this.deleteCategory(t) }) }) },renderCategorySelect: function() { const e = document.getElementById("weiboCategorySelect"); e.innerHTML = '<option value="">选择分类</option>', this.categories.forEach(t => { const a = document.createElement("option"); a.value = t, a.textContent = t, e.appendChild(a) }) },renderWeiboList: function() {const e = document.getElementById("weiboList"); e.innerHTML = ""; const t = this.currentCategory ? this.weibos.filter(e => e.category === this.currentCategory) : this.weibos; if (0 === t.length) return void(e.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">暂无微博内容，点击"刷新动态"按钮加载内容</div>');t.forEach(t => {void 0 === t.isLiked && (t.isLiked = !1), t.commentsList || (t.commentsList = []); const a = document.createElement("div"); a.className = "weibo-item"; const n = t.isLiked ? "like-btn liked" : "like-btn"; let i = t.username.charAt(0); t.username.startsWith("网友") && (i = t.username.replace("网友", "")); let o = "";o = t.commentsList && t.commentsList.length > 0 ? `\n <div class="weibo-comments-container">\n <div class="weibo-comments-header">\n <div class="weibo-comments-title">评论 (${t.commentsList.length})</div>\n <button class="refresh-comments-btn" data-weibo-id="${t.id}">刷新评论</button>\n </div>\n <div class="weibo-comments-list-inline">\n ${t.commentsList.map(e=>`\n <div class="weibo-comment-item-inline">\n <div class="weibo-comment-header-inline">\n <span class="weibo-comment-user-inline">${e.user}</span>\n <span class="weibo-comment-stance stance-${e.stance}">${e.stanceText}</span>\n <span class="weibo-comment-time-inline">${e.time}</span>\n </div>\n <div class="weibo-comment-text-inline">${e.content}</div>\n </div>\n `).join("")}\n </div>\n </div>\n ` : `\n <div class="weibo-comments-container">\n <div class="weibo-comments-header">\n <div class="weibo-comments-title">暂无评论</div>\n <button class="refresh-comments-btn" data-weibo-id="${t.id}">生成评论</button>\n </div>\n </div>\n `, a.innerHTML = `\n <div class="weibo-avatar">${i}</div>\n <div class="weibo-content">\n <div class="weibo-item-header">\n <span class="weibo-username">${t.username}</span>\n ${t.category?`<span class="weibo-item-category">${t.category}</span>`:""}\n <span class="weibo-timestamp">${t.timestamp}</span>\n </div>\n <div class="weibo-item-text">${t.content}</div>\n <div class="weibo-item-actions">\n <button class="repost-btn">转发 ${t.reposts}</button>\n <button class="comment-btn" data-weibo-id="${t.id}">评论 ${t.comments}</button>\n <button class="${n}" data-weibo-id="${t.id}">点赞 ${t.likes}</button>\n <button class="delete-btn" data-weibo-id="${t.id}">删除</button>\n </div>\n ${o}\n </div>`, e.appendChild(a)}), document.querySelectorAll(".like-btn").forEach(e => { e.addEventListener("click", function() { const e = parseInt(this.getAttribute("data-weibo-id")), t = weiboManager.weibos.find(t => t.id === e); t && (t.isLiked ? (t.likes = Math.max(0, t.likes - 1), t.isLiked = !1, this.classList.remove("liked")) : (t.likes += 1, t.isLiked = !0, this.classList.add("liked")), this.textContent = `点赞 ${t.likes}`, localStorage.setItem("weibos", JSON.stringify(weiboManager.weibos))) }) }), document.querySelectorAll(".comment-btn").forEach(e => { e.addEventListener("click", function() { const e = parseInt(this.getAttribute("data-weibo-id")); weiboManager.openCommentModal(e) }) }), document.querySelectorAll(".repost-btn").forEach(e => { e.addEventListener("click", function() { const e = parseInt(this.closest(".weibo-item").querySelector(".comment-btn").getAttribute("data-weibo-id")), t = weiboManager.weibos.find(t => t.id === e); t && (t.reposts += 1, localStorage.setItem("weibos", JSON.stringify(weiboManager.weibos)), this.textContent = `转发 ${t.reposts}`, alert("转发成功！")) }) }), document.querySelectorAll(".delete-btn").forEach(e => { e.addEventListener("click", function() { const e = parseInt(this.getAttribute("data-weibo-id")); weiboManager.showDeleteWeiboConfirm(e) }) }), document.querySelectorAll(".refresh-comments-btn").forEach(e => { e.addEventListener("click", function() { const e = parseInt(this.getAttribute("data-weibo-id")); weiboManager.refreshCommentsForWeibo(e) }) })},openCommentModal: function(e) { this.currentWeiboId = e; const t = this.weibos.find(t => t.id === e), a = document.getElementById("weiboCommentsList"); a.innerHTML = "", t.commentsList && t.commentsList.length > 0 ? t.commentsList.forEach(e => { const t = document.createElement("div"); t.className = "weibo-comment-item", t.innerHTML = `<div><span class="weibo-comment-user">${e.user}</span><span style="font-size: 12px; color: #666;">${e.time}</span></div><div class="weibo-comment-text">${e.content}</div>`, a.appendChild(t) }) : a.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">暂无评论</div>', document.getElementById("weiboCommentModal").style.display = "flex", document.getElementById("weiboCommentInput").focus() },submitNewComment: async function() {let e = document.getElementById("weiboCommentInput").value.trim();if (!e && this.currentWeiboId) { const t = this.weibos.find(t => t.id === this.currentWeiboId); if (t) { const a = document.getElementById("weiboCommentInput"); a.value = "正在生成评论...", a.disabled = !0; try { e = await this.generateComment(t.content), a.value = e } catch (e) { console.error("生成评论失败:", e), a.value = "评论一下！" } finally { a.disabled = !1 } } }e && this.currentWeiboId && this.addComment(this.currentWeiboId, e)},addComment: function(e, t) { const a = this.weibos.find(t => t.id === e); a && (a.commentsList || (a.commentsList = []), a.commentsList.unshift({ user: this.userProfile.name, content: t, time: "刚刚" }), a.comments += 1, localStorage.setItem("weibos", JSON.stringify(this.weibos)), document.getElementById("weiboCommentInput").value = "", document.getElementById("weiboCommentModal").style.display = "none", this.renderWeiboList()) },renderDiscoverPage: function() { this.renderTrendingTopics(), this.renderHotSearch(), this.renderRandomQuote(), 0 === this.hotSearchList.length && this.generateHotSearch(), 0 === this.trendingTopics.length && this.generateTrendingTopics() },renderTrendingTopics: function() { const e = document.getElementById("weiboTopicList"); e.innerHTML = "";[...this.trendingTopics].sort(() => .5 - Math.random()).slice(0, 5).forEach(t => { const a = document.createElement("div"); a.className = "weibo-topic-item", a.innerHTML = `<div class="weibo-topic-name">${t.name}</div><div class="weibo-topic-stats">${t.posts} 帖子 · ${t.trend}</div>`, e.appendChild(a) }) },generateTrendingTopics: function() { this.trendingTopics = [{ name: "#AI技术分享#", posts: Math.floor(50 * Math.random() + 10) + "万", trend: "热" }, { name: "#日常生活#", posts: Math.floor(100 * Math.random() + 20) + "万", trend: "新" }, { name: "#美食探店#", posts: Math.floor(80 * Math.random() + 15) + "万", trend: "沸" }, { name: "#恐怖故事#", posts: Math.floor(60 * Math.random() + 5) + "万", trend: "新" }], this.renderTrendingTopics() },generateHotSearch: async function() {const e = document.getElementById("weiboHotSearchList"); e.innerHTML = '<div style="text-align: center; padding: 10px; color: #666;">正在实时生成热搜...</div>'; const t = this.userProfile.name, a = this.userProfile.persona, n = this.userProfile.followers, i = n > 1e4 || /明星|演员|歌手|网红|大V|偶像|艺人|巨星/.test(a); let o = "请生成10个微博热搜词条（不带#号），每行一个。"; i ? o += `\n用户身份是是：${t}，人设是：${a}，粉丝数：${n}。\n这是一个知名人物。请务必在生成的10个热搜中，包含1-3条关于"${t}"的热搜，并且将关于"${t}"的热搜放在前三名。\n其他热搜可以是社会新闻、娱乐八卦等。` : o += "\n用户身份是普通人。请生成10个普通的社会、娱乐、生活类热搜。", o += "\n格式要求：纯文本，每行一个词条，不要带序号。";try { const t = await appState.apiService.generateRawContent("你是一个微博热搜生成器。", o, .8), a = t.split("\n").filter(e => "" !== e.trim()).map(e => e.replace(/^\d+\.\s*/, "").trim()).slice(0, 10); this.hotSearchList = a.map((e, t) => { let a = ""; return t < 3 ? a = "tag-hot" : 3 === t && (a = "tag-new"), { text: e, tag: a } }), this.renderHotSearch() } catch (t) { console.error("生成热搜失败:", t), this.hotSearchList = [{ text: "服务器开小差了", tag: "" }, { text: "AI生成失败", tag: "" }], this.renderHotSearch() }},renderHotSearch: function() { const e = document.getElementById("weiboHotSearchList"); e.innerHTML = "", this.hotSearchList.forEach((t, a) => { const n = document.createElement("div"); n.className = "weibo-topic-item"; const i = a < 3 ? `rank-top-${a + 1}` : "rank-normal", o = t.tag ? `<span class="weibo-tag ${t.tag}">${0 === a ? "爆" : "热"}</span>` : ""; n.innerHTML = `<div class="weibo-topic-name"><span class="weibo-rank-number ${i}">${a + 1}</span> ${t.text} ${o}</div><div class="weibo-topic-stats" style="padding-left: 25px;">${Math.floor(500 * Math.random() + 100)}万 搜索量</div>`, e.appendChild(n) }) },renderRandomQuote: function() { const e = Math.floor(Math.random() * this.quotes.length); document.getElementById("weiboRandomQuote").textContent = this.quotes[e] },loadUserProfile: function() { document.getElementById("weiboProfileName").value = this.userProfile.name, document.getElementById("weiboProfileBio").value = this.userProfile.bio, document.getElementById("weiboProfilePersona").value = this.userProfile.persona, document.getElementById("weiboProfileLocation").value = this.userProfile.location, document.getElementById("weiboProfileFollowers").value = this.userProfile.followers, document.getElementById("weiboProfileFollowing").value = this.userProfile.following, document.getElementById("myProfileName").textContent = this.userProfile.name, document.getElementById("myProfileBio").textContent = this.userProfile.bio, document.getElementById("myProfileFollowers").textContent = this.userProfile.followers, document.getElementById("myProfileFollowing").textContent = this.userProfile.following, document.getElementById("myProfileWeibos").textContent = this.weibos.filter(e => e.username === this.userProfile.name).length; const e = document.getElementById("myProfileAvatar"); e && (e.textContent = this.userProfile.name.charAt(0)) },saveUserProfile: function() { this.userProfile = { name: document.getElementById("weiboProfileName").value.trim() || "微博用户", bio: document.getElementById("weiboProfileBio").value.trim() || "这个人很懒，什么都没有写...", persona: document.getElementById("weiboProfilePersona").value.trim() || "普通用户", location: document.getElementById("weiboProfileLocation").value.trim(), followers: parseInt(document.getElementById("weiboProfileFollowers").value) || 0, following: parseInt(document.getElementById("weiboProfileFollowing").value) || 0 }, localStorage.setItem("weiboUserProfile", JSON.stringify(this.userProfile)), document.getElementById("weiboProfileModal").style.display = "none", this.updateUserWeibos(), this.updateUserAvatar(), this.loadUserProfile() },updateUserWeibos: function() { this.weibos.forEach(e => { "当前用户" === e.username && (e.username = this.userProfile.name) }), localStorage.setItem("weibos", JSON.stringify(this.weibos)), this.renderWeiboList() },filterByCategory: function(e) { this.currentCategory = e, this.renderCategoryTags(), this.renderWeiboList() },addCategory: function() { const e = document.getElementById("weiboNewCategoryInput").value.trim(); e && !this.categories.includes(e) && (this.categories.push(e), localStorage.setItem("weiboCategories", JSON.stringify(this.categories)), this.renderCategoryTags(), this.renderCategoryList(), this.renderCategorySelect(), document.getElementById("weiboNewCategoryInput").value = "") },deleteCategory: function(e) { this.categories = this.categories.filter(t => t !== e), localStorage.setItem("weiboCategories", JSON.stringify(this.categories)), this.renderCategoryTags(), this.renderCategoryList(), this.renderCategorySelect(), this.currentCategory === e && this.filterByCategory("") },publishWeibo: async function() { const e = document.getElementById("weiboText").value.trim(), t = document.getElementById("weiboCategorySelect").value; if (!e) return void alert("请输入微博内容！"); if (e) { const a = { id: Date.now(), username: this.userProfile.name, content: e, timestamp: "刚刚", category: t, likes: 0, comments: 0, reposts: 0, commentsList: [], isLiked: !1, isChatCharacter: !1, isFanRole: !1, generatingComments: !1, lastCommentRefresh: null }; this.weibos.unshift(a), localStorage.setItem("weibos", JSON.stringify(this.weibos)), document.getElementById("weiboText").value = "", document.getElementById("weiboCategorySelect").value = "", this.renderWeiboList(), this.loadUserProfile(), alert("微博发布成功！") } },refreshDynamicContent: async function() { await this.loadDynamicWeibos(), this.renderDiscoverPage(), alert("已添加新动态！") },switchPage: function(e) { document.getElementById("weiboHomePage").classList.remove("active"), document.getElementById("weiboDiscoverPage").classList.remove("active"), document.getElementById("weiboProfilePage").classList.remove("active"), document.getElementById("weiboHomeLink").classList.remove("active"), document.getElementById("weiboDiscoverLink").classList.remove("active"), document.getElementById("weiboProfileLink").classList.remove("active"), "home" === e ? (document.getElementById("weiboHomePage").classList.add("active"), document.getElementById("weiboHomeLink").classList.add("active")) : "discover" === e ? (document.getElementById("weiboDiscoverPage").classList.add("active"), document.getElementById("weiboDiscoverLink").classList.add("active"), this.renderDiscoverPage()) : "profile" === e && (document.getElementById("weiboProfilePage").classList.add("active"), document.getElementById("weiboProfileLink").classList.add("active"), this.loadUserProfile()) },bindEvents: function() {document.getElementById("weiboManageCategories").addEventListener("click", () => { document.getElementById("weiboCategoryModal").style.display = "flex" }), document.getElementById("weiboCloseCategoryModal").addEventListener("click", () => { document.getElementById("weiboCategoryModal").style.display = "none" }), document.getElementById("weiboProfileLink").addEventListener("click", e => { e.preventDefault(), this.switchPage("profile") }), document.getElementById("weiboCloseProfileModal").addEventListener("click", () => { document.getElementById("weiboProfileModal").style.display = "none" }), document.getElementById("weiboUserAvatar").addEventListener("click", () => { this.loadUserProfile(), document.getElementById("weiboProfileModal").style.display = "flex" }), document.getElementById("weiboHomeLink").addEventListener("click", e => { e.preventDefault(), this.switchPage("home") }), document.getElementById("weiboDiscoverLink").addEventListener("click", e => { e.preventDefault(), this.switchPage("discover") }), document.getElementById("weiboAddCategoryBtn").addEventListener("click", () => { this.addCategory() }), document.getElementById("weiboNewCategoryInput").addEventListener("keypress", e => { "Enter" === e.key && this.addCategory() }), document.getElementById("weiboSaveProfileBtn").addEventListener("click", () => { this.saveUserProfile() }), document.getElementById("weiboPublishBtn").addEventListener("click", () => { this.publishWeibo() }), document.getElementById("weiboText").addEventListener("keypress", e => { e.ctrlKey && "Enter" === e.key && this.publishWeibo() }), document.getElementById("weiboRefreshHotSearch").addEventListener("click", () => { this.generateHotSearch() }), document.getElementById("weiboRefreshTopics").addEventListener("click", () => { this.generateTrendingTopics() }), document.getElementById("weiboCloseCommentModal").addEventListener("click", () => { document.getElementById("weiboCommentModal").style.display = "none" }), document.getElementById("weiboCancelComment").addEventListener("click", () => { document.getElementById("weiboCommentModal").style.display = "none" }), document.getElementById("weiboSubmitComment").addEventListener("click", () => { this.submitNewComment() }), document.getElementById("weiboCommentInput").addEventListener("keypress", e => { e.key === "Enter" && e.ctrlKey && this.submitNewComment() }), document.getElementById("weiboRefreshDynamicBtn").addEventListener("click", () => { this.refreshDynamicContent() }), document.getElementById("weiboSaveBackupBtn").addEventListener("click", () => { const e = { weibos: this.weibos, categories: this.categories, userProfile: this.userProfile, backupTime: new Date().toLocaleString() }, t = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(e)), a = document.createElement("a"); a.setAttribute("href", t), a.setAttribute("download", `weibo_backup_${new Date().getTime()}.json`), document.body.appendChild(a), a.click(), a.remove() }), document.getElementById("weiboImportBackupBtn").addEventListener("click", () => { document.getElementById("weiboImportInput").click() }), document.getElementById("weiboImportInput").addEventListener("change", e => { const t = e.target.files[0]; if (!t) return; const a = new FileReader; a.onload = e => { try { const t = JSON.parse(e.target.result); t.weibos && t.categories && t.userProfile ? confirm("确定要导入备份吗？这将会覆盖当前所有动态和设置！") && (this.weibos = t.weibos, this.categories = t.categories, this.userProfile = t.userProfile, localStorage.setItem("weibos", JSON.stringify(this.weibos)), localStorage.setItem("weiboCategories", JSON.stringify(this.categories)), localStorage.setItem("weiboUserProfile", JSON.stringify(this.userProfile)), alert("恢复备份成功！页面即将刷新。"), location.reload()) : alert("无效的备份文件格式！") } catch (e) { alert("解析备份文件失败！") } }, a.readAsText(t) }), document.getElementById("editMyProfileBtn").addEventListener("click", () => { this.loadUserProfile(), document.getElementById("weiboProfileModal").style.display = "flex" })}};

/***********************************
* ✤ 全局管理
 ***********************************/  
//● 应用全局状态管理器
const appState = {currentPersona: null, apiConfig: {}, customCSS: '', isGenerating: false, models: [], lastUpdated: null,apiService: new ApiService(), chatManager: new ChatManager(), worldbookManager: new WorldbookManager(), multiPersonaManager: new MultiPersonaManager(),currentPersonaTab: 'ai', currentEditingMessageId: null, selectionMode: false, selectedMessageIds: [], chatMode: 'online', chatType: 'single'};let currentInterface = 'desktop';let deleteMessageId = null;let deleteWorldbookId = null;function submitPassword(){lockPassword.verifyPassword()}function cancelPassword(){lockPassword.cancelPassword()}const originalUnlock=lockScreen.unlock;

/***********************************
* ✤ 世界书剧情总结界面
 ***********************************/
let selectedChatMessages=[],allChatMessages=[],currentSummary='';function loadAllChatsForSummary(){try{const e=appState?.chatManager?.getMessages?.()||[];if(allChatMessages=e,updateChatSelectionList(),updateSelectedCount(),selectedChatMessages.length>0&&(selectedChatMessages=selectedChatMessages.filter(e=>allChatMessages.some(t=>t.id===e.id))),console.log(`已加载 ${allChatMessages.length} 条聊天记录`),document.getElementById("summary-empty")&&(document.getElementById("summary-empty").style.display="none"),allChatMessages.length>0){const e=document.getElementById("summary-progress");e&&(e.style.display="none");const t=document.getElementById("summary-result");t&&(t.style.display="none")}showWorldbookStatus(`已加载 ${allChatMessages.length} 条聊天记录`,"success")}catch(e){console.error("加载聊天记录失败:",e),showWorldbookStatus("加载聊天记录失败","error")}}function updateChatSelectionList(){const e=document.getElementById("chat-selection-list");if(!e)return;if(0===allChatMessages.length)return e.innerHTML='<div style="text-align:center;padding:20px;color:#999;font-size:12px;">暂无聊天记录</div>',void 0;const t=allChatMessages.slice(-20);let a="";t.forEach((t,n)=>{const i=allChatMessages.length-20+n+1,o=i>0?i:n+1,l=selectedChatMessages.some(e=>e.id===t.id),d=t.sender==="user"?"我":"AI",c=t.content?.length>30?t.content.substring(0,30)+"...":t.content||"无内容";a+=`<div class="chat-selection-item" style="padding:8px;margin-bottom:6px;border:1px solid #ddd;border-radius:4px;background:#fff;cursor:pointer;" onclick="toggleChatSelection('${t.id}', event)"><div style="display:flex;align-items:center;gap:8px;"><div style="width:16px;height:16px;border:1px solid #000;border-radius:3px;display:flex;align-items:center;justify-content:center;background:${l?"#000":"#fff"}">${l?"✓":""}</div><div style="flex:1;min-width:0;"><div style="display:flex;justify-content:space-between;margin-bottom:3px;"><span style="font-size:11px;font-weight:600;color:#000;">${d}</span><span style="font-size:10px;color:#666;">第${o}条</span></div><div style="font-size:11px;color:#444;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${c}</div></div></div></div>`}),allChatMessages.length>20&&(a+=`<div style="text-align:center;padding:8px;font-size:11px;color:#666;border-top:1px dashed #ddd;margin-top:8px;">显示最近20条记录，共${allChatMessages.length}条</div>`),e.innerHTML=a}function toggleChatSelection(e,t){t&&t.stopPropagation();const a=allChatMessages.find(t=>t.id===e);if(!a)return;const n=selectedChatMessages.some(t=>t.id===e);n?selectedChatMessages=selectedChatMessages.filter(t=>t.id!==e):selectedChatMessages.push(a),updateChatSelectionList(),updateSelectedCount()}function toggleSelectAllChats(){if(0===allChatMessages.length)return;selectedChatMessages.length<allChatMessages.length?selectedChatMessages=[...allChatMessages]:selectedChatMessages=[],updateChatSelectionList(),updateSelectedCount()}function updateSelectedCount(){const e=document.getElementById("selected-count");e&&(e.textContent=selectedChatMessages.length)}function clearSummarySelection(){selectedChatMessages=[],updateChatSelectionList(),updateSelectedCount()}async function generateChatSummary(){if(0===selectedChatMessages.length)return void alert("请先选择要总结的聊天记录！");const e=appState?.apiService?.config?.apiKey;if(!e)return void(alert("请先在API配置中设置API密钥！"),setTimeout(()=>openApp("api"),500));const t=document.getElementById("summary-progress"),a=document.getElementById("summary-progress-fill"),n=document.getElementById("summary-progress-text"),i=document.getElementById("summary-progress-percent"),r=document.getElementById("summary-progress-detail");t&&(t.style.display="block",a.style.width="10%",n.textContent="正在准备生成...",i.textContent="10%",r.textContent=`准备处理 ${selectedChatMessages.length} 条聊天记录`);const o=document.getElementById("summary-length"),d=document.getElementById("summary-style");if(!o||!d)return void alert("界面元素缺失，请刷新页面重试");const c=o.value,l=d.value;let h=1000,s="";switch(c){case"short":h=500,s="500字简略版";break;case"medium":h=1e3,s="1000字标准版";break;case"long":h=2e3,s="2000字详细版"}let u="",p="";switch(l){case"modern":u="现代小说",p="采用现代叙事风格，时间地点明确，细节描写具体，情感真实自然。直接以时间开篇（例如'2024年10月10日晚十点'），包含具体时间、地点、人物动作、外貌着装、事件经过。人物对话融入叙述，心理活动自然穿插。结尾需有事件收束或情节推进。整段连续无空行，用句号分隔事件转折。";break;case"ancient":u="古典小说",p="采用章回体白话风格，以'话说'、'且说'开头，融入浅近文言词汇。时间表述为'某年某月某日某时'，地点描述典雅，人物称呼古风（如'公子'、'小姐'）。着装描写用古典词汇（如'锦袍'、'罗裙'）。事件叙述条理清晰，对话符合古代用语。结尾可加'正是'对仗句。整段连贯，无现代词汇。";break;case"romantic":u="唯美小说",p="采用诗意抒情风格，时间地点场景化描写（如'灯火璀璨的夜晚'）。人物外貌用比喻（如'闪钻如星河'），情感细腻，氛围渲染强烈。对话融入叙述，心理活动丰富。使用通感修辞，意象密集。结尾有意境升华。整段如散文诗，语言优美流畅。";break}try{t&&(a.style.width="30%",i.textContent="30%",n.textContent="正在分析对话...",r.textContent="提取核心情节与时间线");const m=selectedChatMessages.map(e=>`【${e.sender==="user"?"用户":"角色"}】${e.content}`).join("\n");t&&(a.style.width="50%",i.textContent="50%",n.textContent="正在构建叙事框架...",r.textContent="编排时间顺序与事件链条");const g=`# 小说式总结创作指令
请根据以下聊天对话记录，创作一段小说式叙事总结。要求融合叙事与总结，将对话转化为连贯的故事情节。
【原对话记录】${m}
【创作要求】1.${p}2.创作${s}的叙事总结3.严格遵循示例格式：以具体时间开篇，连续叙述事件，包含时间、地点、人物外貌、动作、对话、心理活动。4.对话内容自然融入叙述，不直接引用原句。5.有明确的事件推进和情节转折。6.结尾有阶段性收束或悬念。7.整段文字连续无空行，用句号分隔事件。
【示例格式】"2024年10月10日晚十点，法国波尔多一场国际慈善晚宴上，灯火璀璨，人声鼎沸。21岁身着闪钻纯白鱼尾裙...纪梵卿注视眼前与传言迥异的女孩...这是二人初次相遇...直到一个星期后...2024年10月20日上午九点半，上海陆家某高级相亲会场..."
【禁止事项】1.不要出现"总结"、"概述"等明显词汇。2.不要分段落或留空行。3.不要简单罗列对话要点。4.不要脱离示例的紧凑叙事风格。
【输出要求】直接输出完整叙事文本，不要任何标题、说明或标记。`;t&&(a.style.width="70%",i.textContent="70%",n.textContent="正在生成叙事总结...",r.textContent="AI正在创作小说式总结");let y="";try{if(appState?.apiService?.chatCompletion){const e=await appState.apiService.chatCompletion(g,"novel_summary",{maxTokens:2*h,temperature:l==="ancient"?0.8:0.7});y=e?.content?.trim()||""}if(!y){const e=appState?.apiService?.config?.apiKey,n=appState?.apiService?.config?.apiUrl||"https://api.openai.com/v1",i=appState?.apiService?.config?.model||"gpt-3.5-turbo",r=await fetch(`${n}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json","Authorization":`Bearer ${e}`},body:JSON.stringify({model:i,messages:[{role:"system",content:l==="ancient"?"你是精通章回体小说的专业作者，擅长将事件转化为古典叙事。":l==="romantic"?"你是诗意叙事作家，擅长将对话转化为唯美场景。":"你是专业叙事作者，擅长将对话转化为具体时间线的连贯故事。"},{role:"user",content:g}],max_tokens:2*h,temperature:l==="ancient"?0.8:0.7,top_p:.9})});if(r.ok){const e=await r.json();y=e.choices?.[0]?.message?.content?.trim()||""}}}catch(e){console.error("API调用失败:",e)}if(!y)throw new Error("生成失败");currentSummary=y;const b=y.replace(/\s/g,"").length;t&&(a.style.width="100%",i.textContent="100%",n.textContent="生成完成！",r.textContent=`成功生成${b}字的小说式总结`,setTimeout(()=>{t.style.display="none",a.style.width="0%"},2e3));const w=document.getElementById("summary-result"),k=document.getElementById("summary-content"),v=document.getElementById("summary-word-count"),C=document.getElementById("summary-style-display"),S=document.getElementById("summary-timestamp"),A=document.getElementById("summary-empty");w&&(w.style.display="block"),k&&(k.textContent=y),v&&(v.textContent=b),C&&(C.textContent=u),S&&(S.textContent=`${new Date().toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})} 生成`),A&&(A.style.display="none"),w?.scrollIntoView({behavior:"smooth",block:"nearest"}),showWorldbookStatus(`成功生成${b}字的小说式总结`,"success")}catch(e){console.error("生成失败:",e),t&&(t.style.display="none",a.style.width="0%");const a=selectedChatMessages.slice(0,3).map(e=>`${e.sender==="user"?"用户":"角色"}：${e.content?.substring(0,15)||""}`).join("；"),n=selectedChatMessages.length;let i=`2024年10月10日晚十点，法国波尔多慈善晚宴上，21岁的世纪白昼与22岁的纪梵卿首次相遇。她身着闪钻白裙不慎将红酒泼在他西装上，诚恳道歉并提出赔偿。纪梵卿注视眼前与传闻不同的女孩，只接受了道歉。一周后，因母亲催促，纪梵卿前往上海陆家嘴相亲会。2024年10月20日上午九点半，两人在相亲会场再次相遇。世纪白昼身着蓝色短裙匆忙冲出走廊，撞入纪梵卿怀中。他认出这张脸，心想一周内相遇两次实在巧合。此时经纪人电话响起，打断了他的思绪。`;if(l==="ancient"){i=`话说2024年10月10日晚十点，法国波尔多慈善晚宴，灯火辉煌。21岁白裙小姐世纪白昼匆忙间撞上22岁锦衣公子纪梵卿，酒渍染衣。小姐深鞠一躬，愿赔万金。公子观其神色诚恳，拒金受歉。七日后，公子奉母命赴上海相亲会。2024年10月20日辰时，陆家相亲场内，二人竟再逢。小姐着蓝纱裙急行廊间，复撞公子怀。公子暗忖：七日两遇，实乃奇缘。忽闻小姐怀中电话铃响，正是经纪人寻来。`}else if(l==="romantic"){i=`2024年10月10日那个灯火如星的夜晚，法国波尔多的晚宴上，21岁身着星河般闪钻长裙的世纪白昼，在转身的瞬间撞进了22岁纪梵卿的世界。红酒如命运泼洒在他纯白西装上，绽开一朵暗红的花。她低头道歉时发间的栀子香，让他记住了这个与传言不同的女孩。七天后，上海秋日的阳光里，母亲电话中的忧虑让他踏入相亲会场。2024年10月20日上午九点半，陆家嘴的玻璃长廊中，身着甸子蓝短裙的她像一只迷路的蝴蝶再次撞入他怀中。一周两次的相遇比小说更巧合，他尚未理清思绪，她包中响起的电话铃声已划破安静。`}currentSummary=i;const r=document.getElementById("summary-result"),d=document.getElementById("summary-content"),o=document.getElementById("summary-word-count"),h=document.getElementById("summary-style-display"),s=document.getElementById("summary-timestamp"),u=document.getElementById("summary-empty");r&&(r.style.display="block"),d&&(d.textContent=i),o&&(o.textContent=i.replace(/\s/g,"").length),h&&(h.textContent=u+"（本地生成）"),s&&(s.textContent=`${new Date().toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})} 生成`),u&&(u.style.display="none"),r?.scrollIntoView({behavior:"smooth",block:"nearest"}),showWorldbookStatus("使用本地模式生成了小说式总结","info")}}function copySummary(){if(!currentSummary)return void alert("没有可复制的内容");navigator.clipboard.writeText(currentSummary).then(()=>{alert("已复制到剪贴板")}).catch(e=>{console.error("复制失败:",e),alert("复制失败")})}function regenerateSummary(){0===selectedChatMessages.length?alert("请先选择聊天记录"):generateChatSummary()}document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("worldbook-interface");if(e){const t=new MutationObserver(function(t){t.forEach(function(t){"attributes"===t.type&&"class"===t.attributeName&&e.classList.contains("active")&&setTimeout(()=>{loadAllChatsForSummary()},300)})});t.observe(e,{attributes:!0})}});

/***********************************
* ✤ 桃源界面
 ***********************************/
let orderData=[],cartItems=[],favoriteItems=[],currentEditingCartItem=null,savedAddresses=[],selectedTag="家",userProfile={name:"某某"},selectedAddressIndex=-1,countdownTimers={},currentRecommendationId=null;function loadCustomFoods(){const e=localStorage.getItem('customFoods');if(e){const t=JSON.parse(e);return t.forEach(e=>e.isCustom=!0),t}return[]}function saveCustomFoods(e){const t=e.filter(e=>e.isCustom);localStorage.setItem('customFoods',JSON.stringify(t))}function initFoodDelivery(){walletManager.initWallet&&walletManager.initWallet();window.foodDelivery={hasActiveOrders:!1,cartItems:[],updateStatus:function(){updateStatusIndicators()}};const e=loadCustomFoods();window.foodData=[...foodData,...e];renderFoodItems();updateCart();loadOrdersFromStorage();loadFavoritesFromStorage();loadAddressesFromStorage();loadUserProfileFromStorage();updateCartAddress();setTimeout(()=>{setRandomRecommendation();document.getElementById("recommendation-modal").classList.add("active");document.getElementById("food-delivery-interface").querySelector(".overlay").classList.add("active")},2000);setupEventListeners();startAllCountdowns();renderEvaluations();setupAddFoodFunctionality();initFoodDeliveryIntegration()}function setupAddFoodFunctionality(){document.getElementById('add-food-category').addEventListener('click',function(){document.getElementById('add-food-modal').style.display='flex';document.getElementById('new-food-name').focus()});document.getElementById('add-food-modal-close').addEventListener('click',closeAddFoodModal);document.getElementById('add-food-cancel').addEventListener('click',closeAddFoodModal);document.getElementById('new-food-category').addEventListener('change',function(){const e=document.getElementById('new-food-custom-category');e.style.display=this.value==='自定义'?'block':'none'});document.getElementById('add-food-save').addEventListener('click',saveNewFood)}function closeAddFoodModal(){document.getElementById('add-food-modal').style.display='none';resetAddFoodForm()}function resetAddFoodForm(){document.getElementById('new-food-name').value='';document.getElementById('new-food-description').value='';document.getElementById('new-food-price').value='';document.getElementById('new-food-category').value='汉堡';document.getElementById('new-food-custom-category').value='';document.getElementById('new-food-custom-category').style.display='none';document.getElementById('new-food-icon').value='fas fa-hamburger';document.getElementById('new-food-features').value=''}function saveNewFood(){const e=document.getElementById('new-food-name').value.trim(),t=document.getElementById('new-food-description').value.trim(),a=parseFloat(document.getElementById('new-food-price').value),n=document.getElementById('new-food-icon').value,i=document.getElementById('new-food-features').value.trim();let o=document.getElementById('new-food-category').value;if(!e||!t||isNaN(a)||a<=0)return void alert('请输入有效的食物信息');if(o==='自定义'){const t=document.getElementById('new-food-custom-category').value.trim();if(!t)return void alert('请输入自定义分类名称');o=t}const r=i?i.split(',').map(e=>e.trim()).filter(e=>e):[],s={id:'custom_'+Date.now(),name:e,description:t,price:a,category:o,icon:n,features:r,isFavorite:!1,isCustom:!0},d=loadCustomFoods();d.push(s);saveCustomFoods(d);window.foodData.push(s);renderFoodItems();closeAddFoodModal();alert(`"${e}" 已成功添加到 ${o} 分类中！`)}function deleteCustomFood(e){if(!confirm('确定要永久删除这个食物吗？'))return;const t=window.foodData.findIndex(t=>t.id===e);if(t===-1)return;window.foodData.splice(t,1);const a=loadCustomFoods(),n=a.filter(t=>t.id!==e);saveCustomFoods(n);renderFoodItems();alert('食物已永久删除！')}function renderFoodItems(){const e=document.getElementById('food-grid'),t=document.getElementById('hot-food-grid');e.innerHTML='';t.innerHTML='';window.foodData.slice(0,4).forEach(a=>{e.appendChild(createFoodCard(a))});window.foodData.forEach(a=>{t.appendChild(createFoodCard(a))})}function createFoodCard(e){const t=document.createElement('div');t.className='food-card';const a=e.isCustom?`<button class="delete-food-btn" data-id="${e.id}" title="删除此食物">✖</button>`:'';t.innerHTML=`<div class="card-top-buttons"><button class="favorite-btn ${e.isFavorite?'active':''}" data-id="${e.id}"><i class="${e.isFavorite?'fas':'far'} fa-heart"></i></button>${a}</div><div class="food-icon"><i class="${e.icon}"></i></div><div class="food-info"><div class="food-name">${e.name}<span class="food-category">${e.category}</span></div><div class="food-desc">${e.description}</div><div class="food-features">${e.features.map(e=>`<span class="food-feature">${e}</span>`).join('')}</div><div class="food-footer"><div class="food-price">¥${e.price}</div><button class="add-to-cart-btn" data-id="${e.id}"><i class="fas fa-plus"></i></button></div></div>`;t.querySelector('.favorite-btn').addEventListener('click',function(a){a.stopPropagation();toggleFavorite(e.id)});t.querySelector('.add-to-cart-btn').addEventListener('click',function(a){a.stopPropagation();openEditModalForFood(e.id)});e.isCustom&&t.querySelector('.delete-food-btn').addEventListener('click',function(a){a.stopPropagation();deleteCustomFood(e.id)});t.addEventListener('click',function(a){a.target.closest('button')||openEditModalForFood(e.id)});return t}function openEditModalForFood(e){const t=window.foodData.find(t=>t.id==e);if(!t)return void console.error("找不到食物:",e);console.log("正在编辑的食物:",t.name,t.category);const a=cartItems.find(a=>a.id==e);currentEditingCartItem=a?{id:a.id,name:a.name,price:a.price,quantity:a.quantity,icon:a.icon,remark:a.remark||"",utensils:a.utensils||"需要餐具",description:a.description||t.description,features:a.features||t.features,category:a.category||t.category,isCustom:a.isCustom||t.isCustom||!1}:{id:t.id,name:t.name,price:t.price,quantity:1,icon:t.icon,remark:"",utensils:"需要餐具",description:t.description||"",features:t.features||[],category:t.category||"",isCustom:t.isCustom||!1};showCartItemDetail(e)}function setRandomRecommendation(){const e=Math.floor(Math.random()*window.foodData.length),t=window.foodData[e];currentRecommendationId=t.id;document.getElementById('recommendation-modal-icon').innerHTML=`<i class="${t.icon}"></i>`;document.getElementById('recommendation-modal-title').textContent=t.name;document.getElementById('recommendation-modal-subtitle').textContent="今日特惠 · 限量供应";document.getElementById('recommendation-modal-desc').textContent=t.description;document.getElementById('recommendation-modal-price').textContent=`¥${t.price}`;const a=document.getElementById('recommendation-modal-features');a.innerHTML='';t.features.forEach(e=>{const t=document.createElement('div');t.className='modal-feature';t.textContent=e;a.appendChild(t)})}function loadOrdersFromStorage(){const e=localStorage.getItem('foodDeliveryOrders');if(e){orderData=JSON.parse(e);orderData=orderData.filter(e=>e.status!=='canceled');updateOrderStatuses();saveOrdersToStorage();renderOrderList()}}function updateOrderStatuses(){const e=new Date();orderData.forEach(t=>{if(t.status==='delivering'){if(t.deliveryTime&&new Date(t.deliveryTime)<e){t.status='overtime';t.isOvertime=!0}if(t.estimatedArrivalTime&&new Date(t.estimatedArrivalTime)<e){t.status='delivered'}}})}function saveOrdersToStorage(){localStorage.setItem('foodDeliveryOrders',JSON.stringify(orderData))}function loadFavoritesFromStorage(){const e=localStorage.getItem('foodDeliveryFavorites');if(e){const t=JSON.parse(e);favoriteItems=[];window.foodData.forEach(a=>{a.isFavorite=t.includes(a.id);a.isFavorite&&favoriteItems.push(a)})}}function saveFavoritesToStorage(){const e=window.foodData.filter(e=>e.isFavorite).map(e=>e.id);localStorage.setItem('foodDeliveryFavorites',JSON.stringify(e))}function loadUserProfileFromStorage(){const e=localStorage.getItem('foodDeliveryProfile');if(e){userProfile=JSON.parse(e);document.getElementById('name-text').textContent=userProfile.name;document.getElementById('name-edit-input').value=userProfile.name}}function saveUserProfileToStorage(){localStorage.setItem('foodDeliveryProfile',JSON.stringify(userProfile))}function renderOrderList(e="all"){const t=document.getElementById('orders-list'),a=t.querySelectorAll('.order-card');a.forEach(e=>e.remove());const n=t.querySelector('.empty-orders:not(#empty-orders)');if(n){n.remove()}const i=orderData.filter(e=>e.status!=='canceled');if(0===i.length){document.getElementById('empty-orders').style.display='block';return}document.getElementById('empty-orders').style.display='none';let o=i;if("all"!==e){if("overtime"===e){o=i.filter(e=>!0===e.isOvertime)}else{o=i.filter(t=>t.status===e)}}if(0===o.length){const a=document.createElement('div');a.className='empty-orders';a.innerHTML=`<i class="fas fa-filter"></i><p>没有${getFilterText(e)}的订单</p>`;t.appendChild(a);return}o.forEach(e=>{const a=createOrderCard(e);t.appendChild(a)})}function getFilterText(e){switch(e){case"delivering":return"配送中";case"delivered":return"已送达";case"canceled":return"已取消";case"overtime":return"已超时";default:return""}}function createOrderCard(e){const t=document.createElement('div');t.className='order-card';t.setAttribute('data-id',e.id);const a=e.items.reduce((t,a)=>t+a.price*a.quantity,0);let n="",i="";switch(e.status){case"delivering":n="配送中";i="status-delivering";break;case"delivered":n="已送达";i="status-delivered";break;case"canceled":n="已取消";i="status-canceled";break;case"overtime":n="已超时";i="status-overtime";break}t.innerHTML=`<div class="order-header"><div class="order-status ${i}">${n}</div><div class="order-time">${e.time}</div></div><div class="order-content"><div class="order-restaurant"><i class="fas fa-store"></i>${e.restaurant}</div><div class="order-items">${e.items.map(e=>`<div class="order-item"><div class="order-item-name">${e.name}</div><div class="order-item-quantity">×${e.quantity}</div><div class="order-item-price">¥${e.price.toFixed(1)}</div></div>`).join('')}</div><div class="order-total"><span>总计</span><span>¥${a.toFixed(1)}</span></div></div><div class="order-footer"><div class="order-actions"><button class="order-btn primary view-detail-btn" data-id="${e.id}">查看详情</button>${'delivered'===e.status?`<button class="order-btn primary evaluate-btn" data-id="${e.id}">评价订单</button>`:''}<button class="order-btn danger delete-order-btn" data-id="${e.id}">删除订单</button></div></div>`;return t}function generateStarRating(e){let t="";const a=Math.floor(e),n=e%1>=.5;for(let i=0;i<a;i++){t+='<i class="fas fa-star"></i>'}if(n){t+='<i class="fas fa-star-half-alt"></i>'}const o=5-a-(n?1:0);for(let i=0;i<o;i++){t+='<i class="far fa-star"></i>'}return t}function showOrderDetail(e){const t=orderData.find(t=>t.id===e);if(!t)return;const a=document.getElementById('order-detail-content'),n=t.items.reduce((e,t)=>e+t.price*t.quantity,0);let i="0%",o=!1,s=!1,d=!1,r=!1;const l=new Date(),c=new Date(t.time),u=t.pickupTime?new Date(t.pickupTime):new Date(c.getTime()+5*6e4),p=t.deliveryTime?new Date(t.deliveryTime):new Date(u.getTime()+15*6e4),m=t.estimatedArrivalTime?new Date(t.estimatedArrivalTime):new Date(p.getTime()+10*6e4);o=!0;s=l>=u;d=l>=p;r='delivered'===t.status||l>=m;r?i="100%":d?i="75%":s?i="50%":o&&(i="25%");const f=generateCountdownHtml(t),h=generateStarRating(t.riderRating||5);a.innerHTML=`<div class="detail-section"><h3 class="detail-section-title"><i class="fas fa-clock"></i>配送信息</h3>${f}<div class="delivery-progress"><div class="progress-steps"><div class="progress-step"><div class="step-icon ${o?'active':''}">1</div><div class="step-label ${o?'active':''}">接单</div></div><div class="progress-step"><div class="step-icon ${s?'active':''}">2</div><div class="step-label ${s?'active':''}">取餐</div></div><div class="progress-step"><div class="step-icon ${d?'active':''}">3</div><div class="step-label ${d?'active':''}">配送</div></div><div class="progress-step"><div class="step-icon ${r?'active':''}">4</div><div class="step-label ${r?'active':''}">送达</div></div></div><div class="progress-bar"><div class="progress-fill" style="width: ${i}"></div></div></div><div class="rider-info"><div class="rider-name">${t.riderName} 骑手</div><div class="rider-rating"><div class="star-rating">${h}</div><span>${t.riderRating||5}</span></div></div><div class="detail-address"><div class="address-label">配送地址</div><div class="address-value">${t.deliveryAddress}</div></div></div><div class="detail-section"><h3 class="detail-section-title"><i class="fas fa-utensils"></i>订单详情</h3><div class="detail-items-list">${t.items.map(e=>{const a=window.foodData.find(t=>t.name===e.name)||{icon:"fas fa-utensils",description:""};return`<div class="detail-item"><div class="detail-item-img"><i class="${a.icon}"></i></div><div class="detail-item-info"><div class="detail-item-name">${e.name} ×${e.quantity}</div><div class="detail-item-desc">${a.description}</div><div class="detail-item-price">¥${e.price.toFixed(1)}</div></div></div>`}).join('')}</div><div class="order-total" style="margin-top:16px"><span>总计</span><span>¥${n.toFixed(1)}</span></div></div><div class="detail-section"><h3 class="detail-section-title"><i class="fas fa-sticky-note"></i>订单备注</h3><div class="detail-remark"><div class="remark-label">备注信息</div><div class="remark-value">${t.remark||"无"}</div></div><div class="detail-utensils"><div class="utensil-option ${'需要餐具'===t.utensils?'active':''}"><i class="fas fa-utensils"></i><span>需要餐具</span></div><div class="utensil-option ${'不需要餐具'===t.utensils?'active':''}"><i class="fas fa-ban"></i><span>不需要餐具</span></div></div></div>${'delivered'===t.status||t.isOvertime?`<div class="detail-section"><h3 class="detail-section-title"><i class="fas fa-star"></i>订单评价</h3><div style="padding:10px 0"><button class="order-btn primary" id="evaluate-order-btn" data-id="${t.id}" style="width:100%">前往评价</button></div></div>`:''}<div class="detail-section"><button class="order-btn danger delete-order-detail-btn" data-id="${t.id}" style="width:100%">删除订单</button></div>`;document.getElementById('order-detail-modal').classList.add('active');const v=document.querySelector('.delete-order-detail-btn');v&&v.addEventListener('click',function(){const e=parseInt(this.getAttribute('data-id'));deleteOrder(e)});const g=document.getElementById('evaluate-order-btn');if(g){g.addEventListener('click',function(){const e=parseInt(this.getAttribute('data-id'));document.getElementById('order-detail-modal').classList.remove('active');document.querySelectorAll('.food-page-container').forEach(t=>{t.classList.remove('active')});document.getElementById('evaluations-page').classList.add('active');document.querySelectorAll('#food-delivery-interface .nav-item').forEach(t=>{t.classList.remove('active')});renderEvaluations();setTimeout(()=>{const t=document.querySelector(`.evaluation-card[data-id="${e}"]`);t&&t.scrollIntoView({behavior:'smooth',block:'center'})},100)})}startCountdown(e)}function generateCountdownHtml(e){const t=new Date(),a=e.estimatedArrivalTime?new Date(e.estimatedArrivalTime):new Date(new Date(e.time).getTime()+30*6e4),n=a.getTime()-t.getTime();if('delivered'===e.status){return`<div class="delivery-time-info"><div class="delivery-time-label">送达时间</div><div class="delivery-time-value">${e.deliveredTime||'已送达'}</div></div>`}if(n<0||e.isOvertime){return`<div class="delivery-time-info"><div class="delivery-time-label">预计送达时间</div><div class="delivery-time-value overtime">${formatTime(a)}</div></div><div class="time-countdown"><div class="countdown-timer overtime">已超时</div></div>`}const i=Math.max(0,Math.floor(n/60000)),o=Math.max(0,Math.floor(n%60000/1000));return`<div class="delivery-time-info"><div class="delivery-time-label">预计送达时间</div><div class="delivery-time-value">${formatTime(a)}</div></div><div class="time-countdown"><div class="countdown-timer" id="countdown-${e.id}">剩余 ${i}分${o}秒</div></div>`}function formatTime(e){const t=e.getHours().toString().padStart(2,'0'),a=e.getMinutes().toString().padStart(2,'0');return`${t}:${a}`}function startCountdown(e){const t=orderData.find(t=>t.id===e);if(!t||'delivered'===t.status||'canceled'===t.status)return;countdownTimers[e]&&clearInterval(countdownTimers[e]);countdownTimers[e]=setInterval(()=>{updateOrderCountdown(e)},1e3)}function startAllCountdowns(){orderData.forEach(e=>{'delivering'===e.status&&!e.isOvertime&&startCountdown(e.id)})}function updateOrderCountdown(e){const t=orderData.find(t=>t.id===e);if(!t){countdownTimers[e]&&(clearInterval(countdownTimers[e]),delete countdownTimers[e]);return}if('delivered'===t.status||'canceled'===t.status){countdownTimers[e]&&(clearInterval(countdownTimers[e]),delete countdownTimers[e]);return}const a=new Date(),n=t.estimatedArrivalTime?new Date(t.estimatedArrivalTime):new Date(new Date(t.time).getTime()+30*6e4),i=n.getTime()-a.getTime(),o=document.getElementById(`countdown-${e}`);if(o){if(i<=0){o.textContent=`已超时`;o.className='countdown-timer overtime';if(!t.isOvertime){t.isOvertime=!0;t.status='overtime';saveOrdersToStorage();const a=document.querySelector('.filter-btn.active').getAttribute('data-filter');renderOrderList(a);showNotification(`订单 ${e} 已超时`)}}else{const n=Math.floor(i/60000),d=Math.floor(i%60000/1000);o.textContent=`剩余 ${n}分${d}秒`;o.className='countdown-timer'}}const s=t.riderRating||5;if(s<3){if(!t.isOvertime){t.estimatedArrivalTime=new Date(n.getTime()+5e3).toISOString()}}else if(3===s&&!t.isOvertime&&Math.random()<.5){t.estimatedArrivalTime=new Date(n.getTime()+5e3).toISOString()}}function deleteOrder(e){const t=orderData.findIndex(t=>t.id===e);if(-1===t)return;if(confirm('确定要删除这个订单吗？')){orderData.splice(t,1);saveOrdersToStorage();countdownTimers[e]&&(clearInterval(countdownTimers[e]),delete countdownTimers[e]);const a=document.querySelector('.filter-btn.active').getAttribute('data-filter');renderOrderList(a);renderEvaluations();document.getElementById('order-detail-modal').classList.remove('active');showNotification('订单已删除')}}function showCartItemDetail(e){const t=document.getElementById('cart-detail-content');t.innerHTML=`<div class="detail-item"><div class="detail-item-img"><i class="${currentEditingCartItem.icon}"></i></div><div class="detail-item-info"><div class="detail-item-name">${currentEditingCartItem.name}</div><div class="detail-item-desc">${currentEditingCartItem.description||""}</div><div class="detail-item-price">¥${currentEditingCartItem.price.toFixed(1)}</div></div></div><div class="quantity-control"><button class="quantity-btn" id="decrease-quantity"><i class="fas fa-minus"></i></button><div class="quantity-value" id="detail-quantity">${currentEditingCartItem.quantity}</div><button class="quantity-btn" id="increase-quantity"><i class="fas fa-plus"></i></button></div><div class="cart-detail-remark"><div class="detail-section-title"><i class="fas fa-sticky-note"></i>备注信息</div><textarea class="remark-input" id="detail-remark" placeholder="请输入备注信息（如：少辣、不要香菜等）">${currentEditingCartItem.remark||""}</textarea></div><div class="cart-detail-utensils"><div class="detail-section-title"><i class="fas fa-utensils"></i>餐具选择</div><div class="detail-utensils"><div class="utensil-option ${'需要餐具'===currentEditingCartItem.utensils?'active':''}" data-utensil="需要餐具"><i class="fas fa-utensils"></i><span>需要餐具</span></div><div class="utensil-option ${'不需要餐具'===currentEditingCartItem.utensils?'active':''}" data-utensil="不需要餐具"><i class="fas fa-ban"></i><span>不需要餐具</span></div></div></div>`;const a=document.getElementById('detail-quantity');document.getElementById('decrease-quantity').addEventListener('click',()=>{let e=parseInt(a.textContent);e>1&&(a.textContent=e-1)});document.getElementById('increase-quantity').addEventListener('click',()=>a.textContent=parseInt(a.textContent)+1);document.querySelectorAll('.utensil-option').forEach(e=>{e.addEventListener('click',function(){document.querySelectorAll('.utensil-option').forEach(e=>e.classList.remove('active'));this.classList.add('active')})});document.getElementById('cart-detail-modal').classList.add('active');document.getElementById('overlay').classList.add('active')}function saveCartItemDetail(){if(!currentEditingCartItem)return;const e=parseInt(document.getElementById('detail-quantity').textContent),t=document.getElementById('detail-remark').value.trim(),a=document.querySelector('.utensil-option.active').getAttribute('data-utensil'),n=cartItems.findIndex(t=>t.id===currentEditingCartItem.id);if(-1!==n){cartItems[n].quantity=e;cartItems[n].remark=t;cartItems[n].utensils=a}else{const n=window.foodData.find(t=>t.id===currentEditingCartItem.id);n&&cartItems.push({id:n.id,name:n.name,price:n.price,quantity:e,icon:n.icon,description:n.description||"",features:n.features||[],category:n.category||"",remark:t,utensils:a,isCustom:n.isCustom||!1})}updateCart();document.getElementById('cart-detail-modal').classList.remove('active');document.getElementById('overlay').classList.remove('active');showNotification('已保存修改')}function loadAddressesFromStorage(){const e=localStorage.getItem('foodDeliveryAddresses');if(e){savedAddresses=JSON.parse(e);renderSavedAddresses()}}function saveAddressesToStorage(){localStorage.setItem('foodDeliveryAddresses',JSON.stringify(savedAddresses))}function renderSavedAddresses(){const e=document.getElementById('address-list');e.innerHTML='';if(0===savedAddresses.length){e.innerHTML='<div class="no-addresses"><i class="fas fa-map-marker-alt"></i><p>暂无已保存的地址</p><p>请在上方添加您的地址</p></div>';return}savedAddresses.forEach((t,a)=>{const n=document.createElement('div');n.className=`address-item ${a===selectedAddressIndex?'active':''}`;n.setAttribute('data-index',a);n.innerHTML=`<div class="address-item-header"><div class="address-item-name">${t.tag}<span class="address-tag-small">${t.tag}地址</span></div><div class="address-item-actions"><button class="address-item-action-btn edit-address-btn" data-index="${a}"><i class="fas fa-edit"></i></button><button class="address-item-action-btn delete-address-btn" data-index="${a}"><i class="fas fa-trash-alt"></i></button></div></div><div class="address-item-content">${t.address}</div>`;e.appendChild(n)})}function addNewAddress(e,t){const a={address:e,tag:t},n=savedAddresses.findIndex(e=>e.tag===t);-1!==n?(savedAddresses[n]=a,showNotification(`已更新${t}地址`)):(savedAddresses.push(a),showNotification(`已保存${t}地址`));0===savedAddresses.length&&(selectedAddressIndex=0);saveAddressesToStorage();renderSavedAddresses();updateCartAddress();document.getElementById('address-input').value=''}function editAddress(e){if(e>=0&&e<savedAddresses.length){const t=savedAddresses[e];document.getElementById('address-input').value=t.address;selectedTag=t.tag;document.querySelectorAll('.address-tag').forEach(a=>{a.classList.remove('active');a.getAttribute('data-tag')===t.tag&&a.classList.add('active')});document.querySelector('.address-content').scrollTop=0;document.getElementById('address-input').focus();selectedAddressIndex=e;renderSavedAddresses()}}function deleteAddress(e){if(e>=0&&e<savedAddresses.length){const t=savedAddresses[e].tag;savedAddresses.splice(e,1);selectedAddressIndex===e?selectedAddressIndex=-1:selectedAddressIndex>e&&selectedAddressIndex--;saveAddressesToStorage();renderSavedAddresses();updateCartAddress();showNotification(`已删除${t}地址`)}}function updateCartAddress(){const e=document.getElementById('cart-address-info'),t=document.getElementById('cart-address-content');if(0===savedAddresses.length){e.classList.add('empty');t.textContent='请添加收货地址'}else{e.classList.remove('empty');const a=selectedAddressIndex>=0?selectedAddressIndex:0,s=savedAddresses[a];t.innerHTML=`<div>${userProfile.name}</div><div>${s.address}</div><div style="font-size:12px;color:#999;margin-top:4px">${s.tag}地址</div>`}}function toggleFavorite(e){const t=window.foodData.find(t=>t.id===e);if(!t)return;t.isFavorite=!t.isFavorite;if(t.isFavorite){favoriteItems.find(t=>t.id===e)||favoriteItems.push(t);showNotification(`${t.name} 已添加到收藏`)}else{const a=favoriteItems.findIndex(t=>t.id===e);-1!==a&&favoriteItems.splice(a,1);showNotification(`${t.name} 已取消收藏`)}saveFavoritesToStorage();renderFoodItems();document.getElementById('favorites-page').classList.contains('active')&&renderFavorites()}function showFoodDetail(e){alert(`美食详情：\n\n${e.name}\n${e.description}\n\n特色：${e.features.join('、')}\n价格：¥${e.price}`)}function updateCart(){const e=cartItems.reduce((e,t)=>e+t.quantity,0);document.getElementById('cart-count').textContent=e;renderCartItems();updateCartTotal();window.foodDelivery.cartItems=cartItems;window.foodDelivery.updateStatus()}function renderCartItems(){const e=document.getElementById('cart-items');e.innerHTML='';if(0===cartItems.length){e.innerHTML='<div style="text-align:center;padding:40px;color:#999">购物车是空的</div>';return}cartItems.forEach(t=>{const a=document.createElement('div');a.className='cart-item';a.innerHTML=`<div class="cart-item-icon"><i class="${t.icon}"></i></div><div class="cart-item-info"><div class="cart-item-name">${t.name}</div><div class="cart-item-price">¥${t.price}</div><div class="cart-item-controls"><div class="cart-item-quantity"><button class="quantity-btn-small minus" data-id="${t.id}"><i class="fas fa-minus"></i></button><div class="cart-item-quantity-value">${t.quantity}</div><button class="quantity-btn-small plus" data-id="${t.id}"><i class="fas fa-plus"></i></button></div><button class="cart-item-detail-btn detail-btn" data-id="${t.id}"><i class="fas fa-edit"></i> 编辑</button></div></div>`;e.appendChild(a)});document.querySelectorAll('.quantity-btn-small.minus').forEach(e=>{e.addEventListener('click',function(){const t=this.getAttribute('data-id');decreaseQuantity(t)})});document.querySelectorAll('.quantity-btn-small.plus').forEach(e=>{e.addEventListener('click',function(){const t=this.getAttribute('data-id');increaseQuantity(t)})});document.querySelectorAll('.detail-btn').forEach(e=>{e.addEventListener('click',function(){const t=this.getAttribute('data-id');openEditModalForFood(t)})})}function increaseQuantity(e){const t=cartItems.find(t=>t.id==e);t&&(t.quantity++,updateCart())}function decreaseQuantity(e){const t=cartItems.findIndex(t=>t.id==e);if(-1!==t){if(cartItems[t].quantity>1){cartItems[t].quantity--}else{cartItems.splice(t,1)}updateCart()}}function updateCartTotal(){const e=cartItems.reduce((e,t)=>e+t.price*t.quantity,0);document.getElementById('cart-total-price').textContent=`¥${e.toFixed(1)}`}function renderFavorites(){const e=document.getElementById('favorites-list'),t=document.getElementById('empty-favorites'),a=e.querySelectorAll('.food-card');a.forEach(e=>e.remove());if(0===favoriteItems.length){t.style.display='block';return}t.style.display='none';favoriteItems.forEach(t=>{const a=createFoodCard(t);e.appendChild(a)})}function renderEvaluations(){const e=document.getElementById('evaluations-list'),t=document.getElementById('empty-evaluations'),a=e.querySelectorAll('.evaluation-card');a.forEach(e=>e.remove());const n=orderData.filter(e=>'delivered'===e.status||'overtime'===e.status);if(0===n.length){t.style.display='block';return}t.style.display='none';n.forEach(e=>{const t=createEvaluationCard(e);e.appendChild(t)})}function createEvaluationCard(e){const t=document.createElement('div');t.className='evaluation-card';t.setAttribute('data-id',e.id);const a=e.items.reduce((t,a)=>t+a.price*a.quantity,0),n=e.items.map(e=>`${e.name} ×${e.quantity}`).join('，'),i='overtime'===e.status,o=e.evaluated&&e.evaluation;if(o){const a=e.evaluation;t.innerHTML=`<div class="evaluation-header"><div class="evaluation-restaurant">${e.restaurant}</div><div class="evaluation-time">${e.time} ${i?'<span style="color:#f44336">(已超时)</span>':''}</div></div><div class="submitted-evaluation"><div class="submitted-evaluation-header"><div class="submitted-evaluation-title">已评价</div><div class="submitted-evaluation-time">评价时间: ${a.time||'刚刚'}</div></div><div class="submitted-rating"><div class="star-rating">${generateStarRating(a.rating)}</div><span style="margin-left:8px;font-weight:600">${a.rating}分</span></div><div class="submitted-comment">${a.comment}</div><div class="evaluation-actions"><button class="evaluation-btn danger delete-evaluation-btn" data-id="${e.id}"><i class="fas fa-trash-alt"></i> 删除评价</button></div></div>`}else{t.innerHTML=`<div class="evaluation-header"><div class="evaluation-restaurant">${e.restaurant}</div><div class="evaluation-time">${e.time} ${i?'<span style="color:#f44336">(已超时)</span>':''}</div></div><div class="evaluation-content"><p style="margin-bottom:16px;color:var(--secondary-color)">${n}</p><p style="margin-bottom:16px;color:var(--primary-color);font-weight:600">总价: ¥${a.toFixed(1)}</p><div class="rating-section"><div class="rating-title">请为${e.riderName}骑手评分</div><div class="star-rating-input" id="rating-${e.id}"><i class="far fa-star star-input" data-rating="1"></i><i class="far fa-star star-input" data-rating="2"></i><i class="far fa-star star-input" data-rating="3"></i><i class="far fa-star star-input" data-rating="4"></i><i class="far fa-star star-input" data-rating="5"></i></div><div style="font-size:12px;color:var(--secondary-color);margin-top:4px">骑手当前评分: ${e.riderRating||5}星</div></div><div class="comment-section"><div class="rating-title">评价内容</div><textarea class="comment-input" id="comment-${e.id}" placeholder="请写下您的评价...${i?' (骑手配送超时，您可以在评价中反馈)':''}"></textarea></div><div class="evaluation-actions"><button class="evaluation-btn primary submit-evaluation-btn" data-id="${e.id}">提交评价</button></div></div>`;const a=t.querySelectorAll(`#rating-${e.id} .star-input`);a.forEach(t=>{t.addEventListener('click',function(){const a=parseInt(this.getAttribute('data-rating')),n=t.querySelectorAll(`#rating-${e.id} .star-input`);n.forEach((t,n)=>{n<a?t.className='fas fa-star star-input active':t.className='far fa-star star-input'});t.setAttribute('data-rating',a)})})}return t}function submitEvaluation(e,t,a){const n=orderData.find(n=>n.id===e);if(!n)return;n.evaluated=!0;n.evaluation={rating:t,comment:a,time:new Date().toLocaleString()};const i=n.riderRating||5,o=(i+t)/2;n.riderRating=parseFloat(o.toFixed(1));saveOrdersToStorage();renderEvaluations();showNotification('评价提交成功，感谢您的反馈！')}function deleteEvaluation(e){const t=orderData.find(t=>t.id===e);if(!t)return;confirm('确定要删除这个评价吗？')&&(t.evaluated=!1,delete t.evaluation,saveOrdersToStorage(),renderEvaluations(),showNotification('评价已删除'))}function setupEventListeners(){document.querySelectorAll('.filter-btn').forEach(e=>{e.addEventListener('click',function(){document.querySelectorAll('.filter-btn').forEach(e=>{e.classList.remove('active')});this.classList.add('active');const e=this.getAttribute('data-filter');renderOrderList(e)})});document.addEventListener('click',function(e){if(e.target.closest('.view-detail-btn')){const t=parseInt(e.target.closest('.view-detail-btn').getAttribute('data-id'));showOrderDetail(t)}});document.addEventListener('click',function(e){if(e.target.closest('.evaluate-btn')){const t=parseInt(e.target.closest('.evaluate-btn').getAttribute('data-id'));document.querySelectorAll('.food-page-container').forEach(e=>{e.classList.remove('active')});document.getElementById('evaluations-page').classList.add('active');document.querySelectorAll('#food-delivery-interface .nav-item').forEach(e=>{e.classList.remove('active')});renderEvaluations();setTimeout(()=>{const e=document.querySelector(`.evaluation-card[data-id="${t}"]`);e&&e.scrollIntoView({behavior:'smooth',block:'center'})},100)}});document.addEventListener('click',function(e){if(e.target.closest('.delete-order-btn')){const t=parseInt(e.target.closest('.delete-order-btn').getAttribute('data-id'));deleteOrder(t)}});document.addEventListener('click',function(e){if(e.target.closest('.delete-evaluation-btn')){const t=parseInt(e.target.closest('.delete-evaluation-btn').getAttribute('data-id'));deleteEvaluation(t)}});document.getElementById('order-detail-close').addEventListener('click',function(){document.getElementById('order-detail-modal').classList.remove('active')});document.getElementById('cart-detail-save').addEventListener('click',saveCartItemDetail);document.getElementById('cart-detail-cancel').addEventListener('click',function(){document.getElementById('cart-detail-modal').classList.remove('active');document.getElementById('overlay').classList.remove('active')});document.getElementById('cart-detail-close').addEventListener('click',function(){document.getElementById('cart-detail-modal').classList.remove('active');document.getElementById('overlay').classList.remove('active')});document.getElementById('address-menu-item').addEventListener('click',function(){document.getElementById('address-panel').classList.add('active');document.getElementById('overlay').classList.add('active')});document.getElementById('favorites-menu-item').addEventListener('click',function(){document.querySelectorAll('.food-page-container').forEach(e=>{e.classList.remove('active')});document.getElementById('favorites-page').classList.add('active');document.querySelectorAll('#food-delivery-interface .nav-item').forEach(e=>{e.classList.remove('active')});renderFavorites()});document.getElementById('evaluations-menu-item').addEventListener('click',function(){document.querySelectorAll('.food-page-container').forEach(e=>{e.classList.remove('active')});document.getElementById('evaluations-page').classList.add('active');document.querySelectorAll('#food-delivery-interface .nav-item').forEach(e=>{e.classList.remove('active')});renderEvaluations()});document.addEventListener('click',function(e){if(e.target.closest('.submit-evaluation-btn')){const t=parseInt(e.target.closest('.submit-evaluation-btn').getAttribute('data-id')),a=document.querySelector(`.evaluation-card[data-id="${t}"]`);let n=a.getAttribute('data-rating')||0;if(!n||'0'===n)return void alert('请为骑手评分');n=parseInt(n);const i=document.getElementById(`comment-${t}`).value.trim();if(!i)return void alert('请填写评价内容');submitEvaluation(t,n,i)}});document.getElementById('address-close').addEventListener('click',function(){document.getElementById('address-panel').classList.remove('active');document.getElementById('overlay').classList.remove('active');document.getElementById('address-input').value='';selectedAddressIndex=-1;renderSavedAddresses()});document.querySelectorAll('.address-tag').forEach(e=>{e.addEventListener('click',function(){document.querySelectorAll('.address-tag').forEach(e=>{e.classList.remove('active')});this.classList.add('active');selectedTag=this.getAttribute('data-tag');const e=savedAddresses.find(e=>e.tag===selectedTag);e&&-1===selectedAddressIndex&&(document.getElementById('address-input').value=e.address)})});document.getElementById('save-address-btn').addEventListener('click',function(){const e=document.getElementById('address-input'),t=e.value.trim();if(!t)return void(showNotification('请输入地址'),e.focus());if(-1!==selectedAddressIndex){savedAddresses[selectedAddressIndex]={address:t,tag:selectedTag};saveAddressesToStorage();renderSavedAddresses();updateCartAddress();showNotification(`已更新${selectedTag}地址`);selectedAddressIndex=-1;e.value=''}else addNewAddress(t,selectedTag)});document.addEventListener('click',function(e){if(e.target.closest('.address-item')&&!e.target.closest('.address-item-actions')){const t=e.target.closest('.address-item'),a=parseInt(t.getAttribute('data-index'));if(a>=0&&a<savedAddresses.length){selectedAddressIndex=a;renderSavedAddresses();updateCartAddress();setTimeout(()=>{document.getElementById('address-panel').classList.remove('active');document.getElementById('overlay').classList.remove('active')},300);showNotification(`已选择${savedAddresses[a].tag}地址`)}}if(e.target.closest('.edit-address-btn')){e.stopPropagation();const t=e.target.closest('.edit-address-btn'),a=parseInt(t.getAttribute('data-index'));editAddress(a)}if(e.target.closest('.delete-address-btn')){e.stopPropagation();const t=e.target.closest('.delete-address-btn'),a=parseInt(t.getAttribute('data-index'));confirm('确定要删除这个地址吗？')&&deleteAddress(a)}});document.getElementById('cart-btn').addEventListener('click',function(){document.getElementById('cart-panel').classList.add('active');document.getElementById('overlay').classList.add('active')});document.getElementById('cart-close').addEventListener('click',function(){document.getElementById('cart-panel').classList.remove('active');document.getElementById('overlay').classList.remove('active')});document.getElementById('cart-change-address').addEventListener('click',function(){document.getElementById('cart-panel').classList.remove('active');document.getElementById('address-panel').classList.add('active')});document.getElementById('cart-address-info').addEventListener('click',function(){0===savedAddresses.length&&(document.getElementById('cart-panel').classList.remove('active'),document.getElementById('address-panel').classList.add('active'))});document.getElementById('checkout-btn').addEventListener('click',function(){if(0===cartItems.length)return void alert('购物车是空的，请先添加商品');if(0===savedAddresses.length){alert('请先添加收货地址');document.getElementById('cart-panel').classList.remove('active');document.getElementById('overlay').classList.remove('active');document.getElementById('address-panel').classList.add('active');document.getElementById('overlay').classList.add('active');return}const e=cartItems.reduce((e,t)=>e+t.price*t.quantity,0),t=walletManager.payFoodDelivery(e,"桃源外卖订单");if(!t.success)return void alert(t.message);const a=selectedAddressIndex>=0?selectedAddressIndex:0,n=savedAddresses[a],i=generateChineseName(),o=parseFloat((3+2*Math.random()).toFixed(1));let s=!1;o<3?s=!0:3===o&&(s=Math.random()<.5);const d=orderData.length>0?Math.max(...orderData.map(e=>e.id))+1:1001,r=new Date(),l=`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,'0')}-${String(r.getDate()).padStart(2,'0')} ${String(r.getHours()).padStart(2,'0')}:${String(r.getMinutes()).padStart(2,'0')}`,c=30;s?c+=10+20*Math.random():o>=4&&(c-=5+5*Math.random());const u=new Date(r.getTime()+c*6e4),p=new Date(r.getTime()+5*6e4),m=new Date(p.getTime()+10*6e4),f={id:d,status:"delivering",time:l,restaurant:"美食外卖",items:cartItems.map(e=>({name:e.name,quantity:e.quantity,price:e.price})),deliveryAddress:n.address,remark:cartItems.map(e=>e.remark).filter(e=>e).join('; '),riderName:i,riderRating:o,estimatedArrivalTime:u.toISOString(),pickupTime:p.toISOString(),deliveryTime:m.toISOString(),utensils:"需要餐具",evaluated:!1,isOvertime:s};orderData.unshift(f);saveOrdersToStorage();const h=`订单提交成功！\n订单号：${d}\n收货人：${userProfile.name}\n配送地址：${n.address}\n总金额：¥${e.toFixed(1)}\n骑手：${i} (${o}★)\n预计送达时间：${formatTime(u)}${s?"\n\n注意：该骑手评级较低，订单可能超时！":""}`;alert(h+'\n'+t.message);cartItems=[];updateCart();document.getElementById('cart-panel').classList.remove('active');document.getElementById('overlay').classList.remove('active');startCountdown(d);const v=document.querySelector('.filter-btn.active').getAttribute('data-filter');renderOrderList(v);renderEvaluations();showNotification('订单已提交，正在配送中...');createNewOrderInChat(f)});document.getElementById('modal-close').addEventListener('click',function(){document.getElementById('recommendation-modal').classList.remove('active');document.getElementById('overlay').classList.remove('active')});document.getElementById('modal-later').addEventListener('click',function(){document.getElementById('recommendation-modal').classList.remove('active');document.getElementById('overlay').classList.remove('active')});document.getElementById('modal-add').addEventListener('click',function(){openEditModalForFood(currentRecommendationId);document.getElementById('recommendation-modal').classList.remove('active');document.getElementById('overlay').classList.remove('active')});document.getElementById('overlay').addEventListener('click',function(){document.getElementById('recommendation-modal').classList.remove('active');document.getElementById('address-panel').classList.remove('active');document.getElementById('cart-panel').classList.remove('active');document.getElementById('cart-detail-modal').classList.remove('active');this.classList.remove('active')});document.querySelectorAll('.category-item').forEach(e=>{e.addEventListener('click',function(){document.querySelectorAll('.category-item').forEach(e=>{e.classList.remove('active')});this.classList.add('active');const e=this.querySelector('.category-name').textContent;"全部"===e?renderFoodItems():filterFoodByCategory(e);showNotification(`已筛选：${e}`)})});document.querySelector('.search-input').addEventListener('keypress',function(e){if('Enter'===e.key){const t=this.value.trim();t&&(searchFood(t),showNotification(`正在搜索：${t}`))}});const e=document.getElementById('name-display'),t=document.getElementById('name-edit-btn'),a=document.getElementById('name-edit-input'),n=document.getElementById('profile-save-btn'),i=document.getElementById('name-text');e.addEventListener('click',function(){this.classList.add('editing');t.style.display='block';a.classList.add('active');n.classList.add('active');a.focus()});t.addEventListener('click',function(e){e.stopPropagation();e.classList.add('editing');a.classList.add('active');n.classList.add('active');a.focus()});n.addEventListener('click',function(){const e=a.value.trim();if(!e)return void alert('请输入姓名');userProfile.name=e;i.textContent=e;saveUserProfileToStorage();e.classList.remove('editing');a.classList.remove('active');n.classList.remove('active');t.style.display='none';updateCartAddress();showNotification('姓名已更新')});a.addEventListener('blur',function(){setTimeout(()=>{n.matches(':active')||(e.classList.remove('editing'),a.classList.remove('active'),n.classList.remove('active'),t.style.display='none')},200)});document.querySelector('.address-tag[data-tag="家"]').classList.add('active')}function generateChineseName(){const e=chineseSurnames[Math.floor(Math.random()*chineseSurnames.length)],t=["明","伟","强","军","磊","涛","勇","超","杰","浩","鹏","飞","洋","宇","晨"],a=t[Math.floor(Math.random()*t.length)];return e+a}function filterFoodByCategory(e){const t=document.getElementById('food-grid'),a=document.getElementById('hot-food-grid');t.innerHTML='';a.innerHTML='';const n=window.foodData.filter(t=>t.category===e);n.length>0?n.forEach(e=>{t.appendChild(createFoodCard(e));a.appendChild(createFoodCard(e))}):(t.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:40px;color:#999">该分类下暂无美食</div>',a.innerHTML='')}function searchFood(e){const t=document.getElementById('food-grid'),a=document.getElementById('hot-food-grid');t.innerHTML='';a.innerHTML='';const n=window.foodData.filter(t=>t.name.includes(e)||t.description.includes(e)||t.features.some(t=>t.includes(e)));n.length>0?n.forEach(e=>{t.appendChild(createFoodCard(e));a.appendChild(createFoodCard(e))}):(t.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:40px;color:#999">未找到相关美食</div>',a.innerHTML='')}function showNotification(e){const t=document.createElement('div');t.textContent=e;t.style.cssText='position:fixed;top:80px;left:50%;transform:translateX(-50%);background-color:rgba(51,51,51,0.9);color:white;padding:12px 24px;border-radius:50px;z-index:2000;font-size:14px;animation:fadeInOut 2.5s ease-in-out;white-space:nowrap;max-width:80%;overflow:hidden;text-overflow:ellipsis;border:1px solid #333;';const a=document.createElement('style');a.textContent='@keyframes fadeInOut{0%{opacity:0;transform:translateX(-50%) translateY(-10px)}15%{opacity:1;transform:translateX(-50%) translateY(0)}85%{opacity:1;transform:translateX(-50%) translateY(0)}100%{opacity:0;transform:translateX(-50%) translateY(-10px)}}';document.head.appendChild(a);document.body.appendChild(t);setTimeout(()=>{t.remove();a.remove()},2500)}function createNewOrderInChat(e){"function"==typeof createNewOrder?createNewOrder(e):console.log('订单数据:',e)}const foodOrderManager={orders:JSON.parse(localStorage.getItem('aiFoodOrders'))||[],init:function(){this.renderOrderList(),this.setupEventListeners()},setupEventListeners:function(){document.getElementById('send-ai-order-btn')&&document.getElementById('send-ai-order-btn').addEventListener('click',()=>this.sendSelectedOrder())},addOrder:function(e,t,a,n,i,o){const r={id:Date.now()+Math.random().toString(36).substr(2,9),recipient:e,type:t,items:a,total:n,address:i,timestamp:new Date().toISOString(),status:o||'pending'};return this.orders.unshift(r),this.saveOrders(),this.renderOrderList(),r},saveOrders:function(){localStorage.setItem('aiFoodOrders',JSON.stringify(this.orders))},renderOrderList:function(){const e=document.getElementById('order-list');if(!e)return;this.orders.length>0?e.innerHTML=this.orders.map((e,t)=>`<div class="order-item"><input type="radio" name="selectedOrder" value="${e.id}" id="order-${e.id}"><label for="order-${e.id}" class="order-info"><strong>订单${t+1}:</strong> 给AI的${e.type}，总价:¥${e.total}<div class="order-details">地址:${e.address}</div></label></div>`).join(""):e.innerHTML='<div class="empty-order">暂无给AI的外卖订单</div>'},sendSelectedOrder:async function(){const e=document.querySelector('input[name="selectedOrder"]:checked');if(!e)return alert('请先选择一个订单！');const t=e.value,a=this.orders.find(e=>e.id==t);if(!a)return alert('订单不存在！');const i=this.getAIName();let o=`【给AI的外卖订单】\n收件人:${i}\n订单类型:${a.type}\n订单总价:¥${a.total}\n配送地址:${a.address}\n下单时间:${new Date(a.timestamp).toLocaleString()}\n订单内容:\n`;a.items.forEach((e,t)=>{o+=`${t+1}.${e.name} x${e.quantity} ¥${e.price}\n`}),o+=`\n请根据您的角色人设回应这份外卖订单。`,document.getElementById("message-input").value=o,document.getElementById("message-input").focus(),this.orders=this.orders.filter(e=>e.id!==t),this.saveOrders(),this.renderOrderList()},getAIName:function(){const e=JSON.parse(localStorage.getItem("aiPersona")||"{}");return e.name||"AI"},loadOrders:function(){this.orders=JSON.parse(localStorage.getItem('aiFoodOrders'))||[],this.renderOrderList()}};function initFoodDeliveryIntegration(){foodOrderManager.init()}function loadOrders(){const e=document.getElementById("order-list"),t=JSON.parse(localStorage.getItem("foodDeliveryOrders"))||[];if(0===t.length)return void(e.innerHTML='<div class="empty-order">暂无外卖订单</div>');t.sort((e,t)=>new Date(t.createdAt)-new Date(e.createdAt));let a="";t.forEach(t=>{const n=new Date(t.createdAt).toLocaleDateString(),o=new Date(t.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),r=t.items&&t.items.length>0?t.items.map(e=>`${e.name} × ${e.quantity}`).join(", "):"无具体项目";a+=`<div class="order-item"><div class="order-info"><div><strong>${t.restaurant||"餐厅"}</strong></div><div class="order-details">${r} | ${n} ${o} | 总计: ¥${t.totalAmount||"0.00"}</div></div></div>`}),e.innerHTML=a}function filterOrdersByType(){}function sendAIOfferOrder(){const e=JSON.parse(localStorage.getItem("foodDeliveryOrders"))||[];if(0===e.length)return void alert("没有可分享的外卖订单");const t=e[e.length-1],a=`我刚刚点了外卖：${t.restaurant}的外卖，有${t.items.length}样食物，总共¥${t.total}。${"delivering"===t.status?"外卖正在配送中！":"外卖已经送达了！"}`;document.getElementById("message-input").value=a,addUserMessageAndCallAI()}function clearAllOrders(){confirm("确定要清空所有历史订单吗？此操作不可撤销。")&&(localStorage.removeItem("foodDeliveryOrders"),loadOrders(),alert("历史订单已清空！"))};

/***********************************
* ✤ 谧笺书城界面
 ***********************************/
const bookstoreManager={pages:{home:document.getElementById('bookstore-home'),movie:document.getElementById('bookstore-movie'),shelf:document.getElementById('bookstore-shelf'),profile:document.getElementById('bookstore-profile')},myShelf:JSON.parse(localStorage.getItem('bookstoreShelf'))||[],dreams:JSON.parse(localStorage.getItem('bookstoreDreams'))||[],customBooks:JSON.parse(localStorage.getItem('bookstoreCustomBooks'))||[],featuredBook:JSON.parse(localStorage.getItem('bookstoreFeatured'))||{id:"1"},selectedRoles:[],editingStyleBook:null,isEditingShelf:!1,isEditingCustom:!1,styleOptions:["末世","仙侠","都市","科幻","悬疑","玄幻","历史","言情","武侠","奇幻","穿越","系统","重生","游戏","灵异","军事","职场","校园","轻小说"],touchStartX:0,touchStartY:0,isSwiping:!1,swipeThreshold:30,sidebarVisible:!1,bookDetailPage:null,currentBookId:null,chapters:[],editingChapterId:null,isDragging:!1,dragStartIndex:-1,readingPage:null,generatedChapters:{},init(){this.bindEvents();this.createBubbleNav();this.updateShelfDisplay();this.showCategoryBooks('recommend');this.loadDreamsData();this.initializeCustomBooks();this.loadFeaturedBook();this.createBookDetailPage();this.initializeUserSystem();this.loadGeneratedChapters();this.initMoviePage()},initMoviePage(){const m=this.pages.movie;if(m){const style=document.createElement('style');style.innerHTML='.fake-full{position:absolute!important;top:0!important;left:0!important;width:100%!important;height:100%!important;z-index:9999!important;background:#fff!important;display:flex!important;align-items:center;justify-content:center;}.fake-full #mVideo{width:525px!important;height:100%vw!important;transform:rotate(90deg)!important;object-fit:contain!important;background:#fff!important;box-shadow:none!important;}.seek-indicator{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.6);color:#fff;padding:10px 20px;border-radius:20px;font-size:14px;pointer-events:none;display:none;z-index:10011;}#bookstore-movie::-webkit-scrollbar{width:0px;background:transparent;}';document.head.appendChild(style);m.style.cssText='width:100%;height:100%;background:#fff;overflow-y:auto;overflow-x:hidden;position:relative;-webkit-overflow-scrolling:touch;';m.innerHTML='<div id="mPlayerWrapper" style="min-height:100%;display:flex;flex-direction:column;"><div id="mPlayerContainer" style="padding-top:0px;display:flex;flex-direction:column;justify-content:center;align-items:center;position:relative;width:100%;"><div id="mMsg" style="color:#999;text-align:center;padding:40px 0;"><i class="fas fa-play-circle" style="font-size:60px;color:#eee;margin-bottom:15px;"></i><p style="font-size:14px;">准备好观看视频了吗？</p></div><video id="mVideo" style="display:none;width:90%;border-radius:8px;background:#000;max-height:70vh;"></video><div id="mSeekInd" class="seek-indicator"></div></div><div id="mCtrls" style="padding:20px;padding-bottom:120px;background:#fff;"><input type="file" id="movieFileBtn" accept="video/*" style="width:100%;margin-bottom:20px;font-size:12px;color:#666;"><div id="mPlayGroup" style="display:none;gap:12px;"><button id="mPlayBtn" style="flex:1;padding:14px;background:#000;color:#fff;border:none;border-radius:10px;font-size:14px;font-weight:500;">播放 / 暂停</button><button id="mFullBtn" style="width:60px;background:#f5f5f5;color:#333;border:none;border-radius:10px;"><i class="fas fa-expand"></i></button></div></div></div>';const btn=document.getElementById('movieFileBtn'),v=document.getElementById('mVideo'),msg=document.getElementById('mMsg'),pg=document.getElementById('mPlayGroup'),c=document.getElementById('mPlayerContainer'),ind=document.getElementById('mSeekInd');let tStartX=0,tMoveX=0,isVDragging=!1;btn.onchange=(e)=>{const f=e.target.files[0];if(f){v.src=URL.createObjectURL(f);v.style.display='block';msg.style.display='none';pg.style.display='flex';v.play()}};document.getElementById('mPlayBtn').onclick=()=>{v.paused?v.play():v.pause()};document.getElementById('mFullBtn').onclick=()=>{c.classList.add('fake-full')};c.addEventListener('touchstart',(e)=>{if(!v.src)return;isVDragging=!0;const f=c.classList.contains('fake-full');tStartX=f?e.touches[0].clientY:e.touches[0].clientX;tMoveX=0;ind.style.display='none';ind.style.opacity='1'});c.addEventListener('touchmove',(e)=>{if(!isVDragging)return;const f=c.classList.contains('fake-full');const curX=f?e.touches[0].clientY:e.touches[0].clientX;const d=curX-tStartX;tMoveX=d;if(Math.abs(d)>10){const s=Math.round(d/10)*(f?-1:1);ind.style.display='block';ind.innerText=(s>0?'+':"")+s+'s';if(f)ind.style.transform='translate(-50%,-50%) rotate(90deg)'}});c.addEventListener('touchend',()=>{if(!isVDragging)return;isVDragging=!1;if(Math.abs(tMoveX)>20){const f=c.classList.contains('fake-full');v.currentTime+=Math.round(tMoveX/10)*(f?-1:1)}setTimeout(()=>{ind.style.opacity='0';setTimeout(()=>{ind.style.display='none'},300)},500)});v.ondblclick=()=>{c.classList.toggle('fake-full')}}},updateShelfDisplay(){const e=document.getElementById('shelf-grid');if(!e)return;e.innerHTML='';if(0===this.myShelf.length){e.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:40px;color:#999;"><i class="fas fa-book-open" style="font-size:40px;margin-bottom:10px;display:block;"></i>书架空空如也</div>';return}this.myShelf.forEach(t=>{const n=document.createElement('div');n.className='book-item';n.dataset.id=t.id;n.innerHTML=`${this.isEditingShelf?'<div class="remove-book">×</div>':""}<div class="book-cover"><i class="fas fa-book"></i><span class="book-badge">${t.badge||"经典"}</span></div><div class="book-info"><div class="book-title">${t.title}</div><div class="book-author">${t.author||"未知"}</div></div>`;e.appendChild(n)})},initializeUserSystem(){const e=localStorage.getItem('bookstoreUsername');e&&this.updateUsernameDisplay(e);this.bindUsernameEvents()},bindUsernameEvents(){const e=document.getElementById('user-display-name');e&&e.addEventListener('click',t=>{t.stopPropagation();this.openUsernameEditModal()});document.addEventListener('click',e=>{if(e.target.classList.contains('close-edit-name')){e.preventDefault();this.closeUsernameEditModal();return}if(e.target.id==='cancel-username-btn'){e.preventDefault();this.closeUsernameEditModal();return}if(e.target.id==='save-username-btn'){e.preventDefault();this.saveUsername();return}if(e.target.id==='username-edit-modal'){this.closeUsernameEditModal();return}})},openUsernameEditModal(){const e=document.getElementById('username-edit-modal');if(!e)return;const t=document.getElementById('user-display-name').textContent;const n=document.getElementById('username-input');n.value=t!=='游客用户'?t:'';e.style.display='flex';n.focus()},closeUsernameEditModal(){const e=document.getElementById('username-edit-modal');e&&(e.style.display='none',document.getElementById('username-input').value='')},saveUsername(){const e=document.getElementById('username-input');const t=e.value.trim();if(!t)return alert('用户名不能为空'),void e.focus();if(t.length>20)return alert('用户名不能超过20个字符'),void e.focus();localStorage.setItem('bookstoreUsername',t);this.updateUsernameDisplay(t);this.updateAllBookAuthors(t);this.closeUsernameEditModal();this.showNotification('用户名已更新')},updateUsernameDisplay(e){const t=document.getElementById('user-display-name');t&&(t.textContent=e)},updateAllBookAuthors(e){this.myShelf.forEach(t=>{t.author=e});localStorage.setItem('bookstoreShelf',JSON.stringify(this.myShelf));this.customBooks.forEach(t=>{t.author=e});localStorage.setItem('bookstoreCustomBooks',JSON.stringify(this.customBooks))},showNotification(e){const t=document.createElement('div');t.textContent=e;t.style.cssText='position:fixed;top:20px;right:20px;background:#000;color:#fff;padding:12px 20px;border-radius:4px;z-index:2000;font-size:14px;box-shadow:0 2px 10px rgba(0,0,0,0.2);animation:fadeInOut 2s ease-in-out;';document.body.appendChild(t);setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},2000)},createBookDetailPage(){this.bookDetailPage=document.createElement('div');this.bookDetailPage.id='book-detail-page';this.bookDetailPage.className='bookstore-page';this.bookDetailPage.style.cssText='position:absolute;top:0;left:0;width:100%;height:100%;background:white;z-index:100;display:none;flex-direction:column;';this.bookDetailPage.innerHTML=`<div class="header"><button class="back-button back-from-detail">●</button><h1>书籍详情</h1></div><div class="scrollable-content"><div class="bookstore-container"><div class="bookstore-content"><div class="page-content" id="book-detail-content" style="padding:20px;"></div></div></div></div>`;document.querySelector('.bookstore-container').appendChild(this.bookDetailPage);document.querySelector('.back-from-detail').addEventListener('click',()=>{this.closeBookDetail()})},createBubbleNav(){const e=document.createElement('div');e.className='sidebar-nav';e.id='bookstore-sidebar';e.innerHTML='<div class="sidebar-bubble active" data-page="home" title="阅读"><div class="bubble-icon"><i class="fas fa-home"></i></div><div class="bubble-label">阅读</div></div><div class="sidebar-bubble" data-page="movie" title="影视"><div class="bubble-icon"><i class="fas fa-film"></i></div><div class="bubble-label">影视</div></div><div class="sidebar-bubble" data-page="shelf" title="书架"><div class="bubble-icon"><i class="fas fa-book"></i></div><div class="bubble-label">书架</div></div><div class="sidebar-bubble" data-page="profile" title="我的"><div class="bubble-icon"><i class="fas fa-user"></i></div><div class="bubble-label">我的</div></div>';document.querySelector('.bookstore-container').appendChild(e);const t=document.createElement('div');t.className='overlay';t.id='bookstore-overlay';document.querySelector('.bookstore-container').appendChild(t);this.bindBubbleEvents()},bindBubbleEvents(){document.querySelectorAll('.sidebar-bubble').forEach(e=>{e.addEventListener('click',t=>{t.stopPropagation();this.switchPage(e.dataset.page);this.hideSidebar()})})},initializeCustomBooks(){if(0===this.customBooks.length){let e=JSON.parse(localStorage.getItem('bookstoreDreams'))||[];e.forEach(t=>{this.createCustomBookFromDream(t,!0)})}},bindEvents(){document.querySelectorAll('.bookstore-container .nav-tab').forEach(e=>{e.addEventListener('click',()=>{this.handleCategoryClick(e)})});const e=document.getElementById('bookstore-interface');if(e){e.addEventListener('touchstart',t=>{this.handleTouchStart(t)},!1);e.addEventListener('touchmove',t=>{this.handleTouchMove(t)},!1);e.addEventListener('touchend',t=>{this.handleTouchEnd(t)},!1)}document.addEventListener('click',t=>{let n=t.target;if(n.classList.contains('edit-style-btn')){t.stopPropagation();let r=n.closest('.book-item');r&&this.openStyleEditModal(r.dataset.id);return}if(n.classList.contains('remove-custom-book')){t.stopPropagation();let r=n.closest('.book-item');r&&this.removeCustomBook(r.dataset.id);return}if(n.classList.contains('edit-custom-btn')){t.stopPropagation();this.toggleCustomEditMode();return}if(n.classList.contains('edit-featured-btn')){t.preventDefault();t.stopPropagation();this.openEditFeaturedModal();return}if(n.classList.contains('remove-book')){t.stopPropagation();let r=n.closest('.book-item');r&&this.removeFromShelf(r.dataset.id);return}if(n.classList.contains('role-checkbox')){this.handleRoleSelection(t,n);return}if(n.id==='save-style-btn'){t.preventDefault();this.saveStyleEdit();return}if(n.id==='cancel-style-btn'){t.preventDefault();this.closeStyleEditModal();return}if(n.classList.contains('close-style-edit')){t.preventDefault();this.closeStyleEditModal();return}if(n.id==='toggle-custom-style'){t.preventDefault();this.toggleCustomStyleInput();return}if(n.classList.contains('user-name-editable')||n.closest('.user-name-editable')){t.preventDefault();this.openUsernameEditModal();return}if(n.classList.contains('generate-chapter-btn')){t.preventDefault();t.stopPropagation();this.generateChapterContent();return}if(n.id==='start-generate-btn'){t.preventDefault();this.startGenerateChapter();return}if(n.id==='cancel-generate-btn'){t.preventDefault();this.closeGenerateModal();return}if(n.classList.contains('export-data-btn')){t.preventDefault();this.exportBookData();return}if(n.classList.contains('import-data-btn')){t.preventDefault();this.importBookData();return}let r=t.target.closest('.book-item, .featured-book');r&&this.handleBookClick(t,r);if(!t.target.closest('.sidebar-nav')&&this.sidebarVisible){this.hideSidebar()}});const t=document.getElementById('editShelfBtn');t&&t.addEventListener('click',()=>{this.toggleEditMode()});const n=document.getElementById('goDiscoverBtn');n&&n.addEventListener('click',()=>{this.switchPage('home')});document.querySelectorAll('#bookstore-interface .menu-item').forEach(e=>{e.addEventListener('click',()=>{let t=e.querySelector('div').textContent.trim();alert(t+'功能开发中')})});document.querySelectorAll('#bookstore-interface .search-input').forEach(e=>{e.addEventListener('keypress',t=>{'Enter'===t.key&&(e.value.trim()&&(this.handleSearch(e.value.trim()),e.value=''))})});this.bindDreamModalEvents();this.bindFeaturedModalEvents();document.getElementById('bookstore-overlay')&&document.getElementById('bookstore-overlay').addEventListener('click',()=>{this.hideSidebar()})},handleTouchStart(e){this.isSwiping=!0;this.touchStartX=e.touches[0].clientX;this.touchStartY=e.touches[0].clientY},handleTouchMove(e){if(!this.isSwiping)return;const t=e.touches[0].clientX,n=e.touches[0].clientY,r=t-this.touchStartX,o=Math.abs(n-this.touchStartY);Math.abs(r)>o&&(r>this.swipeThreshold&&!this.sidebarVisible?this.showSidebar():r<-this.swipeThreshold&&this.sidebarVisible&&this.hideSidebar())},handleTouchEnd(){this.isSwiping=!1},showSidebar(){document.getElementById('bookstore-sidebar').classList.add('active');document.getElementById('bookstore-overlay').style.display='block';this.sidebarVisible=!0},hideSidebar(){document.getElementById('bookstore-sidebar').classList.remove('active');document.getElementById('bookstore-overlay').style.display='none';this.sidebarVisible=!1},openStyleEditModal(e){this.editingStyleBook=this.customBooks.find(t=>t.id===e);if(!this.editingStyleBook)return;let t=document.getElementById('style-edit-modal');if(!t){t=document.createElement('div');t.id='style-edit-modal';t.style.cssText='display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center;';t.innerHTML=`<div class="new-dream-content" style="width:300px;background:white;border-radius:8px;padding:20px;"><div class="new-dream-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;"><h3 style="margin:0;">编辑书籍风格</h3><button class="close-style-edit" style="background:none;border:none;font-size:20px;cursor:pointer;">×</button></div><div style="margin-bottom:10px;">当前书籍：${this.editingStyleBook.title}</div><div style="margin-bottom:15px;"><label style="display:block;margin-bottom:5px;font-size:14px;">选择风格：</label><select id="style-select" class="new-dream-select" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;margin-bottom:10px;">${this.styleOptions.map(t=>`<option value="${t}" ${this.editingStyleBook.badge===t?'selected':''}>${t}</option>`).join('')}<option value="custom">自定义风格</option></select><div id="custom-style-container" style="display:none;"><input type="text" id="custom-style-input" class="new-dream-input" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;" placeholder="输入自定义风格..."></div><button id="toggle-custom-style" class="new-dream-btn" style="padding:6px 12px;font-size:12px;background:#f0f0f0;color:#333;border:1px solid #ddd;border-radius:4px;cursor:pointer;">自定义风格</button></div><div class="new-dream-actions" style="display:flex;justify-content:flex-end;gap:10px;"><button class="new-dream-btn save" id="save-style-btn" style="padding:8px 16px;">确认</button><button class="new-dream-btn cancel" id="cancel-style-btn" style="padding:8px 16px;">取消</button></div></div>`;document.body.appendChild(t);t.addEventListener('click',e=>{if(e.target===t)this.closeStyleEditModal()});let n=document.getElementById('style-select');n&&n.addEventListener('change',()=>{'custom'===n.value?this.toggleCustomStyleInput(!0):document.getElementById('custom-style-container').style.display='none'})}t.style.display='flex';let n=document.getElementById('style-select');if(n&&'custom'===n.value&&this.toggleCustomStyleInput(!0),n&&this.editingStyleBook.badge&&!this.styleOptions.includes(this.editingStyleBook.badge)){document.getElementById('custom-style-input').value=this.editingStyleBook.badge;this.toggleCustomStyleInput(!0)}},toggleCustomStyleInput(e){let t=document.getElementById('custom-style-container'),n=document.getElementById('toggle-custom-style');if(t){if(void 0===e){t.style.display='none'===t.style.display?'block':'none'}else t.style.display=e?'block':'none';n.textContent='block'===t.style.display?'使用预设风格':'自定义风格'}if('block'===t.style.display){setTimeout(()=>{document.getElementById('custom-style-input').focus()},100)}},closeStyleEditModal(){let e=document.getElementById('style-edit-modal');e&&(e.style.display='none');this.editingStyleBook=null},saveStyleEdit(){if(!this.editingStyleBook)return;let e=document.getElementById('style-select').value,t='';if('custom'===e){t=document.getElementById('custom-style-input').value.trim();if(!t)return alert('请输入自定义风格'),void document.getElementById('custom-style-input').focus()}else t=e;let n=this.customBooks.findIndex(n=>n.id===this.editingStyleBook.id);if(n>-1){this.customBooks[n].badge=t;localStorage.setItem('bookstoreCustomBooks',JSON.stringify(this.customBooks));this.showCategoryBooks('custom');this.closeStyleEditModal();alert('风格已更新！')}},openBookDetail(e){this.currentBookId=e;const t=this.myShelf.find(t=>t.id===e);if(!t)return;const n=document.getElementById('book-detail-content');if(!n)return;const r=localStorage.getItem('bookstoreUsername')||'游客用户';n.innerHTML=`<div class="book-detail-header" style="text-align:center;margin-bottom:20px;"><h2 style="margin-bottom:10px;color:#333;">${t.title}</h2><div><span class="book-badge" style="background:#000;color:#fff;padding:4px 12px;border-radius:12px;font-size:12px;">${t.badge||'自定义书籍'}</span></div></div><div class="book-detail-info" style="border:1px solid #ddd;border-radius:10px;padding:15px;margin-bottom:20px;background:#f9f9f9;"><div class="info-row" style="display:flex;margin-bottom:8px;"><span style="font-weight:600;width:80px;color:#555;">作者：</span><span>${r}</span></div><div class="info-row" style="display:flex;margin-bottom:8px;"><span style="font-weight:600;width:80px;color:#555;">评分：</span><span><i class="fas fa-star" style="color:#000000;margin-right:5px;"></i>${t.rating||'9.0'}</span></div><div class="info-row" style="display:flex;margin-bottom:8px;"><span style="font-weight:600;width:80px;color:#555;">字数：</span><span>${t.wordCount||'待填写'}</span></div><div class="info-row" style="display:flex;"><span style="font-weight:600;width:80px;color:#555;">状态：</span><span>${t.updateInfo||'梦境作品'}</span></div></div><div class="book-detail-desc" style="margin-bottom:25px;"><h3 style="margin-bottom:10px;color:#333;border-bottom:1px solid #ddd;padding-bottom:5px;">简介</h3><div style="line-height:1.6;color:#555;font-size:14px;">${t.desc||'暂无详细描述'}</div></div><div class="book-detail-actions" style="text-align:center;display:flex;gap:15px;justify-content:center;"><button class="header-btn start-reading-btn">开始阅读</button><button class="header-btn manage-chapters-btn">目录管理</button></div>`;document.querySelector('.start-reading-btn').addEventListener('click',()=>{this.startReading(t.id)});document.querySelector('.manage-chapters-btn').addEventListener('click',()=>{this.openChapterManager(t.id)});document.getElementById('bookstore-interface').querySelector('.header').style.display='none';Object.values(this.pages).forEach(t=>{t.style.display='none'});this.bookDetailPage.style.display='block'},closeBookDetail(){document.getElementById('bookstore-interface').querySelector('.header').style.display='flex';this.bookDetailPage.style.display='none';this.pages.shelf.style.display='block';this.updateShelfDisplay()},startReading(e){const t=this.myShelf.find(t=>t.id===e);if(t){this.openReadingPage(e,t.title)}else{alert('书籍信息加载失败')}},createReadingPage(){this.readingPage=document.createElement('div');this.readingPage.id='reading-page';this.readingPage.className='bookstore-page';this.readingPage.style.cssText='position:absolute;top:0;left:0;width:100%;height:100%;background:white;z-index:100;display:none;flex-direction:column;';this.readingPage.innerHTML=`<div class="header"><button class="back-button back-from-reading">●</button><h1>阅读器</h1></div><div class="scrollable-content"><div class="bookstore-container"><div class="bookstore-content"><div class="page-content" id="reading-content" style="padding:0;"></div></div></div></div>`;document.querySelector('.bookstore-container').appendChild(this.readingPage);document.querySelector('.back-from-reading').addEventListener('click',()=>{this.closeReadingPage()})},openReadingPage(e,t){if(!this.readingPage)this.createReadingPage();this.currentBookId=e;const n=JSON.parse(localStorage.getItem(`bookstoreChapters_${this.currentBookId}`))||[];const r=this.loadGeneratedChaptersForBook(e);document.getElementById('bookstore-interface').querySelector('.header').style.display='none';Object.values(this.pages).forEach(e=>{e.style.display='none'});this.bookDetailPage.style.display='none';this.readingPage.style.display='block';const o=document.getElementById('reading-content');let i='';if(n.length>0){i=`<div style="margin-bottom:20px;padding:0 20px;"><h3 style="color:#333;margin-bottom:15px;padding-bottom:5px;">章节选择</h3><div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:15px;">`;n.forEach((t,n)=>{const o=r[n];i+=`<button class="chapter-select-btn" data-index="${n}" style="padding:8px 12px;border:1px solid #000;border-radius:6px;background:${o?'#000000':'#fff'};color:${o?'white':'#000'};cursor:pointer;font-size:14px;">第${n+1}章</button>`});i+='</div></div>';i+=`<div style="margin-bottom:20px;padding:0 20px;"><button class="generate-chapter-btn" style="padding:10px 20px;background:#000000;color:white;border:none;border-radius:8px;font-size:16px;cursor:pointer;"><i class="fas fa-magic" style="margin-right:8px;"></i>AI生成章节内容</button><p style="font-size:12px;color:#666;margin-top:8px;">选择章节后点击此按钮，AI将根据章节简介生成10000字小说内容</p></div>`;i+=`<div style="margin-bottom:20px;padding:0 20px;"><h3 style="color:#333;margin-bottom:15px;padding-bottom:5px;">章节内容备份</h3><div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:15px;"><button class="export-data-btn" style="padding:10px 20px;background:#4CAF50;color:white;border:none;border-radius:8px;font-size:14px;cursor:pointer;"><i class="fas fa-file-export" style="margin-right:8px;"></i>导出章节备份</button><button class="import-data-btn" style="padding:10px 20px;background:#2196F3;color:white;border:none;border-radius:8px;font-size:14px;cursor:pointer;"><i class="fas fa-file-import" style="margin-right:8px;"></i>导入章节备份</button><input type="file" id="import-file-input" accept=".json" style="display:none;"></div><p style="font-size:12px;color:#666;margin-top:8px;">导出包含完整的章节小说内容，导入将创建对应的章节</p></div>`}i+=`<div style="text-align:center;padding:20px;max-width:100%;"><h2 style="color:#333;margin-bottom:20px;font-size:24px;">${t}</h2><div style="color:#666;font-size:16px;line-height:1.8;text-align:left;padding:20px;background:#f9f9f9;border-radius:8px;max-width:100%;word-wrap:break-word;"><p>这里是《${t}》的阅读界面。</p><p>${n.length>0?'请选择上方章节开始阅读，或使用AI生成章节内容。':'暂无章节内容，请先在目录管理中创建章节。'}</p><p>阅读功能正在开发中，敬请期待！</p></div></div>`;o.innerHTML=i;document.querySelectorAll('.chapter-select-btn').forEach(e=>{e.addEventListener('click',t=>{const n=parseInt(e.dataset.index);const r=JSON.parse(localStorage.getItem(`bookstoreChapters_${this.currentBookId}`))||[];const o=r[n]||{title:`第${n+1}章`};this.selectChapterForReading(n,o,r[n])})});document.querySelector('.generate-chapter-btn')&&document.querySelector('.generate-chapter-btn').addEventListener('click',()=>{this.generateChapterContent()});document.querySelector('.export-data-btn')&&document.querySelector('.export-data-btn').addEventListener('click',()=>{this.exportBookData()});document.querySelector('.import-data-btn')&&document.querySelector('.import-data-btn').addEventListener('click',()=>{this.importBookData()});const s=document.getElementById('import-file-input');if(s){s.removeEventListener('change',this.handleImportFileBound);this.handleImportFileBound=this.handleImportFile.bind(this);s.addEventListener('change',this.handleImportFileBound)}},exportBookData(){const e=this.currentBookId;if(!e)return alert('未选择书籍');const t=this.myShelf.find(t=>t.id===e);if(!t)return alert('书籍信息获取失败');const n=JSON.parse(localStorage.getItem(`bookstoreChapters_${e}`))||[];const r=this.generatedChapters[e]||{};const o=[];n.forEach((t,n)=>{const i=r[n];if(i&&i.content){o.push({title:t.title||`第${n+1}章`,content:i.content,wordCount:i.wordCount||Math.ceil(i.content.length/3),generatedAt:i.generatedAt||new Date().toISOString(),chapterIndex:n})}});if(o.length===0)return alert('没有可以导出的章节内容，请先生成章节内容');const i={version:"1.0",exportDate:new Date().toISOString(),bookTitle:t.title,chapters:o,chapterCount:o.length,totalWordCount:o.reduce((e,t)=>e+(t.wordCount||0),0)};const s=JSON.stringify(i,null,2),a=`${t.title}_小说内容_${new Date().toLocaleDateString().replace(/\//g,'-')}.json`,c=document.createElement('a');c.href='data:application/json;charset=utf-8,'+encodeURIComponent(s);c.download=a;c.style.display='none';document.body.appendChild(c);c.click();document.body.removeChild(c);this.showNotification(`成功导出${o.length}个章节内容，总计${i.totalWordCount}字！`)},importBookData(){let e=document.getElementById('import-file-input');if(!e){e=document.createElement('input');e.type='file';e.id='import-file-input';e.accept='.json';e.style.display='none';e.addEventListener('change',t=>{this.handleImportFile(t)});document.body.appendChild(e)}e.click()},handleImportFile(e){const t=e.target.files[0];if(!t)return;if(!t.name.endsWith('.json'))return alert('请选择JSON格式的文件');const n=new FileReader();n.onload=r=>{try{const o=JSON.parse(r.target.result);this.processChapterBackup(o)}catch(o){console.error('解析JSON失败:',o);alert('文件格式错误，无法导入')}};n.readAsText(t)},processChapterBackup(e){if(!e.version||!e.chapters){return alert('备份文件格式不正确')}if(e.chapters.length===0){return alert('备份文件中没有章节内容')}e.chapters.forEach(t=>{const n=t.title||'未命名章节';const r=t.content||'';if(r.length>0){const o=this.findOrCreateChapterIndex(n,r.substring(0,100));const i={content:r,wordCount:t.wordCount||Math.ceil(r.length/3),generatedAt:t.generatedAt||new Date().toISOString(),title:n,chapterIndex:o,bookTitle:this.myShelf.find(t=>t.id===this.currentBookId)?.title||'未知书籍',isBackupImport:!0};this.saveGeneratedChapterContent(this.currentBookId,o,i);}});this.showNotification(`成功导入${e.chapters.length}个章节内容！`);const t=this.myShelf.find(t=>t.id===this.currentBookId);if(t){setTimeout(()=>{this.openReadingPage(this.currentBookId,t.title)},500)}},findOrCreateChapterIndex(e,t){let n=JSON.parse(localStorage.getItem(`bookstoreChapters_${this.currentBookId}`))||[];const r=n.findIndex(n=>n.title===e);if(r!==-1)return r;const o={id:Date.now()+'-'+Math.random().toString(36).substr(2,9),title:e,content:t+'...',wordCount:Math.ceil(t.length/3),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};n.push(o);localStorage.setItem(`bookstoreChapters_${this.currentBookId}`,JSON.stringify(n));return n.length-1},loadGeneratedChaptersForBook(e){return this.generatedChapters[e]||{}},selectChapterForReading(e,t,n){const r=this.generatedChapters[this.currentBookId]||{};const o=r[e];if(o&&o.content){this.viewGeneratedContent(o,t,e)}else{alert(`选择第${e+1}章：${t.title}\n\n该章节尚未生成内容，请点击"AI生成章节内容"按钮生成小说内容。`)}},loadGeneratedChapters(){const e=localStorage.getItem('bookstoreGeneratedChapters');this.generatedChapters=e?JSON.parse(e):{}},saveGeneratedChapters(){localStorage.setItem('bookstoreGeneratedChapters',JSON.stringify(this.generatedChapters))},saveGeneratedChapterContent(e,t,n){if(!this.generatedChapters[e])this.generatedChapters[e]={};this.generatedChapters[e][t]=n;this.saveGeneratedChapters();const r=JSON.parse(localStorage.getItem(`bookstoreChapters_${e}`))||[];if(r[t]){r[t].generatedContent=n.content;r[t].generatedAt=n.generatedAt;r[t].wordCount=n.wordCount;r[t].aiGenerated=!0;r[t].backupImported=n.isBackupImport||!1;localStorage.setItem(`bookstoreChapters_${e}`,JSON.stringify(r))}},generateChapterContent(){const e=JSON.parse(localStorage.getItem(`bookstoreChapters_${this.currentBookId}`))||[];if(e.length===0)return alert('请先在目录管理中创建章节');let t=document.getElementById('generate-modal');if(!t){t=this.createGenerateModalElement();document.body.appendChild(t)}const n=document.getElementById('chapter-select');n.innerHTML='';e.forEach((t,r)=>{const o=document.createElement('option');o.value=r;o.textContent=`第${r+1}章：${t.title}`;n.appendChild(o)});t.style.display='flex';n.focus()},createGenerateModalElement(){const e=document.createElement('div');e.id='generate-modal';e.style.cssText='display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:2000;justify-content:center;align-items:center;';e.innerHTML=`<div class="modal-content" style="width:90%;max-width:500px;background:#fff;border-radius:10px;padding:20px;"><div class="modal-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;"><h3 class="modal-title" style="margin:0;color:#333;">AI生成章节内容</h3><button class="close-generate-modal" style="background:none;border:none;font-size:20px;cursor:pointer;color:#666;">×</button></div><div class="modal-body"><div class="form-group" style="margin-bottom:15px;"><label style="display:block;margin-bottom:5px;font-size:14px;color:#333;">选择要生成的章节</label><select id="chapter-select" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px;"></select></div><div class="form-group" style="margin-bottom:15px;"><label style="display:block;margin-bottom:5px;font-size:14px;color:#333;">生成设置</label><div style="background:#f9f9f9;border:1px solid #ddd;border-radius:6px;padding:15px;font-size:13px;color:#555;"><p style="margin:0 0 10px 0;"><strong>提示词模板：</strong>小说生成器将根据以下提示生成内容：</p><ul style="margin:0;padding-left:20px;"><li>根据章节标题和简介进行扩写</li><li>生成约10000字的小说内容</li><li>保持原著风格和人物设定</li><li>情节连贯，逻辑合理</li><li>语言生动，描写细腻</li></ul><p style="margin:10px 0 0 0;"><strong>注意：</strong>生成内容为AI创作，建议生成后仔细校对。</p></div></div></div><div class="modal-actions" style="display:flex;gap:10px;"><button id="start-generate-btn" style="flex:1;padding:12px;background:#000000;color:white;border:none;border-radius:6px;font-size:14px;cursor:pointer;">开始生成</button><button id="cancel-generate-btn" style="flex:1;padding:12px;background:#f0f0f0;color:#333;border:1px solid #ddd;border-radius:6px;font-size:14px;cursor:pointer;">取消</button></div></div>`;e.querySelector('.close-generate-modal').addEventListener('click',()=>{this.closeGenerateModal()});e.querySelector('#cancel-generate-btn').addEventListener('click',()=>{this.closeGenerateModal()});e.querySelector('#start-generate-btn').addEventListener('click',()=>{this.startGenerateChapter()});e.addEventListener('click',t=>{t.target===e&&this.closeGenerateModal()});document.addEventListener('keydown',t=>{'Escape'===t.key&&'flex'===e.style.display&&this.closeGenerateModal()});return e},startGenerateChapter(){const e=document.getElementById('chapter-select');if(!e||e.value==='')return alert('请选择要生成的章节');const t=parseInt(e.value),n=JSON.parse(localStorage.getItem(`bookstoreChapters_${this.currentBookId}`))||[],r=n[t];if(!r)return alert('章节信息加载失败');this.closeGenerateModal();this.callGenerateAPI(r,t)},callGenerateAPI(e,t){const n=this.getApiService();if(!n){console.error('API服务未初始化');return this.showApiNotConfigured()}const r=document.getElementById('reading-content');if(!r)return;const o=this.currentBookId?this.myShelf.find(r=>r.id===this.currentBookId):null,i=o?o.title:'未知书籍';r.innerHTML=`<div style="text-align:center;padding:40px 20px;max-width:100%;"><div style="font-size:48px;color:#000000;margin-bottom:20px;"><i class="fas fa-spinner fa-spin"></i></div><h3 style="color:#333;margin-bottom:15px;">AI正在生成章节内容</h3><div style="background:#f9f9f9;border:1px solid #ddd;border-radius:8px;padding:20px;margin-bottom:20px;text-align:left;max-width:100%;"><p style="margin:0 0 10px 0;"><strong>正在生成：</strong>第${t+1}章 - ${e.title}</p><p style="margin:0 0 10px 0;"><strong>章节简介：</strong>${e.content||'无简介'}</p><p style="margin:0;"><strong>生成目标：</strong>约10000字小说内容扩写</p></div><div style="color:#666;font-size:14px;line-height:1.6;max-width:100%;"><p>正在调用AI API生成小说内容...</p><p>这可能需要一些时间，请耐心等待。</p></div></div>`;const s=`你是一个专业的小说作家。请直接创作小说的章节内容，不要添加任何前言、说明、标题符号 or 评论。

基于以下信息创作小说章节内容：

章节标题：${e.title}
章节简介：${e.content||'无简介'}
书籍名称：《${i}》

创作要求：
1. 直接开始写小说内容，不要添加任何解释性文字
2. 不要使用特殊符号作为标题前缀（如#、*、~等）
3. 保持原著风格和人物设定
4. 情节要连贯合理，逻辑清晰
5. 语言要生动细腻，有丰富的描写
6. 创作约10000字的完整章节内容
7. 结构要完整，有开头、发展、高潮和结尾

现在请开始直接创作小说内容：`;const a=n.getCurrentConfig();if(!a||!a.apiKey){console.error('API密钥未配置');return this.showApiNotConfigured()}const c={model:a.model||'gpt-3.5-turbo',messages:[{role:'system',content:'你是一个专业的小说作家，请直接创作小说内容，不要添加任何解释性文字或前言。'},{role:'user',content:s}],max_tokens:4000,temperature:0.7,stream:!1};n.chatWithRole('',s,0.7,1,'online','single','AI写作助手').then(n=>{this.handleGenerationResult(n,e,t,i)}).catch(n=>{this.handleGenerationError(n,e,t,i)})},getApiService(){if(window.appState&&window.appState.apiService)return window.appState.apiService;const e=JSON.parse(localStorage.getItem('apiConfig'));if(e&&e.apiKey&&e.model){const t=new ApiService();t.updateConfig(e);window.appState||(window.appState={});window.appState.apiService||(window.appState.apiService=t);return t}return null},handleGenerationResult(e,t,n,r){const o=document.getElementById('reading-content');if(!o)return;const i=this.currentBookId?this.myShelf.find(o=>o.id===this.currentBookId):null,s=i?i.title:'未知书籍';let a='';let c=0;if(e&&Array.isArray(e)&&e.length>0){a=e.join('\n\n');c=Math.ceil(a.length/3)}else if(e&&typeof e==='string'){a=e;c=Math.ceil(a.length/3)}const l={content:a,wordCount:c,generatedAt:new Date().toISOString(),title:t.title,chapterIndex:n,bookTitle:s};this.saveGeneratedChapterContent(this.currentBookId,n,l);o.innerHTML=`<div style="text-align:center;padding:20px;max-width:100%;"><div style="font-size:48px;color:#000000;margin-bottom:20px;"><i class="fas fa-check-circle"></i></div><h3 style="color:#333;margin-bottom:15px;font-size:20px;">章节内容生成完成！</h3><div style="background:#f9f9f9;border:1px solid #ddd;border-radius:8px;padding:20px;margin-bottom:20px;text-align:left;max-width:100%;"><p style="margin:0 0 10px 0;"><strong>生成章节：</strong>第${n+1}章 - ${t.title}</p><p style="margin:0 0 10px 0;"><strong>所属书籍：</strong>《${s}》</p><p style="margin:0 0 10px 0;"><strong>生成时间：</strong>${new Date().toLocaleString()}</p><p style="margin:0 0 10px 0;"><strong>字数统计：</strong>${c||'约10000'}字</p><p style="margin:0;"><strong>生成状态：</strong><span style="color:#000000;">成功</span></p></div><div style="color:#666;font-size:14px;line-height:1.6;margin-bottom:30px;max-width:100%;"><p>AI已根据章节简介成功生成了完整的小说内容。</p><p>生成的内容已保存，您可以在阅读界面查看完整章节。</p></div><div style="background:#fff;border:1px solid #000000;border-radius:8px;padding:20px;margin-bottom:30px;text-align:left;max-width:100%;"><h4 style="color:#333;margin-bottom:10px;">生成内容预览：</h4><div style="max-height:200px;overflow-y:auto;font-size:14px;line-height:1.6;color:#555;max-width:100%;word-wrap:break-word;"><p>${a?a.substring(0,500)+(a.length>500?'...':''):'生成内容为空'}</p></div></div><div style="display:flex;gap:15px;justify-content:center;"><button class="view-generated-btn" style="padding:12px 24px;background:#000000;color:white;border:none;border-radius:8px;font-size:16px;cursor:pointer;">查看完整内容</button><button class="back-to-reading-btn" style="padding:12px 24px;background:#f0f0f0;color:#333;border:1px solid #ddd;border-radius:8px;font-size:16px;cursor:pointer;">返回阅读</button></div></div>`;document.querySelector('.view-generated-btn').addEventListener('click',()=>{this.viewGeneratedContent(l,t,n)});document.querySelector('.back-to-reading-btn').addEventListener('click',()=>{this.currentBookId&&this.openReadingPage(this.currentBookId,s)})},handleGenerationError(e,t,n,r){const o=document.getElementById('reading-content');if(!o)return;o.innerHTML=`<div style="text-align:center;padding:40px 20px;max-width:100%;"><div style="font-size:48px;color:#f44336;margin-bottom:20px;"><i class="fas fa-exclamation-circle"></i></div><h3 style="color:#333;margin-bottom:15px;font-size:20px;">生成失败</h3><div style="background:#f9f9f9;border:1px solid #ddd;border-radius:8px;padding:20px;margin-bottom:20px;text-align:left;max-width:100%;"><p style="margin:0 0 10px 0;color:#f44336;"><strong>错误信息：</strong>${e.message||'API调用失败'}</p><p style="margin:0 0 10px 0;"><strong>尝试生成的章节：</strong>第${n+1}章 - ${t.title}</p></div><div style="color:#666;font-size:14px;line-height:1.6;margin-bottom:30px;max-width:100%;"><p>AI内容生成失败，可能的原因：</p><ul style="text-align:left;margin:10px 0;max-width:100%;"><li>API配置不正确</li><li>网络连接问题</li><li>API服务暂时不可用</li><li>API密钥无效或已过期</li></ul><p>请检查API配置后重试。</p></div><div style="display:flex;gap:15px;justify-content:center;"><button class="retry-generate-btn" style="padding:12px 24px;background:#000000;color:white;border:none;border-radius:8px;font-size:16px;cursor:pointer;">重新生成</button><button class="configure-api-btn" style="padding:12px 24px;background:#2196F3;color:white;border:none;border-radius:8px;font-size:16px;cursor:pointer;">配置API</button><button class="back-to-reading-btn" style="padding:12px 24px;background:#f0f0f0;color:#333;border:1px solid #ddd;border-radius:8px;font-size:16px;cursor:pointer;">返回阅读</button></div></div>`;document.querySelector('.retry-generate-btn').addEventListener('click',()=>{this.callGenerateAPI(t,n)});document.querySelector('.configure-api-btn').addEventListener('click',()=>{window.openApp&&window.openApp('api')});document.querySelector('.back-to-reading-btn').addEventListener('click',()=>{const o=this.currentBookId?this.myShelf.find(o=>o.id===this.currentBookId):null;o&&this.openReadingPage(this.currentBookId,o.title)})},showApiNotConfigured(){alert('请先在API设置中配置API密钥和模型\n\n操作步骤：\n1. 返回桌面点击"API"应用\n2. 输入API密钥和选择模型\n3. 测试连接成功后即可使用生成功能');const e=this.currentBookId?this.myShelf.find(e=>e.id===this.currentBookId):null;e&&this.openReadingPage(this.currentBookId,e.title)},viewGeneratedContent(e,t,n){const r=document.getElementById('reading-content');r&&(r.innerHTML=`<div style="padding:16px 8px;max-width:100%;box-sizing:border-box;width:100%;"><h2 style="color:#333;margin-bottom:20px;border-bottom:1px solid #ddd;padding-bottom:10px;font-size:24px;text-align:center;font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">第${n+1}章：${t.title}</h2><div style="background:#fff;border:none;border-radius:0;padding:16px 8px;margin:0;max-width:100%;box-sizing:border-box;width:100%;"><div style="font-size:18px;line-height:1.8;color:#333;white-space:pre-wrap;word-wrap:break-word;text-align:justify;max-width:100%;box-sizing:border-box;width:100%;padding:0 8px;font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;letter-spacing:normal;text-indent:2em;font-weight:400;">${e.content}</div></div><div style="display:flex;justify-content:space-between;align-items:center;margin:20px 0;padding:12px;background:#f9f9f9;border-radius:6px;max-width:100%;box-sizing:border-box;width:100%;font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;"><div><span style="color:#666;font-size:14px;">字数：${e.wordCount||'未知'}字</span><span style="margin-left:20px;color:#666;font-size:14px;">生成时间：${e.generatedAt?new Date(e.generatedAt).toLocaleString():'未知'}</span></div><button class="back-to-reading-btn" style="padding:10px 20px;background:#000000;color:white;border:none;border-radius:6px;font-size:14px;cursor:pointer;font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">返回</button></div></div>`);function addReadingControls(){const e=document.createElement("div");e.id="reading-controls";e.style.cssText="position:fixed;bottom:180px;left:50%;transform:translateX(-50%);width:240px;background:#fff;border:2px solid #000;border-radius:15px;padding:15px;z-index:2000;box-shadow:0 5px 20px rgba(0,0,0,0.2);display:none;flex-direction:column;gap:12px;";e.innerHTML=`<div class="control-row"><label style="font-size:12px;color:#000;margin-bottom:4px;display:block;">屏幕边距 (可负数)</label><input type="range" min="-100" max="200" value="20" class="margin-slider" style="width:100%;height:4px;appearance:none;background:#ddd;outline:none;border-radius:2px;"> <span class="value-display" style="font-size:11px;color:#000;margin-left:8px;">20px</span></div><div class="control-row"><label style="font-size:12px;color:#000;margin-bottom:4px;display:block;">行距 (0.5-5.0)</label><input type="range" min="0.5" max="5.0" step="0.1" value="1.8" class="line-height-slider" style="width:100%;height:4px;appearance:none;background:#ddd;outline:none;border-radius:2px;"> <span class="value-display" style="font-size:11px;color:#000;margin-left:8px;">1.8</span></div>`;const container=document.querySelector("#reading-content")||document.querySelector(".phone-container")||document.body;container.appendChild(e);const t=document.createElement("div");t.id="reading-controls-toggle";t.style.cssText="position:fixed;bottom:140px;left:50%;transform:translateX(-50%);width:50px;height:50px;background:#000;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;z-index:2001;cursor:pointer;font-size:18px;box-shadow:0 3px 10px rgba(0,0,0,0.3);";t.innerHTML="●";container.appendChild(t);let n=!1;t.addEventListener("click",()=>{n=!n;e.style.display=n?"flex":"none";t.innerHTML=n?"◆":"●"});e.querySelector(".margin-slider").addEventListener("input",function(){const e=this.value;this.nextElementSibling.textContent=e+"px";const mainContent=document.querySelector("#reading-content .modal-body")||document.querySelector("#reading-content .chapter-content")||document.querySelector("#reading-content > div");if(mainContent){mainContent.style.paddingLeft=e+"px";mainContent.style.paddingRight=e+"px";const allText=mainContent.querySelectorAll("div,p,span");allText.forEach(t=>{t.style.paddingLeft=e+"px";t.style.paddingRight=e+"px"})}});e.querySelector(".line-height-slider").addEventListener("input",function(){const e=this.value;this.nextElementSibling.textContent=e;const mainContent=document.querySelector("#reading-content .modal-body")||document.querySelector("#reading-content .chapter-content")||document.querySelector("#reading-content > div");if(mainContent){mainContent.style.lineHeight=e;const allText=mainContent.querySelectorAll("div,p,span");allText.forEach(t=>{t.style.lineHeight=e})}})}addReadingControls();document.querySelector('.back-to-reading-btn').addEventListener('click',()=>{const e=this.currentBookId?this.myShelf.find(e=>e.id===this.currentBookId):null;e&&this.openReadingPage(this.currentBookId,e.title)})},closeGenerateModal(){const e=document.getElementById('generate-modal');e&&(e.style.display='none')},closeReadingPage(){this.readingPage.style.display='none';this.openBookDetail(this.currentBookId)},bindDreamModalEvents(){document.querySelectorAll('.section-more').forEach(e=>{if(!e.classList.contains('edit-featured-btn')){e.addEventListener('click',t=>{t.preventDefault();this.openDreamModal()})}});document.querySelector('.close-new-dream').addEventListener('click',()=>{this.closeDreamModal()});document.getElementById('cancel-dream-btn').addEventListener('click',()=>{this.closeDreamModal()});document.querySelectorAll('.new-dream-tab').forEach(e=>{e.addEventListener('click',()=>{this.switchDreamTab(e.dataset.tab)})});document.getElementById('save-dream-btn').addEventListener('click',()=>{this.saveDream()});document.getElementById('new-dream-modal').addEventListener('click',e=>{'new-dream-modal'===e.target.id&&this.closeDreamModal()})},bindFeaturedModalEvents(){document.querySelector('.close-edit-featured').addEventListener('click',()=>{this.closeEditFeaturedModal()});document.getElementById('cancel-featured-btn').addEventListener('click',()=>{this.closeEditFeaturedModal()});document.getElementById('save-featured-btn').addEventListener('click',()=>{this.saveFeaturedBook()});document.getElementById('edit-featured-modal').addEventListener('click',e=>{'edit-featured-modal'===e.target.id&&this.closeEditFeaturedModal()});document.getElementById('featured-search').addEventListener('input',e=>{this.filterFeaturedBooks(e.target.value)})},switchDreamTab(e){document.querySelectorAll('.new-dream-tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.new-dream-tab-content').forEach(t=>t.classList.remove('active'));document.querySelector(`.new-dream-tab[data-tab="${e}"]`).classList.add('active');document.getElementById(`tab-${e}`).classList.add('active');'relate'===e&&this.loadRoles()},openDreamModal(){this.selectedRoles=[];this.loadDreamsData();document.getElementById('new-dream-modal').style.display='flex';document.getElementById('dream-title').focus()},closeDreamModal(){document.getElementById('new-dream-modal').style.display='none';this.resetDreamForm();this.selectedRoles=[]},openEditFeaturedModal(){this.loadAllBooksForFeatured();document.getElementById('edit-featured-modal').style.display='flex'},closeEditFeaturedModal(){document.getElementById('edit-featured-modal').style.display='none'},resetDreamForm(){document.getElementById('dream-title').value='';document.getElementById('dream-intro').value='';document.getElementById('dream-worldbook').value='';let e=document.getElementById('dream-roles-container');e&&(e.innerHTML='');this.switchDreamTab('title')},loadDreamsData(){this.loadWorldbooks()},loadRoles(){let e=document.getElementById('dream-roles-container');if(!e)return;e.innerHTML='';let t=JSON.parse(localStorage.getItem('aiPersona')||'{}'),n=JSON.parse(localStorage.getItem('userPersona')||'{}'),r=JSON.parse(localStorage.getItem('multiPersonas')||'[]');if(t.name){let o=document.createElement('div');o.className='role-item';o.innerHTML=`<input type="checkbox" class="role-checkbox" id="role-ai-persona" value="ai-persona" data-name="${t.name}"><label for="role-ai-persona">${t.name}（AI角色）</label>`;e.appendChild(o)}if(n.name){let o=document.createElement('div');o.className='role-item';o.innerHTML=`<input type="checkbox" class="role-checkbox" id="role-user-persona" value="user-persona" data-name="${n.name}"><label for="role-user-persona">${n.name}（用户角色）</label>`;e.appendChild(o)}r.forEach(t=>{let n=document.createElement('div');n.className='role-item';n.innerHTML=`<input type="checkbox" class="role-checkbox" id="role-${t.id}" value="${t.id}" data-name="${t.name}"><label for="role-${t.id}">${t.name}（多聊角色）</label>`;e.appendChild(n)});if(0===e.children.length){let t=document.createElement('div');t.className='no-roles';t.textContent='暂无角色，请在聊天界面创建角色后返回';e.appendChild(t)}},loadWorldbooks(){let e=document.getElementById('dream-worldbook');if(!e)return;e.innerHTML='<option value="">选择世界书</option>';let t=JSON.parse(localStorage.getItem('worldbook')||'[]');t.forEach((t,n)=>{e.innerHTML+=`<option value="${t.id}">${t.title||'未命名记录'}</option>`});e.innerHTML||(e.innerHTML+='<option value="">暂无世界书</option>')},handleRoleSelection(e,t){let n=t.value,r=t.dataset.name;t.checked?this.selectedRoles.push({id:n,name:r}):this.selectedRoles=this.selectedRoles.filter(e=>e.id!==n)},loadAllBooksForFeatured(){let e=document.getElementById('featured-book-list');if(!e)return;e.innerHTML='';let t=Array.from(document.querySelectorAll('#bookstore-home .book-item')).map(t=>({id:t.dataset.id,title:t.querySelector('.book-title span').textContent,badge:t.querySelector('.book-badge').textContent,author:t.querySelector('.book-meta span').textContent.replace(' ',''),rating:t.querySelector('.book-meta span:nth-child(2)').textContent.replace(' ',''),desc:t.querySelector('.book-desc').textContent,wordCount:t.querySelector('.book-stats span:nth-child(1)').textContent,updateInfo:t.querySelector('.book-stats span:nth-child(2)').textContent}));this.customBooks.forEach(e=>{t.push({id:e.id,title:e.title,badge:e.badge,author:e.author,rating:e.rating,desc:e.desc,wordCount:e.wordCount,updateInfo:e.updateInfo,isCustom:!0})});t.forEach(t=>{let n=document.createElement('div');n.className='book-selector-item';n.dataset.id=t.id;n.innerHTML=`<div class="book-selector-title"><span>${t.title}</span><span class="book-selector-badge">${t.badge}</span></div><div class="book-selector-meta"><span><i class="fas fa-user"></i> ${t.author}</span><span><i class="fas fa-star"></i> ${t.rating}</span></div><div class="book-selector-desc">${t.desc.substring(0,40)}${40<t.desc.length?'...':''}</div>`;e.appendChild(n);n.addEventListener('click',()=>{document.querySelectorAll('.book-selector-item').forEach(e=>e.classList.remove('selected'));n.classList.add('selected');this.selectedFeaturedBook=t})})},filterFeaturedBooks(e){let t=document.querySelectorAll('.book-selector-item');t.forEach(t=>{let n=t.querySelector('.book-selector-title span').textContent.toLowerCase();n.includes(e.toLowerCase())?t.style.display='block':t.style.display='none'})},saveFeaturedBook(){if(!this.selectedFeaturedBook)return alert('请选择一本书作为编辑推荐'),void 0;this.featuredBook=this.selectedFeaturedBook;localStorage.setItem('bookstoreFeatured',JSON.stringify(this.featuredBook));this.updateFeaturedDisplay();this.closeEditFeaturedModal();alert('编辑推荐已更新！')},loadFeaturedBook(){this.featuredBook&&this.updateFeaturedDisplay()},updateFeaturedDisplay(){if(!this.featuredBook||!this.featuredBook.id)return;let e=document.getElementById('featured-book-container');if(!e)return;let t=Array.from(document.querySelectorAll('#bookstore-home .book-item')).find(t=>t.dataset.id===this.featuredBook.id);if(!t&&!this.customBooks.find(e=>e.id===this.featuredBook.id))return;let n=this.customBooks.find(e=>e.id===this.featuredBook.id)||{title:t.querySelector('.book-title span').textContent,badge:t.querySelector('.book-badge').textContent,author:t.querySelector('.book-meta span').textContent.replace(' ',''),desc:t.querySelector('.book-desc').textContent,wordCount:t.querySelector('.book-stats span:nth-child(1)').textContent,updateInfo:t.querySelector('.book-stats span:nth-child(2)').textContent};e.dataset.id=this.featuredBook.id;e.querySelector('.featured-title span').textContent=n.title;e.querySelector('.featured-badge').textContent=n.badge;e.querySelector('.featured-meta span:nth-child(1)').innerHTML=`<i class="fas fa-user"></i> ${n.author}`;e.querySelector('.featured-meta span:nth-child(2)').innerHTML=`<i class="fas fa-tag"></i> ${'自定义'===n.badge?'梦境/创作':n.badge.includes('科幻')?'科幻':n.badge.includes('悬疑')?'悬疑':'文学'}`;e.querySelector('.featured-meta span:nth-child(3)').innerHTML=`<i class="fas fa-star"></i> ${n.rating||'9.0'}`;e.querySelector('.featured-desc').textContent=n.desc;e.querySelector('.featured-stats span:nth-child(1)').textContent=n.wordCount;e.querySelector('.featured-stats span:nth-child(2)').textContent=n.updateInfo},saveDream(){let e=document.getElementById('dream-title').value.trim(),t=document.getElementById('dream-intro').value.trim(),n=document.getElementById('dream-worldbook').value;if(!e)return alert('请填写梦境标题'),void document.getElementById('dream-title').focus();if(!t)return alert('请填写梦境简介'),void document.getElementById('dream-intro').focus();let r=localStorage.getItem('bookstoreUsername')||'游客用户';let o={id:Date.now()+'-'+Math.random().toString(36).substr(2,9),title:e,intro:t,roles:this.selectedRoles.map(e=>({id:e.id,name:e.name})),worldbook:n,timestamp:(new Date).toISOString()};this.dreams.push(o);localStorage.setItem('bookstoreDreams',JSON.stringify(this.dreams));this.createCustomBookFromDream(o);alert('梦境保存成功并已添加到自定义书籍中！');this.closeDreamModal();this.showCategoryBooks('custom')},createCustomBookFromDream(e,t){let n=localStorage.getItem('bookstoreUsername')||'游客用户';let r={id:e.id,title:e.title,author:n,badge:'自定义',rating:'9.0',desc:e.intro.substring(0,50)+(50<e.intro.length?'...':''),wordCount:'待填写',updateInfo:'梦境作品',dreamData:e,timestamp:e.timestamp};if(t){this.customBooks.push(r);localStorage.setItem('bookstoreCustomBooks',JSON.stringify(this.customBooks))}else{this.customBooks.push(r);localStorage.setItem('bookstoreCustomBooks',JSON.stringify(this.customBooks));this.showCategoryBooks('custom')}},getRoleNames(e){if(!e||0===e.length)return null;return e.map(t=>t.name).join('、')},handleCategoryClick(e){document.querySelectorAll('.bookstore-container .nav-tab').forEach(t=>t.classList.remove('active'));e.classList.add('active');this.showCategoryBooks(e.dataset.category);this.isEditingCustom=!1},handleSearch(e){alert('搜索功能开发中，搜索词: '+e)},switchPage(e){console.log('切换到页面:',e);Object.values(this.pages).forEach(t=>{t.classList.remove('active');t.style.display='none'});if(this.pages[e]){this.pages[e].classList.add('active');this.pages[e].style.display='block'}this.bookDetailPage.style.display='none';document.getElementById('bookstore-interface').querySelector('.header').style.display='flex';document.querySelectorAll('.sidebar-bubble').forEach(t=>{console.log('按钮:',t.dataset.page,'匹配:',t.dataset.page===e);t.classList.toggle('active',t.dataset.page===e)});'shelf'===e&&this.updateShelfDisplay();'home'===e&&this.showCategoryBooks('recommend');'movie'===e&&this.loadMoviePage&&this.loadMoviePage();this.isEditingCustom=!1},updateShelfDisplay(){let e=document.getElementById('emptyShelf'),t=document.getElementById('shelfContent'),n=document.getElementById('shelfBooks');if(!e||!t||!n)return;const r=localStorage.getItem('bookstoreUsername')||'游客用户';if(0<this.myShelf.length){e.style.display='none';t.style.display='block';n.innerHTML=this.myShelf.map(e=>{const t=this.customBooks.find(t=>t.id===e.id);return`<div class="book-item" data-id="${e.id}"><div class="book-title"><span>${e.title}</span><span class="book-badge">${e.badge}</span>${this.isEditingShelf?'<button class="remove-book">移除</button>':t?'<button class="view-detail-btn">详情</button>':''}</div><div class="book-meta"><span><i class="fas fa-user"></i> ${r}</span><span><i class="fas fa-star"></i> ${e.rating}</span></div><div class="book-desc">${e.desc}</div><div class="book-stats"><span>${e.wordCount}</span><span>${e.updateInfo}</span></div></div>`}).join('');document.querySelectorAll('.view-detail-btn').forEach(e=>{e.addEventListener('click',t=>{t.stopPropagation();const n=e.closest('.book-item');n&&this.openBookDetail(n.dataset.id)})})}else{e.style.display='block';t.style.display='none'}},toggleEditMode(){this.isEditingShelf=!this.isEditingShelf;let e=document.getElementById('editShelfBtn');e&&(e.textContent=this.isEditingShelf?'完成':'编辑');this.updateShelfDisplay()},toggleCustomEditMode(){this.isEditingCustom=!this.isEditingCustom;this.showCategoryBooks('custom')},handleBookClick(e,t){let n=t.dataset.id,r=t.querySelector('.book-title span, .featured-title span').textContent;if(this.pages.home.classList.contains('active')){if(confirm('打开《'+r+'》\n\n是否加入书架？')){const o=this.customBooks.find(e=>e.id===n);const i=localStorage.getItem('bookstoreUsername')||'游客用户';this.addToShelf({id:n,title:r,author:i,badge:this.getBookBadge(t),rating:this.getBookRating(t),desc:this.getBookDesc(t),wordCount:this.getBookWordCount(t),updateInfo:this.getBookUpdateInfo(t),isCustom:!!o})}}else if(this.pages.shelf.classList.contains('active')){const o=this.customBooks.find(e=>e.id===n);if(o){this.openBookDetail(n)}else{alert('《'+r+'》详情页面正在研发中，敬请期待！')}}else{alert('开始阅读《'+r+'》')}},addToShelf(e){if(!this.myShelf.some(t=>t.id===e.id)){this.myShelf.push(e);localStorage.setItem('bookstoreShelf',JSON.stringify(this.myShelf));this.updateShelfDisplay();alert('《'+e.title+'》已加入书架')}else{alert('这本书已经在书架中了')}},removeFromShelf(e){this.myShelf=this.myShelf.filter(t=>t.id!==e);localStorage.setItem('bookstoreShelf',JSON.stringify(this.myShelf));this.updateShelfDisplay()},removeCustomBook(e){if(confirm('确定要删除这本自定义书籍吗？')){this.customBooks=this.customBooks.filter(t=>t.id!==e);localStorage.setItem('bookstoreCustomBooks',JSON.stringify(this.customBooks));let t=this.dreams.findIndex(t=>t.id===e);-1<t&&(this.dreams.splice(t,1),localStorage.setItem('bookstoreDreams',JSON.stringify(this.dreams)));alert('自定义书籍已删除');this.showCategoryBooks('custom')}},getBookAuthor(e){return localStorage.getItem('bookstoreUsername')||'游客用户'},getBookBadge(e){let t=e.querySelector('.book-badge, .featured-badge');return t?t.textContent:'连载中'},getBookRating(e){let t=e.querySelector('.book-meta, .featured-meta');if(t){for(let n of t.querySelectorAll('span'))if(n.textContent.includes('9.'))return n.textContent.split(' ')[1]||'9.0'}return'9.0'},getBookDesc(e){let t=e.querySelector('.book-desc, .featured-desc');return t?t.textContent:'暂无描述'},getBookWordCount(e){let t=e.querySelector('.book-stats, .featured-stats');if(t){let n=t.querySelectorAll('span');if(0<n.length)return n[0].textContent}return'0字'},getBookUpdateInfo(e){let t=e.querySelector('.book-stats, .featured-stats');if(t){let n=t.querySelectorAll('span');if(1<n.length)return n[1].textContent}return'最新更新'},showCategoryBooks(e){const bookList=document.querySelector('#bookstore-home .book-list');if(!bookList)return;let customBooksContainer=bookList.querySelector('.custom-books-container');if(customBooksContainer){customBooksContainer.remove()}const allBooks=document.querySelectorAll('#bookstore-home .book-item');allBooks.forEach(book=>{book.style.display='none'});if('recommend'===e){allBooks.forEach(book=>book.style.display='block');return}if('literature'===e){allBooks.forEach(book=>{const meta=book.querySelector('.book-meta');if(meta&&(meta.textContent.includes('文学')||meta.textContent.includes('诗歌')||meta.textContent.includes('心理')||meta.textContent.includes('现实'))){book.style.display='block'}});return}if('novel'===e){allBooks.forEach(book=>{const meta=book.querySelector('.book-meta');if(meta&&(meta.textContent.includes('小说')||meta.textContent.includes('言情')||meta.textContent.includes('奇幻')||meta.textContent.includes('武侠')||meta.textContent.includes('悬疑'))){book.style.display='block'}});return}if('classic'===e){allBooks.forEach(book=>{const badge=book.querySelector('.book-badge');if(badge&&badge.textContent.includes('经典')){book.style.display='block'}});return}if('history'===e){allBooks.forEach(book=>{const meta=book.querySelector('.book-meta');if(meta&&meta.textContent.includes('历史')){book.style.display='block'}});return}if('horror'===e){allBooks.forEach(book=>{const meta=book.querySelector('.book-meta');if(meta&&meta.textContent.includes('恐怖')||meta.textContent.includes('惊悚')||meta.textContent.includes('灵异')){book.style.display='block'}});return}if('custom'===e){customBooksContainer=document.createElement('div');customBooksContainer.className='custom-books-container';if(0===this.customBooks.length){customBooksContainer.innerHTML=`<div style="text-align:center;padding:40px 20px;color:#777;"><i class="fas fa-book" style="font-size:48px;margin-bottom:20px;opacity:0.5;"></i><div style="font-size:16px;margin-bottom:10px;">暂无自定义书籍</div><div style="font-size:12px;">点击"更多"按钮创建梦境书籍</div></div>`;bookList.appendChild(customBooksContainer);return}let customHeader=document.createElement('div');customHeader.className='section-title';customHeader.style.marginBottom='15px';customHeader.innerHTML=`<span>自定义书籍 (${this.customBooks.length}本)</span><button class="edit-custom-btn">${this.isEditingCustom?'完成':'管理'}</button>`;customBooksContainer.appendChild(customHeader);let customBooksList=document.createElement('div');customBooksList.className='book-list';const u=localStorage.getItem('bookstoreUsername')||'游客用户';this.customBooks.forEach(t=>{let n=document.createElement('div');n.className='book-item';n.dataset.id=t.id;n.innerHTML=`<div class="book-title"><span>${t.title}</span><span class="book-badge">${t.badge}</span>${this.isEditingCustom?`<button class="edit-style-btn">风格</button><button class="remove-custom-book">删除</button>`:''}</div><div class="book-meta"><span><i class="fas fa-user"></i> ${u}</span><span><i class="fas fa-star"></i> ${t.rating}</span></div><div class="book-desc">${t.desc}</div><div class="book-stats"><span>${t.wordCount}</span><span>${t.updateInfo}</span></div>`;customBooksList.appendChild(n)});customBooksContainer.appendChild(customBooksList);bookList.appendChild(customBooksContainer)}},initChapterSystem(){this.chapters=JSON.parse(localStorage.getItem(`bookstoreChapters_${this.currentBookId}`))||[];this.editingChapterId=null;this.isDragging=!1;this.dragStartIndex=-1},openChapterManager(e){this.currentBookId=e;this.initChapterSystem();document.getElementById('bookstore-interface').querySelector('.header').style.display='none';Object.values(this.pages).forEach(e=>{e.style.display='none'});this.bookDetailPage.style.display='none';let t=document.getElementById('chapter-manager-page');if(!t){t=this.createChapterManagerPageElement();document.querySelector('.bookstore-container').appendChild(t)}t.style.display='block';this.renderChapters()},createChapterManagerPageElement(){const e=document.createElement('div');e.id='chapter-manager-page';e.className='bookstore-page';e.style.cssText='position:absolute;top:0;left:0;width:100%;height:100%;background:white;z-index:100;display:none;flex-direction:column;';e.innerHTML=`<div class="header"><button class="back-button back-from-chapters">●</button><h1>目录管理</h1></div><div class="scrollable-content"><div class="bookstore-container"><div class="bookstore-content"><div class="page-content" style="padding:20px;"><div class="chapters-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;"><h2 style="margin:0;color:#333;">章节列表</h2><button class="add-chapter-btn">添加章节</button></div><div class="chapters-info" style="background:#f9f9f9;border:1px solid #ddd;border-radius:8px;padding:15px;margin-bottom:20px;"><p style="margin:0 0 10px 0;color:#666;font-size:14px;"><i class="fas fa-info-circle" style="margin-right:5px;"></i>拖拽章节可以重新排序，点击章节名称可以编辑</p><p style="margin:0;color:#666;font-size:14px;"><i class="fas fa-list-ol" style="margin-right:5px;"></i>当前共有 <span id="chapter-count">0</span> 个章节</p></div><div class="chapters-list" id="chapters-list" style="min-height:300px;"><div class="empty-chapters" style="text-align:center;padding:60px 20px;color:#999;"><i class="fas fa-book-open" style="font-size:48px;margin-bottom:20px;opacity:0.5;"></i><div style="font-size:16px;margin-bottom:10px;">暂无章节</div><div style="font-size:14px;">点击"添加章节"按钮开始创建目录</div></div></div></div></div></div></div>`;e.querySelector('.back-from-chapters').addEventListener('click',()=>{this.closeChapterManager()});e.querySelector('.add-chapter-btn').addEventListener('click',()=>{this.openAddChapterModal()});return e},renderChapters(){const e=document.getElementById('chapters-list'),t=document.getElementById('chapter-count');if(!e)return;if(0===this.chapters.length){e.innerHTML=`<div class="empty-chapters" style="text-align:center;padding:60px 20px;color:#999;"><i class="fas fa-book-open" style="font-size:48px;margin-bottom:20px;opacity:0.5;"></i><div style="font-size:16px;margin-bottom:10px;">暂无章节</div><div style="font-size:14px;">点击"添加章节"按钮开始创建目录</div></div>`;t.textContent='0';return}t.textContent=this.chapters.length;let n='';this.chapters.forEach((t,r)=>{n+=`<div class="chapter-item" data-index="${r}" draggable="true" style="border:1px solid #ddd;border-radius:8px;padding:15px;margin-bottom:10px;background:#fff;cursor:grab;position:relative;transition:transform 0.2s;"><div class="chapter-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;"><div class="chapter-number" style="font-weight:600;color:#333;font-size:14px;">第 ${r+1} 章</div><div class="chapter-actions" style="display:flex;gap:8px;"><button class="edit-chapter-btn" data-id="${t.id}"><i class="fas fa-edit"></i> 编辑</button><button class="delete-chapter-btn" data-id="${t.id}"><i class="fas fa-trash"></i> 删除</button></div></div><div class="chapter-content"><div class="chapter-title" style="font-weight:700;font-size:16px;color:#333;margin-bottom:8px;">${t.title}</div><div class="chapter-desc" style="color:#666;font-size:14px;line-height:1.5;">${t.content||'暂无内容描述'}</div><div class="chapter-meta" style="display:flex;justify-content:space-between;margin-top:10px;font-size:12px;color:#999;"><span>创建时间: ${this.formatChapterDate(t.createdAt)}</span><span>字数: ${t.wordCount||'0'} 字</span></div></div></div>`});e.innerHTML=n;this.bindDragEvents();document.querySelectorAll('.edit-chapter-btn').forEach(e=>{e.addEventListener('click',t=>{t.stopPropagation();const n=e.dataset.id;this.openEditChapterModal(n)})});document.querySelectorAll('.delete-chapter-btn').forEach(e=>{e.addEventListener('click',t=>{t.stopPropagation();const n=e.dataset.id;this.deleteChapter(n)})})},bindDragEvents(){const e=document.querySelectorAll('.chapter-item');e.forEach(t=>{t.addEventListener('dragstart',e=>{this.dragStartIndex=parseInt(t.dataset.index);t.style.opacity='0.5';this.isDragging=!0});t.addEventListener('dragover',e=>{e.preventDefault();this.isDragging&&parseInt(t.dataset.index)!==this.dragStartIndex&&(t.style.transform='translateY(-5px)')});t.addEventListener('dragleave',()=>{t.style.transform=''});t.addEventListener('drop',e=>{e.preventDefault();t.style.transform='';if(this.isDragging&&-1!==this.dragStartIndex){const n=parseInt(t.dataset.index);if(n!==this.dragStartIndex){const e=this.chapters.splice(this.dragStartIndex,1);this.chapters.splice(n,0,e[0]);this.saveChaptersToStorage();this.renderChapters()}this.isDragging=!1;this.dragStartIndex=-1}});t.addEventListener('dragend',()=>{t.style.opacity='1';this.isDragging=!1;this.dragStartIndex=-1})})},openAddChapterModal(){this.editingChapterId=null;this.openChapterModal()},openEditChapterModal(e){this.editingChapterId=e;this.openChapterModal()},openChapterModal(){let e=document.getElementById('chapter-edit-modal');if(!e){e=this.createChapterModalElement();document.body.appendChild(e)}const t=document.getElementById('chapter-title-input'),n=document.getElementById('chapter-content-input'),r=document.getElementById('chapter-word-count');if(this.editingChapterId){const o=this.chapters.find(e=>e.id===this.editingChapterId);if(o){t.value=o.title||'';n.value=o.content||'';r.value=o.wordCount||'0';e.querySelector('.modal-title').textContent='编辑章节'}}else{t.value='';n.value='';r.value='0';e.querySelector('.modal-title').textContent='添加章节'}e.style.display='flex';t.focus()},createChapterModalElement(){const e=document.createElement('div');e.id='chapter-edit-modal';e.style.cssText='display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:2000;justify-content:center;align-items:center;';e.innerHTML=`<div class="modal-content" style="width:90%;max-width:500px;background:#fff;border-radius:10px;padding:20px;"><div class="modal-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;"><h3 class="modal-title" style="margin:0;color:#333;">添加章节</h3><button class="close-chapter-modal" style="background:none;border:none;font-size:20px;cursor:pointer;color:#666;">×</button></div><div class="modal-body"><div class="form-group" style="margin-bottom:15px;"><label style="display:block;margin-bottom:5px;font-size:14px;color:#333;">章节标题</label><input type="text" id="chapter-title-input" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px;" placeholder="例如：第一章 初遇"></div><div class="form-group" style="margin-bottom:15px;"><label style="display:block;margin-bottom:5px;font-size:14px;color:#333;">章节内容描述</label><textarea id="chapter-content-input" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px;min-height:120px;resize:vertical;" placeholder="简要描述本章节的主要内容..."></textarea></div><div class="form-group" style="margin-bottom:20px;"><label style="display:block;margin-bottom:5px;font-size:14px;color:#333;">字数统计</label><input type="number" id="chapter-word-count" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px;" placeholder="0" min="0" step="100"></div></div><div class="modal-actions" style="display:flex;gap:10px;"><button class="save-chapter-btn">保存章节</button><button class="cancel-chapter-btn">取消</button></div></div>`;e.querySelector('.close-chapter-modal').addEventListener('click',()=>{this.closeChapterModal()});e.querySelector('.cancel-chapter-btn').addEventListener('click',()=>{this.closeChapterModal()});e.querySelector('.save-chapter-btn').addEventListener('click',()=>{this.saveChapter()});e.addEventListener('click',t=>{t.target===e&&this.closeChapterModal()});document.addEventListener('keydown',t=>{'Escape'===t.key&&'flex'===e.style.display&&this.closeChapterModal()});return e},saveChapter(){const e=document.getElementById('chapter-title-input').value.trim(),t=document.getElementById('chapter-content-input').value.trim(),n=parseInt(document.getElementById('chapter-word-count').value)||0;if(!e)return alert('请填写章节标题'),void document.getElementById('chapter-title-input').focus();if(this.editingChapterId){const r=this.chapters.findIndex(t=>t.id===this.editingChapterId);if(-1!==r){this.chapters[r].title=e;this.chapters[r].content=t;this.chapters[r].wordCount=n;this.chapters[r].updatedAt=(new Date).toISOString()}}else{const r={id:Date.now()+'-'+Math.random().toString(36).substr(2,9),title:e,content:t,wordCount:n,createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()};this.chapters.push(r)}this.saveChaptersToStorage();this.closeChapterModal();this.renderChapters()},deleteChapter(e){if(!confirm('确定要删除这个章节吗？此操作不可撤销。'))return;const t=this.chapters.findIndex(t=>t.id===e);if(-1!==t){this.chapters.splice(t,1);this.saveChaptersToStorage();this.renderChapters()}},saveChaptersToStorage(){if(this.currentBookId){localStorage.setItem(`bookstoreChapters_${this.currentBookId}`,JSON.stringify(this.chapters))}},closeChapterModal(){const e=document.getElementById('chapter-edit-modal');e&&(e.style.display='none');this.editingChapterId=null},closeChapterManager(){const e=document.getElementById('chapter-manager-page');e&&(e.style.display='none');this.openBookDetail(this.currentBookId)},formatChapterDate(e){const t=new Date(e);return`${t.getFullYear()}-${(t.getMonth()+1).toString().padStart(2,'0')}-${t.getDate().toString().padStart(2,'0')}`}};document.addEventListener('DOMContentLoaded',function(){document.getElementById('bookstore-interface')&&bookstoreManager.init()});

/***********************************
* ✤ 奕阁界面
 ***********************************/
class GomokuGame{constructor(){this.canvas=null;this.ctx=null;this.board=Array.from({length:15},()=>Array(15).fill(0));this.gameOver=false;this.isPlayerTurn=true;this.ratio=window.devicePixelRatio||2;this.GRID_SIZE=15}init(containerId){const container=document.getElementById(containerId);if(!container)return;const gameContainer=document.createElement('div');gameContainer.className='gomoku-container';gameContainer.innerHTML=`<h2 class="gomoku-title">GOMOKU</h2><div class="gomoku-status" id="gomoku-status">BLACK'S TURN</div><div class="gomoku-board-wrapper"><canvas class="gomoku-canvas" id="gomoku-canvas"></canvas></div><button class="gomoku-btn" id="gomoku-reset">RESET GAME</button>`;container.appendChild(gameContainer);this.canvas=document.getElementById('gomoku-canvas');this.ctx=this.canvas.getContext('2d');this.statusText=document.getElementById('gomoku-status');const indicator=document.getElementById('construction-status');if(indicator){indicator.className='status-indicator status-offline';indicator.style.backgroundColor='red'}this.resizeCanvas();window.addEventListener('resize',()=>this.resizeCanvas());this.drawBoard();this.setupEventListeners()}resizeCanvas(){const wrapper=this.canvas.parentElement;const containerWidth=wrapper.clientWidth;this.canvas.style.width=containerWidth+'px';this.canvas.style.height=containerWidth+'px';const pixelWidth=containerWidth*this.ratio;const pixelHeight=containerWidth*this.ratio;if(this.canvas.width!==pixelWidth||this.canvas.height!==pixelHeight){this.canvas.width=pixelWidth;this.canvas.height=pixelHeight;this.ctx.setTransform(1,0,0,1,0,0);this.ctx.scale(this.ratio,this.ratio);this.size=containerWidth;this.CELL=this.size/16;this.OFFSET=(this.size-(this.GRID_SIZE-1)*this.CELL)/2;if(!this.gameOver)this.redrawBoard()}}redrawBoard(){this.drawBoard();for(let i=0;i<15;i++){for(let j=0;j<15;j++){if(this.board[i][j]===1)this.drawStep(i,j,true);else if(this.board[i][j]===2)this.drawStep(i,j,false)}}}drawBoard(){this.ctx.clearRect(0,0,this.size,this.size);this.ctx.strokeStyle="#000";this.ctx.lineWidth=1;this.ctx.lineCap="square";this.ctx.imageSmoothingEnabled=false;for(let i=0;i<this.GRID_SIZE;i++){const pos=Math.round(this.OFFSET+i*this.CELL)+0.5;this.ctx.beginPath();this.ctx.moveTo(this.OFFSET,pos);this.ctx.lineTo(this.size-this.OFFSET,pos);this.ctx.stroke();this.ctx.beginPath();this.ctx.moveTo(pos,this.OFFSET);this.ctx.lineTo(pos,this.size-this.OFFSET);this.ctx.stroke()}const dots=[[3,3],[11,3],[7,7],[3,11],[11,11]];dots.forEach(dot=>{this.ctx.beginPath();const x=this.OFFSET+dot[0]*this.CELL+0.5;const y=this.OFFSET+dot[1]*this.CELL+0.5;this.ctx.arc(x,y,this.CELL*0.12,0,Math.PI*2);this.ctx.fillStyle="#000";this.ctx.fill()})}drawStep(i,j,isBlack){this.ctx.beginPath();const x=this.OFFSET+i*this.CELL+0.5;const y=this.OFFSET+j*this.CELL+0.5;this.ctx.arc(x,y,this.CELL*0.42,0,Math.PI*2);if(isBlack){this.ctx.fillStyle="#000";this.ctx.fill()}else{this.ctx.fillStyle="#fff";this.ctx.fill();this.ctx.strokeStyle="#000";this.ctx.lineWidth=1;this.ctx.stroke()}this.board[i][j]=isBlack?1:2}setupEventListeners(){this.canvas.onclick=e=>this.handleCanvasClick(e);document.getElementById('gomoku-reset').onclick=()=>this.resetGame()}handleCanvasClick(e){if(this.gameOver||!this.isPlayerTurn)return;const indicator=document.getElementById('construction-status');if(indicator){indicator.className='status-indicator status-online';indicator.style.backgroundColor='#0f0'}const rect=this.canvas.getBoundingClientRect();const scale=this.size/rect.width;const clientX=(e.clientX-rect.left)*scale;const clientY=(e.clientY-rect.top)*scale;const i=Math.round((clientX-this.OFFSET)/this.CELL);const j=Math.round((clientY-this.OFFSET)/this.CELL);if(i>=0&&i<15&&j>=0&&j<15&&this.board[i][j]===0){this.drawStep(i,j,true);if(this.checkWin(i,j,1)){this.statusText.innerText="VICTORY";this.statusText.style.color="#000";this.gameOver=true;return}this.isPlayerTurn=false;this.statusText.innerText="AI THINKING...";setTimeout(()=>this.computerAI(),400)}}checkWin(x,y,c){const dirs=[[1,0],[0,1],[1,1],[1,-1]];for(let[dx,dy]of dirs){let count=1;for(let s of[1,-1]){let tx=x+dx*s,ty=y+dy*s;while(tx>=0&&tx<15&&ty>=0&&ty<15&&this.board[tx][ty]===c){count++;tx+=dx*s;ty+=dy*s}}if(count>=5)return true}return false}computerAI(){let max=-1,u=7,v=7;for(let i=0;i<15;i++){for(let j=0;j<15;j++){if(this.board[i][j]===0){let score=Math.max(this.evaluate(i,j,1),this.evaluate(i,j,2)*1.05);if(score>max){max=score;u=i;v=j}}}}this.drawStep(u,v,false);if(this.checkWin(u,v,2)){this.statusText.innerText="AI WINS";this.statusText.style.color="#d9534f";this.gameOver=true}else{this.isPlayerTurn=true;this.statusText.innerText="BLACK'S TURN"}const indicator=document.getElementById('construction-status');if(indicator){indicator.className='status-indicator status-offline';indicator.style.backgroundColor='red'}}evaluate(x,y,c){let score=0;const dirs=[[1,0],[0,1],[1,1],[1,-1]];for(let[dx,dy]of dirs){let count=0,block=0;for(let s of[1,-1]){for(let k=1;k<5;k++){let tx=x+dx*s*k,ty=y+dy*s*k;if(tx>=0&&tx<15&&ty>=0&&ty<15){if(this.board[tx][ty]===c)count++;else if(this.board[tx][ty]!==0){block++;break}else break}else{block++;break}}}if(count>=4)score+=10000;else if(count===3)score+=(block===0?1000:100);else if(count===2)score+=10;else score+=1}return score}resetGame(){const indicator=document.getElementById('construction-status');if(indicator){indicator.className='status-indicator status-offline';indicator.style.backgroundColor='red'}this.board=Array.from({length:15},()=>Array(15).fill(0));this.gameOver=false;this.isPlayerTurn=true;this.statusText.innerText="BLACK'S TURN";this.statusText.style.color="#666";this.drawBoard()}}function openGamePage(gameId){document.getElementById('construction-master-page').style.display='none';document.getElementById('construction-'+gameId+'-page').style.display='flex';if(gameId==='gomoku'){if(!window.gomokuGame){window.gomokuGame=new GomokuGame()}if(!document.getElementById('gomoku-game-container').hasChildNodes()){window.gomokuGame.init('gomoku-game-container')}}else if(gameId==='truth'){if(!document.getElementById('truth-game-container').hasChildNodes()){loadTruthGame()}}}function goBackToGameMaster(){document.querySelectorAll('.construction-page').forEach(page=>{page.style.display='none'});document.getElementById('construction-master-page').style.display='flex'}function loadTruthGame(){const container=document.getElementById('truth-game-container');if(!container.hasChildNodes()){const truthGameHTML=`<div class="truth-game-container"><div class="truth-game-wrapper"><div class="truth-control-panel"><div class="truth-dice-container"><div class="truth-dice" id="truth-dice">?</div><button class="truth-roll-btn" id="truth-roll-btn">摇骰子</button></div><div class="truth-player-status"><div class="truth-player-info active" id="truth-player1-info"><div class="truth-player-color"></div><div><h3 class="truth-player-name">玩家 1</h3><p class="truth-player-position">位置: <span id="truth-player1-pos">0/60</span></p></div></div><div class="truth-player-info" id="truth-player2-info"><div class="truth-player-color"></div><div><h3 class="truth-player-name">玩家 2</h3><p class="truth-player-position">位置: <span id="truth-player2-pos">0/60</span></p></div></div></div><div class="truth-game-status" id="truth-game-status">游戏开始！玩家 1 的回合</div><div class="truth-question-panel"><h3 class="truth-question-title">当前问题 <span id="truth-question-number">#1</span></h3><div class="truth-question-text" id="truth-current-question">等待摇骰子...</div><div class="truth-answer-input-container" id="truth-answer-input-container"><textarea class="truth-answer-input" id="truth-answer-input" placeholder="到达问题格子后可以在这里输入回答..."></textarea><div class="truth-current-answer" id="truth-current-answer" style="display:none"><div class="truth-answer-text" id="truth-answer-text-display"></div><div class="truth-answer-info"><span>回答者: <span id="truth-answer-player">玩家 1</span></span><span id="truth-answer-time">刚刚</span></div></div></div><div class="truth-question-controls"><button class="truth-submit-btn" id="truth-submit-btn">提交答案</button><button class="truth-answer-btn" id="truth-answer-btn">已回答</button><button class="truth-skip-btn" id="truth-skip-btn">跳过问题</button></div></div><div class="truth-questions-manager"><h3 class="truth-manager-title">自定义问题 (最多60个)</h3><div class="truth-questions-list" id="truth-questions-list"><div class="truth-question-item">请添加您自己的问题...</div></div><div class="truth-add-question"><input type="text" class="truth-question-input" id="truth-question-input" placeholder="输入一个新问题..."><button class="truth-add-btn" id="truth-add-btn">添加</button></div></div><div class="truth-answer-history"><h3 class="truth-history-title">回答历史</h3><div class="truth-answers-list" id="truth-answers-list"><div class="truth-answer-item">还没有回答记录...</div></div></div></div></div></div>`;container.innerHTML=truthGameHTML;initTruthGame()}}function initTruthGame(){function loadQuestionsFromStorage(){try{const savedQuestions=JSON.parse(localStorage.getItem('truthGameQuestions')||'[]');return savedQuestions;}catch(e){console.error('加载问题失败:',e);return[];}}function saveQuestionsToStorage(questions){try{localStorage.setItem('truthGameQuestions',JSON.stringify(questions));}catch(e){console.error('保存问题失败:',e);}}function updateStatusIndicator(isOnline){const indicator=document.getElementById('construction-status');if(indicator){if(isOnline){indicator.className='status-indicator status-online';indicator.style.backgroundColor='#0f0';}else{indicator.className='status-indicator status-offline';indicator.style.backgroundColor='red';}}}const gameState={currentPlayer:1,playerPositions:[0,0],questions:loadQuestionsFromStorage(),answeredQuestions:[],isRolling:false,gameActive:true,currentAnswer:"",answerHistory:[]};function renderQuestionsList(){const questionsList=document.getElementById('truth-questions-list');if(gameState.questions.length===0){questionsList.innerHTML='<div class="truth-question-item">请添加您自己的问题...</div>';return;}questionsList.innerHTML='';gameState.questions.forEach((question,index)=>{const questionItem=document.createElement('div');questionItem.className='truth-question-item';questionItem.innerHTML=`<span>#${index+1}: ${question.substring(0,40)}${question.length>40?'...':''}</span><button class="truth-delete-question">删除</button>`;questionsList.appendChild(questionItem);questionItem.querySelector('.truth-delete-question').addEventListener('click',function(e){e.stopPropagation();gameState.questions.splice(index,1);saveQuestionsToStorage(gameState.questions);renderQuestionsList();});});}function loadPersonaNames(){const userPersona=JSON.parse(localStorage.getItem("userPersona")||"{}");const aiPersona=JSON.parse(localStorage.getItem("aiPersona")||"{}");const userName=userPersona.name||"您";const aiName=aiPersona.name||"助手";document.getElementById('truth-player1-info').querySelector('.truth-player-name').textContent=userName;document.getElementById('truth-player2-info').querySelector('.truth-player-name').textContent=aiName;document.getElementById('truth-game-status').textContent=`游戏开始！${userName} 的回合`;document.getElementById('truth-answer-player').textContent=userName;}loadPersonaNames();renderQuestionsList();async function callAIAPI(question){try{const aiPersona=JSON.parse(localStorage.getItem('aiPersona')||'{}');const userPersona=JSON.parse(localStorage.getItem('userPersona')||'{}');const systemPrompt=`你是${aiPersona.name||'AI角色'}，角色设定：${aiPersona.desc||''}。用户是${userPersona.name||'用户'}，用户设定：${userPersona.desc||''}。请以角色身份真诚回答问题。`;const messages=[{role:'system',content:systemPrompt},{role:'user',content:question}];if(window.appState&&window.appState.apiService){const response=await window.appState.apiService.sendMessage(messages,{temperature:0.7,max_tokens:300});return response.content||'';}const apiConfig=JSON.parse(localStorage.getItem('apiConfig')||'{}');const apiKey=localStorage.getItem('apiKey')||apiConfig.apiKey;const apiUrl=localStorage.getItem('apiUrl')||apiConfig.apiUrl||'https://api.openai.com/v1';const model=localStorage.getItem('selectedModel')||apiConfig.model;if(!apiKey||!model){throw new Error('请先在奕阁设置中配置API');}const requestBody={model:model,messages:messages,temperature:0.7,max_tokens:300};const response=await fetch(apiUrl+(apiUrl.endsWith('/v1')?'/chat/completions':'/v1/chat/completions'),{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${apiKey}`},body:JSON.stringify(requestBody)});if(!response.ok){throw new Error(`API请求失败: ${response.status}`);}const data=await response.json();return data.choices?.[0]?.message?.content?.trim()||data.candidates?.[0]?.content?.parts?.[0]?.text?.trim()||'';}catch(error){console.error('调用AI API失败:',error);const aiPersona=JSON.parse(localStorage.getItem('aiPersona')||'{}');return`${aiPersona.name||'AI'}：无法回答问题 (${error.message})`;}}document.getElementById('truth-roll-btn').addEventListener('click',function(){if(!gameState.isRolling&&gameState.gameActive){updateStatusIndicator(true);gameState.isRolling=true;const dice=document.getElementById('truth-dice');let rolls=0;const maxRolls=8;const rollInterval=setInterval(()=>{dice.textContent=Math.floor(Math.random()*6)+1;rolls++;if(rolls>=maxRolls){clearInterval(rollInterval);const diceValue=Math.floor(Math.random()*6)+1;dice.textContent=diceValue;setTimeout(()=>{movePlayer(diceValue);gameState.isRolling=false;updateStatusIndicator(false);},400);}},80);}});async function movePlayer(steps){const playerIndex=gameState.currentPlayer-1;let newPosition=gameState.playerPositions[playerIndex]+steps;if(newPosition>=60)newPosition=59;gameState.playerPositions[playerIndex]=newPosition;updatePlayerPosition();if(newPosition<60){const questionNum=newPosition+1;document.getElementById('truth-question-number').textContent='#'+questionNum;const questionText=gameState.questions[newPosition]||`问题 #${questionNum}: 这是一个示例问题，请添加您自己的问题。`;document.getElementById('truth-current-question').textContent=questionText;document.getElementById('truth-answer-input').value='';document.getElementById('truth-current-answer').style.display='none';if(gameState.currentPlayer===2){document.getElementById('truth-answer-input').style.display='none';const aiName=document.getElementById('truth-player2-info').querySelector('.truth-player-name').textContent;document.getElementById('truth-game-status').textContent=`${aiName} 正在思考...`;try{const aiAnswer=await callAIAPI(questionText);const answerPlayerName=document.getElementById('truth-player2-info').querySelector('.truth-player-name').textContent;document.getElementById('truth-answer-text-display').textContent=aiAnswer;document.getElementById('truth-answer-player').textContent=answerPlayerName;document.getElementById('truth-answer-time').textContent='刚刚';document.getElementById('truth-current-answer').style.display='block';const answerItem={player:2,playerName:answerPlayerName,question:questionText,answer:aiAnswer,time:new Date().toLocaleTimeString(),position:newPosition};gameState.answerHistory.push(answerItem);updateAnswerHistory();setTimeout(()=>{gameState.currentPlayer=1;updatePlayerPosition();},1500);}catch(error){document.getElementById('truth-game-status').textContent='AI回答生成失败';console.error('AI回答错误:',error);}}else{document.getElementById('truth-answer-input').style.display='block';document.getElementById('truth-answer-input').placeholder='到达问题格子后可以在这里输入回答...';gameState.currentAnswer='';}gameState.gameActive=true;}}function updatePlayerPosition(){const player1Name=document.getElementById('truth-player1-info').querySelector('.truth-player-name').textContent;const player2Name=document.getElementById('truth-player2-info').querySelector('.truth-player-name').textContent;document.getElementById('truth-player1-pos').textContent=gameState.playerPositions[0]+'/60';document.getElementById('truth-player2-pos').textContent=gameState.playerPositions[1]+'/60';document.getElementById('truth-player1-info').classList.toggle('active',gameState.currentPlayer===1);document.getElementById('truth-player2-info').classList.toggle('active',gameState.currentPlayer===2);document.getElementById('truth-game-status').textContent=`${gameState.currentPlayer===1?player1Name:player2Name} 的回合`;}document.getElementById('truth-add-btn').addEventListener('click',function(){const input=document.getElementById('truth-question-input');const questionText=input.value.trim();if(questionText){if(gameState.questions.length>=60){alert('已达到60个问题的上限！');return;}gameState.questions.push(questionText);saveQuestionsToStorage(gameState.questions);renderQuestionsList();input.value='';}});document.getElementById('truth-submit-btn').addEventListener('click',function(){const answerInput=document.getElementById('truth-answer-input');const answerText=answerInput.value.trim();if(answerText&&gameState.gameActive&&gameState.currentPlayer===1){gameState.currentAnswer=answerText;const playerPos=gameState.playerPositions[0];const questionNum=playerPos+1;const questionText=gameState.questions[playerPos]||`问题 #${questionNum}`;const answerPlayerName=document.getElementById('truth-player1-info').querySelector('.truth-player-name').textContent;const answerItem={player:1,playerName:answerPlayerName,question:questionText,answer:answerText,time:new Date().toLocaleTimeString(),position:playerPos};gameState.answerHistory.push(answerItem);answerInput.style.display='none';document.getElementById('truth-answer-text-display').textContent=answerText;document.getElementById('truth-answer-player').textContent=answerPlayerName;document.getElementById('truth-answer-time').textContent='刚刚';document.getElementById('truth-current-answer').style.display='block';updateAnswerHistory();answerInput.value='';}});document.getElementById('truth-answer-btn').addEventListener('click',function(){if(gameState.gameActive){gameState.currentPlayer=gameState.currentPlayer===1?2:1;updatePlayerPosition();const diceValue=Math.floor(Math.random()*6)+1;setTimeout(()=>{movePlayer(diceValue);},500);}});document.getElementById('truth-skip-btn').addEventListener('click',function(){if(gameState.gameActive){gameState.currentPlayer=gameState.currentPlayer===1?2:1;updatePlayerPosition();const diceValue=Math.floor(Math.random()*6)+1;setTimeout(()=>{movePlayer(diceValue);},500);}});function updateAnswerHistory(){const answersList=document.getElementById('truth-answers-list');if(gameState.answerHistory.length===0){answersList.innerHTML='<div class="truth-answer-item">还没有回答记录...</div>';return;}answersList.innerHTML='';gameState.answerHistory.slice().reverse().forEach(item=>{const answerItem=document.createElement('div');answerItem.className='truth-answer-item';answerItem.innerHTML=`<div><strong>${item.playerName}:</strong> ${item.answer.substring(0,60)}${item.answer.length>60?'...':''}</div><div style="font-size:0.7rem;color:#666;">问题 #${item.position+1} • ${item.time}</div>`;answersList.appendChild(answerItem);});}updatePlayerPosition();}

/***********************************
* ✤ 国际汇界面
 ***********************************/
function internationalHandleCategoryClick(e){const t=document.querySelectorAll('#international-interface .category-item'),n=document.querySelectorAll('#international-interface .product-card');t.forEach(t=>t.classList.remove('active'));e.classList.add('active');const r=e.getAttribute('data-category').toLowerCase();n.forEach(e=>{const t=e.querySelector('.product-name').textContent.trim();if(t==='添加商品'){e.style.display='block';return}const n=e.getAttribute('data-category')?e.getAttribute('data-category').toLowerCase():'';r==='all'||n===r?e.style.display='block':e.style.display='none'})}function internationalHandleBrandClick(e){const t=document.querySelectorAll('#international-interface .brand-item'),n=document.querySelectorAll('#international-interface .product-card');t.forEach(t=>t.classList.remove('active'));e.classList.add('active');const r=e.textContent.trim();n.forEach(e=>{const t=e.querySelector('.product-name').textContent.trim();if(t==='添加商品'){e.style.display='block';return}const n=e.getAttribute('data-brand');r==='全部'||n===r?e.style.display='block':e.style.display='none'})}function internationalOpenProductDetail(e,t){addToCart(e,t)}function internationalOpenAddProductModal(){document.getElementById('international-add-product-modal').style.display='flex'}function internationalCloseAddProductModal(){document.getElementById('international-add-product-modal').style.display='none';document.getElementById('international-product-name').value='';document.getElementById('international-product-price').value='';document.getElementById('international-product-category').value='clothing';const e=document.getElementById('international-custom-category-input');if(e){e.value='';e.style.display='none'}}function toggleCustomCategoryInput(){const e=document.getElementById('international-product-category'),t=document.getElementById('international-custom-category-input');if(e.value==='custom'){t.style.display='block';t.focus()}else{t.style.display='none'}}function getPinyinInitials(name){if(!name||name.trim()==='')return'SP';let result='';for(let i=0;i<name.length&&result.length<5;i++){const char=name[i];if(char>='\u4e00'&&char<='\u9fff'){const code=char.charCodeAt(0),offset=code-0x4E00;if(offset>=0&&offset<=20901){const groups=[{s:0,e:500,l:'Y'},{s:501,e:1000,l:'D'},{s:1001,e:1500,l:'Q'},{s:1501,e:2000,l:'W'},{s:2001,e:2500,l:'Z'},{s:2501,e:3000,l:'S'},{s:3001,e:3500,l:'X'},{s:3501,e:4000,l:'B'},{s:4001,e:4500,l:'C'},{s:4501,e:5000,l:'L'},{s:5001,e:5500,l:'F'},{s:5501,e:6000,l:'G'},{s:6001,e:6500,l:'H'},{s:6501,e:7000,l:'J'},{s:7001,e:7500,l:'K'},{s:7501,e:8000,l:'M'},{s:8001,e:8500,l:'N'},{s:8501,e:9000,l:'P'},{s:9001,e:9500,l:'R'},{s:9501,e:10000,l:'T'},{s:10001,e:10500,l:'A'},{s:10501,e:11000,l:'E'},{s:11001,e:11500,l:'O'},{s:11501,e:12000,l:'U'},{s:12001,e:12500,l:'V'},{s:12501,e:13000,l:'I'},{s:13001,e:13500,l:'Y'},{s:13501,e:14000,l:'D'},{s:14001,e:14500,l:'Q'},{s:14501,e:15000,l:'W'},{s:15001,e:15500,l:'Z'},{s:15501,e:16000,l:'S'},{s:16001,e:16500,l:'X'},{s:16501,e:17000,l:'B'},{s:17001,e:17500,l:'C'},{s:17501,e:18000,l:'L'},{s:18001,e:18500,l:'F'},{s:18501,e:19000,l:'G'},{s:19001,e:19500,l:'H'},{s:19501,e:20000,l:'J'},{s:20001,e:20500,l:'K'},{s:20501,e:20901,l:'M'}];for(const group of groups){if(offset>=group.s&&offset<=group.e){result+=group.l;break}}if(result.length<=i)result+='X'}}else if(/[a-zA-Z]/.test(char)){result+=char.toUpperCase()}else if(/[0-9]/.test(char)){result+=char}}return result||name.substring(0,5).toUpperCase()}function saveCustomProduct(e,t,n,r){const a=JSON.parse(localStorage.getItem('internationalCustomProducts')||'[]');a.push({name:e,price:t,category:n,onclick:r});localStorage.setItem('internationalCustomProducts',JSON.stringify(a))}function loadCustomProducts(){const e=JSON.parse(localStorage.getItem('internationalCustomProducts')||'[]'),t=document.querySelector('#international-interface .products-grid'),n=t.querySelector('.add-product-btn');e.forEach(e=>{const r=document.createElement('div');r.className='product-card',r.setAttribute('data-category',e.category),r.setAttribute('onclick',e.onclick);const a=document.createElement('div');a.className='product-icon',a.textContent=getPinyinInitials(e.name);const o=document.createElement('div');o.className='product-info';const i=document.createElement('div');i.className='product-name',i.textContent=e.name;const c=document.createElement('div');c.className='product-price',c.textContent=e.price;const l=document.createElement('button');l.className='delete-product-btn',l.onclick=function(event){event.stopPropagation();if(confirm('确定删除吗？')){r.remove();removeCustomProduct(e.name)}};o.appendChild(i),o.appendChild(c),r.appendChild(a),r.appendChild(o),r.appendChild(l),t.insertBefore(r,n)})}function removeCustomProduct(e){const t=JSON.parse(localStorage.getItem('internationalCustomProducts')||'[]'),n=t.findIndex(t=>t.name===e);if(n>-1){t.splice(n,1);localStorage.setItem('internationalCustomProducts',JSON.stringify(t))}}function internationalAddCustomProduct(){const e=document.getElementById('international-product-name').value.trim(),t=document.getElementById('international-product-price').value.trim();let n=document.getElementById('international-product-category').value;if(!e||!t)return alert('请输入完整的商品信息');if(n==='custom'){const r=document.getElementById('international-custom-category-input').value.trim();if(!r)return alert('请输入自定义分类名称');n=r;const a=JSON.parse(localStorage.getItem('internationalCustomCategories')||'[]');if(!a.includes(n))internationalAddCustomCategory(n)}const o=t.replace('¥',''),i=getPinyinInitials(e),c=document.querySelector('#international-interface .products-grid'),l=document.createElement('div');l.className='product-card',l.setAttribute('data-category',n.toLowerCase()),l.setAttribute('onclick',`addToCart('${e.replace(/'/g,"\\'")}','¥${o}')`);const s=document.createElement('div');s.className='product-icon',s.textContent=i;const d=document.createElement('div');d.className='product-info';const u=document.createElement('div');u.className='product-name',u.textContent=e;const m=document.createElement('div');m.className='product-price',m.textContent='¥'+o;const p=document.createElement('button');p.className='delete-product-btn',p.onclick=function(event){event.stopPropagation();if(confirm('确定删除吗？')){l.remove();removeCustomProduct(e)}};d.appendChild(u),d.appendChild(m),l.appendChild(s),l.appendChild(d),l.appendChild(p),c.insertBefore(l,c.querySelector('.add-product-btn')),saveCustomProduct(e,'¥'+o,n.toLowerCase(),`addToCart('${e.replace(/'/g,"\\'")}','¥${o}')`),internationalCloseAddProductModal(),alert('商品添加成功！')}function internationalOpenAddCategoryModal(){const e=document.getElementById('international-add-category-modal');e.style.display='flex';renderManageList(e,'internationalCustomCategories','category-item','data-category')}function internationalCloseAddCategoryModal(){document.getElementById('international-add-category-modal').style.display='none';document.getElementById('international-category-name').value=''}function internationalAddCustomCategory(e){const t=typeof e==='string'?e:document.getElementById('international-category-name').value.trim();if(!t)return alert('请输入分类名称');const n=JSON.parse(localStorage.getItem('internationalCustomCategories')||'[]');if(n.includes(t))return alert('已存在');const r=document.querySelector('#international-interface .categories-scroll'),a=document.createElement('div');a.className='category-item',a.setAttribute('data-category',t.toLowerCase()),a.textContent=t,a.onclick=function(){internationalHandleCategoryClick(this)};r.insertBefore(a,document.querySelector('#international-interface .category-item.add-category-btn')),saveCustomCategory(t);if(typeof e!=='string'){internationalCloseAddCategoryModal();alert('分类添加成功！')}}function saveCustomCategory(e){const t=JSON.parse(localStorage.getItem('internationalCustomCategories')||'[]');if(!t.includes(e)){t.push(e);localStorage.setItem('internationalCustomCategories',JSON.stringify(t))}}function loadCustomCategories(){const e=JSON.parse(localStorage.getItem('internationalCustomCategories')||'[]'),t=document.querySelector('#international-interface .categories-scroll'),n=document.querySelector('#international-interface .category-item.add-category-btn');e.forEach(e=>{const r=document.createElement('div');r.className='category-item',r.setAttribute('data-category',e.toLowerCase()),r.textContent=e,r.onclick=function(){internationalHandleCategoryClick(this)};t.insertBefore(r,n)})}function internationalOpenAddBrandModal(){const e=document.getElementById('international-add-brand-modal');e.style.display='flex';renderManageList(e,'internationalCustomBrands','brand-item','text')}function internationalCloseAddBrandModal(){document.getElementById('international-add-brand-modal').style.display='none';document.getElementById('international-brand-name').value=''}function internationalAddCustomBrand(){const e=document.getElementById('international-brand-name').value.trim();if(!e)return alert('请输入品牌名称');const t=JSON.parse(localStorage.getItem('internationalCustomBrands')||'[]');if(t.includes(e))return alert('已存在');const n=document.querySelector('#international-interface .brands-scroll'),r=document.createElement('div');r.className='brand-item',r.textContent=e,r.onclick=function(){internationalHandleBrandClick(this)};n.insertBefore(r,document.querySelector('#international-interface .brand-item.add-brand-btn')),saveCustomBrand(e),internationalCloseAddBrandModal(),alert('品牌添加成功！')}function saveCustomBrand(e){const t=JSON.parse(localStorage.getItem('internationalCustomBrands')||'[]');if(!t.includes(e)){t.push(e);localStorage.setItem('internationalCustomBrands',JSON.stringify(t))}}function loadCustomBrands(){const e=JSON.parse(localStorage.getItem('internationalCustomBrands')||'[]'),t=document.querySelector('#international-interface .brands-scroll'),n=document.querySelector('#international-interface .brand-item.add-brand-btn');e.forEach(e=>{const r=document.createElement('div');r.className='brand-item',r.textContent=e,r.onclick=function(){internationalHandleBrandClick(this)};t.insertBefore(r,n)})}function renderManageList(e,t,n,r){const a=JSON.parse(localStorage.getItem(t)||'[]');let o=e.querySelector('.manage-list');o?o.innerHTML='':(o=document.createElement('div'),o.className='manage-list',o.style.cssText='margin-top:15px;max-height:120px;overflow-y:auto;border-top:1px solid #eee;padding-top:10px',e.querySelector('.international-modal-content').appendChild(o));a.forEach(a=>{const i=document.createElement('div');i.style.cssText='display:flex;justify-content:space-between;padding:5px 0;font-size:13px;border-bottom:1px solid #f5f5f5',i.innerHTML=`<span>${a}</span><span style="color:#ff4d4f;cursor:pointer" onclick="removeItemData('${t}','${a}','${n}','${r}')">删除</span>`,o.appendChild(i)})}function removeItemData(e,t,n,r){if(confirm(`确定删除“${t}”吗？`)){const a=JSON.parse(localStorage.getItem(e)||'[]').filter(e=>e!==t);localStorage.setItem(e,JSON.stringify(a));const o=document.querySelectorAll(`#international-interface .${n}`);o.forEach(e=>{if(r==='data-category'){if(e.getAttribute('data-category')===t.toLowerCase())e.remove()}else{if(e.textContent.trim()===t)e.remove()}});const i=document.querySelector('.international-modal[style*="flex"]');if(i)renderManageList(i,e,n,r)}}function internationalHandleSearch(e){const t=document.getElementById('international-search-input');if(!t)return;if(e.key==='Enter'||e.type==='click'){const n=t.value.trim().toLowerCase();document.querySelectorAll('#international-interface .product-card').forEach(e=>{const t=e.querySelector('.product-name');if(t){const r=t.textContent.trim().toLowerCase();e.style.display=(n===''||r.includes(n))?'block':'none'}})}}function initializeSearch(){const e=document.getElementById('international-search-input');if(e){e.addEventListener('keyup',internationalHandleSearch);const t=document.querySelector('#international-interface .search-icon');t&&t.addEventListener('click',internationalHandleSearch)}}document.addEventListener('DOMContentLoaded',function(){loadCustomProducts();loadCustomCategories();loadCustomBrands();initializeSearch()}); let cart=[];function openCart(){const list=document.getElementById('cart-items-list');list.innerHTML=cart.length?cart.map((i,index)=>`<div style="display:flex;justify-content:space-between;border-bottom:1px solid #eee;padding:5px 0"><span>${i.n}</span><span><b>${i.p}</b><b onclick="removeFromCart(${index})" style="color:red;cursor:pointer;margin-left:10px">×</b></span></div>`).join(''):'购物车空空如也';document.getElementById('cart-modal').style.display='flex'}function closeCart(){document.getElementById('cart-modal').style.display='none'}function removeFromCart(index){cart.splice(index,1);openCart();}function closeCart(){document.getElementById('cart-modal').style.display='none'}function addToCart(n,p){cart.push({n:n,p:p});alert('已加入购物车！')};let touchStartY=0;document.getElementById('nav-trigger').addEventListener('touchstart',e=>{touchStartY=e.touches[0].clientY});document.getElementById('nav-trigger').addEventListener('touchend',e=>{if(touchStartY-e.changedTouches[0].clientY>50)document.getElementById('arc-nav').classList.add('show')});document.getElementById('arc-nav').addEventListener('touchstart',e=>{touchStartY=e.touches[0].clientY});document.getElementById('arc-nav').addEventListener('touchend',e=>{if(e.changedTouches[0].clientY-touchStartY>50)document.getElementById('arc-nav').classList.remove('show')});function switchPage(pageId){document.querySelectorAll('.full-page').forEach(p=>p.style.display='none');document.querySelector('.scrollable-content').style.display='none';if(pageId==='home'){document.querySelector('.scrollable-content').style.display='block';}else{document.getElementById('page-'+pageId).style.display='block';}document.getElementById('arc-nav').classList.remove('show')}

/***********************************
* ✤ 开机动画界面
 ***********************************/
document.getElementById('startup-overlay').addEventListener('click',function(){const t=this,e=document.getElementById('startup-container'),n=document.querySelectorAll('.flower'),o=document.getElementById('app-hint');o.style.opacity='0';n.forEach((t,e)=>{t.style.opacity='1';t.style.animation=(0===e?'orbit1':'orbit2')+' 1.5s cubic-bezier(0.4, 0, 0.2, 1) forwards'});e.style.transform='scale(0.95)';setTimeout(()=>{e.style.opacity='0';t.style.opacity='0';setTimeout(()=>t.remove(),800)},1200)});

/***********************************
* ✤ 激活码界面
 ***********************************/
const ADMIN_PASSWORD="世纪MiniPhone666666";function showTermsModal(){const e=document.createElement("div");e.id="terms-modal",e.style.cssText="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.95);z-index:10000;display:flex;justify-content:center;align-items:center;color:#fff;font-family:system-ui";e.innerHTML='<div style="background:#111;border:2px solid #fff;border-radius:12px;padding:25px;max-width:700px;max-height:85vh;overflow-y:auto;position:relative"><button onclick="closeTerms()" style="position:absolute;top:15px;right:15px;background:transparent;border:none;color:#fff;font-size:24px;cursor:pointer">×</button><h1 style="text-align:center;margin-bottom:20px;font-size:24px">世纪MiNiPHONE服务条款</h1><div style="font-size:14px;line-height:1.6"><p><strong>前言</strong><br>✤欢迎使用世纪MiNiPHONE服务（以下简称"本服务"）。在开始使用前，请仔细阅读本服务条款（以下简称"本条款"）。本条款构成您与世纪白昼（以下简称"服务提供方"）之间的法律协议。您对本服务的任何访问、使用行为即表示您已阅读、理解并同意受本条款所有内容的约束。如您不同意本条款的任何部分，请立即停止使用本服务。<br><strong>生效日期：2026年1月10日</strong></p><p><strong>第一条 服务概述</strong><br>1. 世纪MiNiPHONE是世纪白昼个人原创设计的人工智能交互界面产品，其整体及全部组成部分均受版权法及相关知识产权法律保护。<br>2.本服务目前暂定为公益性质的技术分享项目，旨在为用户提供AI交互体验。用户需自行获取、配置并使用相关的API接口服务。</p><p><strong>第二条 使用规范与禁止行为</strong><br>〖知识产权合规要求，用户在使用本服务过程中，应当严格遵守以下知识产权规定〗：<br>1.如需导入第三方角色卡（包括但不限于"酒馆"等平台的用户创作内容），用户必须事先获得原著作权人的明确书面或口头授权；<br>2.严禁对本服务的任何组成部分（包括但不限于界面设计、视觉元素、功能代码、文档资料）进行复制、修改、改编、翻译、反向工程、反编译、反汇编或以其他形式进行二次创作；<br>3.严禁以任何形式对本服务进行商业性使用，包括但不限于转售、分销、许可、租赁或用于任何盈利性活动；<br>4.禁止未经服务提供方书面许可，向任何第三方分享、传播本服务的访问链接、安装包或其他相关资源。<br>〖用户承诺不从事以下可能损害本服务独特性或竞争优势的行为〗：<br>1.不得将本服务的界面设计、功能逻辑、用户体验或其他技术细节提供给其他同类产品或服务的开发者作为设计参考；<br>2. 不得接受或采纳其他类似产品或服务的界面设计建议用于本服务。<br>〖用户在使用本服务进行交互时，必须遵守中华人民共和国法律法规及公序良俗，不得利用本服务从事以下行为〗：<br>1. 不得讨论、传播或煽动任何涉及国家分裂、颠覆政权、破坏国家统一的内容；<br>2.不得讨论、传播或煽动任何涉及民族仇恨、民族歧视、破坏民族团结的内容；<br>3.不得讨论、传播或煽动任何涉及宗教矛盾、破坏宗教和谐的内容；<br>4. 不得讨论、传播任何其他法律、法规禁止的敏感话题或信息。</p><p><strong>第三条 违规处理</strong><br>〖若服务提供方发现或合理怀疑用户违反本条款的任何规定，服务提供方有权立即采取以下一项或多项措施，无需事先通知或解释〗：<br>1.暂停或永久终止该用户使用本服务的权限；<br>2. 从相关群组或社区中移除该用户；<br>3. 删除用户违规内容。<br>✤用户因违规行为给服务提供方或第三方造成损失的，应承担相应的法律责任。</p><p><strong>第四条 技术支持与反馈</strong><br>1.为提升问题解决效率，用户在遇到技术问题时，应首先查阅官方提供的精华消息、教程文档或常见问题解答。<br>2.如现有文档未涵盖您遇到的问题，可礼貌地向管理员咨询，并提供清晰的问题描述和必要的上下文信息。<br>3.服务提供方欢迎用户以建设性的方式反馈系统漏洞或提出功能改进建议，但对于反馈的采纳与否及实施时间，服务提供方保留单方决定权。</p><p><strong>第五条 知识产权声明</strong><br>1.世纪MiNiPHONE的整体设计、用户界面（UI）、用户体验（UX）、软件代码、相关文档及所有附属材料，其全部知识产权（包括但不限于版权、商标权、专利权）均独占性地归属于世纪白昼个人所有。<br>2.本条款不构成服务提供方将其知识产权转让或许可给用户的任何意思表示。用户仅获得一项有限的、不可转让的、非排他性的许可，用于根据本条款规定的目的和方式使用本服务。<br>3.服务提供方在此向"泮个终于"老师对本服务代码优化所提供的建议表示感谢，此感谢不意味着服务提供方对其建议内容的知识产权归属作出任何认定。</p><p><strong>第六条 免责声明</strong><br>1. "按现状"提供：本服务是基于公益目的"按现状"和"可提供"的基础向用户提供，服务提供方明确免除所有明示或暗示的保证，包括但不限于对适销性、特定用途适用性、准确性、完整性、不侵权及持续可用的保证。<br>2.风险自担：用户因使用本服务（包括但不限于依赖本服务内容、通过本服务进行交互等）而产生的一切风险、损失、损害（包括直接、间接、附带或后果性损害）由用户自行承担。服务提供方及其关联方对前述内容不承担任何责任。<br>3.服务变更权：服务提供方保留随时自行决定修改、暂停、中断或终止本服务全部或部分内容的权利，且无需事先通知用户，也无需对用户或任何第三方承担任何责任。</p><p><strong>第七条 条款的修改与更新</strong><br>1.服务提供方有权根据法律法规的变化、业务调整或用户体验优化的需要，随时单方面修订本条款。<br>2.修订后的条款将在本服务相关平台（如群公告）公布后立即生效，取代原有条款。<br>3.用户继续使用本服务的行为将被视为已阅读、理解并接受修订后的条款。如用户不同意修订内容，其唯一且排他的救济方式是立即停止使用本服务。</p><p><strong>✤再次提醒：本服务为个人原创作品，凝聚了大量心血。请尊重原创，共同维护良好的技术分享环境。感谢您的理解与支持。<br>世纪白昼 献上</strong></p></div><div style="text-align:center;margin-top:25px"><button onclick="acceptTerms()" style="padding:12px 40px;background:#fff;color:#000;border:none;border-radius:25px;font-size:16px;cursor:pointer;font-weight:bold">我已知悉并同意</button></div></div>';document.body.appendChild(e)}function closeTerms(){document.getElementById("terms-modal")&&document.getElementById("terms-modal").remove(),document.getElementById("activation-modal")&&(document.getElementById("activation-modal").style.display="flex")}function acceptTerms(){localStorage.setItem("mini-phone-terms-accepted","true"),closeTerms()}function checkTerms(){if(!localStorage.getItem("mini-phone-terms-accepted"))return showTermsModal(),!1;return!0}class ActivationManager{constructor(){this.storageKey='activation_codes',this.usedKey='used_codes',this.activationKey='device_activated',this.deviceIdKey='mini_device_id',this.deviceId=this.getOrCreateDeviceId(),this.init()}getOrCreateDeviceId(){let e=localStorage.getItem(this.deviceIdKey);return e||(e='DEV-'+Date.now()+'-'+Math.random().toString(36).substr(2,9),localStorage.setItem(this.deviceIdKey,e)),e}init(){this.checkActivationStatus(),this.bindEvents(),this.initHiddenTrigger()}checkActivationStatus(){if(localStorage.getItem(this.activationKey)==="true"){const e=document.getElementById("activation-modal");e&&(e.style.display="none")}}bindEvents(){const e=document.getElementById("activate-btn");e&&e.addEventListener("click",()=>this.activateDevice())}initHiddenTrigger(){let e=0,t=null;const n=document.querySelector('.status-bar')||document.body;n.style.cursor='default',n.addEventListener('click',()=>{e++,clearTimeout(t),t=setTimeout(()=>{e=0},300),e>=5&&(toggleAdminPanel(),e=0)})}activateDevice(){const e=document.getElementById("activation-code")?document.getElementById("activation-code").value:"",t=this.validate(e);t.valid?(this.markUsed(t.code.code,this.deviceId),localStorage.setItem(this.activationKey,"true"),setTimeout(()=>{const e=document.getElementById("activation-modal");e&&(e.style.display="none")},1500)):document.getElementById("activation-message")&&(document.getElementById("activation-message").textContent=t.message)}getCodes(){return JSON.parse(localStorage.getItem(this.storageKey)||'[]')}saveCodes(e){localStorage.setItem(this.storageKey,JSON.stringify(e)),this.refreshList()}getUsed(){return JSON.parse(localStorage.getItem(this.usedKey)||'[]')}markUsed(e,t){const r=this.getUsed(),n=r.find(r=>r.code===e);n||(r.push({code:e,deviceId:t,usedAt:new Date().toISOString()}),localStorage.setItem(this.usedKey,JSON.stringify(r)),this.saveCodes(this.getCodes().map(r=>r.code===e?{...r,used:!0,usedAt:new Date().toISOString(),usedBy:t}:r)))}validate(e){const t=e.trim().toUpperCase(),r=this.getCodes().find(e=>e.code===t);if(!r)return{valid:!1,message:"激活码不存在"};if(r.used)return r.usedBy===this.deviceId?(localStorage.setItem(this.activationKey,"true"),{valid:!0,message:"本设备已激活，欢迎回来",code:r}):{valid:!1,message:"激活码已被其他设备使用"};return{valid:!0,message:"激活成功",code:r}}addCode(e){const t=e.trim().toUpperCase();if(!t)return{success:!1,message:"激活码不能为空"};const r=this.getCodes();return r.some(e=>e.code===t)?{success:!1,message:"激活码已存在"}:(r.push({code:t,used:!1,created:new Date().toISOString(),deviceId:this.deviceId}),this.saveCodes(r),{success:!0,message:"激活码添加成功"})}generate(){const e="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";let t="";for(let r=0;r<8;r++)t+=e.charAt(Math.floor(Math.random()*e.length));return`ACT-${new Date().getFullYear()}-${t}`}deleteCode(e){if(!confirm(`确定删除激活码：${e}？`))return!1;const t=this.getCodes().filter(t=>t.code!==e);return this.saveCodes(t),!0}refreshList(){const e=this.getCodes(),t=this.getUsed(),r=document.getElementById("code-list");if(r){r.innerHTML="";if(!e.length)r.innerHTML='<div style="text-align:center;color:#999;padding:20px;">暂无数据</div>';else e.forEach(e=>{const n=t.find(t=>t.code===e.code),a=!!n,o=n&&n.deviceId===this.deviceId,s=document.createElement("div");s.style.cssText=`padding:8px;margin-bottom:5px;border:1px solid ${a?"#eee":"#000"};border-radius:4px;display:flex;justify-content:space-between;align-items:center;background:${a?"#fafafa":"#fff"};`,s.innerHTML=`<div><div style="font-weight:bold;font-size:12px;color:${a?"#999":"#000"}">${e.code}</div><div style="font-size:9px;color:#999">${new Date(e.created).toLocaleDateString()}</div>${a?`<div style="font-size:8px;color:${o?"#4caf50":"#f44336"};margin-top:2px">${o?"本设备已使用":"其他设备已使用"}</div>`:""}</div><button onclick="deleteCode('${e.code}')" style="padding:2px 5px;background:#000;color:#fff;border:none;border-radius:3px;font-size:10px;cursor:pointer;">删</button>`,r.appendChild(s)})}this.updateStats()}updateStats(){const e=this.getCodes(),t=this.getUsed().length;document.getElementById("total-codes")&&(document.getElementById("total-codes").textContent=e.length),document.getElementById("used-codes")&&(document.getElementById("used-codes").textContent=t)}exportCodes(){const e=this.getCodes(),t=this.getUsed();if(!e.length)return alert("无数据");try{const r=JSON.stringify({codes:e,used:t,exportDeviceId:this.deviceId,exportTime:new Date().toISOString(),expireTime:Date.now()+20*60*1000,version:"1.2"}),n=btoa(encodeURIComponent(r)),a=new Blob([n],{type:"application/json"}),o=URL.createObjectURL(a),s=document.createElement("a");s.href=o,s.download=`BACKUP_${Date.now()}.json`,s.click()}catch(e){alert("导出失败")}}processImport(e){const t=new FileReader;t.onload=r=>{try{const t=decodeURIComponent(atob(r.target.result)),n=JSON.parse(t);if(!n.codes||!Array.isArray(n.codes))return alert("激活码格式不匹配");if(n.expireTime&&n.expireTime<Date.now())return alert("该备份文件已过期（有效期20分钟）");const a=this.getCodes(),o=this.getUsed();n.codes.forEach(r=>{const s=a.find(e=>e.code===r.code);s?s.used&&o.find(e=>e.code===r.code)&&e.deviceId!==this.deviceId&&(s.used=!0,s.usedBy=o.find(e=>e.code===r.code).deviceId):a.push({...r,importedAt:new Date().toISOString(),importedFromDevice:n.exportDeviceId||"unknown"})}),n.used&&Array.isArray(n.used)&&n.used.forEach(e=>{o.find(t=>t.code===e.code)||o.push(e)}),localStorage.setItem(this.usedKey,JSON.stringify(o)),this.saveCodes(a),alert("导入成功")}catch(e){console.error("导入失败:",e),alert("读取失败：该文件内容非加密激活码数据")}},t.readAsText(e)}}const manager=new ActivationManager;function loginAdmin(){const e=document.getElementById("admin-password").value,t=document.getElementById("login-message");e===ADMIN_PASSWORD?(localStorage.setItem("admin_logged_in","true"),document.getElementById("admin-login").style.display="none",document.getElementById("admin-content").style.display="block",manager.refreshList(),t.textContent=""):t.textContent="密码错误"}function logoutAdmin(){localStorage.removeItem("admin_logged_in"),document.getElementById("admin-content").style.display="none",document.getElementById("admin-login").style.display="block",document.getElementById("admin-password").value="",toggleAdminPanel()}function showAddCodeForm(){document.getElementById("add-code-form").style.display="block"}function hideAddForm(){document.getElementById("add-code-form").style.display="none",document.getElementById("new-code-input").value=""}function generateCode(){document.getElementById("new-code-input").value=manager.generate()}function addCode(){const e=document.getElementById("new-code-input").value,t=manager.addCode(e);t.success?(hideAddForm(),manager.refreshList()):alert(t.message)}function deleteCode(e){manager.deleteCode(e)&&manager.refreshList()}function toggleAdminPanel(){const e=document.getElementById("admin-panel");e&&(e.style.display=e.style.display==="none"||e.style.display===""?"block":"none")}function exportCodes(){manager.exportCodes()}function showImportDialog(){const e=document.getElementById("import-file");e?e.click():alert("找不到文件上传控件")}function processImport(e){const t=e.target.files[0];t&&manager.processImport(t)}document.addEventListener("DOMContentLoaded",function(){checkTerms()?manager.checkActivationStatus():document.getElementById("activation-modal")&&(document.getElementById("activation-modal").style.display="none"),localStorage.getItem("admin_logged_in")==="true"&&(document.getElementById("admin-login").style.display="none",document.getElementById("admin-content").style.display="block",manager.refreshList());const e=document.createElement('input');e.type='file',e.id='import-file',e.style.display='none',e.accept='.json',e.onchange=processImport,document.body.appendChild(e)});

/***********************************
* ✤ UI 交互与辅助函数
 ***********************************/
 //● 聊天交互模块
function switchChatType(e){appState.chatType=e;localStorage.setItem('chatType',e);updateChatTypeUI();const t={single:'单聊模式',multi:'多聊模式'},a={single:'和一个角色进行聊天',multi:'和多个角色进行聊天，可切换不同角色回复'};alert(`已切换到${t[e]}！\n${a[e]}`)}function updateChatTypeUI(){const e=document.getElementById('single-chat-btn'),t=document.getElementById('multi-chat-btn'),a=document.getElementById('multi-persona-selector');e.classList.remove('active'),t.classList.remove('active'),'single'===appState.chatType?(e.classList.add('active'),a.classList.remove('active')):(t.classList.add('active'),a.classList.add('active'),refreshMultiPersonaSelect())}function loadChatType(){const e=localStorage.getItem('chatType');e&&(appState.chatType=e),updateChatTypeUI()}function refreshMultiPersonaSelect(){const e=document.getElementById('multi-persona-select'),t=appState.multiPersonaManager.getAllPersonas();e.innerHTML='';if(0===t.length){const a=document.createElement('option');a.value='',a.textContent='请先添加多聊角色',e.appendChild(a);return}t.forEach(t=>{const a=document.createElement('option');a.value=t.id,a.textContent=t.name,appState.multiPersonaManager.currentPersonaId===t.id&&(a.selected=!0),e.appendChild(a)})}function switchMultiPersona(){const e=document.getElementById('multi-persona-select'),t=e.value;if(t){appState.multiPersonaManager.setCurrentPersona(t);const e=appState.multiPersonaManager.getCurrentPersona();e&&alert(`已切换到角色:${e.name}`)}}function addMultiPersona(){const e=document.getElementById('multi-persona-name'),t=document.getElementById('multi-persona-desc'),a=e.value.trim(),n=t.value.trim();if(!a||!n)return void alert('请填写角色姓名和人设描述！');const i=appState.multiPersonaManager.addPersona(a,n);e.value='',t.value='',refreshMultiPersonaPreview(),'multi'===appState.chatType&&refreshMultiPersonaSelect(),alert(`已添加角色:${i.name}`)}function saveMultiPersonas(){alert('多聊角色已保存！')}function refreshMultiPersonaPreview(){const e=document.getElementById('multi-preview-content'),t=appState.multiPersonaManager.getAllPersonas();if(0===t.length){e.innerHTML='暂无多聊角色';return}let a='';t.forEach(t=>{a+=`<div style="margin-bottom:10px;padding:8px;border:1px solid #000;border-radius:4px;background:white;"><strong>${t.name}</strong><div style="font-size:10px;color:#000;margin-top:4px;">${t.description}</div><div style="font-size:9px;color:#333;margin-top:2px;">${new Date(t.timestamp).toLocaleString()}</div><button onclick="deleteMultiPersona('${t.id}')" style="margin-top:5px;padding:2px 6px;font-size:10px;background:white;border:1px solid #000;border-radius:3px;cursor:pointer;color:#000;">删除</button></div>`}),e.innerHTML=a}function deleteMultiPersona(e){confirm('确定要删除这个角色吗？')&&(appState.multiPersonaManager.deletePersona(e)&&(refreshMultiPersonaPreview(),'multi'===appState.chatType&&refreshMultiPersonaSelect(),alert('角色已删除！')))}function switchChatMode(e){appState.chatMode=e;localStorage.setItem('chatMode',e);updateChatModeUI();const t={online:'线上模式',offline:'线下模式'},a={online:'短信模式：短文本，日常说话语气，不加修饰词',offline:'剧情模式：长文本，走唯美长剧情，小说式，各种修饰词都可以写'};alert(`已切换到${t[e]}！\n${a[e]}`)}function updateChatModeUI(){const e=document.getElementById('online-mode-btn'),t=document.getElementById('offline-mode-btn'),a=document.getElementById('chat-mode-display'),n=document.getElementById('chat-mode-indicator');e.classList.remove('active'),t.classList.remove('active'),'online'===appState.chatMode?(e.classList.add('active'),a.textContent='线上模式',n.className='chat-mode-indicator chat-mode-online'):(t.classList.add('active'),a.textContent='线下模式',n.className='chat-mode-indicator chat-mode-offline')}function loadChatMode(){const e=localStorage.getItem('chatMode');e&&(appState.chatMode=e),updateChatModeUI()}function clearAllChatHistory(){const e=appState.chatManager.getMessageCount();if(0===e)return void alert('聊天记录已经是空的！');document.getElementById('clear-chat-text').textContent=`您确定要清空所有 ${e} 条聊天记录吗？此操作不可撤销。`,document.getElementById('clear-chat-dialog').style.display='flex'}function confirmClearChatHistory(){const e=appState.chatManager.clearAllMessages();document.getElementById('clear-chat-dialog').style.display='none',alert(`已成功清空 ${e} 条聊天记录！`),renderChatMessages()}function cancelClearChatHistory(){document.getElementById('clear-chat-dialog').style.display='none'}function toggleSelectionMode(){appState.selectionMode=!appState.selectionMode;const e=document.getElementById('chat-messages'),t=document.getElementById('selection-mode-info'),a=document.getElementById('selection-actions'),n=document.getElementById('selection-mode-btn');if(appState.selectionMode){e.classList.add('selection-mode'),t.classList.add('active'),a.classList.add('active'),n.textContent='退出选择模式',n.classList.add('danger'),appState.selectedMessageIds=[],updateSelectionCount()}else{e.classList.remove('selection-mode'),t.classList.remove('active'),a.classList.remove('active'),n.textContent='选择消息清空',n.classList.remove('danger'),document.querySelectorAll('.message.selected').forEach(e=>{e.classList.remove('selected')}),appState.selectedMessageIds=[]}renderChatMessages()}function toggleMessageSelection(e,t){const a=document.querySelector(`.message[data-message-id="${e}"]`);t.checked?appState.selectedMessageIds.includes(e)||(appState.selectedMessageIds.push(e),a.classList.add('selected')):(a=>{const t=appState.selectedMessageIds.indexOf(e);t!==-1&&(appState.selectedMessageIds.splice(t,1),a.classList.remove('selected'))})(a),updateSelectionCount()}function updateSelectionCount(){document.getElementById('selection-count').textContent=appState.selectedMessageIds.length}function deleteSelectedMessages(){const e=appState.selectedMessageIds.length;if(0===e)return void alert('请先选择要删除的消息！');document.getElementById('delete-selected-text').textContent=`您确定要删除选中的 ${e} 条消息吗？此操作不可撤销。`,document.getElementById('delete-selected-dialog').style.display='flex'}function confirmDeleteSelectedMessages(){const e=appState.chatManager.deleteMessages(appState.selectedMessageIds);document.getElementById('delete-selected-dialog').style.display='none',toggleSelectionMode(),alert(`已成功删除 ${e} 条消息！`)}function cancelDeleteSelectedMessages(){document.getElementById('delete-selected-dialog').style.display='none'}let sendButtonClickCount=0,sendButtonTimer=null,lastClickTime=0;function handleSendButtonClick(){const e=new Date().getTime(),t=e-lastClickTime;lastClickTime=e,sendButtonClickCount++,sendButtonTimer&&clearTimeout(sendButtonTimer),1===sendButtonClickCount||t>2e3?sendButtonTimer=setTimeout(()=>{addUserMessageOnly(),sendButtonClickCount=0,sendButtonTimer=null},200):2===sendButtonClickCount&&t<=2e3&&(clearTimeout(sendButtonTimer),addUserMessageAndCallAI(),sendButtonClickCount=0,sendButtonTimer=null)}function addUserMessageOnly(){const e=document.getElementById("message-input"),t=e.value.trim();t&&(e.value="",(()=>{const e=JSON.parse(localStorage.getItem("userPersona")||"{}").name||"您";appState.chatManager.addMessage("user",t,e,null)})(),renderChatMessages())}function addUserMessageAndCallAI(){const e=document.getElementById("message-input"),t=e.value.trim();if(t){e.value="",(()=>{const e=JSON.parse(localStorage.getItem("userPersona")||"{}").name||"您";appState.chatManager.addMessage("user",t,e,null)})(),renderChatMessages(),callAI()}}async function callAI(){if(!appState.isGenerating){const e=document.getElementById("send-button");appState.isGenerating=!0,e.disabled=!0,e.textContent="生成中...",updateStatusIndicators();const t=appState.chatManager.getMessages(),a=t.filter(e=>"user"===e.sender).pop();if(a){let t,n=null,i;if("single"===appState.chatType){const e=JSON.parse(localStorage.getItem("aiPersona")||"{}");t=e.name||"助手",i=getCurrentRolePrompt(),n=null}else{const e=appState.multiPersonaManager.getCurrentPersona();if(!e)return alert("请先选择多聊角色！"),appState.isGenerating=!1,e.disabled=!1,void(e.textContent="发送");t=e.name,i=e.description,n=e.id}const r=appState.chatManager.addMessage("ai","正在思考...",t,n);renderChatMessages();try{const o=parseFloat(document.getElementById("temperature").value)||.7,c=parseInt(document.getElementById("reply-count").value)||1,l=await appState.apiService.chatWithRole(i,a.content,o,c,appState.chatMode,appState.chatType,t);appState.chatManager.deleteMessage(r.id),l.forEach((e,a)=>{let n=e;a>0&&c>1&&(n=`（继续）\n${e}`),appState.chatManager.addMessage("ai",n,t,n)}),renderChatMessages()}catch(e){appState.chatManager.updateMessage(r.id,`抱歉，生成回复时出现错误：${e.message}`),renderChatMessages()}finally{appState.isGenerating=!1,e.disabled=!1,e.textContent="发送",updateStatusIndicators()}}else appState.isGenerating=!1,e.disabled=!1,e.textContent="发送"}}function exportWorldbookRecords(){const e=appState.worldbookManager.getAllRecords();if(0===e.length)return void showWorldbookBackupStatus('没有世界书记录可以导出','error');const t={version:'1.0',exportTime:new Date().toISOString(),recordCount:e.length,records:e},a=JSON.stringify(t,null,2),n=new Blob([a],{type:'application/json'}),i=URL.createObjectURL(n),o=document.createElement('a');o.href=i,o.download=`worldbook_records_${new Date().toISOString().split('T')[0]}.json`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(i),showWorldbookBackupStatus(`成功导出 ${e.length} 条世界书记录`,'success')}function importWorldbookRecords(){document.getElementById('worldbook-backup-file-input').click()}document.getElementById('worldbook-backup-file-input').addEventListener('change',function(e){const t=e.target.files[0];if(t){const e=new FileReader;e.onload=function(e){try{const t=JSON.parse(e.target.result);t.records&&Array.isArray(t.records)?showWorldbookImportConfirm(t):showWorldbookBackupStatus('文件格式不正确','error')}catch(e){console.error('解析文件失败:',e),showWorldbookBackupStatus('文件解析失败，请检查文件格式','error')}},e.readAsText(t),this.value=''}});function showWorldbookImportConfirm(e){const t=document.createElement('div');t.className='confirm-dialog',t.style.display='flex',t.innerHTML=`<div class="confirm-content"><h3>导入世界书记录</h3><p>导入世界书记录将覆盖当前的所有记录，此操作不可撤销。确定要导入 ${e.recordCount} 条记录吗？</p><div class="confirm-buttons"><button id="worldbook-confirm-import-btn">确认导入</button><button id="worldbook-cancel-import-btn">取消</button></div></div>`,document.body.appendChild(t),document.getElementById('worldbook-confirm-import-btn').onclick=function(){performWorldbookImport(e),document.body.removeChild(t)},document.getElementById('worldbook-cancel-import-btn').onclick=function(){document.body.removeChild(t)}}function performWorldbookImport(e){try{appState.worldbookManager.records.length=0,e.records.forEach(e=>{appState.worldbookManager.records.push(e)}),appState.worldbookManager.saveRecords(),renderWorldbookList(),updateWorldbookStatusIndicator(),showWorldbookBackupStatus(`成功导入 ${e.recordCount} 条世界书记录`,'success')}catch(e){console.error('导入世界书记录失败:',e),showWorldbookBackupStatus('导入世界书记录失败','error')}}function backupWorldbookToLocal(){const e=appState.worldbookManager.getAllRecords();if(0===e.length)return void showWorldbookBackupStatus('没有世界书记录可以备份','error');const t={version:'1.0',backupTime:new Date().toISOString(),recordCount:e.length,records:e};localStorage.setItem('worldbookBackup',JSON.stringify(t)),showWorldbookBackupStatus(`成功备份 ${e.length} 条世界书记录到本地`,'success')}function restoreWorldbookFromLocal(){const e=localStorage.getItem('worldbookBackup');if(!e)return void showWorldbookBackupStatus('没有找到本地备份','error');try{const t=JSON.parse(e);if(!t.records||!Array.isArray(t.records))return void showWorldbookBackupStatus('备份数据格式不正确','error');const a=document.createElement('div');a.className='confirm-dialog',a.style.display='flex',a.innerHTML=`<div class="confirm-content"><h3>恢复世界书记录</h3><p>恢复世界书记录将覆盖当前的所有记录，此操作不可撤销。确定要恢复 ${t.recordCount} 条记录吗？</p><div class="confirm-buttons"><button id="worldbook-confirm-restore-btn">确认恢复</button><button id="worldbook-cancel-restore-btn">取消</button></div></div>`,document.body.appendChild(a),document.getElementById('worldbook-confirm-restore-btn').onclick=function(){performWorldbookRestore(t),document.body.removeChild(a)},document.getElementById('worldbook-cancel-restore-btn').onclick=function(){document.body.removeChild(a)}}catch(e){console.error('解析备份数据失败:',e),showWorldbookBackupStatus('备份数据解析失败','error')}}function performWorldbookRestore(e){try{appState.worldbookManager.records.length=0,e.records.forEach(e=>{appState.worldbookManager.records.push(e)}),appState.worldbookManager.saveRecords(),renderWorldbookList(),updateWorldbookStatusIndicator(),showWorldbookBackupStatus(`成功恢复 ${e.recordCount} 条世界书记录`,'success')}catch(e){console.error('恢复世界书记录失败:',e),showWorldbookBackupStatus('恢复世界书记录失败','error')}}function showWorldbookBackupStatus(e,t){const a=document.getElementById('worldbook-backup-status');a.textContent=e,a.className=`worldbook-backup-status worldbook-backup-${t}`,a.style.display='block',setTimeout(()=>{a.style.display='none'},3e3)}function updateDesktopTime(){const e=new Date(),t=e.getHours().toString().padStart(2,'0'),a=e.getMinutes().toString().padStart(2,'0');document.getElementById('desktop-time').textContent=`${t}:${a}`}function openApp(e){document.getElementById('desktop-interface').classList.remove('active'),document.getElementById(`${e}-interface`).classList.add('active'),currentInterface=e,updateStatusIndicators(),'worldbook'===e&&(renderWorldbookList(),updateWorldbookStatusIndicator()),'wallet'===e&&(walletManager.initWallet(),walletManager.setupEventListeners()),'weibo'===e&&weiboManager.init(),'food-delivery'===e&&!window.foodInited&&(initFoodDelivery(),window.foodInited=!0)}function goBackToDesktop(){document.querySelectorAll('.interface').forEach(e=>{e.classList.remove('active')}),document.getElementById('desktop-interface').classList.add('active'),currentInterface='desktop'}function showDeleteConfirm(e){deleteMessageId=e,document.getElementById('confirm-dialog').style.display='flex'}function confirmDelete(){deleteMessageId&&(appState.chatManager.deleteMessage(deleteMessageId),renderChatMessages()),document.getElementById('confirm-dialog').style.display='none',deleteMessageId=null}function cancelDelete(){document.getElementById('confirm-dialog').style.display='none',deleteMessageId=null}function openPersonaModal(){document.getElementById('persona-modal').style.display='flex',loadPersonaPreviews(),refreshMultiPersonaPreview()}function closePersonaModal(){document.getElementById('persona-modal').style.display='none'}function switchPersonaTab(e){document.querySelectorAll('.persona-tab').forEach(t=>{t.classList.remove('active')}),document.querySelectorAll('.persona-form-section').forEach(t=>{t.classList.remove('active')}),document.querySelector(`.persona-tab[onclick="switchPersonaTab('${e}')"]`).classList.add('active'),document.getElementById(`${e}-persona-section`).classList.add('active'),appState.currentPersonaTab=e,loadPersonaPreviews(),'multi'===e&&refreshMultiPersonaPreview()}function loadPersonaPreviews(){const e=JSON.parse(localStorage.getItem('aiPersona')||'{}'),t=JSON.parse(localStorage.getItem('userPersona')||'{}');(e.name||e.description)?document.getElementById('ai-preview-content').innerHTML=`<strong>姓名:</strong> ${e.name||'未设置'}<br><strong>描述:</strong> ${e.description||'未设置'}`:document.getElementById('ai-preview-content').textContent='暂无角色人设',(t.name||t.description)?document.getElementById('user-preview-content').innerHTML=`<strong>姓名:</strong> ${t.name||'未设置'}<br><strong>描述:</strong> ${t.description||'未设置'}`:document.getElementById('user-preview-content').textContent='暂无我的人设'}function saveAIPersona(){const e=document.getElementById('ai-persona-name').value.trim(),t=document.getElementById('ai-persona-desc').value.trim(),a={name:e,description:t,timestamp:new Date().toISOString()};localStorage.setItem('aiPersona',JSON.stringify(a)),loadPersonaPreviews(),renderChatMessages(),alert('角色人设保存成功！')}function loadAIPersona(){const e=JSON.parse(localStorage.getItem('aiPersona')||'{}');document.getElementById('ai-persona-name').value=e.name||'',document.getElementById('ai-persona-desc').value=e.description||'',loadPersonaPreviews(),renderChatMessages(),alert('角色人设加载成功！')}function saveUserPersona(){const e=document.getElementById('user-persona-name').value.trim(),t=document.getElementById('user-persona-desc').value.trim(),a={name:e,description:t,timestamp:new Date().toISOString()};localStorage.setItem('userPersona',JSON.stringify(a)),loadPersonaPreviews(),renderChatMessages(),alert('我的人设保存成功！')}function loadUserPersona(){const e=JSON.parse(localStorage.getItem('userPersona')||'{}');document.getElementById('user-persona-name').value=e.name||'',document.getElementById('user-persona-desc').value=e.description||'',loadPersonaPreviews(),renderChatMessages(),alert('我的人设加载成功！')}function editMessage(e,t){const a=e.closest('.message'),n=a.querySelector('.message-content'),i=n.textContent;a.classList.add('editing'),n.innerHTML=`<textarea class="edit-input">${i}</textarea><div class="edit-actions"><button onclick="saveEdit('${t}')">保存</button><button onclick="cancelEdit('${t}')">取消</button></div>`,appState.currentEditingMessageId=t}function saveEdit(e){const t=document.querySelector(`.message[data-message-id="${e}"]`),a=t.querySelector('.edit-input'),n=a.value.trim();n&&appState.chatManager.updateMessage(e,n)&&(t.classList.remove('editing'),t.querySelector('.message-content').innerHTML=n),appState.currentEditingMessageId=null}function cancelEdit(e){const t=document.querySelector(`.message[data-message-id="${e}"]`);t.classList.remove('editing');const a=appState.chatManager.messages.find(t=>t.id===e);a&&(t.querySelector('.message-content').innerHTML=a.content),appState.currentEditingMessageId=null}function updateStatusIndicators(){const e=document.getElementById('chat-status'),t=document.getElementById('api-status-indicator'),a=document.getElementById('style-status'),n=document.getElementById('music-status'),i=document.getElementById('wallet-status'),o=document.getElementById('weibo-status'),c=document.getElementById('food-status');appState.isGenerating?(e.className='status-indicator status-generating',e.title='正在生成回复...'):appState.currentPersona?(e.className='status-indicator status-online',e.title='人设已应用'):(e.className='status-indicator status-offline',e.title='使用默认人设');const l=appState.apiService.getCurrentConfig();l.apiKey&&l.model?(t.className='status-indicator status-online',t.title='API配置完成'):(t.className='status-indicator status-offline',t.title='API未配置'),appState.customCSS?(a.className='status-indicator status-online',a.title='自定义样式已应用'):(a.className='status-indicator status-offline',a.title='使用默认样式'),musicPlayer.isPlaying?(n.className='status-indicator status-online',n.title='正在播放'):(n.className='status-indicator status-offline',n.title='未播放'),walletManager.walletData&&walletManager.walletData.totalBalance>0?(i.className='status-indicator status-online',i.title='钱包余额充足'):(i.className='status-indicator status-offline',i.title='钱包余额为空'),weiboManager.weibos&&weiboManager.weibos.length>0?(o.className='status-indicator status-online',o.title=`有 ${weiboManager.weibos.length} 条动态微博`):(o.className='status-indicator status-offline',o.title='微博内容加载中'),window.foodDelivery&&window.foodDelivery.hasActiveOrders?(c.className='status-indicator status-online',c.title='有订单进行中'):window.foodDelivery&&window.foodDelivery.cartItems&&window.foodDelivery.cartItems.length>0?(c.className='status-indicator status-generating',c.title=`购物车有 ${window.foodDelivery.cartItems.length} 件商品`):(c.className='status-indicator status-offline',c.title='桃源应用就绪')}function updateWorldbookStatusIndicator(){const e=document.getElementById('worldbook-status-indicator'),t=document.getElementById('worldbook-status-indicator-title'),a=appState.worldbookManager.getActiveRecords();a.length>0?(e.className='status-indicator status-online',e.title=`有 ${a.length} 条激活的世界书记录`,t.className='status-indicator status-online',t.title=`有 ${a.length} 条激活的世界书记录`):(e.className='status-indicator status-offline',e.title='没有激活的世界书记录',t.className='status-indicator status-offline',t.title='没有激活的世界书记录')}function handleMessageKeypress(e){'Enter'===e.key&&(e.preventDefault(),addUserMessageAndCallAI())}function renderChatMessages(){const e=document.getElementById("chat-messages"),t=appState.chatManager.getMessages(),a=JSON.parse(localStorage.getItem("aiPersona")||"{}"),n=JSON.parse(localStorage.getItem("userPersona")||"{}"),i="single"===appState.chatType;e.innerHTML="",t.forEach(t=>{const r=document.createElement("div"),o="user"===t.sender,s=t.senderName||(o?n.name||"您":i?a.name||"助手":appState.multiPersonaManager.getCurrentPersona()?.name||"助手");r.className=`message ${o?"user-message":"ai-message"}`,r.setAttribute("data-message-id",t.id);const d=appState.selectedMessageIds.includes(t.id);d&&r.classList.add("selected"),r.innerHTML=` \n <div class="message-sender">${s}</div> \n <div class="message-content">${t.content}</div> \n <input type="checkbox" class="message-checkbox" onchange="toggleMessageSelection('${t.id}', this)" ${d?"checked":""}> \n <div class="message-actions"> \n ${o?'<button class="message-action" title="删除" onclick="showDeleteConfirm(\''+t.id+'\')">✖</button> \n <button class="message-action" title="编辑" onclick="editMessage(this, \''+t.id+'\')">✤</button>':'<button class="message-action" title="编辑" onclick="editMessage(this, \''+t.id+'\')">✤</button> \n <button class="message-action" title="删除" onclick="showDeleteConfirm(\''+t.id+'\')">✖</button>'} \n </div> \n `,e.appendChild(r)}),e.scrollTop=e.scrollHeight}function getCurrentAiName(){const e=localStorage.getItem('aiPersona');if(e)try{const t=JSON.parse(e);return t.name||'助手'}catch(e){return'助手'}return'助手'}function getCurrentUserName(){const e=localStorage.getItem('userPersona');if(e)try{const t=JSON.parse(e);return t.name||'您'}catch(e){return'您'}return'您'}function getCurrentRolePrompt(){const e=localStorage.getItem('aiPersona');if(e){const t=JSON.parse(e);return t.description||'你是一个有用的助手'}return'你是一个有用的助手'}

//● api交互
function updateApiEndpoints(){const e=document.getElementById('api-provider').value,t=document.getElementById('api-url'),a=document.getElementById('model-select'),n=document.getElementById('model-provider-badge');if('custom'!==e){t.value=API_ENDPOINTS[e]||'',n.textContent=e.charAt(0).toUpperCase()+e.slice(1),a.innerHTML='<option value="">请选择模型</option>';const i=MODEL_LISTS[e]||[];i.forEach(i=>{const r=document.createElement('option');r.value=i,r.textContent=i,i===appState.apiService.config.model&&(r.selected=!0),a.appendChild(r)})}}function updateSelectedModel(){const e=document.getElementById('model-select'),t=document.getElementById('current-model-display'),a=e.value;a?(t.textContent=`当前模型:${a}`,appState.apiService.updateConfig({model:a})):(t.textContent='当前模型:未选择',appState.apiService.updateConfig({model:''}))}async function testApiConnection(){const e=document.getElementById('api-key').value,t=document.getElementById('api-url').value,a=document.getElementById('api-provider').value,n=document.getElementById('api-status');if(!e)return void(n.style.display='block',n.className='api-status status-error',n.textContent='✖ 请输入API密钥');n.style.display='block',n.className='api-status',n.textContent='测试连接中...';try{appState.apiService.updateConfig({provider:a,apiKey:e,apiUrl:t});const r=await appState.apiService.testConnection();r.success?(n.className='api-status status-success',n.textContent='✔ API连接成功！'):(n.className='api-status status-error',n.textContent=`✖ API连接失败:${r.error}`)}catch(e){n.className='api-status status-error',n.textContent=`✖ API连接失败:${e.message}`}updateStatusIndicators()}async function refreshModels(){const e=document.getElementById('api-key').value,t=document.getElementById('api-url').value,a=document.getElementById('api-provider').value,n=document.getElementById('api-status'),i=document.getElementById('last-updated'),r=document.getElementById('model-provider-badge');if(!e)return void(n.style.display='block',n.className='api-status status-error',n.textContent='✖ 请先输入API密钥');n.style.display='block',n.className='api-status',n.textContent='获取模型中...';try{appState.apiService.updateConfig({provider:a,apiKey:e,apiUrl:t});const o=await appState.apiService.getModels();updateModelSelect(o),n.className='api-status status-success',n.textContent=`✔ 成功获取 ${o.length} 个模型`,appState.models=o,appState.lastUpdated=new Date(),i.textContent=`上次更新:${appState.lastUpdated.toLocaleTimeString()}`,updateSelectedModel(),r.textContent=a.charAt(0).toUpperCase()+a.slice(1)}catch(e){n.className='api-status status-error',n.textContent=`✖ 获取模型失败:${e.message}`;const o=MODEL_LISTS[a]||['default-model'];updateModelSelect(o),appState.models=o,appState.lastUpdated=new Date(),i.textContent=`上次更新:${appState.lastUpdated.toLocaleTimeString()}`,updateSelectedModel(),r.textContent=a.charAt(0).toUpperCase()+a.slice(1)}}function updateModelSelect(e){const t=document.getElementById('model-select');t.innerHTML='<option value="">请选择模型</option>',e.forEach(e=>{const a=document.createElement('option');a.value=e,a.textContent=e,e===appState.apiService.config.model&&(a.selected=!0),t.appendChild(a)})}function saveApiConfig(){const e=document.getElementById('api-key').value,t=document.getElementById('api-url').value,a=document.getElementById('model-select').value,n=document.getElementById('api-provider').value,i=document.getElementById('temperature').value,r=document.getElementById('max-tokens').value,o=document.getElementById('reply-count').value;if(e&&a){appState.apiService.updateConfig({provider:n,apiKey:e,apiUrl:t,model:a,replyCount:parseInt(o)||1}),updateStatusIndicators(),alert('API配置保存成功！')}else alert('请填写完整的API配置信息。')}function clearApiConfig(){document.getElementById('api-key').value='',document.getElementById('api-url').value='https://api.openai.com/v1',document.getElementById('model-select').innerHTML='<option value="">请选择模型</option>',document.getElementById('api-provider').value='openai',document.getElementById('temperature').value='0.7',document.getElementById('max-tokens').value='1000',document.getElementById('reply-count').value='1',document.getElementById('current-model-display').textContent='当前模型:未选择',appState.apiService.updateConfig({provider:'openai',apiKey:'',apiUrl:'https://api.openai.com/v1',model:'',replyCount:1}),updateStatusIndicators(),alert('API配置已清除！')}

//● TTS API交互
function updateTtsApiEndpoints(){const e=document.getElementById('tts-api-provider').value,t=document.getElementById('tts-api-url');'custom'!==e&&(t.value='minimax'===e?'https://api.minimaxi.com/v1':'volink'===e?'https://api.volink.org':'')}async function testTtsConnection(){const e=document.getElementById('tts-api-url').value.trim(),t=document.getElementById('tts-api-key').value.trim(),a=document.getElementById('tts-group-id').value.trim(),n=document.getElementById('tts-status');if(!e)return void showTtsStatus('请输入API地址','error');if(!t)return void showTtsStatus('请输入API密钥','error');a&&ttsService.updateConfig({groupId:a});ttsService.updateConfig({apiUrl:e,apiKey:t});n.style.display='block',n.className='tts-status',n.textContent='测试连接中...';try{const i=await ttsService.testConnection();i.success?(n.className='tts-status success',n.textContent='✔ TTS连接成功！'):(n.className='tts-status error',n.textContent='✖ TTS连接失败:'+i.error)}catch(e){n.className='tts-status error',n.textContent='✖ TTS连接失败:'+e.message}}async function refreshTtsModels(){const e=document.getElementById('tts-api-url').value.trim(),t=document.getElementById('tts-api-key').value.trim(),a=document.getElementById('tts-group-id').value.trim(),n=document.getElementById('tts-status'),i=document.getElementById('tts-last-updated');if(!e)return void showTtsStatus('请输入API地址','error');if(!t)return void showTtsStatus('请输入API密钥','error');a&&ttsService.updateConfig({groupId:a});ttsService.updateConfig({apiUrl:e,apiKey:t});n.style.display='block',n.className='tts-status',n.textContent='获取模型中...';try{const r=await ttsService.getModels();loadTtsModels(),n.className='tts-status success',n.textContent='✔ 成功获取 '+r.length+' 个模型',i.textContent='上次更新:'+new Date().toLocaleTimeString()}catch(e){n.className='tts-status error',n.textContent='✖ 获取模型失败:'+e.message}}function updateSelectedTtsModel(){const e=document.getElementById('tts-model-select'),t=document.getElementById('current-tts-model-display'),a=e.value;a?(t.innerHTML='当前模型: <span>'+a+'</span>',ttsService.updateConfig({model:a})):(t.innerHTML='当前模型: <span>未选择</span>',ttsService.updateConfig({model:''}))}async function refreshTtsVoices(){const e=document.getElementById('tts-model-select').value,t=document.getElementById('tts-status');if(!e)return void showTtsStatus('请先选择模型','error');t.style.display='block',t.className='tts-status',t.textContent='获取语音中...';try{const a=await ttsService.getVoices(e);loadTtsVoices(),t.className='tts-status success',t.textContent='✔ 成功获取 '+a.length+' 个语音',document.getElementById('tts-last-updated').textContent='上次更新:'+new Date().toLocaleTimeString()}catch(e){t.className='tts-status error',t.textContent='✖ 获取语音失败:'+e.message}}function saveTtsConfig(){const e=document.getElementById('tts-api-provider').value,t=document.getElementById('tts-api-url').value.trim(),a=document.getElementById('tts-api-key').value.trim(),n=document.getElementById('tts-group-id').value.trim(),i=document.getElementById('tts-model-select').value,r=document.getElementById('tts-voice-select').value,o=document.getElementById('tts-status');if(e&&t&&a&&i&&r){ttsService.updateConfig({provider:e,apiUrl:t,apiKey:a,groupId:n,model:i,voiceId:r,enabled:!0}),o.style.display='block',o.className='tts-status success',o.textContent='✔ TTS配置保存成功！',setTimeout(()=>{o.style.display='none'},3e3),updateTtsCurrentSelections()}else{o.style.display='block',o.className='tts-status error',o.textContent='✖ 请填写完整的TTS配置信息'}}function clearTtsConfig(){if(confirm('确定要清除TTS配置吗？')){ttsService.updateConfig({provider:'minimax',apiUrl:'https://api.minimaxi.com/v1',apiKey:'',groupId:'',model:'',voiceId:'',enabled:!1}),document.getElementById('tts-api-provider').value='minimax',document.getElementById('tts-api-url').value='https://api.minimaxi.com/v1',document.getElementById('tts-api-key').value='',document.getElementById('tts-group-id').value='',document.getElementById('tts-model-select').value='',document.getElementById('tts-voice-select').value='',document.getElementById('current-tts-model-display').innerHTML='当前模型: <span>未选择</span>',document.getElementById('current-tts-voice-display').innerHTML='当前语音: <span>未选择</span>',showTtsStatus('TTS配置已清除','info')}}async function testTtsVoice(){const e=document.getElementById('tts-voice-select').value,t=document.getElementById('tts-model-select').value,a=document.getElementById('tts-status');if(!e)return void showTtsStatus('请先选择语音','error');if(!t)return void showTtsStatus('请先选择模型','error');const n='你好，欢迎使用世纪小手机的TTS语音功能。这是一个测试语音，用于验证语音合成是否正常工作。';a.style.display='block',a.className='tts-status',a.textContent='生成语音中...';try{const i=await ttsService.textToSpeech(n,e,t,1),r=URL.createObjectURL(i),o=new Audio(r);o.onplay=()=>{a.textContent='正在播放测试语音...'},o.onended=()=>{a.className='tts-status success',a.textContent='✔ 测试语音播放完成',URL.revokeObjectURL(r)},o.onerror=s=>{a.className='tts-status error',a.textContent='✖ 播放失败:'+s.message,URL.revokeObjectURL(r)},o.play()}catch(e){a.className='tts-status error',a.textContent='✖ 语音生成失败:'+e.message}}

//● css交互
function applyGlobalCSS(){const e=document.getElementById('css-editor').value;let t=document.getElementById('global-css');t||(t=document.createElement('style'),t.id='global-css',document.head.appendChild(t)),t.textContent=e,appState.customCSS=e,localStorage.setItem('customCSS',e),updateStatusIndicators(),alert('全局CSS应用成功！')}function resetCSS(){document.getElementById('css-editor').value=`/* 在这里输入您的自定义CSS */\n.message {\n border: 1px solid #000;\n background: white;\n margin: 8px 0;\n max-width: 85%;\n}\n\n.user-message {\n margin-left: auto;\n background: #f8f8f8;\n}\n\n.ai-message {\n margin-right: auto;\n background: #f0f0f0;\n}\n\n.ai-circle {\n border: 3px solid #000;\n background: white;\n transition: all 0.3s ease;\n}\n\n.ai-circle:hover {\n transform: scale(1.05);\n box-shadow: 0 5px 15px rgba(0,0,0,0.1);\n}`,appState.customCSS='',localStorage.removeItem('customCSS');const e=document.getElementById('global-css');e&&e.remove(),updateStatusIndicators(),alert('CSS已重置为默认值！')}function exportCSS(){const e=document.getElementById('css-editor').value,t=new Blob([e],{type:'text/css'}),a=URL.createObjectURL(t),n=document.createElement('a');n.href=a,n.download='ai_app_styles.css',n.click(),URL.revokeObjectURL(a),alert('CSS代码已导出！')}function importCSS(){const e=document.createElement('input');e.type='file',e.accept='.css',e.onchange=function(e){const t=e.target.files[0],a=new FileReader;a.onload=function(e){document.getElementById('css-editor').value=e.target.result,alert('CSS代码已导入！')},a.readAsText(t)},e.click()}function updateTemperatureValue(){const e=document.getElementById('temperature'),t=document.getElementById('temperature-value');t.textContent=e.value} 
   
//● 世界书交互   
function openWorldbookModal(e=null){const t=document.getElementById("worldbook-modal"),a=document.getElementById("worldbook-title"),n=document.getElementById("worldbook-content"),i=document.getElementById("worldbook-modal-title"),r=document.getElementById("worldbook-status");a.value="",n.value="",r.style.display="none",e?((e=appState.worldbookManager.getRecordById(e))&&(i.textContent="编辑世界书记录",a.value=e.title,n.value=e.content,appState.worldbookManager.currentEditingId=e.id)):(i.textContent="添加世界书记录",appState.worldbookManager.currentEditingId=null),t.style.display="flex"}function closeWorldbookModal(){document.getElementById("worldbook-modal").style.display="none",appState.worldbookManager.currentEditingId=null}function saveWorldbookRecord(){const e=document.getElementById("worldbook-title"),t=document.getElementById("worldbook-content"),a=document.getElementById("worldbook-status"),n=e.value.trim(),i=t.value.trim();if(!n||!i)return a.textContent="请填写记录标题和内容",a.className="worldbook-status worldbook-status-error",void(a.style.display="block");let r=!1;const d=appState.worldbookManager.currentEditingId;d?r=appState.worldbookManager.updateRecord(d,n,i):(appState.worldbookManager.addRecord(n,i),r=!0),r?(a.textContent="世界书记录保存成功",a.className="worldbook-status worldbook-status-success",a.style.display="block",renderWorldbookList(),setTimeout(()=>{closeWorldbookModal()},800)):(a.textContent="保存失败，请检查输入",a.className="worldbook-status worldbook-status-error",a.style.display="block"),updateWorldbookStatusIndicator()}function deleteWorldbookRecord(e){appState.worldbookManager.getRecordById(e)&&(deleteWorldbookId=e,document.getElementById("delete-worldbook-dialog").style.display="flex")}function confirmDeleteWorldbookRecord(){deleteWorldbookId&&(appState.worldbookManager.deleteRecord(deleteWorldbookId),renderWorldbookList()),document.getElementById("delete-worldbook-dialog").style.display="none",deleteWorldbookId=null,updateWorldbookStatusIndicator()}function cancelDeleteWorldbookRecord(){document.getElementById("delete-worldbook-dialog").style.display="none",deleteWorldbookId=null}function toggleWorldbookRecord(e){appState.worldbookManager.toggleRecord(e),renderWorldbookList(),updateWorldbookStatusIndicator()}function toggleWorldbookContent(e){const t=document.querySelector(`.worldbook-content[data-record-id="${e}"]`),a=document.querySelector(`.worldbook-toggle[data-record-id="${e}"]`);t&&(t.classList.toggle("expanded"),a&&(a.textContent=t.classList.contains("expanded")?"收起":"展开"))}function renderWorldbookList(){const e=document.getElementById("worldbook-list"),t=appState.worldbookManager.getAllRecords();if(0===t.length)return void(e.innerHTML='<div style="text-align:center;padding:20px;color:#666;">暂无世界书记录，点击右上角"+"添加</div>');e.innerHTML="",t.forEach(t=>{const a=document.createElement("div");a.className="worldbook-item",a.innerHTML=`<div class="worldbook-title"><span class="worldbook-active-indicator ${t.active?"worldbook-active":"worldbook-inactive"}"></span>${t.title}</div><div class="worldbook-content" data-record-id="${t.id}">${t.content}</div><button class="worldbook-toggle" data-record-id="${t.id}" onclick="toggleWorldbookContent('${t.id}')">展开</button><div class="worldbook-actions"><button class="worldbook-action" onclick="toggleWorldbookRecord('${t.id}')">${t.active?"停用":"启用"}</button><button class="worldbook-action" onclick="openWorldbookModal('${t.id}')">编辑</button><button class="worldbook-action" onclick="deleteWorldbookRecord('${t.id}')">删除</button></div>`,e.appendChild(a)})}
    
//● 聊天交互    
function exportChatHistory(){const e=appState.chatManager.getMessages();if(0===e.length)return void showBackupStatus('没有聊天记录可以导出','error');const t={version:'1.0',exportTime:new Date().toISOString(),messageCount:e.length,messages:e},a=JSON.stringify(t,null,2),n=new Blob([a],{type:'application/json'}),i=URL.createObjectURL(n),o=document.createElement('a');o.href=i,o.download=`chat_history_${new Date().toISOString().split('T')[0]}.json`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(i),showBackupStatus(`成功导出 ${e.length} 条聊天记录`,'success')}function importChatHistory(){document.getElementById('backup-file-input').click()}document.getElementById('backup-file-input').addEventListener('change',function(e){const t=e.target.files[0];if(t){const e=new FileReader;e.onload=function(e){try{const t=JSON.parse(e.target.result);t.messages&&Array.isArray(t.messages)?(window.currentImportData=t,document.getElementById('import-confirm-dialog').style.display='flex'):showBackupStatus('文件格式不正确','error')}catch(e){console.error('解析文件失败:',e),showBackupStatus('文件解析失败，请检查文件格式','error')}},e.readAsText(t),this.value=''}}),document.getElementById('confirm-import-btn').addEventListener('click',function(){window.currentImportData&&(performImport(window.currentImportData),document.getElementById('import-confirm-dialog').style.display='none')}),document.getElementById('cancel-import-btn').addEventListener('click',function(){document.getElementById('import-confirm-dialog').style.display='none'});function performImport(e){try{appState.chatManager.messages.length=0,e.messages.forEach(e=>{appState.chatManager.messages.push(e)}),appState.chatManager.saveMessages(),renderChatMessages(),showBackupStatus(`成功导入 ${e.messages.length} 条聊天记录`,'success')}catch(e){console.error('导入聊天记录失败:',e),showBackupStatus('导入聊天记录失败','error')}}function backupToLocal(){const e=appState.chatManager.getMessages();if(0===e.length)return void showBackupStatus('没有聊天记录可以备份','error');const t={version:'1.0',backupTime:new Date().toISOString(),messageCount:e.length,messages:e};localStorage.setItem('chatBackup',JSON.stringify(t)),showBackupStatus(`成功备份 ${e.length} 条聊天记录到本地`,'success')}function restoreFromLocal(){const e=localStorage.getItem('chatBackup');if(!e)return void showBackupStatus('没有找到本地备份','error');try{const t=JSON.parse(e);if(!t.messages||!Array.isArray(t.messages))return void showBackupStatus('备份数据格式不正确','error');window.currentBackupData=t,document.getElementById('restore-confirm-dialog').style.display='flex',document.getElementById('restore-confirm-text').textContent=`恢复聊天记录将覆盖当前的所有消息，此操作不可撤销。确定要恢复 ${t.messageCount} 条消息吗？`}catch(e){console.error('解析备份数据失败:',e),showBackupStatus('备份数据解析失败','error')}}document.getElementById('confirm-restore-btn').addEventListener('click',function(){window.currentBackupData&&(performRestore(window.currentBackupData),document.getElementById('restore-confirm-dialog').style.display='none')}),document.getElementById('cancel-restore-btn').addEventListener('click',function(){document.getElementById('restore-confirm-dialog').style.display='none'});function performRestore(e){try{appState.chatManager.messages.length=0,e.messages.forEach(e=>{appState.chatManager.messages.push(e)}),appState.chatManager.saveMessages(),renderChatMessages(),showBackupStatus(`成功恢复 ${e.messageCount} 条聊天记录`,'success')}catch(e){console.error('恢复聊天记录失败:',e),showBackupStatus('恢复聊天记录失败','error')}}function showBackupStatus(e,t){const a=document.getElementById('backup-status');a.textContent=e,a.className=`backup-status backup-${t}`,a.style.display='block',setTimeout(()=>{a.style.display='none'},3e3)}function toggleProfileCard(){const e=document.getElementById('myProfileCard');e.classList.toggle('expanded'),(()=>{const t=e.querySelector('.profile-toggle');t.textContent=e.classList.contains('expanded')?'▲':'▼'})()}function saveSignature(){localStorage.setItem('desktopSignature',document.getElementById('desktop-signature').textContent)}function loadSignature(){const e=localStorage.getItem('desktopSignature');e&&(document.getElementById('desktop-signature').textContent=e)}

/***********************************
* ✤ 初始化与事件绑定 
 ***********************************/
//● 数据加载与恢复函数
function loadInitialData(){loadSignature();loadChatMode();loadChatType();updateDesktopTime();setInterval(updateDesktopTime,1e3);}

//● 界面初始化函数
function initUIState(){document.querySelectorAll('.interface').forEach(e=>{e.classList.remove('active')});document.getElementById('desktop-interface').classList.add('active');currentInterface='desktop';updateTemperatureValue();updateApiEndpoints();updateStatusIndicators();updateWorldbookStatusIndicator();refreshMultiPersonaPreview();}

//● 锁屏初始化
window.addEventListener("DOMContentLoaded",()=>{lockScreen.init(),document.getElementById("desktop-interface").classList.remove("active")});

//● 锁屏密码初始化
lockScreen.unlock=function(){const e=localStorage.getItem('lockScreenPassword');e?lockPassword.showPasswordPanel():originalUnlock.call(this)};document.getElementById('password-input')&&document.getElementById('password-input').addEventListener('keypress',function(e){'Enter'===e.key&&submitPassword()});

//● 密码设置初始化
window.addEventListener('DOMContentLoaded',function(){initPasswordDisplay()});

if(!window.gomokuGame){window.gomokuGame=new GomokuGame()}window.gomokuGame.init('construction-content')

//● 配置恢复函数
function restoreConfiguration(){const e=appState.apiService.getCurrentConfig();e.apiKey&&(document.getElementById('api-key').value=e.apiKey||'',document.getElementById('api-url').value=e.apiUrl||'https://api.openai.com/v1',document.getElementById('api-provider').value=e.provider||'openai',document.getElementById('temperature').value=.7,document.getElementById('max-tokens').value=1e3,document.getElementById('reply-count').value=e.replyCount||1,e.model&&(e=>{const t=document.getElementById('model-select');setTimeout(()=>{const e=Array.from(t.options).find(e=>e.value===t);e&&(e.selected=!0,updateSelectedModel())},100)})(e));const t=localStorage.getItem('customCSS');t&&(document.getElementById('css-editor').value=t,appState.customCSS=t,(e=>{let t=document.getElementById('global-css');t||(t=document.createElement('style'),t.id='global-css',document.head.appendChild(t)),t.textContent=e})(t));const a=localStorage.getItem('aiPersona');a&&JSON.parse(a);}

//● 界面组件初始化函数
function initUIComponents(){musicPlayer.init();const fabContainer=document.getElementById('fab-container'),fabMainBtn=document.getElementById('fab-main-btn'),fabMenuItems=document.querySelectorAll('.fab-menu-item'),fabIcon=fabMainBtn.querySelector('span'),phoneScreen=document.querySelector('.phone-container .screen');let hasMoved=!1,dragStartX,dragStartY,offsetX,offsetY;const startDrag=e=>{hasMoved=!1;const t=e.touches?e.touches[0]:e;dragStartX=t.clientX,dragStartY=t.clientY;const o=fabContainer.getBoundingClientRect();offsetX=t.clientX-o.left,offsetY=t.clientY-o.top;e.preventDefault();document.addEventListener('mousemove',onMouseMove);document.addEventListener('mouseup',onMouseUp);document.addEventListener('touchmove',onMouseMove,{passive:!1});document.addEventListener('touchend',onMouseUp);};fabMainBtn.addEventListener('mousedown',startDrag);fabMainBtn.addEventListener('touchstart',startDrag,{passive:!1});function onMouseMove(e){if(e.cancelable&&e.preventDefault(),hasMoved||(hasMoved=Math.abs((e.touches?e.touches[0]:e).clientX-dragStartX)>5||Math.abs((e.touches?e.touches[0]:e).clientY-dragStartY)>5),hasMoved){if(fabContainer.classList.contains('active')&&(fabContainer.classList.remove('active'),fabIcon.style.transform='rotate(0deg)',fabIcon.textContent='✤'),1){const t=phoneScreen.getBoundingClientRect(),o=(e.touches?e.touches[0]:e).clientX-t.left-offsetX,n=(e.touches?e.touches[0]:e).clientY-t.top-offsetY,i=t.width-fabContainer.offsetWidth,s=t.height-fabContainer.offsetHeight;fabContainer.style.left=`${Math.max(0,Math.min(o,i))}px`;fabContainer.style.top=`${Math.max(0,Math.min(n,s))}px`;fabContainer.style.right='auto';fabContainer.style.bottom='auto';}}}function onMouseUp(){document.removeEventListener('mousemove',onMouseMove);document.removeEventListener('mouseup',onMouseUp);document.removeEventListener('touchmove',onMouseMove);document.removeEventListener('touchend',onMouseUp);hasMoved||(fabContainer.classList.toggle('active'),fabContainer.classList.contains('active')?(fabIcon.style.transform='rotate(135deg)',fabIcon.textContent='×'):(fabIcon.style.transform='rotate(0deg)',fabIcon.textContent='✤'))}fabMenuItems.forEach(e=>{e.addEventListener('click',function(){const t=this.getAttribute('data-page');document.querySelectorAll('#food-delivery-interface .food-page-container').forEach(e=>{e.classList.remove('active')});const a=document.getElementById(`${t}-page`);a&&a.classList.add('active'),'orders'===t&&'function'==typeof startAllCountdowns&&startAllCountdowns(),'evaluations'===t&&'function'==typeof renderEvaluations&&renderEvaluations(),'favorites'===t&&'function'==typeof renderFavorites&&renderFavorites(),fabContainer.classList.remove('active'),fabIcon.style.transform='rotate(0deg)',fabIcon.textContent='✤'})});window.addEventListener('DOMContentLoaded',()=>{initFoodDeliveryIntegration(),foodOrderManager.loadOrders()});}

//● 对话框事件绑定函数
function bindDialogEvents(){document.getElementById('confirm-delete-btn').addEventListener('click',confirmDelete);document.getElementById('cancel-delete-btn').addEventListener('click',cancelDelete);document.getElementById('confirm-import-btn').addEventListener('click',function(){window.currentImportData&&(performImport(window.currentImportData),document.getElementById('import-confirm-dialog').style.display='none')});document.getElementById('cancel-import-btn').addEventListener('click',function(){document.getElementById('import-confirm-dialog').style.display='none'});document.getElementById('confirm-restore-btn').addEventListener('click',function(){window.currentBackupData&&(performRestore(window.currentBackupData),document.getElementById('restore-confirm-dialog').style.display='none')});document.getElementById('cancel-restore-btn').addEventListener('click',function(){document.getElementById('restore-confirm-dialog').style.display='none'});document.getElementById('confirm-clear-chat-btn').addEventListener('click',confirmClearChatHistory);document.getElementById('cancel-clear-chat-btn').addEventListener('click',cancelClearChatHistory);document.getElementById('confirm-delete-selected-btn').addEventListener('click',confirmDeleteSelectedMessages);document.getElementById('cancel-delete-selected-btn').addEventListener('click',cancelDeleteSelectedMessages);document.getElementById('save-worldbook-btn').addEventListener('click',saveWorldbookRecord);document.getElementById('cancel-worldbook-btn').addEventListener('click',closeWorldbookModal);document.getElementById('confirm-delete-worldbook-btn').addEventListener('click',confirmDeleteWorldbookRecord);document.getElementById('cancel-delete-worldbook-btn').addEventListener('click',cancelDeleteWorldbookRecord);document.getElementById('confirm-weibo-delete-btn').addEventListener('click',function(){weiboManager.confirmDeleteWeibo()});document.getElementById('cancel-weibo-delete-btn').addEventListener('click',function(){weiboManager.cancelDeleteWeibo()});}

//● 表单与输入事件绑定函数
function bindFormEvents(){document.getElementById('desktop-signature').addEventListener('blur',saveSignature);document.getElementById('desktop-signature').addEventListener('keydown',function(e){'Enter'===e.key&&(e.preventDefault(),this.blur())});document.getElementById('temperature').addEventListener('input',updateTemperatureValue);}

//● 数据监听事件绑定函数
function bindDataListeners(){appState.chatManager.addListener('messagesChanged',e=>{renderChatMessages()});appState.chatManager.addListener('messageUpdated',e=>{renderChatMessages()});appState.chatManager.addListener('messageDeleted',e=>{renderChatMessages()});}

//● 主初始化函数（系统启动入口）
function initializeApplication(){loadInitialData();restoreConfiguration();initUIState();initUIComponents();bindDialogEvents();bindFormEvents();bindDataListeners();renderChatMessages();}

//● DOM就绪时启动应用
document.addEventListener('DOMContentLoaded',initializeApplication);
</script>
</body>  
</html>